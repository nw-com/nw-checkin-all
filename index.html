<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北社區打卡系統</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/ficons/6148f9_bb3f0e3c08bd4a3e83840553497fd866~mv2.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 自定義腳本 -->
    <script src="js/dashboard-functions.js"></script>
    <script src="js/features.js" defer></script>
    <script src="js/other.js" defer></script>
    <script src="js/calendar.js" defer></script>
    
    <!-- 已移除 Firebase compat SDK 與初始化；統一使用下方 v10 模組段 -->
    
    <script src="clock-in-functions.js?v=20251006" defer></script>
    <script src="reset-points.js?v=20251006" defer></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1f2937; /* 深灰色背景 */
        }
        .main-container {
            width: 400px;
            height: calc(100vh - 100px); /* 進一步縮減容器高度 */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
            margin: 50px 10px 50px 10px; /* 上50 下50 左10 右10 */
        }
        .header {
            height: 70px;
        }
        .footer {
            height: 70px;
        }
        .content-area {
            height: calc(100% - 140px);
            overflow-y: auto;
        }
        .hide { display: none !important; }
        .tab-btn.active {
            color: #dc2626; /* red-600 */
            border-top-color: #dc2626; /* red-600 */
        }
        .nav-sub-btn.active {
            color: #dc2626; /* red-600 */
            border-top-color: #dc2626; /* red-600 */
        }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sub-tab-btn.active {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626; /* red-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.45);
            backdrop-filter: blur(2px);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px; /* 基本安全內距 */
            overflow: auto; /* 避免內容過長造成遮罩阻擋互動 */
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-height: calc(100vh - 40px);
            overflow-y: auto; /* 內容可捲動 */
            -webkit-overflow-scrolling: touch; /* iOS 捲動優化 */
            margin-top: 12px; /* 與頂部保持距離，避免被地址列遮住 */
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
            padding: 16px;
        }
        /* iOS/瀏覽器安全區支援 */
        @supports (padding: env(safe-area-inset-top)) {
            .modal-backdrop {
                padding-top: calc(env(safe-area-inset-top) + 12px);
                padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
                padding-left: calc(env(safe-area-inset-left) + 12px);
                padding-right: calc(env(safe-area-inset-right) + 12px);
            }
            .modal-content {
                max-height: calc(100vh - 40px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                margin-top: calc(env(safe-area-inset-top) + 12px);
            }
        }
        /* Ensure map canvas is visible */
        .map-canvas {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* Gray background as a fallback */
        }
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 9999px;
            color: white;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            opacity: 1;
            bottom: 110px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- API Key Warning -->
    <div id="api-key-warning" class="hide fixed inset-0 bg-red-100 z-[9999] p-8 text-red-800 flex flex-col items-center justify-center text-center">
        <i data-lucide="alert-triangle" class="w-16 h-16 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">請完成最後的設定步驟</h2>
        <p class="max-w-md">
            系統偵測到您尚未設定 Firebase 或 Google Maps 的 API 金鑰。
            <br><br>
            <strong class="text-red-900">這不是程式錯誤，而是必要的設定。</strong> 基於安全考量，我無法為您產生金鑰，您必須親自完成此設定。
            <br><br>
            請打開 <code>index.html</code> 檔案，找到最下方的 <code>&lt;script type="module"&gt;</code> 區塊，並依照註解指示填入您自己的金鑰。詳細步驟請參考 <code>README.md</code> 檔案。
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">西北社區打卡系統</h1>
            <p class="text-gray-500">社區版V2.1.2</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                 <div class="flex justify-between items-center mb-1">
                    <label for="email" class="block text-sm font-medium text-gray-700">電子郵件</label>
                    <div class="flex items-center">
                        <input id="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">記住我</label>
                    </div>
                </div>
                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                <div class="relative">
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 pr-10" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                    登入
                </button>
                <button type="button" id="apply-account-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                    申請帳號
                </button>
                <button type="button" id="forgot-password-btn" class="w-full bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                    忘記密碼
                </button>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            <p id="login-help" class="text-gray-500 text-xs mt-2 text-center">新建立或核准的帳號需要先設定密碼，請使用「忘記密碼」寄送重設信。</p>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="main-container bg-white flex flex-col hide">
        <!-- Header -->
        <header class="h-[70px] flex items-center justify-between px-4 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <a id="header-logo" href="index.html?goto=navigation&sub=community" title="返回導覽頁" class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                    <span id="header-title" class="text-lg font-bold text-gray-800 whitespace-nowrap">西北社區打卡系統</span>
                </a>
                <span id="welcome-message" class="text-sm text-gray-600 ml-2"></span>
            </div>
            <button id="profile-avatar-btn">
                <img id="header-avatar" src="https://placehold.co/40x40/EFEFEF/333333?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col overflow-hidden bg-gray-50">
            <!-- This will be dynamically populated -->
        </main>

        <!-- Footer Navigation -->
        <footer class="h-[70px] border-t border-gray-200 flex-shrink-0 bg-white">
            <nav id="main-nav" class="flex justify-around h-full items-center">
                <button data-tab="dashboard" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 active">
                    <i data-lucide="layout-dashboard"></i><span class="text-xs mt-1">儀表板</span>
                </button>
                <button data-tab="clock-in" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="fingerprint"></i><span class="text-xs mt-1">打卡</span>
                </button>
                <button id="nav-tracking" data-tab="tracking" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="map-pin"></i><span class="text-xs mt-1">追蹤</span>
                </button>
                <button id="nav-hr" data-tab="hr" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="users"></i><span class="text-xs mt-1">人員</span>
                </button>
                <button id="nav-features" data-tab="features" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="layers"></i><span class="text-xs mt-1">功能</span>
                </button>
                <button id="nav-calendar" data-tab="calendar" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="calendar"></i><span class="text-xs mt-1">行事曆</span>
                </button>
                <button id="nav-schedule" data-tab="schedule" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="calendar-days"></i><span class="text-xs mt-1">排班</span>
                </button>
                <button id="nav-settings" data-tab="settings" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="settings"></i><span class="text-xs mt-1">設定</span>
                </button>
                <button id="nav-group" data-tab="group" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="git-branch"></i><span class="text-xs mt-1">巡邏</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>


    <script type="module">
        // --- 🚨 重要設定：請在此填入您自己的 API 金鑰 🚨 ---
        const firebaseConfig = {
          apiKey: "AIzaSyD81_3sUzJSoQI9ODzpAa95ub2h4xrWCZo",
          authDomain: "nw-checkin-all.firebaseapp.com",
          projectId: "nw-checkin-all",
          storageBucket: "nw-checkin-all.appspot.com",
          messagingSenderId: "162851442567",
          appId: "1:162851442567:web:46e9b42fdbb171d7ff4d22",
          measurementId: "G-PLQS2H99D3"
        };
        const GOOGLE_MAPS_API_KEY = "AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY";
        // Icon library fallback: prevent ReferenceError if lucide not loaded
        if (!window.lucide || typeof window.lucide.createIcons !== 'function') {
            window.lucide = window.lucide || {};
            window.lucide.createIcons = function() {};
            try { console.warn('Lucide 未載入，已使用後備空函式避免錯誤'); } catch (e) {}
        }
        // --- 🚨 設定結束 🚨 ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential,
            EmailAuthProvider, sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot,
            query, where, getDocs, serverTimestamp, orderBy, limit, GeoPoint, Timestamp, writeBatch,
            enableIndexedDbPersistence, arrayUnion, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // 暴露必要的 helper 供非模組腳本使用（過渡期）
        window.__fs = {
            collection,
            getDocs,
            onSnapshot,
            writeBatch,
            doc,
            serverTimestamp,
            addDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            query,
            where,
            orderBy,
            limit,
            Timestamp,
            GeoPoint,
            arrayUnion,
            arrayRemove,
        };
        window.__authHelpers = { onAuthStateChanged };

        // 全域管理員檢查函數（避免區域作用域造成未定義）
        window.checkAdminStatus = async function() {
            try {
                const user = window.__auth?.currentUser;
                if (!user) return false;
                const db = window.__db; const { doc, getDoc } = window.__fs || {};
                if (!db || !doc || !getDoc) return false;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                return !!(userDoc.exists() && userDoc.data().role === 'admin');
            } catch (error) {
                console.warn('checkAdminStatus 失敗:', error);
                return false;
            }
        };

        // 全域審核權限檢查：管理員、人事、高階主管皆可
        window.checkReviewerStatus = async function() {
            try {
                const user = window.__auth?.currentUser;
                if (!user) return false;
                const db = window.__db; const { doc, getDoc } = window.__fs || {};
                if (!db || !doc || !getDoc) return false;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) return false;
                const role = userDoc.data().role;
                return ['admin','hr','manager'].includes(role);
            } catch (error) {
                console.warn('checkReviewerStatus 失敗:', error);
                return false;
            }
        };

        // Global State
        const state = {
            currentUser: null,
            currentUserData: null,
            googleMapsLoaded: false,
            activeListeners: [],
            currentLocation: null,
            users: [],
            trackingMap: null,
            trackingMarkers: [],
            // 用於異常標示的設定與快取
            markAbnormalLocation: true,
            communitiesById: {},
            availableCommunities: [],
            currentCommunity: null,
            appMode: 'default',
            communityIdFromQuery: null,
        };
        
        // 初始化本機裝置ID（用於打卡紀錄與首次打卡裝置標記）
        (function initDeviceId(){
            try {
                const key = 'device_id';
                let id = localStorage.getItem(key);
                if (!id) {
                    const bytes = new Uint8Array(16);
                    crypto.getRandomValues(bytes);
                    id = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                    localStorage.setItem(key, id);
                }
                state.deviceId = id;
            } catch (e) {
                console.warn('初始化裝置ID失敗', e);
                state.deviceId = 'unknown-device';
            }
        })();

        // 角色對應中文標籤
        function roleLabel(role) {
            switch (role) {
                case 'field': return '外勤';
                case 'user': return '內勤';
                case 'junior_manager': return '初階主管';
                case 'manager': return '高階主管';
                case 'hr': return '人事';
                case 'community_admin': return '社區管理員';
                case 'admin': return '管理員';
                default: return role || '內勤';
            }
        }

        // 角色徽章顏色樣式
        function roleBadgeClass(role) {
            switch (role) {
                case 'admin': return 'bg-red-100 text-red-700';
                case 'manager': return 'bg-purple-100 text-purple-700';
                case 'junior_manager': return 'bg-violet-100 text-violet-700';
                case 'hr': return 'bg-amber-100 text-amber-700';
                case 'field': return 'bg-green-100 text-green-700';
                case '總幹事': return 'bg-green-100 text-green-700';
                case '保全': return 'bg-green-100 text-green-700';
                case '秘書': return 'bg-green-100 text-green-700';
                case '清潔': return 'bg-green-100 text-green-700';
                case '機電': return 'bg-green-100 text-green-700';
                default: return 'bg-blue-100 text-blue-700'; // user / 其他
            }
        }

        // 排序輔助：社區編號（字母前綴 + 數字）
        function parseCommunityCode(code) {
            const c = (code || '').toString().trim();
            const m = c.match(/^([A-Za-z]+)(\d+)/);
            if (m) {
                return { prefix: m[1].toUpperCase(), num: parseInt(m[2], 10) };
            }
            // 無法解析，使用整體字串作為前綴，數字設為極大避免干擾排序
            return { prefix: c.toUpperCase(), num: Number.POSITIVE_INFINITY };
        }
        function compareCommunitiesByCode(a, b) {
            const ca = parseCommunityCode(a?.code || '');
            const cb = parseCommunityCode(b?.code || '');
            if (ca.prefix !== cb.prefix) return ca.prefix.localeCompare(cb.prefix);
            if (ca.num !== cb.num) return ca.num - cb.num;
            // 前綴與數字相同時，以完整字串穩定排序
            return (a?.code || '').localeCompare(b?.code || '');
        }

        // 排序輔助：人員依姓氏筆畫（少 → 多）
        const collStroke = (typeof Intl !== 'undefined' && typeof Intl.Collator === 'function')
            ? new Intl.Collator('zh-Hant-u-co-stroke', { sensitivity: 'base' })
            : null;
        function compareUsersBySurnameStroke(a, b) {
            const an = (a?.name || '').trim();
            const bn = (b?.name || '').trim();
            const ac = an.charAt(0);
            const bc = bn.charAt(0);
            if (collStroke) {
                const r = collStroke.compare(ac || '', bc || '');
                if (r !== 0) return r;
            }
            // Fallback：同筆畫或無法比較時，改用中文語系字典序
            return an.localeCompare(bn, 'zh-Hant');
        }

        // 新增輔助：判斷是否為指定社區角色（總幹事、秘書、保全、清潔、機電）
        function isFieldLikeRole(role) {
            const fieldRoles = new Set(['總幹事','秘書','保全','清潔','機電']);
            return fieldRoles.has((role || '').trim());
        }
        
        const loadingScreen = document.getElementById('loading-screen');
        
        function showLoading(show) {
            if(loadingScreen) loadingScreen.classList.toggle('hide', !show);
        }
        // 掛到全域讓外部腳本可使用
        window.showLoading = showLoading;

        function initializeAppLogic() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // 已停用離線持久化以避免不同 SDK 版本衝突
            // 若需啟用，請僅保留單一 SDK 版本並測試瀏覽器支援
            
            const storage = getStorage(app);

            // 暫掛到 window 供過渡期腳本（如 reset-points.js）使用
            window.__app = app;
        window.__auth = auth;
        window.__db = db;
        // 通知其他腳本 Firebase 與全域 helpers 已就緒
        try { window.dispatchEvent(new Event('firebase-ready')); } catch (e) { /* noop */ }
            window.__storage = storage;

            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const mainContent = document.getElementById('main-content');
            const mainNav = document.getElementById('main-nav');
            // 保存容器頁尾（全域底部導覽）的預設內容，便於導覽頁切換時復原
            state.defaultMainNavHtml = mainNav ? mainNav.innerHTML : '';
            const profileAvatarBtn = document.getElementById('profile-avatar-btn');
            const modalContainer = document.getElementById('modal-container');
            const toast = document.getElementById('toast');
            const loginForm = document.getElementById('login-form');
            const bodyEl = document.body;
            
            // Login page specific elements
            const rememberMeCheckbox = document.getElementById('remember-me');
            const emailInput = document.getElementById('email');
            const togglePasswordBtn = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');
            const applyAccountBtn = document.getElementById('apply-account-btn');

            // 解析查詢參數：支援社區模式與指定初始頁
            try {
                const params = new URLSearchParams(window.location.search);
                state.appMode = params.get('mode') || 'default';
                state.communityIdFromQuery = params.get('communityId') || null;
                state.gotoPage = params.get('goto') || null; // e.g., 'navigation'
            } catch (_) {}

            // ---- 距離與異常判定輔助（供多處渲染共用）----
            function calculateDistanceMeters(lat1, lon1, lat2, lon2) {
                const toRad = (v) => (v * Math.PI) / 180;
                const R = 6371000; // 地球半徑（公尺）
                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function openApplyAccountModal() {
                const modalId = `apply-account-modal-${Date.now()}`;
                const defaultAvatar = 'https://placehold.co/80x80/EFEFEF/333333?text=頭像';
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">申請新帳號</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="apply-account-form" class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="apply-avatar-preview" src="${defaultAvatar}" class="w-20 h-20 rounded-full object-cover">
                                    <input type="file" id="apply-avatar-upload" class="hidden" accept="image/*">
                                    <button type="button" id="apply-upload-avatar-btn" class="text-sm px-3 py-1 bg-gray-200 rounded-md">上傳照片</button>
                                </div>

                                <div>
                                    <label for="apply-name" class="block text-sm font-medium text-gray-700">姓名 (必填)</label>
                                    <input type="text" id="apply-name" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-phone" class="block text-sm font-medium text-gray-700">手機號碼</label>
                                    <input type="tel" id="apply-phone" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-title" class="block text-sm font-medium text-gray-700">申請職稱</label>
                                    <select id="apply-title" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="">未選擇</option>
                                        <option value="總幹事">總幹事</option>
                                        <option value="秘書">秘書</option>
                                        <option value="保全">保全</option>
                                        <option value="清潔">清潔</option>
                                        <option value="機電">機電</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="apply-email" class="block text-sm font-medium text-gray-700">電子郵件 (必填)</label>
                                    <input type="email" id="apply-email" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-password" class="block text-sm font-medium text-gray-700">設定密碼 (至少6位)</label>
                                    <input type="password" id="apply-password" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-confirm-password" class="block text-sm font-medium text-gray-700">再次確認密碼</label>
                                    <input type="password" id="apply-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-address" class="block text-sm font-medium text-gray-700">住家地址</label>
                                    <input type="text" id="apply-address" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-birthdate" class="block text-sm font-medium text-gray-700">出生年月日</label>
                                    <input type="date" id="apply-birthdate" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-idnumber" class="block text-sm font-medium text-gray-700">身分證號</label>
                                    <input type="text" id="apply-idnumber" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-blood-type" class="block text-sm font-medium text-gray-700">血型</label>
                                    <select id="apply-blood-type" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="">未選擇</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="O">O</option>
                                        <option value="AB">AB</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="apply-emergency-name" class="block text-sm font-medium text-gray-700">緊急聯絡人姓名</label>
                                    <input type="text" id="apply-emergency-name" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-emergency-relation" class="block text-sm font-medium text-gray-700">與聯絡人關係</label>
                                    <input type="text" id="apply-emergency-relation" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-emergency-phone" class="block text-sm font-medium text-gray-700">緊急連絡人手機號碼</label>
                                    <input type="tel" id="apply-emergency-phone" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-license" class="block text-sm font-medium text-gray-700">專業證照</label>
                                    <select id="apply-license" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="無">無</option>
                                        <option value="職業安全衛生業務主管證照">職業安全衛生業務主管證照</option>
                                        <option value="職業安全衛生管理員證照">職業安全衛生管理員證照</option>
                                        <option value="防火避難設施管理人員證照">防火避難設施管理人員證照</option>
                                        <option value="設備安全管理人員證照">設備安全管理人員證照</option>
                                        <option value="救生員證照">救生員證照</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="apply-service-code" class="block text-sm font-medium text-gray-700">服務社區代號 (手動輸入)</label>
                                    <input type="text" id="apply-service-code" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>

                                <p id="apply-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2 flex-shrink-0">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">取消</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">送出申請</button>
                                </div>
                            </form>
                        </div>
                    </div>`;

                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const form = document.getElementById('apply-account-form');
                const errorEl = document.getElementById('apply-form-error');
                const avatarPreview = document.getElementById('apply-avatar-preview');
                const avatarUploadInput = document.getElementById('apply-avatar-upload');

                // 壓縮圖片為 Base64
                const compressToBase64 = async (file, maxW = 320, maxH = 320, quality = 0.8) => {
                    return await new Promise((resolve, reject) => {
                        const img = new Image();
                        const reader = new FileReader();
                        reader.onload = () => { img.src = reader.result; };
                        reader.onerror = () => reject(new Error('讀取檔案失敗'));
                        img.onload = () => {
                            let { width, height } = img;
                            const ratio = Math.min(maxW / width, maxH / height, 1);
                            width = Math.round(width * ratio); height = Math.round(height * ratio);
                            const canvas = document.createElement('canvas');
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            try {
                                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                                resolve(dataUrl);
                            } catch (e) { reject(e); }
                        };
                        reader.readAsDataURL(file);
                    });

                };

                document.getElementById('apply-upload-avatar-btn').addEventListener('click', () => avatarUploadInput.click());
                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try { avatarPreview.src = await compressToBase64(file); } catch (_) {}
                });

                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';
                    try {
                        const name = document.getElementById('apply-name').value.trim();
                        const phone = document.getElementById('apply-phone').value.trim();
                        const email = document.getElementById('apply-email').value.trim();
                        const password = document.getElementById('apply-password').value;
                        const confirmPassword = document.getElementById('apply-confirm-password').value;
                        const homeAddress = document.getElementById('apply-address').value.trim();
                        const birthDate = document.getElementById('apply-birthdate').value.trim();
                        const idNumber = document.getElementById('apply-idnumber').value.trim();
                        const bloodType = document.getElementById('apply-blood-type').value;
                        const emergencyName = document.getElementById('apply-emergency-name').value.trim();
                        const emergencyRelation = document.getElementById('apply-emergency-relation').value.trim();
                        const emergencyPhone = document.getElementById('apply-emergency-phone').value.trim();
                        const license = document.getElementById('apply-license').value;
                        const serviceCommunityCode = document.getElementById('apply-service-code').value.trim();
                        const applicationTitle = document.getElementById('apply-title').value;

                        if (!name || !email) throw new Error('請填寫姓名與電子郵件');
                        if (password || confirmPassword) {
                            if (password.length < 6) throw new Error('密碼至少 6 位數');
                            if (password !== confirmPassword) throw new Error('兩次密碼不一致');
                        }

                        const data = {
                            name, phone, email, homeAddress, birthDate, idNumber, license, serviceCommunityCode,
                            bloodType, emergencyName, emergencyRelation, emergencyPhone,
                            applicationTitle,
                            avatarUrl: (avatarPreview?.src && !avatarPreview.src.includes('placehold.co')) ? avatarPreview.src : null,
                            status: 'pending',
                            createdAt: serverTimestamp()
                        };
                        const { collection, addDoc } = window.__fs || {};
                        await addDoc(collection(window.__db, 'accountApplications'), data);
                        showToast('申請已送出，待後端審核');
                        close();
                    } catch (err) {
                        console.error('apply account error', err);
                        errorEl.textContent = err.message || '送出失敗，請稍後再試';
                    } finally {
                        showLoading(false);
                    }
                });
            }
            async function ensureAbnormalMarkingConfig() {
                if (state._markSettingLoaded) return;
                try {
                    const { doc, getDoc } = window.__fs || {};
                    const sSnap = await getDoc(doc(db, 'settings', 'location'));
                    if (sSnap.exists()) {
                        const s = sSnap.data();
                        // 若未設定則預設為 true，以符合需求
                        state.markAbnormalLocation = typeof s.markAbnormalLocation === 'boolean' ? s.markAbnormalLocation : true;
                    }
                } catch (e) { /* noop */ }
                state._markSettingLoaded = true;
            }

            async function ensureCommunitiesCache() {
                if (state._communitiesLoaded && state.communitiesById && Object.keys(state.communitiesById).length > 0) return;
                try {
                    const { collection, getDocs } = window.__fs || {};
                    const snap = await getDocs(collection(db, 'communities'));
                    const map = {};
                    snap.forEach(d => {
                        const data = d.data() || {};
                        const gp = data.location;
                        const lat = gp && typeof gp.latitude === 'number' ? gp.latitude : null;
                        const lng = gp && typeof gp.longitude === 'number' ? gp.longitude : null;
                        const radius = (typeof data.radius === 'number' && data.radius >= 0) ? data.radius : null;
                        const region = typeof data.region === 'string' ? data.region : '';
                        const code = typeof data.code === 'string' ? data.code : '';
                        const shortName = typeof data.shortName === 'string' ? data.shortName : '';
                        map[d.id] = {
                            id: d.id,
                            name: data.name || '',
                            region,
                            code,
                            shortName,
                            lat,
                            lng,
                            radius,
                        };
                    });
                    state.communitiesById = map;
                } catch (e) { /* noop */ }
                state._communitiesLoaded = true;
            }

            // 申請帳號按鈕事件
            if (applyAccountBtn) {
                applyAccountBtn.addEventListener('click', () => {
                    try { openApplyAccountModal(); } catch (e) { console.error('openApplyAccountModal error', e); }
                });
            }

            // --- 社區導覽與切換輔助 ---
            function computeAvailableCommunities() {
                const user = state.currentUserData || {};
                const role = user.role || '';
                let list = [];
                const byId = state.communitiesById || {};
                const serviceIds = Array.isArray(user.serviceCommunities) ? user.serviceCommunities.filter(Boolean) : [];
                if (serviceIds.length > 0) {
                    list = serviceIds.map(id => byId[id]).filter(Boolean);
                } else if ([ 'admin', 'manager' ].includes(role)) {
                    list = Object.values(byId);
                } else {
                    // 預設仍顯示所有社區以避免 0 個的狀態
                    list = Object.values(byId);
                }
                // 若計算結果為空且已載入社區資料，回退顯示所有社區，避免出現「0 個」提示
                if (!list || list.length === 0) {
                    list = Object.values(byId);
                }
                // 預設依社區編號排序（如 A101, A102, ... B209）
                list.sort(compareCommunitiesByCode);
                state.availableCommunities = list;
                if (!state.currentCommunity && list.length === 1) {
                    state.currentCommunity = list[0];
                }
                updateHeaderCommunity();
                return list;
            }

            function updateHeaderCommunity() {
                const titleEl = document.getElementById('header-title');
                if (!titleEl) return;
                // 若目前在導覽頁，固定顯示系統標題，避免被上一個社區狀態覆蓋
                if (state.currentPage === 'navigation') {
                    titleEl.textContent = '西北社區打卡系統';
                    return;
                }
                const c = state.currentCommunity;
                if (c?.name) {
                    const code = c.code || '';
                    // 顯示社區名稱，並在下方以較小字體顯示社區編號（縮小間距）
                    titleEl.innerHTML = `${c.name} 社區${code ? '<div class="text-xs text-gray-500" style="margin-top: 2px; line-height: 1;">' + code + '</div>' : ''}`;
                } else {
                    titleEl.textContent = '西北社區打卡系統';
                }
            }

            function isNavigationAllowed(user = null) {
                const u = user || state.currentUserData || {};
                const role = u.role || '';
                const managerial = new Set(['admin','hr','manager','junior_manager']);
                const workerRoles = new Set(['總幹事','秘書','保全','清潔','機電']);
                if (managerial.has(role)) return true;
                if (workerRoles.has(role)) {
                    const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities.filter(Boolean) : [];
                    return ids.length >= 2;
                }
                return false;
            }

            function shouldShowNavigationPage() {
                // 社區模式不顯示導覽頁
                if (state.appMode === 'community') return false;
                // 僅允許特定角色或服務 >=2 社區的指定角色進入導覽頁
                return isNavigationAllowed(state.currentUserData);
            }

            function openCommunitySwitchModal() {
                const modalContainer = document.getElementById('modal-container');
                const list = state.availableCommunities || [];
                if (!modalContainer) return;
                modalContainer.innerHTML = `
                    <div class="modal-overlay" id="community-modal-overlay"></div>
                    <div class="modal-content">
                        <div class="modal-header">選擇社區</div>
                        <div class="space-y-2">
                            ${list.length === 0 ? '<div class="text-gray-500">目前無可選擇的社區</div>' : list.map(c => `
                                <button class="w-full text-left px-3 py-2 rounded border hover:bg-gray-50" data-id="${c.id}">${c.name || '(未命名社區)'}</button>
                            `).join('')}
                        </div>
                        <div class="modal-actions">
                            <button id="community-modal-close" class="px-3 py-1 rounded bg-gray-100">關閉</button>
                        </div>
                    </div>`;
                modalContainer.classList.add('show');
                // bind events
                const close = () => { modalContainer.classList.remove('show'); modalContainer.innerHTML = ''; };
                const overlay = document.getElementById('community-modal-overlay');
                const closeBtn = document.getElementById('community-modal-close');
                overlay && overlay.addEventListener('click', close);
                closeBtn && closeBtn.addEventListener('click', close);
                modalContainer.querySelectorAll('button[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        const c = (state.availableCommunities || []).find(x => x.id === id);
                        if (c) {
                            state.currentCommunity = c;
                            updateHeaderCommunity();
                            showToast(`已切換至「${c.name}」`);
                            close();
                            try { showPage('dashboard'); } catch (_) {}
                        }
                    });
                });
            }

            function enterCommunityMainPage(commId) {
                const c = (state.availableCommunities || []).find(x => x.id === commId) || state.communitiesById?.[commId];
                if (c) {
                    state.currentCommunity = c;
                    updateHeaderCommunity();
                    showPage('dashboard');
                } else {
                    showToast('找不到社區資料', true);
                }
            }

            function computeRecordAbnormal(record, serviceCommunityIds) {
                try {
                    if (!state.markAbnormalLocation) return null;
                    const loc = record.location;
                    const lat = loc && typeof loc.latitude === 'number' ? loc.latitude : null;
                    const lng = loc && typeof loc.longitude === 'number' ? loc.longitude : null;
                    if (lat == null || lng == null) return null;
                    const ids = Array.isArray(serviceCommunityIds) ? serviceCommunityIds : [];
                    if (!ids.length) return null;
                    let considered = 0;
                    let inside = false;
                    let nearest = Infinity;
                    let nearestCommunity = null;
                    for (const id of ids) {
                        const c = state.communitiesById?.[id];
                        if (!c || c.lat == null || c.lng == null || !(typeof c.radius === 'number' && c.radius > 0)) continue;
                        considered++;
                        const dist = calculateDistanceMeters(lat, lng, c.lat, c.lng);
                        if (dist <= c.radius) {
                            inside = true; break;
                        }
                        if (dist < nearest) { nearest = dist; nearestCommunity = c; }
                    }
                    if (!considered) return null;
                    if (inside) return { isAbnormal: false };
                    const detail = nearestCommunity ? `距離${nearestCommunity.name || '最近社區'}約${Math.round(nearest)}公尺` : '';
                    return { isAbnormal: true, detail };
                } catch (e) { return null; }
            }

            // Remember me logic
            const savedEmail = localStorage.getItem('rememberedEmail');
            if (savedEmail) {
                emailInput.value = savedEmail;
                rememberMeCheckbox.checked = true;
            }
            
            // Password visibility toggle
            togglePasswordBtn.addEventListener('click', () => {
                const passwordIcon = document.getElementById('password-icon');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye" class="w-5 h-5"></i>';
                } else {
                    passwordInput.type = 'password';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>';
                }
                lucide.createIcons();
            });


            // --- Authentication Logic ---
            const translateAuthError = (error) => {
                const code = error?.code || '';
                if (code === 'auth/invalid-email') return '電子郵件格式不正確。';
                if (code === 'auth/user-not-found') return '查無此帳號，請先由管理端建立或核准。';
                if (code === 'auth/wrong-password' || code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials') return '密碼錯誤，如忘記請使用「忘記密碼」。';
                if (code === 'auth/too-many-requests') return '嘗試次數過多，已暫時封鎖，稍後再試。';
                if (code === 'auth/operation-not-allowed') return '未啟用 Email/密碼登入，請聯繫系統管理員。';
                if (code === 'auth/network-request-failed') return '網路異常，請檢查連線。';
                return '';
            };

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                const loginError = document.getElementById('login-error');
                loginError.textContent = '';

                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error('login error', error);
                    const msg = translateAuthError(error);
                    loginError.textContent = msg || '登入失敗，請檢查帳號密碼。';
                } finally {
                    showLoading(false);
                }
            });

            // Forgot password
            const forgotPasswordBtn = document.getElementById('forgot-password-btn');
            if (forgotPasswordBtn) {
                forgotPasswordBtn.addEventListener('click', async () => {
                    const email = emailInput.value.trim();
                    const loginError = document.getElementById('login-error');
                    loginError.textContent = '';
                    if (!email) {
                        loginError.textContent = '請先輸入您的電子郵件，再點選忘記密碼。';
                        return;
                    }
                    showLoading(true);
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showToast('已寄出重設密碼通知信');
                    } catch (error) {
                        console.error('reset password error', error);
                        const msg = translateAuthError(error);
                        loginError.textContent = msg || '寄送重設密碼失敗，請稍後再試。';
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            onAuthStateChanged(auth, (user) => {
                cleanupListeners();
                if (user) {
                    bodyEl.classList.remove('bg-red-600');
                    bodyEl.classList.add('bg-gray-100');
                    state.currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const wasNotInitialized = !state.currentUserData;
                            state.currentUserData = { id: user.uid, ...docSnap.data() };
                            if (wasNotInitialized) {
                                initializeAppUI();
                            } else {
                                updateHeaderAvatar();
                            }
                        } else { 
                            showToast('此帳號尚未初始化，請通知管理員建立人員資料', true);
                            signOut(auth); 
                        }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        showToast('讀取用戶資料失敗，請稍後再試', true);
                        signOut(auth);
                    });
                    state.activeListeners.push(unsubscribe);
                } else {
                    bodyEl.classList.remove('bg-gray-100');
                    bodyEl.classList.add('bg-red-600');
                    state.currentUser = null;
                    state.currentUserData = null;
                    loginPage.classList.remove('hide');
                    appContainer.classList.add('hide');
                    showLoading(false);
                }
            });

            // --- UI Initialization and Navigation ---
            function initializeAppUI() {
                loadGoogleMapsScript();
                updateHeaderAvatar();
                // 準備社區資料與標頭顯示
                try { ensureCommunitiesCache().then(() => { computeAvailableCommunities(); updateHeaderCommunity(); }); } catch (_) {}
                // 加入頁首 LOGO/標題的點擊事件，直接回導覽頁（依社區）
                try {
                    const headerLogo = document.getElementById('header-logo');
                    if (headerLogo) {
                        headerLogo.addEventListener('click', (ev) => {
                            // 僅服務 >=2 社區或管理角色可返回導覽頁
                            if (!isNavigationAllowed(state.currentUserData)) {
                                ev.preventDefault();
                                return;
                            }
                            // 若存在 SPA 環境，避免整頁重載，直接切換到導覽頁
                            ev.preventDefault();
                            try { renderFooterNavForNavigation('community'); } catch (e) { /* noop */ }
                            try { showPage('navigation', 'community'); } catch (e) { /* noop */ }
                        });
                    }
                } catch (_) {}
                // 取消頁首連結與按鈕行為（不再提供點擊導覽或社區切換）
                
                // 社區模式：隱藏內部標頭與底部導覽，並固定由外層控制
                const appHeaderEl = appContainer.querySelector('header');
                const appFooterEl = appContainer.querySelector('footer');
                if (state.appMode === 'community') {
                    appHeaderEl && appHeaderEl.classList.add('hide');
                    appFooterEl && appFooterEl.classList.add('hide');
                }
                
                const navTracking = document.getElementById('nav-tracking');
                const navSettings = document.getElementById('nav-settings');
                const navHr = document.getElementById('nav-hr');
                const navGroup = document.getElementById('nav-group');
                const navFeatures = document.getElementById('nav-features');
                const navCalendar = document.getElementById('nav-calendar');
                const navSchedule = document.getElementById('nav-schedule');
                const navDashboard = document.querySelector('.tab-btn[data-tab="dashboard"]');
                const navClockIn = document.querySelector('.tab-btn[data-tab="clock-in"]');

                // 導覽顯示權限（角色：admin、manager、junior_manager、總幹事、秘書、保全、清潔、機電）
                const role = state.currentUserData.role;
                [navTracking, navSettings, navHr, navGroup, navSchedule].forEach(el => el && el.classList.add('hide'));

                if (role === 'admin') {
                    // 管理員：顯示追蹤與排班；設定已移至導覽頁
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                    // 人事分頁不再針對「人事」角色開放，預設隱藏
                    navHr && navHr.classList.add('hide');
                } else if (role === 'manager') {
                    // 高階主管：顯示追蹤與排班
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === 'junior_manager') {
                    // 初階主管：僅顯示群組
                    navGroup && navGroup.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === '總幹事') {
                    // 總幹事：儀錶板、打卡、追蹤、功能、行事曆
                    navTracking && navTracking.classList.remove('hide');
                    // 其他分頁已移除；設定、人事、群組、排班保持隱藏
                    navSettings && navSettings.classList.add('hide');
                } else if (['秘書','保全','清潔','機電'].includes(role)) {
                    // 一般人員（秘書、保全、清潔、機電）：儀錶板、打卡、功能、行事曆
                    // 追蹤、設定、人事、群組、排班全部隱藏
                    navSettings && navSettings.classList.add('hide');
                } else {
                    // 其餘角色：保守預設不顯示進階分頁
                    navSettings && navSettings.classList.add('hide');
                }
                
                loginPage.classList.add('hide');
                appContainer.classList.remove('hide');

                // 若為社區模式且帶入 communityId，直接進入儀表板，不顯示導覽頁
                if (state.appMode === 'community' && state.communityIdFromQuery) {
                    // 設定當前社區
                    const cid = state.communityIdFromQuery;
                    state.currentCommunity = state.communitiesById?.[cid] || state.currentCommunity;
                    try {
                        const cname = state.currentCommunity?.name || '';
                        window.parent && window.parent.postMessage({ type: 'community-info', id: cid, name: cname }, '*');
                    } catch (_) {}
                    showPage('dashboard');
                    showLoading(false);
                    return;
                }

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                let initialPage = 'dashboard';
                let initialSub = null;
                // 若 URL 指定導覽頁，優先顯示導覽頁
                if (state.gotoPage === 'navigation') {
                    initialPage = 'navigation';
                    initialSub = 'community';
                    renderFooterNavForNavigation(initialSub);
                } else if (shouldShowNavigationPage()) {
                    initialPage = 'navigation';
                    initialSub = 'community';
                    // 顯示容器頁尾為導覽子分頁
                    renderFooterNavForNavigation(initialSub);
                } else {
                    restoreFooterMainTabs('dashboard');
                }
                showPage(initialPage, initialSub);
                showLoading(false);
            }

            function updateHeaderAvatar() {
                const headerAvatar = document.getElementById('header-avatar');
                if (state.currentUserData?.avatarUrl) {
                    headerAvatar.src = state.currentUserData.avatarUrl;
                } else {
                    headerAvatar.src = `https://placehold.co/40x40/EFEFEF/333333?text=${state.currentUserData?.name?.charAt(0) || 'U'}`;
                }
                const welcomeMessage = document.getElementById('welcome-message');
                if(welcomeMessage) {
                    welcomeMessage.textContent = `歡迎~ ${state.currentUserData.name}`;
                }
            }
            
            function renderTrackingDevices(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <h2 class="text-lg font-bold mb-4">打卡裝置監控</h2>
                        <div class="mb-4 flex items-center gap-4">
                            <div>
                                <label for="device-date-filter" class="block text-sm font-medium text-gray-700">查詢日期</label>
                                <input type="date" id="device-date-filter" class="mt-1 px-3 py-2 border rounded-md">
                            </div>
                            <div class="flex items-end">
                                <button id="device-search-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">查詢</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">打卡日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">打卡時的裝置ID</th>
                                    </tr>
                                </thead>
                                <tbody id="device-records-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">請選擇日期並點擊查詢</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // 設定預設日期為今天
                const dateFilter = document.getElementById('device-date-filter');
                const today = new Date();
                dateFilter.value = today.toISOString().split('T')[0];
                
                const searchBtn = document.getElementById('device-search-btn');
                searchBtn.addEventListener('click', loadDeviceRecords);
                
                // 載入打卡裝置記錄
                async function loadDeviceRecords() {
                    const selectedDate = new Date(dateFilter.value);
                    if (isNaN(selectedDate.getTime())) {
                        showToast('請選擇有效日期', true);
                        return;
                    }
                    
                    const deviceRecordsList = document.getElementById('device-records-list');
                    deviceRecordsList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                    <span class="ml-2">載入中...</span>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    try {
                        // 取得日期範圍 (當日 00:00 到 23:59)
                        const startDate = new Date(selectedDate);
                        startDate.setHours(0, 0, 0, 0);
                        const endDate = new Date(selectedDate);
                        endDate.setHours(23, 59, 59, 999);
                        
                        // 查詢打卡記錄（前端依日期過濾，避免複合索引需求）
                        const clockInRef = collection(db, 'clockInRecords');
                        const q = query(clockInRef);
                        const qs = await getDocs(q);
                        
                        const records = [];
                        qs.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                        
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startDate && ts <= endDate;
                        }).sort((a, b) => {
                            const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return tb - ta;
                        });
                        
                        // 取得所有用戶資料以顯示姓名
                        const usersRef = collection(db, 'users');
                        const usersSnapshot = await getDocs(usersRef);
                        const usersData = {};
                        usersSnapshot.forEach(doc => { usersData[doc.id] = doc.data(); });
                        
                        // 以使用者為單位分組
                        const grouped = {};
                        filtered.forEach(r => {
                            const uid = r.userId;
                            if (!grouped[uid]) grouped[uid] = [];
                            grouped[uid].push(r);
                        });
                        
                        let html = '';
                        Object.keys(grouped).forEach(uid => {
                            const user = usersData[uid];
                            if (!user) return;
                            const recs = grouped[uid];
                            const deviceIds = [...new Set(recs.map(r => r.deviceId).filter(Boolean))];
                            const hasAnomalies = deviceIds.length > 1;
                            
                            recs.forEach(r => {
                                const rowClass = hasAnomalies ? 'bg-red-50' : '';
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : new Date());
                                const locName = typeof r.locationName === 'string' ? r.locationName : (r.location?.address || null);
                                const statusText = getStatusDisplayText(r.type || '未知', locName, r.dutyType || null);
                                const statusColorClass = getStatusColor(statusText);
                                html += `
                                    <tr class="${rowClass}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.name||'U').charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                                <div class="text-sm font-medium text-gray-900">${user.name || '未知'}</div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">${statusText}</span>
                                            ${hasAnomalies ? '<div class="text-xs text-red-600 mt-1">異常</div>' : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ts.toLocaleString('zh-TW', { hour12: false })}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.deviceId || '未知'}</td>
                                    </tr>
                                `;
                            });
                        });
                        
                        document.getElementById('device-records-list').innerHTML = html || `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">沒有符合條件的紀錄</td>
                            </tr>
                        `;
                        
                    } catch (error) {
                        console.error('載入裝置記錄失敗:', error);
                        document.getElementById('device-records-list').innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">載入失敗，請稍後再試</td>
                            </tr>
                        `;
                    }
                }
                
                function getStatusColor(status) {
                    if (typeof status !== 'string') return 'bg-gray-100 text-gray-800';
                    if (status.includes('上班')) return 'bg-green-100 text-green-800';
                    if (status.includes('已下班-未打卡')) return 'bg-yellow-100 text-yellow-800';
                    if (status.includes('下班') || status.includes('已下班')) return 'bg-red-100 text-red-800';
                    if (status.includes('外出') || status.includes('抵達') || status.includes('離開')) return 'bg-blue-100 text-blue-800';
                    if (status.includes('返回')) return 'bg-green-100 text-green-800';
                    if (status.includes('請假') || status.includes('臨時請假')) return 'bg-orange-100 text-orange-800';
                    if (status.includes('特殊勤務') || status.includes('出勤')) return 'bg-indigo-100 text-indigo-800';
                    return 'bg-gray-100 text-gray-800';
                }
            }

            mainNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-btn');
                if (!tabButton) return;
                const tab = tabButton.dataset.tab;
                if (!tab || state.currentPage === tab) return;
                // 交由 showPage 重建頁尾並設定正確的 active 樣式
                showPage(tab);
            });

            // 導覽頁使用容器頁尾（Footer）作為子分頁切換，非內嵌於頁面內容
            function renderFooterNavForNavigation(activeSubTab) {
                if (!mainNav) return;
                const role = state.currentUserData?.role || '';
                const showSettings = role === 'admin';
                const managerial = new Set(['admin','hr','manager','junior_manager']);
                const showNameTab = managerial.has(role);
                let html = `
                    <button data-subtab="community" class="nav-sub-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${!activeSubTab || activeSubTab==='community' ? 'active' : ''}">
                        <i data-lucide="building-2"></i><span class="text-xs mt-1">依社區</span>
                    </button>`;
                if (showNameTab) {
                    html += `
                    <button data-subtab="name" class="nav-sub-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${activeSubTab==='name' ? 'active' : ''}">
                        <i data-lucide="user"></i><span class="text-xs mt-1">依姓名</span>
                    </button>`;
                }
                if (showSettings) {
                    html += `
                    <button data-subtab="settings" class="nav-sub-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${activeSubTab==='settings' ? 'active' : ''}">
                        <i data-lucide="settings"></i><span class="text-xs mt-1">設定</span>
                    </button>`;
                }
                mainNav.innerHTML = html;
                // 綁定容器頁尾子分頁切換
                mainNav.querySelectorAll('.nav-sub-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // 切換 active 樣式以符合主頁 footer 風格
                        mainNav.querySelectorAll('.nav-sub-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        showPage('navigation', btn.dataset.subtab);
                    });
                });
                try { lucide.createIcons(); } catch (_) {}
            }

            function applyRoleNavVisibility() {
                const role = state.currentUserData?.role || '';
                const navTracking = document.getElementById('nav-tracking');
                const navSchedule = document.getElementById('nav-schedule');
                const navSettings = document.getElementById('nav-settings');
                const navHr = document.getElementById('nav-hr');
                const navGroup = document.getElementById('nav-group');

                // 預設隱藏進階分頁
                navTracking && navTracking.classList.add('hide');
                navSchedule && navSchedule.classList.add('hide');
                navSettings && navSettings.classList.add('hide');
                navHr && navHr.classList.add('hide');
                navGroup && navGroup.classList.add('hide');

                if (role === 'admin') {
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    // 全域設定已移至導覽頁設定，保持隱藏
                    navSettings && navSettings.classList.add('hide');
                    // 人事保持隱藏
                    navHr && navHr.classList.add('hide');
                } else if (role === 'manager') {
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === 'junior_manager') {
                    navGroup && navGroup.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === '總幹事') {
                    navTracking && navTracking.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (['秘書','保全','清潔','機電'].includes(role)) {
                    navSettings && navSettings.classList.add('hide');
                } else {
                    navSettings && navSettings.classList.add('hide');
                }
            }

            function restoreFooterMainTabs(activeTab) {
                if (!mainNav) return;
                const role = state.currentUserData?.role || '';

                // 根據角色群組動態重建主頁頁尾導覽按鈕
                const isManagement = new Set(['admin','hr','manager','junior_manager']).has(role);
                const isStaff = new Set(['總幹事','秘書','保全','清潔','機電']).has(role);

                const items = [];
                const pushItem = (tab, icon, label) => items.push({ tab, icon, label });
                const idForTab = (tab) => {
                    switch (tab) {
                        case 'tracking': return 'nav-tracking';
                        case 'hr': return 'nav-hr';
                        case 'features': return 'nav-features';
                        case 'calendar': return 'nav-calendar';
                        case 'schedule': return 'nav-schedule';
                        case 'settings': return 'nav-settings';
                        case 'group': return 'nav-group';
                        default: return '';
                    }
                };

                if (isManagement) {
                    // 管理員、人事、高階主管、初階主管：依權限顯示並依指定順序排列
                    pushItem('dashboard', 'layout-dashboard', '儀表板');
                    if (['admin','hr','manager','junior_manager'].includes(role)) {
                        pushItem('tracking', 'map-pin', '追蹤');
                    }
                    if (['admin','hr','manager','junior_manager'].includes(role)) {
                        pushItem('schedule', 'calendar-days', '排班');
                    }
                    pushItem('features', 'layers', '功能');
                    // 巡邏：目前對 junior_manager 必定顯示，管理員/高階主管/人事若具權限也顯示
                    if (['admin','manager','junior_manager','hr'].includes(role)) {
                        pushItem('group', 'git-branch', '巡邏');
                    }
                    if (['admin','hr','manager','junior_manager'].includes(role)) {
                        pushItem('hr', 'users', '人員');
                    }
                } else if (isStaff) {
                    // 總幹事、秘書、保全、清潔、機電
                    pushItem('dashboard', 'layout-dashboard', '儀表板');
                    pushItem('clock-in', 'fingerprint', '打卡');
                    pushItem('features', 'layers', '功能');
                    pushItem('group', 'git-branch', '巡邏');
                } else {
                    // 其他未定義角色：保守呈現基本功能
                    pushItem('dashboard', 'layout-dashboard', '儀表板');
                    pushItem('clock-in', 'fingerprint', '打卡');
                    pushItem('features', 'layers', '功能');
                }

                const html = items.map(({ tab, icon, label }) => {
                    const idAttr = idForTab(tab);
                    const activeClass = (activeTab || 'dashboard') === tab ? 'active' : '';
                    return `
                        <button ${idAttr ? `id="${idAttr}"` : ''} data-tab="${tab}" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${activeClass}">
                            <i data-lucide="${icon}"></i><span class="text-xs mt-1">${label}</span>
                        </button>`;
                }).join('\n');

                mainNav.innerHTML = html;
                try { lucide.createIcons(); } catch (_) {}
            }

            // 確保在任何時候點擊頭像按鈕都能打開個人資料
            document.getElementById('profile-avatar-btn').addEventListener('click', renderProfileModal);

            function showPage(pageName, subPage = null, params = {}) {
                cleanupListeners();
                // 記錄目前頁面，供其他互動判斷
                state.currentPage = pageName;
                state.currentLocation = null;
                state.trackingMap = null;
                state.trackingMarkers = [];
                // 導覽頁改用容器頁尾作為子分頁切換；非導覽頁復原容器頁尾
                if (mainNav) {
                    if (pageName === 'navigation') {
                        renderFooterNavForNavigation(subPage || 'community');
                    } else {
                        restoreFooterMainTabs(pageName);
                    }
                }
                // 依頁面調整頁首標題與返回導覽的連結行為
                try {
                    const headerLogo = document.getElementById('header-logo');
                    const headerTitle = document.getElementById('header-title');
                    if (headerLogo && headerTitle) {
                        if (pageName === 'navigation') {
                            // 導覽頁：顯示系統標題，關閉返回導覽的點擊行為
                            headerTitle.textContent = '西北社區打卡系統';
                            headerLogo.classList.add('pointer-events-none', 'cursor-default');
                            headerLogo.removeAttribute('href');
                        } else {
                            // 其他頁：顯示社區名稱（若有）；僅允許可返回導覽的帳號啟用點擊
                            try { updateHeaderCommunity(); } catch (e) { /* noop */ }
                            if (isNavigationAllowed(state.currentUserData)) {
                                headerLogo.classList.remove('pointer-events-none', 'cursor-default');
                                headerLogo.setAttribute('href', 'index.html?goto=navigation&sub=community');
                            } else {
                                headerLogo.classList.add('pointer-events-none', 'cursor-default');
                                headerLogo.removeAttribute('href');
                            }
                        }
                    }
                } catch (_) {}
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const role = state.currentUserData?.role || '';
                const router = {
                    'dashboard': renderDashboard,
                    'clock-in': () => renderClockIn(subPage || 'location'),
                    'tracking': () => ['admin','hr','manager','junior_manager'].includes(role) ? renderTracking(subPage || 'map', params) : renderAccessDenied(),
                    'features': () => renderFeatures(subPage || 'training'),
                    'calendar': () => renderCalendar(subPage || 'overview'),
                    'schedule': () => ['admin','hr','manager','junior_manager'].includes(role) ? renderShifts(subPage || null) : renderAccessDenied(),
                    'settings': () => role === 'admin' ? renderSettings(subPage || 'applications') : renderAccessDenied(),
                    'hr': () => (['admin','hr','manager','junior_manager'].includes(role)) ? renderHR(subPage || 'applications') : renderAccessDenied(),
                    'navigation': () => isNavigationAllowed(state.currentUserData) ? renderNavigation(subPage || 'community') : renderAccessDenied(),
                    'group': () => ['admin','hr','manager','junior_manager','總幹事','秘書','保全','清潔','機電'].includes(role) ? renderGroup(subPage || 'map') : renderAccessDenied()
                };
                const renderFunction = router[pageName] || renderAccessDenied;
                try {
                    renderFunction(params);
                } catch(e) {
                    console.error("Failed to render page:", e);
                    mainContent.innerHTML = `<div class="p-4 text-red-500">頁面載入失敗。</div>`;
                }
                lucide.createIcons();
            }

            function renderAccessDenied() {
                mainContent.innerHTML = `
                    <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <i data-lucide="ban" class="w-16 h-16 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold">權限不足</h2>
                        <p>您沒有權限訪問此頁面。</p>
                    </div>
                `;
            }

            // 導覽頁（管理階層使用）
            function renderNavigation(subPage) {
                const role = state.currentUserData?.role || '';
                const showSettings = role === 'admin';
                // 導覽頁：子分頁切換移至容器頁尾（Footer），內容區全高顯示
                mainContent.innerHTML = `
                    <div id="sub-page-content" class="overflow-y-auto h-full"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'name') {
                    renderNavByName(subPageContent);
                } else if (subPage === 'settings' && showSettings) {
                    renderNavSettings(subPageContent);
                } else {
                    renderNavByCommunity(subPageContent);
                }
                try { lucide.createIcons(); } catch (_) {}
            }

            function renderNavByCommunity(container) {
                const byId = state.communitiesById || {};
                const isReady = byId && Object.keys(byId).length > 0;
                // 若社區資料尚未載入，顯示載入中並在載入完成後重繪
                if (!isReady) {
                    container.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                                <div>載入社區資料中...</div>
                            </div>
                        </div>`;
                    try {
                        ensureCommunitiesCache().then(() => {
                            try { computeAvailableCommunities(); } catch (_) {}
                            renderNavByCommunity(container);
                            try { lucide.createIcons(); } catch (_) {}
                    // 綁定角色過濾按鈕
                    const summaryEl = document.getElementById('shift-summary');
                    const updateRoleButtonsActive = () => {
                        if (!summaryEl) return;
                        summaryEl.querySelectorAll('button[data-role]').forEach(b => {
                            const r = b.getAttribute('data-role');
                            const active = (pageState.roleFilter === r);
                            b.classList.toggle('ring-2', active);
                            b.classList.toggle('ring-offset-1', active);
                            b.classList.toggle('opacity-80', !active && pageState.roleFilter !== null);
                        });
                    };
                    if (summaryEl) {
                        summaryEl.querySelectorAll('button[data-role]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const role = btn.getAttribute('data-role');
                                pageState.roleFilter = (pageState.roleFilter === role) ? null : role;
                                updateRoleButtonsActive();
                                renderCalendar();
                                renderMonthlyList();
                            });
                        });
                        updateRoleButtonsActive();
                    }
                        });
                    } catch (_) {}
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }

                // 確保可顯示清單已計算
                try { computeAvailableCommunities(); } catch (_) {}
                const list = state.availableCommunities || [];
                if (!list.length) {
                    container.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="home" class="w-8 h-8 mx-auto mb-3"></i>
                                <div>目前沒有可顯示的社區</div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }

                let selectedRegion = null; // '台北' | '新北' | '桃園' | null
                const renderList = () => {
                    const sorted = [...list].sort(compareCommunitiesByCode);
                    const filtered = selectedRegion ? sorted.filter(c => (c?.region || '') === selectedRegion) : sorted;
                    // 依社區簡稱內容顯示，支援多行（顯示至多兩行），置中顯示
                    const toTwoLines = (text) => {
                        const raw = (text || '').toString();
                        const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                        if (lines.length === 0) return ['未命名', ''];
                        if (lines.length === 1) return [lines[0], ''];
                        return [lines[0], lines[1]];
                    };
                    container.innerHTML = `
                        <div class="p-4 space-y-3">
                            <div class="flex items-center mb-2">
                                <div class="flex items-center gap-2 flex-nowrap overflow-x-auto">
                                    <button class="region-btn px-3 py-1 rounded border ${selectedRegion==='台北'?'bg-red-600 text-white border-red-600':'bg-white'}" data-region="台北">台北</button>
                                    <button class="region-btn px-3 py-1 rounded border ${selectedRegion==='新北'?'bg-red-600 text-white border-red-600':'bg-white'}" data-region="新北">新北</button>
                                    <button class="region-btn px-3 py-1 rounded border ${selectedRegion==='桃園'?'bg-red-600 text-white border-red-600':'bg-white'}" data-region="桃園">桃園</button>
                                </div>
                                
                            </div>
                            <hr class="border-t border-gray-200 my-2" />
                            <div class="text-sm text-gray-500">總社區數：${filtered.length}</div>
                            <div class="grid grid-cols-5 gap-2">
                                ${filtered.map(c => {
                                    const [line1, line2] = toTwoLines(c.shortName || c.name || c.code || '');
                                    const title = (c.name || '').replace(/"/g,'&quot;');
                                    return `
                                    <button class="enter-community w-full px-3 py-2 rounded-md border bg-white hover:bg-red-50 text-gray-800 font-medium text-sm flex flex-col items-center justify-center text-center" style="aspect-ratio: 1 / 1;" data-id="${c.id}" title="${title}">
                                        <span class="block leading-tight text-center" style="font-size:13px;">${line1 || '&nbsp;'}</span>
                                        <span class="block leading-tight text-center" style="font-size:13px;">${line2 || '&nbsp;'}</span>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>`;
                    container.querySelectorAll('.enter-community').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            enterCommunityMainPage(id);
                        });
                    });
                    container.querySelectorAll('.region-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const r = e.currentTarget.getAttribute('data-region');
                            selectedRegion = (selectedRegion === r) ? null : r;
                            renderList();
                        });
                    });
                    try { lucide.createIcons(); } catch (_) {}
                };
                renderList();
                try { lucide.createIcons(); } catch (_) {}
            }

            function renderNavByName(container) {
                const { collection, getDocs } = window.__fs || {};
                const db = window.__db;
                container.innerHTML = `<div class="p-4"><div class="text-gray-500">載入中...</div></div>`;
                if (!db || !collection || !getDocs) {
                    container.innerHTML = `<div class="p-4 text-red-600">資料庫尚未就緒</div>`;
                    return;
                }
                getDocs(collection(db, 'users')).then((snap) => {
                    const users = [];
                    snap.forEach(d => users.push({ id: d.id, ...d.data() }));

                    // 計算年齡
                    const computeAge = (birth) => {
                        if (!birth) return null;
                        let dt = null;
                        try {
                            if (typeof birth === 'string') {
                                const s = birth.trim();
                                // 支援 YYYY-MM-DD 與 YYYY/MM/DD
                                dt = new Date(s.replace(/\//g, '-'));
                            } else if (birth && typeof birth.seconds === 'number') {
                                dt = new Date(birth.seconds * 1000);
                            } else if (birth instanceof Date) {
                                dt = birth;
                            }
                        } catch (_) { dt = null; }
                        if (!dt || isNaN(dt.getTime())) return null;
                        const today = new Date();
                        let age = today.getFullYear() - dt.getFullYear();
                        const m = today.getMonth() - dt.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < dt.getDate())) age--;
                        return age;
                    };

                    // 僅顯示指定角色：總幹事、秘書、保全、清潔、機電
                    const allowedRoles = new Set(['總幹事','秘書','保全','清潔','機電']);
                    let baseUsers = users.filter(u => allowedRoles.has((u.role || '')));
                    // 人員依姓氏筆畫少→多（先排序再篩選顯示）
                    baseUsers.sort(compareUsersBySurnameStroke);

                    let selectedRole = null; // '總幹事' | '秘書' | '保全' | '清潔' | '機電' | null

                    const renderList = () => {
                        const filtered = selectedRole ? baseUsers.filter(u => (u.role || '') === selectedRole) : baseUsers;
                        container.innerHTML = `
                            <div class="p-4 space-y-3">
                                <div class="flex items-center mb-2">
                                    <div class="flex items-center gap-2 flex-nowrap overflow-x-auto">
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='總幹事'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="總幹事">總幹事</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='秘書'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="秘書">秘書</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='保全'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="保全">保全</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='清潔'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="清潔">清潔</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='機電'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="機電">機電</button>
                                    </div>
                                </div>
                                <hr class="border-t border-gray-200 my-2" />
                                <div class="text-sm text-gray-500">總人員數：${filtered.length}</div>
                                <div class="grid grid-cols-5 gap-2">
                                    ${filtered.map(u => {
                                        const rawName = (u.name || u.displayName || u.email || '(未命名)') + '';
                                        const cleaned = rawName.replace(/\s+/g,'');
                                        const nameLine = cleaned || '(未命名)';
                                        const age = computeAge(u.birth || u.birthday || u.birthDate);
                                        const ageText = (typeof age === 'number' && age >= 0) ? `(${age})` : '';
                                        const ageClass = (typeof age === 'number' && age >= 70) ? 'font-bold text-red-600' : '';
                                        const title = rawName.replace(/"/g,'&quot;');
                                        return `
                                        <button class="view-att w-full px-3 py-2 rounded-md border bg-white hover:bg-blue-50 text-gray-800 font-medium text-sm flex flex-col items-center justify-center text-center" style="aspect-ratio: 1 / 1;" data-id="${u.id}" title="${title}">
                                            <span class="block leading-tight whitespace-nowrap text-center" style="font-size:13px;">${nameLine}</span>
                                            <span class="block leading-tight whitespace-nowrap text-center ${ageClass}" style="font-size:13px;">${ageText || '&nbsp;'}</span>
                                        </button>`;
                                    }).join('')}
                                </div>
                            </div>`;

                        container.querySelectorAll('.view-att').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const id = e.currentTarget.getAttribute('data-id');
                                showPage('tracking', 'attendance', { selectedUserId: id });
                            });
                        });
                        container.querySelectorAll('.role-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const r = e.currentTarget.getAttribute('data-role');
                                selectedRole = (selectedRole === r) ? null : r;
                                renderList();
                            });
                        });
                        try { lucide.createIcons(); } catch (_) {}
                    };

                    renderList();
                }).catch((err) => {
                    console.warn('載入人員失敗', err);
                    container.innerHTML = `<div class="p-4 text-red-600">載入人員失敗</div>`;
                });
            }

            function renderNavSettings(container) {
                // 導覽頁設定：帳號申請、帳號列表、社區列表
                const allowed = ['applications','accounts','community'];
                const sub = allowed.includes(state.navSettingsSubPage) ? state.navSettingsSubPage : 'accounts';
                container.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="applications" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${sub === 'applications' ? 'active' : ''}">帳號申請</button>
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${sub === 'accounts' ? 'active' : ''}">帳號列表</button>
                        <button data-subtab="community" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${sub === 'community' ? 'active' : ''}">社區列表</button>
                    </div>
                    <div id="nav-settings-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                try { lucide.createIcons(); } catch (_) {}

                const contentEl = document.getElementById('nav-settings-content');
                if (sub === 'applications') {
                    renderSettingsApplications(contentEl);
                } else if (sub === 'accounts') {
                    renderSettingsAccounts(contentEl);
                } else {
                    renderSettingsCommunity(contentEl);
                }

                container.querySelectorAll('.sub-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        state.navSettingsSubPage = btn.dataset.subtab;
                        renderNavSettings(container);
                    });
                });
            }

            // --- Page Render Functions ---
            
            function renderDashboard() {
                const role = state.currentUserData?.role || '';
                const isManagerial = role === 'admin' || role === 'manager' || role === 'junior_manager';

                // 依角色切換儀表板內容：
                // 管理員 / 高階主管 / 初階主管：顯示社區列表
                // 總幹事、一般人員（秘書、保全、清潔、機電 等外勤）：顯示我的狀態與通知
                let contentHtml = '';
                if (isManagerial) {
                    contentHtml = `
                        <div id="all-users-summary-card" class="bg-white p-4 rounded-lg mb-4 shadow-sm border cursor-pointer">
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i>所有社區人員狀態</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="flex items-center justify-between p-3 rounded bg-green-50 border border-green-100">
                                    <div class="flex items-center text-green-700 font-semibold"><i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>上班</div>
                                    <div id="count-work" class="text-green-800 font-bold">0</div>
                                </div>
                                <div class="flex items-center justify-between p-3 rounded bg-gray-50 border border-gray-200">
                                    <div class="flex items-center text-gray-700 font-semibold"><i data-lucide="moon" class="w-4 h-4 mr-2"></i>下班</div>
                                    <div id="count-off" class="text-gray-800 font-bold">0</div>
                                </div>
                                <div class="flex items-center justify-between p-3 rounded bg-yellow-50 border border-yellow-200">
                                    <div class="flex items-center text-yellow-700 font-semibold"><i data-lucide="plane" class="w-4 h-4 mr-2"></i>請假</div>
                                    <div id="count-leave" class="text-yellow-800 font-bold">0</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 mt-2">點擊可查看詳細名單</div>
                        </div>
                        <div id="dashboard-notifications" class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                           <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="bell" class="w-4 h-4 mr-2"></i>通知</h3>
                           <div id="dashboard-duty-list" class="space-y-2 text-gray-700">
                             <div class="text-gray-500">讀取中...</div>
                           </div>
                           <div class="mt-2 border-t border-gray-100"></div>
                           <div id="dashboard-anomalies-list" class="space-y-2 text-gray-700 mt-2">
                             <div class="text-gray-500">讀取中...</div>
                           </div>
                        </div>`;
                } else {
                    contentHtml = `
                        <div class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                            <h3 class="font-bold text-red-800 mb-2 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i>我的狀態</h3>
                            <div id="my-status" class="text-gray-600">讀取中...</div>
                        </div>
                        <div id="dashboard-notifications" class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                           <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="bell" class="w-4 h-4 mr-2"></i>通知</h3>
                           <div id="dashboard-duty-list" class="space-y-2 text-gray-700">
                             <div class="text-gray-500">讀取中...</div>
                           </div>
                           <div class="mt-2 border-t border-gray-100"></div>
                           <div id="dashboard-anomalies-list" class="space-y-2 text-gray-700 mt-2">
                             <div class="text-gray-500">讀取中...</div>
                           </div>
                        </div>`;
                }

                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-center border-b border-gray-200 bg-white">
                         <p id="current-time" class="text-lg font-semibold text-gray-700"></p>
                    </div>
                    <div class="p-4 overflow-y-auto" style="height: calc(100% - 50px);">${contentHtml}</div>
                `;
                lucide.createIcons();
                // 初始更新「我的狀態」以確保立即顯示（僅非管理視圖）
                try {
                    if (!isManagerial && typeof updateDashboardStatus === 'function') {
                        updateDashboardStatus();
                    }
                } catch (e) { console.warn('updateDashboardStatus 初始執行失敗', e); }
                const timeEl = document.getElementById('current-time');
                const timerInterval = setInterval(() => {
                    if(timeEl){ timeEl.textContent = new Date().toLocaleString('zh-TW', { dateStyle: 'long', timeStyle: 'medium', hour12: false }); }
                }, 1000);
                state.activeListeners.push(() => clearInterval(timerInterval));
                
                // 管理階層：渲染異常通知（社區列表顯示已移除）
                if (isManagerial) {
                    try { renderManagerAnomalies(); } catch (e) { console.warn('渲染異常通知失敗', e); }
                }
                
                // 檢查是否顯示員工狀態
                // 定義默認設置
                const defaultSettings = {
                    showEmployeeStatus: true
                };
                
                // 嘗試從本地存儲獲取設置
                let localSettings;
                try {
                    const savedSettings = localStorage.getItem('app_general_settings');
                    localSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
                } catch (e) {
                    console.warn("Could not load settings from local storage:", e);
                    localSettings = defaultSettings;
                }
                
                // 應用本地設置（僅當存在「所有同仁狀態」卡片時）
                if (localSettings.showEmployeeStatus === false) {
                    const container = document.getElementById('all-users-summary-card');
                    if (container) container.style.display = 'none';
                }
                
                // 嘗試從Firebase獲取最新設置，但不阻塞UI
                try {
                    const settingsRef = doc(db, "settings", "general");
                    getDoc(settingsRef).then((docSnap) => {
                        if (docSnap.exists()) {
                            const settings = docSnap.data();
                            // 保存到本地存儲以供將來使用
                            localStorage.setItem('app_general_settings', JSON.stringify(settings));
                            
                            // 如果設置與本地不同，立即應用
                            if (settings.showEmployeeStatus !== localSettings.showEmployeeStatus) {
                                const container = document.getElementById('all-users-summary-card');
                                if (container) {
                                    container.style.display = settings.showEmployeeStatus ? 'block' : 'none';
                                }
                            }
                    }
                }).catch(error => {
                    console.warn("Could not fetch latest settings, using local settings instead:", error);
                });
            } catch (error) {
                console.warn("Error in settings fetch attempt:", error);
            }

            // 儀表板：社區列表載入（僅管理員/主管顯示）
            function loadDashboardCommunityList() {
                try {
                    const fs = window.__fs || {};
                    const db = window.__db;
                    const listEl = document.getElementById('dashboard-community-list');
                    if (!db || !listEl) return;
                    const { collection, query, orderBy, getDocs } = fs;
                    const communitiesRef = collection(db, 'communities');
                    let q;
                    try {
                        q = query(communitiesRef, orderBy('name'));
                    } catch (_) {
                        q = communitiesRef;
                    }
                    getDocs(q).then((snap) => {
                        listEl.innerHTML = '';
                        if (snap.empty) {
                            listEl.innerHTML = '<div class="text-gray-500">暫無社區資料</div>';
                            return;
                        }
                        const isAdmin = state.currentUserData?.role === 'admin';
                        snap.forEach(docSnap => {
                            const c = docSnap.data();
                            const lat = c.location?.latitude;
                            const lng = c.location?.longitude;
                            const region = c.region || '';
                            const code = c.code || '';
                            const row = document.createElement('div');
                            row.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                            row.innerHTML = `
                                <div>
                                    <p class="font-medium text-gray-800">
                                        ${region ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-700 mr-2\">${region}</span>` : ''}
                                        ${code ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700 mr-2\">${code}</span>` : ''}
                                        ${c.name || '(未命名)'}
                                    </p>
                                    <p class="text-sm text-gray-500">${c.address || ''}</p>
                                    <p class="text-xs text-gray-400">${(Number.isFinite(lat) && Number.isFinite(lng)) ? `(${lat.toFixed ? lat.toFixed(6) : lat}, ${lng.toFixed ? lng.toFixed(6) : lng})` : '未設定座標'}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${(Number.isFinite(lat) && Number.isFinite(lng)) ? `<button class="view-map-btn px-2 py-1 text-gray-600 hover:text-red-600" data-lat="${lat}" data-lng="${lng}"><i data-lucide="map-pin" class="w-4 h-4"></i></button>` : ''}
                                    ${isAdmin ? `<button class="delete-community-btn px-2 py-1 text-gray-600 hover:text-red-600" data-id="${docSnap.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                                </div>`;
                            listEl.appendChild(row);
                        });
                        lucide.createIcons();
                        listEl.querySelectorAll('.view-map-btn').forEach(btn => btn.addEventListener('click', (e) => {
                            const lat = parseFloat(e.currentTarget.dataset.lat);
                            const lng = parseFloat(e.currentTarget.dataset.lng);
                            if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
                            openMapModal(lat, lng);
                        }));
                        listEl.querySelectorAll('.delete-community-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (!id) return;
                            const ok = confirm('確定要刪除此社區？此操作不可逆。');
                            if (!ok) return;
                            try {
                                const { doc, deleteDoc } = window.__fs; const db = window.__db;
                                await deleteDoc(doc(db, 'communities', id));
                                e.currentTarget.closest('.flex.items-center.justify-between')?.remove();
                                try { if (state.communitiesById) { delete state.communitiesById[id]; } } catch (_) {}
                                showToast('已刪除社區');
                            } catch (err) {
                                console.error('刪除社區失敗', err);
                                showToast('刪除社區失敗', true);
                            }
                        }));
                    }).catch((err) => {
                        console.error('讀取社區列表失敗', err);
                        listEl.innerHTML = '<div class="text-red-500">讀取社區列表失敗</div>';
                    });
                } catch (e) {
                    console.warn('初始化社區列表失敗', e);
                }
            }

            // 管理者異常通知（未打卡、定位異常、提早下班）
            async function renderManagerAnomalies() {
                try {
                    const listEl = document.getElementById('dashboard-anomalies-list');
                    if (!listEl) return;
                    const fs = window.__fs || {}; const db = window.__db;
                    const { collection, getDocs, query, where, orderBy, Timestamp } = fs;
                    // 取得所有使用者（套用可見性設定）
                    const usersSnap = await getDocs(collection(db, 'users'));
                    let users = [];
                    usersSnap.forEach(d => users.push({ id: d.id, ...d.data() }));
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) { visibleUsers = JSON.parse(savedSettings).visibleUsers || {}; }
                    } catch (_) {}
                    users = users.filter(u => visibleUsers[u.id] !== false);

                    // 依當前社區過濾（若有）
                    const currentCode = state.currentCommunity?.code || state.currentCommunity?.id || null;
                    if (currentCode) {
                        users = users.filter(u => Array.isArray(u.serviceCommunities) ? u.serviceCommunities.includes(currentCode) : (u.serviceCommunityCode === currentCode));
                    }

                    // 今日範圍
                    const now = new Date();
                    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                    const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;

                    // 取全日打卡紀錄（前端過濾所屬使用者）
                    const recSnap = await getDocs(query(collection(db, 'clockInRecords'), where('timestamp', '>=', tsStart), where('timestamp', '<=', tsEnd)));
                    const records = [];
                    recSnap.forEach(d => records.push({ id: d.id, ...d.data() }));

                    const byUser = {};
                    users.forEach(u => { byUser[u.id] = []; });
                    records.forEach(r => { if (byUser[r.userId]) byUser[r.userId].push(r); });
                    Object.keys(byUser).forEach(uid => {
                        byUser[uid].sort((a,b)=>{
                            const ta = a.timestamp?.toDate?.() ? a.timestamp.toDate() : (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() ? b.timestamp.toDate() : (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return ta - tb;
                        });
                    });

                    // 讀取今日預期上下班時間（全域+個人覆蓋）
                    const ymKey = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
                    const { doc, getDoc } = fs;
                    let daysMap = {};
                    try {
                        const sSnap = await getDoc(doc(db, 'settings', `workdays_${ymKey}`));
                        if (sSnap.exists()) { const sd = sSnap.data(); daysMap = sd?.days || {}; }
                    } catch (_) {}
                    // 簡化：個人覆蓋僅在有資料時讀取
                    await Promise.all(users.map(async (u) => {
                        try {
                            const uSnap = await getDoc(doc(db, 'users', u.id, 'workdays', ymKey));
                            if (uSnap.exists()) {
                                const ud = uSnap.data();
                                daysMap = { ...daysMap, ...(ud?.days || {}) };
                            }
                        } catch (_) {}
                    }));

                    const holidays = window.__holidaySettingsCache || { weekendIsHoliday: false, holidays: [] };
                    const holidaysSet = new Set(holidays.holidays || []);
                    const isHoliday = (date) => {
                        const ymd = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                        const weekend = date.getDay() === 0 || date.getDay() === 6;
                        return holidaysSet.has(ymd) || (holidays.weekendIsHoliday && weekend);
                    };

                    const ymdToday = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;
                    const expectedEndTimeOf = (u) => {
                        const d = daysMap[ymdToday] || {};
                        return d.end || (!isHoliday(start) && (start.getDay()>=1 && start.getDay()<=5) ? '17:30' : '');
                    };
                    const expectedStartTimeOf = (u) => {
                        const d = daysMap[ymdToday] || {};
                        return d.start || (!isHoliday(start) && (start.getDay()>=1 && start.getDay()<=5) ? '09:00' : '');
                    };

                    const anomalies = [];
                    users.forEach(u => {
                        const recs = byUser[u.id] || [];
                        // 未打卡（有預期上班時間且當日無任何紀錄）
                        const expStart = expectedStartTimeOf(u);
                        if (expStart && recs.length === 0) {
                            anomalies.push({ type: '未打卡', user: u, detail: '今日尚未有任何打卡紀錄' });
                        }
                        // 位置異常（任何紀錄標記異常）
                        for (const r of recs) {
                            const abnormal = computeRecordAbnormal(r, Array.isArray(u.serviceCommunities) ? u.serviceCommunities : (u.serviceCommunityCode ? [u.serviceCommunityCode] : []));
                            if (abnormal && abnormal.isAbnormal) {
                                anomalies.push({ type: '打卡定位異常', user: u, detail: abnormal.detail || '' });
                                break;
                            }
                        }
                        // 提早下班（最後一筆為下班且早於預期）
                        const last = recs[recs.length-1] || null;
                        const expEnd = expectedEndTimeOf(u);
                        if (last && (last.type === '下班' || last.type === '自動下班') && expEnd) {
                            const ts = last.timestamp?.toDate?.() ? last.timestamp.toDate() : (last.timestamp ? new Date(last.timestamp) : null);
                            if (ts) {
                                const [eh, em] = expEnd.split(':').map(x=>parseInt(x,10));
                                const endDt = new Date(start.getFullYear(), start.getMonth(), start.getDate(), eh||17, em||30, 0, 0);
                                if (ts < endDt) {
                                    anomalies.push({ type: '提早下班打卡', user: u, detail: `下班時間 ${ts.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false})}，早於預期 ${expEnd}` });
                                }
                            }
                        }
                    });

                    // 顯示通知
                    let html = '';
                    anomalies.forEach(a => {
                        const name = a.user.name || a.user.displayName || '未命名';
                        const icon = a.type === '未打卡' ? 'alert-triangle' : (a.type === '打卡定位異常' ? 'map-pin' : 'log-out');
                        const color = a.type === '未打卡' ? 'text-red-700' : (a.type === '打卡定位異常' ? 'text-yellow-700' : 'text-orange-700');
                        const bg = a.type === '未打卡' ? 'bg-red-50 border-red-200' : (a.type === '打卡定位異常' ? 'bg-yellow-50 border-yellow-200' : 'bg-orange-50 border-orange-200');
                        html += `
                            <div class="p-3 ${bg} border rounded-md">
                                <div class="flex items-center">
                                    <i data-lucide="${icon}" class="w-4 h-4 mr-2 ${color}"></i>
                                    <span class="font-medium text-gray-800">${a.type}</span>
                                </div>
                                <div class="mt-1 text-sm text-gray-700">${name}</div>
                                ${a.detail ? `<div class="mt-1 text-xs text-gray-500">${a.detail}</div>` : ''}
                            </div>`;
                    });
                    listEl.innerHTML = html || '<div class="text-gray-500">暫無異常通知</div>';
                    try { lucide.createIcons(); } catch (_) {}
                } catch (e) {
                    console.warn('載入管理者異常通知失敗', e);
                }
            }

            // 點擊摘要卡開啟所有同仁狀態彈窗
            const summaryCard = document.getElementById('all-users-summary-card');
            if (summaryCard) {
                summaryCard.addEventListener('click', () => {
                    openAllUsersStatusModal();
                });
            }
            
            // 儀錶板通知（週五值班提醒）
            (async () => {
                try {
                    const fs = window.__fs || {};
                    const db = window.__db;
                    const user = window.__auth?.currentUser;
                    const listEl = document.getElementById('dashboard-duty-list');
                    if (!db || !user || !listEl) return;

                    const { doc, getDoc, collection, query, where, onSnapshot, Timestamp } = fs;

                    function formatYMD(date) {
                        const y = date.getFullYear();
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        const d = String(date.getDate()).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    }

                    function getWeekFriday(date) {
                        const d = new Date(date);
                        const day = d.getDay();
                        // 調整到本週的星期一
                        const diffToMonday = day === 0 ? -6 : (1 - day);
                        const monday = new Date(d);
                        monday.setDate(d.getDate() + diffToMonday);
                        const friday = new Date(monday);
                        friday.setDate(monday.getDate() + 4);
                        return friday;
                    }

                    async function renderDutyReminder() {
                        const now = new Date();
                        const day = now.getDay(); // 1=Mon, 5=Fri
                        const friday = getWeekFriday(now);
                        const isoFriday = formatYMD(friday);

                        const settingsRef = doc(db, 'settings', 'general');
                        const s = await getDoc(settingsRef);
                        const roster = s.exists() ? (s.data().fridayDutyRoster || {}) : {};
                        const names = roster[isoFriday] || [];

                        const clearedKey = `dutyReminderCleared-${isoFriday}-${user.uid}`;
                        const cleared = localStorage.getItem(clearedKey) === '1';

                        const shouldShow = (day === 1 && names.length > 0) || (day === 5 && names.length > 0 && !cleared);
                        if (shouldShow) {
                            // 建立或更新週五值班提醒卡片
                            let card = document.getElementById('duty-reminder-card');
                            const html = `
                                <div id="duty-reminder-card" class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                  <div class="flex items-center justify-between">
                                    <div class="flex items-center"><i data-lucide="alert-circle" class="w-4 h-4 mr-2 text-yellow-600"></i><span class="font-medium text-yellow-800">本週五值班</span></div>
                                    <button id="view-calendar" class="text-blue-600 hover:underline text-sm">查看月曆</button>
                                  </div>
                                  <div class="mt-2 text-sm text-gray-700">值班人員：${names.join('、')}</div>
                                  <div class="mt-1 text-xs text-gray-500">星期五（${isoFriday}）值班提醒</div>
                                </div>`;
                            if (card) {
                                card.outerHTML = html;
                                card = document.getElementById('duty-reminder-card');
                            } else {
                                listEl.insertAdjacentHTML('afterbegin', html);
                                card = document.getElementById('duty-reminder-card');
                            }
                            const btn = document.getElementById('view-calendar');
                            btn?.addEventListener('click', () => showPage('calendar', 'overview'));
                            lucide.createIcons();
                        } else {
                            // 移除值班提醒卡片，不影響其他通知
                            const card = document.getElementById('duty-reminder-card');
                            if (card) card.remove();
                            if (!listEl.children.length) {
                                listEl.innerHTML = '<div class="text-gray-500">暫無提醒</div>';
                            }
                        }

                        // 週五當天監聽打卡紀錄以清除提醒
                        if (day === 5 && names.length > 0 && !cleared) {
                            const start = new Date(friday.getFullYear(), friday.getMonth(), friday.getDate());
                            const end = new Date(friday.getFullYear(), friday.getMonth(), friday.getDate(), 23, 59, 59, 999);
                            const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                            const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                            const q = query(
                                collection(db, 'clockInRecords'),
                                where('userId', '==', user.uid),
                                where('timestamp', '>=', tsStart),
                                where('timestamp', '<=', tsEnd)
                            );
                            const unsubDuty = onSnapshot(q, (snap) => {
                                let clearedNow = false;
                                snap.forEach(d => {
                                    const r = d.data();
                                    if (r.type === '下班' || r.type === '自動下班') {
                                        clearedNow = true;
                                    }
                                });
                                if (clearedNow) {
                                    localStorage.setItem(clearedKey, '1');
                                    const card = document.getElementById('duty-reminder-card');
                                    if (card) card.remove();
                                    if (!listEl.children.length) {
                                        listEl.innerHTML = '<div class="text-gray-500">暫無提醒</div>';
                                    }
                                }
                            });
                            state.activeListeners.push(unsubDuty);
                        }
                    }

                    async function renderWorkdayClockCard() {
                        try {
                            const fs = window.__fs || {};
                            const db = window.__db;
                            const user = window.__auth?.currentUser;
                            const listEl = document.getElementById('dashboard-duty-list');
                            if (!db || !user || !listEl) return;

                            const { doc, getDoc, collection, query, where, orderBy, getDocs, Timestamp } = fs;
                            
                            const formatYMD = (date) => {
                                const y = date.getFullYear();
                                const m = String(date.getMonth() + 1).padStart(2, '0');
                                const d = String(date.getDate()).padStart(2, '0');
                                return `${y}-${m}-${d}`;
                            };

                            const holidays = window.__holidaySettingsCache || { weekendIsHoliday: false, holidays: [] };
                            const holidaysSet = new Set(holidays.holidays || []);
                            const isHoliday = (date) => {
                                const ymd = formatYMD(date);
                                const weekend = date.getDay() === 0 || date.getDay() === 6;
                                return holidaysSet.has(ymd) || (holidays.weekendIsHoliday && weekend);
                            };

                            const getDaysMap = async (year, monthIdx) => {
                                const ymKey = `${year}-${String(monthIdx + 1).padStart(2, '0')}`;
                                let daysMap = {};
                                try {
                                    const sSnap = await getDoc(doc(db, 'settings', `workdays_${ymKey}`));
                                    if (sSnap.exists()) { const sd = sSnap.data(); daysMap = sd?.days || {}; }
                                } catch (_) {}
                                try {
                                    const uSnap = await getDoc(doc(db, 'users', user.uid, 'workdays', ymKey));
                                    if (uSnap.exists()) { const ud = uSnap.data(); daysMap = { ...daysMap, ...(ud?.days || {}) }; }
                                } catch (_) {}
                                return daysMap;
                            };

                            const now = new Date();
                            const daysMapNow = await getDaysMap(now.getFullYear(), now.getMonth());
                            const ymdToday = formatYMD(now);
                            const todayCfg = daysMapNow[ymdToday] || {};
                            const todayStartExp = todayCfg.start || (!isHoliday(now) && (now.getDay()>=1 && now.getDay()<=5) ? '09:00' : '');
                            
                            let actualStart = null;
                            if (todayStartExp) {
                                const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                                const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                                const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                                let q;
                                try {
                                    q = query(collection(db, 'clockInRecords'), where('userId', '==', user.uid), where('timestamp', '>=', tsStart), where('timestamp', '<=', tsEnd), orderBy('timestamp', 'asc'));
                                } catch (_) {
                                    q = query(collection(db, 'clockInRecords'), where('userId', '==', user.uid), where('timestamp', '>=', tsStart), where('timestamp', '<=', tsEnd));
                                }
                                const snap = await getDocs(q);
                                const recs = [];
                                snap.forEach(d => recs.push(d.data()));
                                const startRec = recs.find(r => r.type === '上班') || recs.find(r => r.type === '外出');
                                if (startRec && startRec.timestamp) {
                                    actualStart = startRec.timestamp?.toDate?.() ? startRec.timestamp.toDate() : new Date(startRec.timestamp);
                                }
                            }

                            let nextDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                            let nextStartExp = '';
                            for (let i = 0; i < 30; i++) {
                                const map = await getDaysMap(nextDate.getFullYear(), nextDate.getMonth());
                                const cfg = map[formatYMD(nextDate)] || {};
                                const wk = nextDate.getDay();
                                const defaultStart = (!isHoliday(nextDate) && wk>=1 && wk<=5) ? '09:00' : '';
                                const st = cfg.start || defaultStart;
                                if (st) { nextStartExp = st; break; }
                                nextDate.setDate(nextDate.getDate() + 1);
                            }

                            const line1 = todayStartExp ? (actualStart ? `今天：${actualStart.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false})}（已打卡）` : `今天：${todayStartExp}（預期）`) : '今天：非工作日';
                            const line2 = nextStartExp ? `下一工作日（${String(nextDate.getMonth()+1).padStart(2,'0')}/${String(nextDate.getDate()).padStart(2,'0')}）：${nextStartExp}` : '下一工作日：未設定';

                            const html = `
                                <div id="workday-clock-card" class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                                  <div class="flex items-center"><i data-lucide="clock" class="w-4 h-4 mr-2 text-blue-600"></i><span class="font-medium text-blue-800">上班打卡時刻</span></div>
                                  <div class="mt-1 text-sm text-gray-700">${line1}</div>
                                  <div class="mt-1 text-sm text-gray-700">${line2}</div>
                                </div>`;
                            const existing = document.getElementById('workday-clock-card');
                            if (existing) existing.outerHTML = html;
                            else listEl.insertAdjacentHTML('afterbegin', html);
                            try { lucide.createIcons(); } catch (_) {}
                        } catch (e) {
                            console.warn('渲染打卡時刻通知失敗', e);
                        }
                    }

                    renderWorkdayClockCard();
                    renderDutyReminder();
                } catch (e) {
                    console.warn('初始化儀錶板通知失敗', e);
                }
            })();
                
                const usersRef = collection(db, "users");
                const unsubscribe = onSnapshot(query(usersRef), (querySnapshot) => {
                    const countWorkEl = document.getElementById('count-work');
                    const countOutboundEl = document.getElementById('count-outbound');
                    const countOffEl = document.getElementById('count-off');
                    const countLeaveEl = document.getElementById('count-leave');
                    let myStatusFound = false;
                    const users = [];
                    querySnapshot.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                    
                    // 獲取設定中的可見使用者設定
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn("Could not load user visibility settings:", e);
                    }
                    
                    // 過濾掉不顯示的使用者
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    // 進一步過濾：僅顯示服務「目前社區」的外勤相關角色（總幹事、秘書、保全、清潔、機電）
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || null;
                    const filteredUsersList = visibleUsersList.filter(u => {
                        // 角色過濾（排除管理員、人事、主管）
                        if (!isFieldLikeRole(u.role)) return false;
                        // 社區服務過濾（支援以 id 或 code 表示的欄位）
                        const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                        const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                        const codeSingle = u.serviceCommunityCode || null;
                        const matchById = currentCommId ? ids.includes(currentCommId) : false;
                        const matchByCode = currentCommCode ? (codesArr.includes(currentCommCode) || codeSingle === currentCommCode) : false;
                        return matchById || matchByCode;
                    });
                    
                    // 狀態優先級（自訂）：
                    // 1) 上班中-辦公室 2) 返回-辦公室 3) 外出-項目-地點 4) 抵達-項目-地點
                    // 5) 離開-項目-地點 6) 請假中 7) 已下班 其餘置後
                    const statusPriority = (user) => {
                        const locationText = user.clockInStatus === '外出' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null);
                        const display = getStatusDisplayText(user.clockInStatus || '未打卡', locationText, user.dutyType);
                        // 請假中：臨時請假或當天有效的請假申請
                        let isLeave = (user.clockInStatus === '臨時請假') || (display.includes('請假'));
                        if (!isLeave) {
                            const leave = user.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (user.leaveStartTime && user.leaveEndTime) {
                                    const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                    const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }

                        if (display.includes('上班') && (display.includes('辦公室') || display.includes('在辦公室'))) return 1;
                        if (display.includes('返回') && (display.includes('辦公室') || display.includes('在辦公室'))) return 2;
                        if (display.startsWith('外出-')) return 3;
                        if (display.startsWith('抵達-')) return 4;
                        if (display.startsWith('離開-')) return 5;
                        if (isLeave) return 6;
                        if (display.includes('下班')) return 7;
                        return 8;
                    };

                    filteredUsersList.sort((a, b) => {
                        const prA = statusPriority(a);
                        const prB = statusPriority(b);
                        if (prA !== prB) return prA - prB;
                        // 同優先級用最近更新時間（lastUpdated）新到舊
                        const tA = a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0);
                        const tB = b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0);
                        if (tA.getTime() !== tB.getTime()) return tB - tA;
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    }).forEach(user => {
                            const locationText = user.clockInStatus === '外出' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null);
                            const statusText = getStatusDisplayText(user.clockInStatus || '未打卡', locationText, user.dutyType);
                            const statusColor = getStatusColor(statusText);
                        if (user.id === state.currentUser.uid) {
                            myStatusFound = true;
                            (async () => {
                                try {
                                    const myStatusEl = document.getElementById('my-status');
                                    if (!myStatusEl) return; // 若未渲染「我的狀態」，則略過更新
                                    const recordsRef = collection(db, 'clockInRecords');
                                    const q = query(recordsRef, where('userId', '==', state.currentUser.uid), orderBy('timestamp', 'desc'), limit(1));
                                    const snap = await getDocs(q);
                                    let innerHTML = '';
                                    if (!snap.empty) {
                                        const r = snap.docs[0].data();
                                        const statusTextLast = getStatusDisplayText(r.type || '未知', r.locationName || null, r.dutyType || null);
                                        const statusColorLast = getStatusColor(statusTextLast);
                                        const ts = r.timestamp && r.timestamp.toDate ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                                        innerHTML = `
                                          <div class="flex items-center justify-between">
                                            <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                          </div>
                                          <div class="text-sm text-gray-500 mt-1">
                                            ${ts ? '打卡 ' + ts.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false}) : ''}
                                          </div>`;
                                    } else {
                                        const statusTextLast = '尚未打卡';
                                        const statusColorLast = getStatusColor(statusTextLast);
                                        innerHTML = `
                                          <div class="flex items-center justify-between">
                                            <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                          </div>`;
                                    }
                                    myStatusEl.innerHTML = innerHTML;
                                } catch (err) {
                                    console.error('讀取最新打卡紀錄失敗', err);
                                }
                            })();
                        }
                    });

                   // 計算摘要人數
                   let countWork = 0, countOutbound = 0, countOff = 0, countLeave = 0;
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                   filteredUsersList.forEach(user => {
                       const s = user.clockInStatus || '';
                       const leave = user.leaveStatus || '';
                       if (s === '上班' || s === '返回') countWork++;
                       // 排除外出/抵達/離開於摘要顯示
                       else if (s === '下班' || s === '已下班-未打卡') countOff++;
                        
                        // 檢查請假狀態：臨時請假或當天有效的請假申請
                        let isLeave = s === '臨時請假';
                        if (!isLeave && (leave === 'approved' || leave === 'pending')) {
                            // 檢查是否有當天有效的請假記錄
                            if (user.leaveStartTime && user.leaveEndTime) {
                                const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                            }
                        }
                       if (isLeave) countLeave++;
                   });
                    if (countWorkEl) countWorkEl.textContent = countWork;
                    if (countOutboundEl) countOutboundEl.textContent = countOutbound;
                    if (countOffEl) countOffEl.textContent = countOff;
                    if (countLeaveEl) countLeaveEl.textContent = countLeave;
                    if(!myStatusFound && document.getElementById('my-status')){ document.getElementById('my-status').textContent = '無法取得您的狀態'; }
                
                });
                state.activeListeners.push(unsubscribe);
            }

            // 所有同仁狀態彈窗
            function openAllUsersStatusModal() {
                // 背景
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                backdrop.id = 'all-users-modal-backdrop';
                // 容器
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
                modal.id = 'all-users-modal';
                const box = document.createElement('div');
                box.className = 'bg-white rounded-lg shadow-lg w-11/12 max-w-2xl p-4 border';
                box.innerHTML = `
                    <div class=\"flex items-center justify-between mb-2\">
                        <h3 class=\"font-bold text-lg flex items-center\"><i data-lucide=\"users\" class=\"w-5 h-5 mr-2\"></i>所有同仁狀態</h3>
                        <button id=\"close-all-users-modal\" class=\"text-gray-600 hover:text-gray-800\"><i data-lucide=\"x\" class=\"w-5 h-5\"></i></button>
                    </div>
                    <div id=\"all-users-modal-list\" class=\"space-y-2 max-h-[60vh] overflow-y-auto\">
                        <div class=\"text-center p-4 text-gray-500\">讀取中...</div>
                    </div>
                `;
                modal.appendChild(box);
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);
                lucide.createIcons();
                
                const usersRef = collection(db, 'users');
                const unsub = onSnapshot(query(usersRef), (querySnapshot) => {
                    const listEl = document.getElementById('all-users-modal-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                    
                    // 顯示設定過濾
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn('Could not load user visibility settings:', e);
                    }
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    
                    // 進一步過濾：僅顯示服務「目前社區」的外勤相關角色（總幹事、秘書、保全、清潔、機電）
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || null;
                    const filteredByRoleAndCommunity = visibleUsersList.filter(u => {
                        if (!isFieldLikeRole(u.role)) return false;
                        const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                        const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                        const codeSingle = u.serviceCommunityCode || null;
                        const matchById = currentCommId ? ids.includes(currentCommId) : false;
                        const matchByCode = currentCommCode ? (codesArr.includes(currentCommCode) || codeSingle === currentCommCode) : false;
                        return matchById || matchByCode;
                    });
                    
                    // 排序：自訂狀態優先級 + 最近更新時間（新至舊） + 姓名
                    const statusPriority = (user) => {
                        const locationText = user.clockInStatus === '外出' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null);
                        const display = getStatusDisplayText(user.clockInStatus || '未打卡', locationText, user.dutyType);
                        let isLeave = (user.clockInStatus === '臨時請假') || (display.includes('請假'));
                        if (!isLeave) {
                            const leave = user.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (user.leaveStartTime && user.leaveEndTime) {
                                    const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                    const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }

                        if (display.includes('上班') && (display.includes('辦公室') || display.includes('在辦公室'))) return 1;
                        if (display.includes('返回') && (display.includes('辦公室') || display.includes('在辦公室'))) return 2;
                        if (display.startsWith('外出-')) return 3;
                        if (display.startsWith('抵達-')) return 4;
                        if (display.startsWith('離開-')) return 5;
                        if (isLeave) return 6;
                        if (display.includes('下班')) return 7;
                        return 8;
                    };

                    (async () => {
                        const latestMap = {};
                        try {
                            await Promise.all(filteredByRoleAndCommunity.map(async (u) => {
                                try {
                                    const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                    const latestSnap = await getDocs(qLatest);
                                    if (!latestSnap.empty) {
                                        // 儲存整筆最新紀錄資料以便取得 type/locationName/dutyType/timestamp
                                        latestMap[u.id] = latestSnap.docs[0].data();
                                    } else {
                                        latestMap[u.id] = null;
                                    }
                                } catch (e) {
                                    console.warn('載入使用者最新打卡失敗:', e);
                                    latestMap[u.id] = null;
                                }
                            }));
                        } catch (e) {
                            console.warn('建立最新打卡時間對應表失敗:', e);
                        }

                    // 狀態過濾：僅保留上班、下班、請假（排除外出/抵達/離開）
                    const filteredByStatus = filteredByRoleAndCommunity.filter(u => {
                        const latest = latestMap[u.id] || null;
                        const locText = latest?.locationName || (u.clockInStatus === '外出' && u.outboundLocation ? u.outboundLocation : (u.lastLocation?.address || null));
                        const display = latest ? getStatusDisplayText(latest.type || '未知', latest.locationName || null, latest.dutyType || null)
                                              : getStatusDisplayText(u.clockInStatus || '未打卡', locText, u.dutyType);
                        // 請假判定
                        let isLeave = (u.clockInStatus === '臨時請假') || display.includes('請假');
                        if (!isLeave) {
                            const leave = u.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (u.leaveStartTime && u.leaveEndTime) {
                                    const leaveStart = u.leaveStartTime.toDate ? u.leaveStartTime.toDate() : new Date(u.leaveStartTime);
                                    const leaveEnd = u.leaveEndTime.toDate ? u.leaveEndTime.toDate() : new Date(u.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }
                        if (isLeave) return true;
                        if (display.includes('下班') || (u.clockInStatus === '下班')) return true;
                        if (display.includes('上班') || (u.clockInStatus === '返回')) return true;
                        return false;
                    });

                    filteredByStatus.sort((a, b) => {
                            const latestA = latestMap[a.id] || null;
                            const latestB = latestMap[b.id] || null;
                            const locA = latestA?.locationName || (a.clockInStatus === '外出' && a.outboundLocation ? a.outboundLocation : (a.lastLocation?.address || null));
                            const locB = latestB?.locationName || (b.clockInStatus === '外出' && b.outboundLocation ? b.outboundLocation : (b.lastLocation?.address || null));
                            const displayA = latestA ? getStatusDisplayText(latestA.type || '未知', latestA.locationName || null, latestA.dutyType || null)
                                                     : getStatusDisplayText(a.clockInStatus || '未打卡', locA, a.dutyType);
                            const displayB = latestB ? getStatusDisplayText(latestB.type || '未知', latestB.locationName || null, latestB.dutyType || null)
                                                     : getStatusDisplayText(b.clockInStatus || '未打卡', locB, b.dutyType);

                            // 判斷請假（臨時請假或當天有效申請）
                            let isLeaveA = (a.clockInStatus === '臨時請假') || (displayA.includes('請假'));
                            if (!isLeaveA) {
                                const leaveA = a.leaveStatus || '';
                                if (leaveA === 'approved' || leaveA === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (a.leaveStartTime && a.leaveEndTime) {
                                        const leaveStartA = a.leaveStartTime.toDate ? a.leaveStartTime.toDate() : new Date(a.leaveStartTime);
                                        const leaveEndA = a.leaveEndTime.toDate ? a.leaveEndTime.toDate() : new Date(a.leaveEndTime);
                                        isLeaveA = leaveStartA <= todayEnd && leaveEndA >= todayStart;
                                    }
                                }
                            }
                            let isLeaveB = (b.clockInStatus === '臨時請假') || (displayB.includes('請假'));
                            if (!isLeaveB) {
                                const leaveB = b.leaveStatus || '';
                                if (leaveB === 'approved' || leaveB === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (b.leaveStartTime && b.leaveEndTime) {
                                        const leaveStartB = b.leaveStartTime.toDate ? b.leaveStartTime.toDate() : new Date(b.leaveStartTime);
                                        const leaveEndB = b.leaveEndTime.toDate ? b.leaveEndTime.toDate() : new Date(b.leaveEndTime);
                                        isLeaveB = leaveStartB <= todayEnd && leaveEndB >= todayStart;
                                    }
                                }
                            }

                            const prioOf = (display, isLeave) => {
                                if (display.includes('上班') && (display.includes('辦公室') || display.includes('在辦公室'))) return 1;
                                if (display.includes('返回') && (display.includes('辦公室') || display.includes('在辦公室'))) return 2;
                                if (display.startsWith('外出-')) return 3;
                                if (display.startsWith('抵達-')) return 4;
                                if (display.startsWith('離開-')) return 5;
                                if (isLeave) return 6;
                                if (display.includes('下班')) return 7;
                                return 8;
                            };

                            const prA = prioOf(displayA, isLeaveA);
                            const prB = prioOf(displayB, isLeaveB);
                            if (prA !== prB) return prA - prB;

                            const tA = latestA?.timestamp?.toDate?.() ? latestA.timestamp.toDate()
                                      : (a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0));
                            const tB = latestB?.timestamp?.toDate?.() ? latestB.timestamp.toDate()
                                      : (b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0));
                            if (tA.getTime() !== tB.getTime()) return tB - tA;
                            return a.name.localeCompare(b.name, 'zh-Hant');
                        }).forEach(user => {
                            const latest = latestMap[user.id] || null;
                            const locText = latest?.locationName || (user.clockInStatus === '外出' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null));
                            const statusText = latest ? getStatusDisplayText(latest.type || '未知', latest.locationName || null, latest.dutyType || null)
                                                      : getStatusDisplayText(user.clockInStatus || '未打卡', locText, user.dutyType);
                            const statusColor = getStatusColor(statusText);
                            const clockInTime = latest?.timestamp?.toDate?.() ? latest.timestamp.toDate() : (latest?.timestamp ? new Date(latest.timestamp) : null);
                            const timeFormatted = clockInTime ? clockInTime.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false}) : 'N/A';
                            listEl.innerHTML += `
                                <div class=\"flex items-center justify-between bg-white p-3 rounded-md shadow-sm border\">
                                    <div class=\"flex items-center\">
                                        <img src=\"${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name?.charAt(0) || 'U'}`}\" class=\"w-8 h-8 rounded-full mr-3 object-cover\">
                                        <div>
                                            <span class=\"font-medium text-gray-700\">${user.name || user.displayName || '未命名'}</span>
                                            <div class=\"flex items-center mt-1\">
                                                <span class=\"text-sm font-semibold ${statusColor} mr-2\">${statusText}</span>
                                                <span class=\"text-xs text-gray-500\" id=\"clock-time-${user.id}\">${timeFormatted}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class=\"flex space-x-2\">
                                        ${user.lastPhotoUrl ? `<button class=\"view-photo-btn p-2 bg-blue-100 rounded-md\" data-photo=\"${user.lastPhotoUrl}\" data-desc=\"${user.lastLocation || ''}\"><i data-lucide=\"image\" class=\"w-6 h-6 text-blue-600\"></i></button>` : ''}
                                    </div>
                                    
                                </div>`;
                        });
                        // 重新以最新 clockInRecords 更新每位使用者的時間（避免快照時序不同步）
                        try {
                            Promise.all(filteredByStatus.map(async (u) => {
                                try {
                                    const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                    const latestSnap = await getDocs(qLatest);
                                    let dt = null;
                                    if (!latestSnap.empty) {
                                        const rec = latestSnap.docs[0].data();
                                        const ts = rec.timestamp;
                                        dt = ts?.toDate?.() ? ts.toDate() : (ts ? new Date(ts) : null);
                                    }
                                    const el = document.querySelector(`#clock-time-${u.id}`);
                                    if (el) {
                                        el.textContent = dt ? dt.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false}) : 'N/A';
                                    }
                                } catch (e) {
                                    console.warn('載入使用者最新打卡失敗:', e);
                                }
                            }));
                        } catch (e) {
                            console.warn('更新最新打卡時間時發生錯誤:', e);
                        }
                    })();
                    try { lucide.createIcons(); } catch (e) {}
                    // 綁定照片與地圖按鈕
                    document.querySelectorAll('#all-users-modal .view-photo-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const photoUrl = e.currentTarget.dataset.photo;
                            const description = e.currentTarget.dataset.desc;
                            if(photoUrl) openPhotoModal([photoUrl], [description]);
                            else showToast('無照片可顯示', true);
                        });
                    });
                    
                });
                
                function closeModal() {
                    try { unsub(); } catch {}
                    const m = document.getElementById('all-users-modal');
                    const b = document.getElementById('all-users-modal-backdrop');
                    if (m) document.body.removeChild(m);
                    if (b) document.body.removeChild(b);
                }
                document.getElementById('close-all-users-modal').addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            }

            function renderClockIn(subPage) {
                const role = state.currentUserData?.role || '';
                const isStaff = new Set(['總幹事','秘書','保全','清潔','機電']).has(role);
                const tabs = isStaff
                    ? [
                        { key: 'workdays', label: '我的班表' },
                        { key: 'location', label: '定位打卡' },
                        { key: 'records', label: '打卡紀錄' },
                        { key: 'leaves', label: '請假申請' }
                      ]
                    : [
                        { key: 'location', label: '定位打卡' },
                        { key: 'records', label: '打卡紀錄' },
                        { key: 'retro', label: '補打卡' },
                        { key: 'leaves', label: '請假申請' }
                      ];

                const tabsHtml = tabs.map(t => `
                    <button data-subtab="${t.key}" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === t.key ? 'active' : ''}">${t.label}</button>
                `).join('');

                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        ${tabsHtml}
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'location') {
                    renderClockInLocation(subPageContent);
                } else if (subPage === 'records') {
                    renderClockInRecords(subPageContent);
                } else if (subPage === 'retro') {
                    renderRetroClockRequestForm(subPageContent);
                } else if (subPage === 'leaves') {
                    renderMyLeaveRecords(subPageContent);
                } else if (subPage === 'workdays') {
                    // 只讀的我的班表（月視圖）
                    renderWorkDatesMonthView(subPageContent);
                } else {
                    // 預設落到定位打卡
                    renderClockInLocation(subPageContent);
                }

                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('clock-in', btn.dataset.subtab)));
            }

            function renderClockInLocation(container) {
                container.innerHTML = `
                    <div class="p-4 h-full flex flex-col">
                        <button id="relocate-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 flex items-center justify-center mb-4">
                            <i data-lucide="locate-fixed" class="w-4 h-4 mr-2"></i>重新定位
                        </button>
                        <div id="map-container" class="flex-grow rounded-lg overflow-hidden border border-gray-300 relative">
                             <div id="map" class="map-canvas"></div>
                             <div id="map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
                        </div>
                        <div id="status-display" class="mt-3 text-center font-semibold text-lg text-gray-700">
                            <span id="status-text">尚未打卡</span>
                        </div>
                        <div id="clock-in-buttons" class="grid grid-cols-2 gap-2 pt-4">
                            <!-- 僅保留兩個按鈕：上班、下班；請假申請已移至子分頁 -->
                            <button id="work-start-btn" data-type="上班" class="clock-in-btn bg-green-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-green-600">上班打卡</button>
                            <button id="work-end-btn" data-type="下班" class="clock-in-btn bg-red-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-red-600">下班打卡</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initClockInMap();

                document.getElementById('relocate-btn').addEventListener('click', initClockInMap);
                
                // 初始化打卡狀態（在定位打卡子頁渲染完成後）
                initClockInButtonStatus();
                updateStatusDisplay();
                
                // 打卡按鈕點擊事件
                document.querySelectorAll('.clock-in-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (btn.classList.contains('disabled')) {
                            return;
                        }
                        
                        if (!state.currentLocation) {
                            alert("無法取得目前位置，請稍後再試");
                            return;
                        }
                        
                        const type = e.target.dataset.type;
                        
                        // 外出打卡需要先輸入地點
                        if (type === "外出") {
                            // 直接打開地點輸入彈窗
                            const backdrop = document.createElement('div');
                            backdrop.id = 'modal-backdrop';
                            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                            backdrop.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // 創建彈窗
                            const modal = document.createElement('div');
                            modal.id = 'location-input-modal';
                            modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 z-50 w-80';
                            
                            // 創建標題
                            const title = document.createElement('h3');
                            title.className = 'text-lg font-semibold mb-4';
                            title.textContent = '請選擇勤務項目並輸入外出地點';

                            // 勤務項目選單
                            const dutyContainer = document.createElement('div');
                            dutyContainer.className = 'mb-4';
                            const dutyLabel = document.createElement('label');
                            dutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            dutyLabel.textContent = '勤務項目';
                            const dutySelect = document.createElement('select');
                            dutySelect.id = 'outbound-duty-type';
                            dutySelect.className = 'w-full border border-gray-300 rounded-md p-2';
                            ['例行督察','例會','區大','臨時會','簡報','其他'].forEach(opt => {
                                const o = document.createElement('option');
                                o.value = opt;
                                o.textContent = opt;
                                dutySelect.appendChild(o);
                            });
                            dutyContainer.appendChild(dutyLabel);
                            dutyContainer.appendChild(dutySelect);

                            // 其他勤務項目輸入框（預設隱藏）
                            const otherDutyContainer = document.createElement('div');
                            otherDutyContainer.id = 'outbound-other-duty-container';
                            otherDutyContainer.className = 'mb-4 hidden';
                            const otherDutyLabel = document.createElement('label');
                            otherDutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            otherDutyLabel.textContent = '其他勤務項目';
                            const otherDutyInput = document.createElement('input');
                            otherDutyInput.id = 'outbound-other-duty';
                            otherDutyInput.type = 'text';
                            otherDutyInput.className = 'w-full border border-gray-300 rounded-md p-2';
                            otherDutyInput.placeholder = '請輸入勤務項目';
                            otherDutyContainer.appendChild(otherDutyLabel);
                            otherDutyContainer.appendChild(otherDutyInput);
                            
                            // 創建輸入框
                            const input = document.createElement('input');
                            input.id = 'outbound-location';
                            input.type = 'text';
                            input.className = 'w-full border border-gray-300 rounded-md p-2 mb-4';
                            input.placeholder = '例如：客戶公司、醫院等';
                            
                            // 創建按鈕容器
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'flex justify-end space-x-2';
                            
                            // 勤務項目切換事件（顯示/隱藏其他輸入框）
                            dutySelect && dutySelect.addEventListener('change', () => {
                                if (dutySelect.value === '其他') {
                                    otherDutyContainer.classList.remove('hidden');
                                } else {
                                    otherDutyContainer.classList.add('hidden');
                                }
                            });
                            // 創建取消按鈕
                            const cancelButton = document.createElement('button');
                            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md';
                            cancelButton.textContent = '取消';
                            cancelButton.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // 創建確認按鈕
                            const confirmButton = document.createElement('button');
                            confirmButton.className = 'px-4 py-2 bg-blue-500 text-white rounded-md';
                            confirmButton.textContent = '確認';
                            confirmButton.addEventListener('click', () => {
                                const dutyTypeEl = document.getElementById('outbound-duty-type');
                                const dutyType = dutyTypeEl ? dutyTypeEl.value : '';
                                let dutyName = dutyType;
                                if (dutyType === '其他') {
                                    const otherDuty = document.getElementById('outbound-other-duty').value.trim();
                                    if (!otherDuty) {
                                        alert('請輸入勤務項目');
                                        return;
                                    }
                                    dutyName = otherDuty;
                                }
                                const locationText = document.getElementById('outbound-location').value.trim();
                                if (locationText) {
                                    state.outboundLocation = locationText;
                                    state.dutyType = dutyName;
                                    // 保存地點到設定的 savedLocations（最多10筆）
                                    try {
                                        if (!state.savedLocations) {
                                            state.savedLocations = [];
                                        }
                                        const exists = state.savedLocations.some(loc => loc === locationText);
                                        if (!exists) {
                                            state.savedLocations.push(locationText);
                                            if (state.savedLocations.length > 10) {
                                                state.savedLocations.shift();
                                            }
                                            // 僅管理員可寫入 Firestore；一般使用者改存 localStorage
                                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                            const user = window.__auth?.currentUser;
                                            if (isAdmin && user) {
                                                const { updateDoc, doc } = window.__fs; const db = window.__db;
                                                updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations })
                                                    .catch(err => console.warn('保存地址到設定失敗', err));
                                            } else {
                                                try {
                                                    const key = `saved_locations_${window.__auth?.currentUser?.uid || 'guest'}`;
                                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                                } catch (e) { console.warn('保存地址到本機失敗', e); }
                                            }
                                        }
                                    } catch (e) {
                                        console.warn('處理 savedLocations 失敗', e);
                                    }
                                    // 保存外出地點到系統位置設定（otherLocations），僅管理員具有寫入權限
                                    try {
                                        const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                        const user = window.__auth?.currentUser; const db = window.__db; const { doc, getDoc, setDoc, arrayUnion, serverTimestamp } = window.__fs;
                                        if (isAdmin && user) {
                                            const settingsRef = doc(db, 'settings', 'location');
                                            // 構建位置物件
                                            const locEntry = {
                                                name: locationText,
                                                lat: (state.currentLocation && typeof state.currentLocation.lat === 'number') ? state.currentLocation.lat : null,
                                                lng: (state.currentLocation && typeof state.currentLocation.lng === 'number') ? state.currentLocation.lng : null,
                                                radius: 100
                                            };
                                            // 先讀取，避免重複名稱
                                            getDoc(settingsRef).then(docSnap => {
                                                const settings = docSnap.exists() ? docSnap.data() : {};
                                                const otherLocations = Array.isArray(settings.otherLocations) ? settings.otherLocations : [];
                                                const nameExists = otherLocations.some(l => (l && l.name) === locationText);
                                                if (!nameExists) {
                                                    setDoc(settingsRef, {
                                                        otherLocations: arrayUnion(locEntry),
                                                        updatedAt: serverTimestamp()
                                                    }, { merge: true }).catch(err => console.warn('保存其他位置失敗', err));
                                                }
                                            }).catch(err => console.warn('讀取位置設定失敗', err));
                                        }
                                    } catch (e) {
                                        console.warn('處理 otherLocations 失敗', e);
                                    }
                                    document.body.removeChild(backdrop);
                                    document.body.removeChild(modal);
                                    // 打開相機，傳遞當前位置和外出地點名稱；若定位失敗則使用後備座標
                                    if (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') {
                                        openCameraModal(type, { ...state.currentLocation, name: locationText });
                                    } else {
                                        showToast('定位逾時，將以未知位置繼續打卡（稍後可同步）');
                                        openCameraModal(type, { lat: 0, lng: 0, name: locationText, isFallback: true });
                                    }
                                } else {
                                    alert('請輸入外出地點');
                                }
                            });
                            
                            // 組裝彈窗
                            buttonContainer.appendChild(cancelButton);
                            buttonContainer.appendChild(confirmButton);
                            modal.appendChild(title);
                            // 插入勤務項目選單與其他輸入
                            modal.appendChild(dutyContainer);
                            modal.appendChild(otherDutyContainer);
                            modal.appendChild(input);
                            modal.appendChild(buttonContainer);
                            
                            // 添加到頁面
                            document.body.appendChild(backdrop);
                            document.body.appendChild(modal);
                        } else if (type === "抵達" || type === "離開" || type === "返回") {
                            // 抵達、離開、返回打卡也需要拍照
                            openCameraModal(type, state.currentLocation);
                        } else if (type === "臨時請假") {
                            // 不執行相機操作
                        } else {
                            openCameraModal(type, state.currentLocation);
                        }
                    });
                });
                
                // 臨時請假按鈕移至「請假申請」子分頁；保留安全檢查避免元素不存在報錯
                const tempLeaveBtnEl = document.getElementById('temp-leave-btn');
                if (tempLeaveBtnEl) {
                    tempLeaveBtnEl.addEventListener('click', () => {
                        openTempLeaveModal();
                    });
                }
                
                // 已移除特殊勤務按鈕
            }

            // 我的班表子分頁：僅顯示「當前社區」中屬於自己的排班（只讀），上方月曆、預設當日、下方顯示時間與哨點
            function renderWorkDatesMonthView(container) {
                const comm = state.currentCommunity;
                if (!comm || !comm.id) {
                    container.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="home" class="w-8 h-8 mx-auto mb-3"></i>
                                <div>請先選擇社區後再查看我的班表</div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }
                const communityId = comm.id;

                const db = window.__db; const { collection, getDocs } = window.__fs || {};
                const userId = window.__auth?.currentUser?.uid || '';

                const pageState = {
                    monthDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
                    selectedDayIso: null,
                    daysMap: {}, // { iso: [{ start, end, postName }] }
                    postNameMap: {}
                };

                const fmtYMD = (d) => {
                    const y = d.getFullYear();
                    const m = (d.getMonth()+1).toString().padStart(2,'0');
                    const day = d.getDate().toString().padStart(2,'0');
                    return `${y}-${m}-${day}`;
                };
                const parseHM = (s) => {
                    const [h,m] = (s||'00:00').split(':').map(x=>parseInt(x,10)||0);
                    return h*60+m;
                };
                const mergeIntervalsMinutes = (list) => {
                    if (!Array.isArray(list) || !list.length) return [];
                    const intervals = list.map(it => ({start: parseHM(it.start||'00:00'), end: parseHM(it.end||'00:00')}))
                        .filter(it => it.end>it.start)
                        .sort((a,b)=>a.start-b.start);
                    const merged = [];
                    for (const iv of intervals) {
                        if (!merged.length || iv.start > merged[merged.length-1].end) {
                            merged.push({start: iv.start, end: iv.end});
                        } else {
                            merged[merged.length-1].end = Math.max(merged[merged.length-1].end, iv.end);
                        }
                    }
                    return merged;
                };
                const coverageMinutes = (list) => mergeIntervalsMinutes(list).reduce((acc,iv)=>acc+(iv.end-iv.start),0);

                const renderShell = () => {
                    container.innerHTML = `
                        <div class="p-3">
                            <div class="flex items-center justify-between mb-2">
                                <button id="my-prev-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">上個月</button>
                                <div id="my-current-month-year" class="text-lg font-semibold"></div>
                                <button id="my-next-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">下個月</button>
                            </div>
                            <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-1">
                                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                            </div>
                            <div id="myshift-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                            <hr class="border-t border-gray-200 my-3" />
                            <div id="myshift-day-panel" class="mt-2"></div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                };

                const renderMonthHeader = () => {
                    const title = document.getElementById('my-current-month-year');
                    if (!title) return;
                    const d = pageState.monthDate;
                    title.textContent = `${d.getFullYear()} 年 ${d.getMonth()+1} 月`;
                    const prev = document.getElementById('my-prev-month');
                    const next = document.getElementById('my-next-month');
                    if (prev) prev.onclick = async ()=>{
                        pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()-1, 1);
                        await loadMonth();
                        renderMonthHeader();
                        renderCalendar();
                        renderDayPanel();
                    };
                    if (next) next.onclick = async ()=>{
                        pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()+1, 1);
                        await loadMonth();
                        renderMonthHeader();
                        renderCalendar();
                        renderDayPanel();
                    };
                };

                const loadPosts = async () => {
                    pageState.postNameMap = {};
                    try {
                        const postsSnap = await getDocs(collection(db, 'communities', communityId, 'posts'));
                        postsSnap.forEach(d => { const data = d.data() || {}; pageState.postNameMap[d.id] = data.name || '未命名哨點'; });
                    } catch (e) { console.warn('載入哨點名稱失敗', e); }
                };

                const loadMonth = async () => {
                    pageState.daysMap = {};
                    try {
                        const y = pageState.monthDate.getFullYear();
                        const m = pageState.monthDate.getMonth()+1; const ymStr = `${y}-${m.toString().padStart(2,'0')}-`;
                        const schedSnap = await getDocs(collection(db, 'communities', communityId, 'postSchedules'));
                        schedSnap.forEach(d => {
                            const data = d.data() || {};
                            const iso = (data.dateIso || '').toString();
                            if (!iso.startsWith(ymStr)) return;
                            const shifts = Array.isArray(data.shifts) ? data.shifts : [];
                            const my = shifts.filter(s => Array.isArray(s.assignees) && s.assignees.includes(userId));
                            if (my.length) {
                                pageState.daysMap[iso] = my.map(s => ({ start: s.start || '', end: s.end || '', postName: pageState.postNameMap[data.postId] || '未命名哨點' }));
                            }
                        });
                    } catch (e) { console.warn('讀取個人排班失敗', e); }
                    const todayIso = fmtYMD(new Date());
                    const dToday = new Date(todayIso);
                    const sameMonth = dToday.getMonth() === pageState.monthDate.getMonth() && dToday.getFullYear() === pageState.monthDate.getFullYear();
                    pageState.selectedDayIso = sameMonth ? todayIso : fmtYMD(new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth(), 1));
                };

                const renderCalendar = () => {
                    const grid = document.getElementById('myshift-calendar-grid');
                    if (!grid) return;
                    const year = pageState.monthDate.getFullYear();
                    const month = pageState.monthDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const startWeekday = firstDay.getDay();
                    const daysInMonth = new Date(year, month+1, 0).getDate();
                    const prevMonthDays = new Date(year, month, 0).getDate();
                    const cells = [];
                    const selectedIso = pageState.selectedDayIso || fmtYMD(new Date());
                    for (let i=startWeekday-1; i>=0; i--) { const date = new Date(year, month-1, prevMonthDays - i); cells.push({ date, inMonth:false }); }
                    for (let d=1; d<=daysInMonth; d++) { cells.push({ date: new Date(year, month, d), inMonth:true }); }
                    const totalCells = Math.ceil(cells.length/7)*7;
                    const nextFill = totalCells - cells.length;
                    for (let i=1; i<=nextFill; i++) { cells.push({ date: new Date(year, month+1, i), inMonth:false }); }
                    grid.innerHTML = cells.map(cell => {
                        const iso = fmtYMD(cell.date);
                        const myList = pageState.daysMap[iso] || [];
                        const cov = coverageMinutes(myList);
                        const bgStyle = (()=>{
                            if (!cell.inMonth) return '';
                            if (!cov) return '';
                            if (cov >= 18*60) return 'background-color:#A7F3D0;';
                            if (cov >= 12*60) return 'background-color:#D1FAE5;';
                            if (cov >= 6*60) return 'background-color:#FEF3C7;';
                            return 'background-color:#FFF7ED;';
                        })();
                        const isSelected = iso === selectedIso;
                        const cls = `${cell.inMonth? '':'bg-gray-50 text-gray-400'} ${isSelected? 'border-2 border-red-500':''} hover:bg-red-50 rounded p-2 text-xs h-[30px] flex flex-col ${cell.inMonth?'bg-white':''}`;
                        return `<div class="${cls}" style="${bgStyle}" data-iso="${iso}"><div class="font-semibold">${cell.date.getDate()}</div><div class="mt-auto text-[10px] text-gray-500">${myList.length? '個人班次 '+myList.length:'無'}</div></div>`;
                    }).join('');
                    grid.querySelectorAll('[data-iso]').forEach(el=>{ el.addEventListener('click', ()=>{ pageState.selectedDayIso = el.getAttribute('data-iso'); renderDayPanel(); }); });
                };

                const renderDayPanel = () => {
                    const panel = document.getElementById('myshift-day-panel');
                    if (!panel) return;
                    const iso = pageState.selectedDayIso || fmtYMD(new Date()); const { Timestamp } = window.__fs || {};
                    const list = pageState.daysMap[iso] || [];
                    panel.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold">${iso} 的個人班表</div>
                        </div>
                        <div>
                            ${list.length===0 ? `<div class="text-gray-500 text-sm">本日無個人排班</div>` : ''}
                            <div class="space-y-2">
                                ${list.map(it=>`
                                    <div class="flex items-center gap-2 p-2 rounded border bg-white">
                                        <span class="text-sm font-medium">${it.start || '—'} ~ ${it.end || '—'}</span>
                                        <span class="text-xs text-gray-500">${it.postName || '未命名哨點'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                };

                const init = async () => {
                    renderShell();
                    await loadPosts();
                    renderMonthHeader();
                    await loadMonth();
                    renderCalendar();
                    renderDayPanel();
                };
                init();
            }

            // 個人請假紀錄子頁籤
            function renderMyLeaveRecords(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex justify-end mb-2">
                            <button id="leave-apply-btn" onclick="openTempLeaveModal()" class="bg-orange-500 text-white px-3 py-2 rounded-md hover:bg-orange-600 flex items-center">
                                <i data-lucide="file-plus" class="w-4 h-4 mr-1"></i>請假申請
                            </button>
                        </div>
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-status-filter" class="text-sm font-medium">審核狀態:</label>
                                <select id="my-leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>全部</option>
                                    <option value="pending">待審核</option>
                                    <option value="approved">已核准</option>
                                    <option value="rejected">已拒絕</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-date-filter" class="text-sm font-medium">日期:</label>
                                <input type="date" id="my-leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <button id="my-leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>搜尋
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">事由</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">開始時間</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">結束時間</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    載入中...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="no-my-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>沒有符合條件的請假記錄</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();

                const statusFilter = document.getElementById('my-leave-status-filter');
                const dateFilter = document.getElementById('my-leave-date-filter');
                const searchBtn = document.getElementById('my-leave-search-btn');

                // 初始加載
                loadMyLeaveRecords();

                searchBtn.addEventListener('click', loadMyLeaveRecords);

                function getStatusBadge(status) {
                    switch (status) {
                        case 'pending':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">待審核</span>';
                        case 'approved':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">已核准</span>';
                        case 'rejected':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">已拒絕</span>';
                        case 'canceled':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">已取消</span>';
                        default:
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">未知</span>';
                    }
                }

                function loadMyLeaveRecords() {
                    const recordsList = document.getElementById('my-leave-records-list');
                    const noRecordsMsg = document.getElementById('no-my-leave-records');

                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    載入中...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();

                    const status = statusFilter.value;
                    const date = dateFilter.value;

                    const user = window.__auth?.currentUser;
                    if (!user) {
                        recordsList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">請先登入以查看請假紀錄</td></tr>';
                        return;
                    }
                    const db = window.__db; const { collection, where, query, getDocs } = window.__fs;
                    let q = query(collection(db, 'leaves'), where('userId', '==', user.uid));
                    if (status !== 'all') { q = query(q, where('status', '==', status)); }
                    // 移除排序以避免 Firestore 索引需求，改用前端排序（若需要）

                    getDocs(q).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }

                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';

                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }

                        let hasRecords = false;
                        const leaves = [];

                        querySnapshot.forEach((docSnap) => {
                            const leave = { id: docSnap.id, ...docSnap.data() };
                            leaves.push(leave);
                        });

                        // 前端過濾與排序
                        const filtered = leaves.filter(leave => {
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                return (startTime < nextDay && endTime > selectedDate);
                            }
                            return true;
                        }).sort((a, b) => {
                            const aTs = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                            const bTs = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                            return bTs - aTs;
                        });

                        filtered.forEach(leave => {
                            hasRecords = true;
                            const startTimeText = leave.startTime.toDate().toLocaleString('zh-TW', { hour12: false });
                            const endTimeText = leave.endTime.toDate().toLocaleString('zh-TW', { hour12: false });

                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || '無事由'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${getStatusBadge(leave.status)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${leave.status === 'pending' ? '<button class="cancel-leave-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded text-xs" data-id="'+(leave.id||'')+'">取消</button>' : ''}
                                </td>
                            `;
                            recordsList.appendChild(row);
                        });

                        lucide.createIcons();

                        // 綁定取消事件（僅顯示於待審核）
                        recordsList.querySelectorAll('.cancel-leave-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = e.currentTarget.dataset.id;
                                if (!id) {
                                    showToast('無法識別假單ID', true);
                                    return;
                                }
                                if (!confirm('確定要取消這筆假單嗎？')) return;
                                try {
                                    const db = window.__db; const { updateDoc, doc, serverTimestamp, Timestamp } = window.__fs; const user = window.__auth?.currentUser;
                                    await updateDoc(doc(db, 'leaves', id), { status: 'canceled', canceledAt: Timestamp.fromDate(new Date()) });
                                    if (user) {
                                        await updateDoc(doc(db, 'users', user.uid), {
                                            leaveStatus: 'canceled',
                                            status: '未打卡',
                                            lastUpdated: serverTimestamp()
                                        });
                                    }
                                    showToast('已取消假單');
                                    loadMyLeaveRecords();
                                } catch (err) {
                                    console.error('取消假單失敗', err);
                                    showToast('取消失敗：'+ (err.message||''), true);
                                }
                            });
                        });

                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                    }).catch(error => {
                        console.error('獲取請假記錄失敗:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">
                                    讀取記錄失敗，請稍後再試
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            // 臨時請假表單
            function openTempLeaveModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.id = 'temp-leave-modal';
                
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const currentHour = now.getHours();
                const defaultEndHour = Math.min(currentHour + 2, 23);
                
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md mx-auto overflow-hidden">
                        <div class="modal-header bg-orange-500 text-white px-4 py-3 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">請假申請</h3>
                            <button class="modal-close text-white hover:text-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="leave-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="leave-reason-type" class="block text-sm font-medium text-gray-700 mb-1">請假事由</label>
                                    <select id="leave-reason-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="病假">病假</option>
                                        <option value="事假">事假</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                
                                <div id="other-reason-container" class="form-group hidden">
                                    <label for="other-reason" class="block text-sm font-medium text-gray-700 mb-1">其他事由</label>
                                    <input type="text" id="other-reason" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="請輸入請假事由">
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="leave-start-date" class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                                        <input type="date" id="leave-start-date" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${todayStr}">
                                    </div>
                                    <div class="form-group">
                                        <label for="leave-start-hour" class="block text-sm font-medium text-gray-700 mb-1">開始小時</label>
                                        <input type="number" id="leave-start-hour" min="0" max="23" step="1" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${currentHour}">
                                    </div>
                                    <div class="form-group">
                                        <label for="leave-end-date" class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                                        <input type="date" id="leave-end-date" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${todayStr}">
                                    </div>
                                    <div class="form-group">
                                        <label for="leave-end-hour" class="block text-sm font-medium text-gray-700 mb-1">結束小時</label>
                                        <input type="number" id="leave-end-hour" min="0" max="23" step="1" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${defaultEndHour}">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" id="leave-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">取消</button>
                                    <button type="submit" id="leave-submit-btn" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">提交申請</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // 事由選擇變更事件
                const reasonTypeSelect = document.getElementById('leave-reason-type');
                const otherReasonContainer = document.getElementById('other-reason-container');
                
                reasonTypeSelect.addEventListener('change', () => {
                    if (reasonTypeSelect.value === '其他') {
                        otherReasonContainer.classList.remove('hidden');
                    } else {
                        otherReasonContainer.classList.add('hidden');
                    }
                });
                
                // 關閉按鈕事件
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // 取消按鈕事件
                document.getElementById('leave-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // 表單提交事件
                document.getElementById('leave-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const reasonType = reasonTypeSelect.value;
                    let reason = reasonType;
                    
                    if (reasonType === '其他') {
                        const otherReason = document.getElementById('other-reason').value.trim();
                        if (!otherReason) {
                            showToast('請輸入請假事由', true);
                            return;
                        }
                        reason = otherReason;
                    }
                    // 取得日期與小時，組合為時間
                    const startDateStr = document.getElementById('leave-start-date').value;
                    const endDateStr = document.getElementById('leave-end-date').value;
                    const startHour = parseInt(document.getElementById('leave-start-hour').value, 10);
                    const endHour = parseInt(document.getElementById('leave-end-hour').value, 10);

                    if (!startDateStr || !endDateStr || isNaN(startHour) || isNaN(endHour)) {
                        showToast('請選擇有效的日期與小時', true);
                        return;
                    }
                    const startTime = new Date(`${startDateStr}T00:00:00`);
                    startTime.setHours(startHour, 0, 0, 0);
                    const endTime = new Date(`${endDateStr}T00:00:00`);
                    endTime.setHours(endHour, 0, 0, 0);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        showToast('請選擇有效的時間', true);
                        return;
                    }
                    
                    if (startTime >= endTime) {
                        showToast('結束時間必須晚於開始時間', true);
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        
                        const db = window.__db; const { addDoc, collection, serverTimestamp, Timestamp, updateDoc, doc } = window.__fs; const user = window.__auth?.currentUser;
                        if (!user) throw new Error('尚未登入');
                        // 創建請假記錄（以小時為單位）
                        await addDoc(collection(db, 'leaves'), {
                            userId: user.uid,
                            userName: state.currentUserData?.name || '',
                            reason: reason,
                            reasonType: reasonType,
                            startTime: Timestamp.fromDate(startTime),
                            endTime: Timestamp.fromDate(endTime),
                            status: 'pending',
                            createdAt: serverTimestamp()
                        });
                        
                        // 更新用戶狀態
                        await updateDoc(doc(db, 'users', user.uid), {
                            status: '請假中',
                            leaveStatus: 'pending',
                            lastUpdated: serverTimestamp()
                        });
                        
                        showToast('請假申請已提交，等待審核');
                        updateStatusDisplay();
                        document.body.removeChild(modal);
                    } catch (error) {
                        console.error('提交請假申請失敗:', error);
                        showToast('提交請假申請失敗，請稍後再試', true);
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            // 特殊勤務表單
            function openSpecialDutyModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.id = 'special-duty-modal';
                
                const now = new Date();
                const formattedNow = now.toISOString().slice(0, 16); // 格式為 YYYY-MM-DDTHH:MM
                const twoHoursLater = new Date(now);
                twoHoursLater.setHours(twoHoursLater.getHours() + 2);
                const formattedTwoHoursLater = twoHoursLater.toISOString().slice(0, 16);
                
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md mx-auto overflow-hidden">
                        <div class="modal-header bg-purple-500 text-white px-4 py-3 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">特殊勤務登記</h3>
                            <button class="modal-close text-white hover:text-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="duty-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="duty-type" class="block text-sm font-medium text-gray-700 mb-1">勤務項目名稱</label>
                                    <select id="duty-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="例行督察">例行督察</option>
                                        <option value="簡報">簡報</option>
                                        <option value="例會">例會</option>
                                        <option value="區大">區大</option>
                                        <option value="臨時會">臨時會</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                
                                <div id="other-duty-container" class="form-group hidden">
                                    <label for="other-duty" class="block text-sm font-medium text-gray-700 mb-1">其他勤務項目</label>
                                    <input type="text" id="other-duty" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="請輸入勤務項目名稱">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-location" class="block text-sm font-medium text-gray-700 mb-1">地點</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="duty-location" class="flex-grow border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="請輸入地點">
                                        <button type="button" id="map-location-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-start-time" class="block text-sm font-medium text-gray-700 mb-1">開始時間</label>
                                    <input type="datetime-local" id="duty-start-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedNow}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-end-time" class="block text-sm font-medium text-gray-700 mb-1">結束時間</label>
                                    <input type="datetime-local" id="duty-end-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedTwoHoursLater}">
                                </div>
                                
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" id="duty-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">取消</button>
                                    <button type="submit" id="duty-submit-btn" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">提交登記</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // 勤務項目選擇變更事件
                const dutyTypeSelect = document.getElementById('duty-type');
                const otherDutyContainer = document.getElementById('other-duty-container');
                
                dutyTypeSelect.addEventListener('change', () => {
                    if (dutyTypeSelect.value === '其他') {
                        otherDutyContainer.classList.remove('hidden');
                    } else {
                        otherDutyContainer.classList.add('hidden');
                    }
                });
                
                // 地圖位置按鈕事件
                document.getElementById('map-location-btn').addEventListener('click', () => {
                    if (state.currentLocation) {
                        // 使用反向地理編碼獲取地址
                        const geocoder = new google.maps.Geocoder();
                        const latlng = { lat: state.currentLocation.lat, lng: state.currentLocation.lng };
                        
                        geocoder.geocode({ location: latlng }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                document.getElementById('duty-location').value = results[0].formatted_address;
                            } else {
                                document.getElementById('duty-location').value = `${state.currentLocation.lat}, ${state.currentLocation.lng}`;
                            }
                        });
                    } else {
                        showToast('無法獲取當前位置', true);
                    }
                });
                
                // 關閉按鈕事件
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // 取消按鈕事件
                document.getElementById('duty-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // 表單提交事件
                document.getElementById('duty-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const dutyType = dutyTypeSelect.value;
                    let dutyName = dutyType;
                    
                    if (dutyType === '其他') {
                        const otherDuty = document.getElementById('other-duty').value.trim();
                        if (!otherDuty) {
                            showToast('請輸入勤務項目名稱', true);
                            return;
                        }
                        dutyName = otherDuty;
                    }
                    
                    const location = document.getElementById('duty-location').value.trim();
                    if (!location) {
                        showToast('請輸入地點', true);
                        return;
                    }
                    
                    const startTime = new Date(document.getElementById('duty-start-time').value);
                    const endTime = new Date(document.getElementById('duty-end-time').value);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        showToast('請選擇有效的時間', true);
                        return;
                    }
                    
                    if (startTime >= endTime) {
                        showToast('結束時間必須晚於開始時間', true);
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        
                        const db = window.__db; const { addDoc, collection, Timestamp, serverTimestamp, updateDoc, doc } = window.__fs; const user = window.__auth?.currentUser;
                        if (!user) throw new Error('尚未登入');
                        // 創建特殊勤務記錄
                        await addDoc(collection(db, 'specialDuties'), {
                            userId: user.uid,
                            userName: state.currentUserData?.name || '',
                            dutyName: dutyName,
                            dutyType: dutyType,
                            location: location,
                            startTime: Timestamp.fromDate(startTime),
                            endTime: Timestamp.fromDate(endTime),
                            createdAt: serverTimestamp()
                        });
                        
                        // 更新用戶狀態
                        await updateDoc(doc(db, 'users', user.uid), {
                            status: `出勤-${dutyName}`,
                            lastUpdated: serverTimestamp()
                        });
                        
                        // 保存地點到設定
                        if (!state.savedLocations) {
                            state.savedLocations = [];
                        }
                        
                        // 檢查是否已存在相同地點
                        const locationExists = state.savedLocations.some(loc => loc === location);
                        if (!locationExists) {
                            state.savedLocations.push(location);
                            // 最多保存10個地點
                            if (state.savedLocations.length > 10) {
                                state.savedLocations.shift();
                            }
                            
                            // 僅管理員可寫入 Firestore；一般使用者改存 localStorage
                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                            if (isAdmin && user) {
                                await updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations });
                            } else {
                                try {
                                    const key = `saved_locations_${user?.uid || 'guest'}`;
                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                } catch (e) { console.warn('保存地址到本機失敗', e); }
                            }
                        }
                        
                        showToast('特殊勤務已登記');
                        updateStatusDisplay();
                        document.body.removeChild(modal);
                    } catch (error) {
                        console.error('提交特殊勤務登記失敗:', error);
                        showToast('提交特殊勤務登記失敗，請稍後再試', true);
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderClockInRecords(container) {
                const now = new Date();
                const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="record-month" class="text-sm font-medium">篩選月份:</label>
                            <input type="month" id="record-month" value="${ym}" class="border border-gray-300 rounded-md px-2 py-1">
                            <button id="open-month-report" class="ml-2 px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">月報表</button>
                        </div>
                        <div id="records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">正在讀取紀錄...</div>
                        </div>
                    </div>
                `;

                const monthInput = document.getElementById('record-month');

                const loadRecords = async () => {
                    await ensureAbnormalMarkingConfig();
                    await ensureCommunitiesCache();
                    const [yearStr, monthStr] = (monthInput.value || ym).split('-');
                    const year = parseInt(yearStr, 10);
                    const monthIdx = parseInt(monthStr, 10) - 1;
                    const startOfMonth = new Date(year, monthIdx, 1, 0, 0, 0, 0);
                    const endOfMonth = new Date(year, monthIdx + 1, 0, 23, 59, 59, 999);
                    
                    const recordsRef = collection(db, "clockInRecords");
                    // Firestore 端月份範圍查詢以避免時區邊界誤差（保留前端過濾作為保險）
                    const { Timestamp } = window.__fs || {};
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfMonth) : startOfMonth;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfMonth) : endOfMonth;
                    const q = query(
                        recordsRef,
                        where("userId", "==", state.currentUser.uid),
                        where("timestamp", ">=", startTS),
                        where("timestamp", "<=", endTS)
                    );

                    const unsubscribe = onSnapshot(q, (querySnapshot) => {
                        const recordsListEl = document.getElementById('records-list');
                        if (!recordsListEl) return;
                        
                        if (querySnapshot.empty) {
                            (async () => {
                                try {
                                    const { doc, getDoc } = window.__fs; const db2 = window.__db;
                                    const uid = state.currentUser?.uid || window.__auth?.currentUser?.uid;
                                    if (!uid) { recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄</p>`; return; }
                                    const userRef = doc(db2, 'users', uid);
                                    const userSnap = await getDoc(userRef);
                                    if (userSnap.exists()) {
                                        const u = userSnap.data();
                                        const ts = u.lastUpdated?.toDate?.() || (u.lastUpdated ? new Date(u.lastUpdated) : null);
                                        if (u.clockInStatus && ts && ts >= startOfMonth && ts <= endOfMonth) {
                                            const statusText = getStatusDisplayText(u.clockInStatus, u.outboundLocation || null, u.dutyType || null);
                                            const statusColor = getStatusColor(statusText);
                                            recordsListEl.innerHTML = `
                                                <div class="bg-white p-3 rounded-lg shadow-sm border mb-3">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                                            <p class="text-sm text-gray-600">${formatDate(ts)}</p>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 text-xs text-gray-400">來源：使用者狀態快照（clockInRecords 建立失敗）</div>
                                                </div>`;
                                            try { lucide.createIcons(); } catch(e){}
                                        } else {
                                                recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄</p>`;
                                            }
                                        } else {
                                            recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄</p>`;
                                    }
                                } catch (e) {
                                    const expectedCodes = ['permission-denied','failed-precondition','invalid-argument'];
                                    const logFn = expectedCodes.includes(e?.code) ? console.warn : console.error;
                                    logFn('讀取使用者狀態快照失敗:', e?.code, e?.message || e);
                                    recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄</p>`;
                                }
                            })();
                            return;
                        }
                        
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // 前端日期過濾與時間降序排序
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startOfMonth && ts <= endOfMonth;
                        }).sort((a, b) => {
                            const timeA = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const timeB = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return timeB - timeA;
                        });
                        
                        recordsListEl.innerHTML = '';
                        filtered.forEach(record => {
                            const card = document.createElement('div');
                            card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
                            const statusText = getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null);
                            const statusColor = getStatusColor(statusText);
                            const abnormalInfo = computeRecordAbnormal(record, state.currentUserData?.serviceCommunities || []);
                            const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                                ? `<div class="mt-1 flex items-center"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">打卡位置異常</span>${abnormalInfo.detail ? `<span class="ml-2 text-xs text-gray-500">${abnormalInfo.detail}</span>` : ''}</div>`
                                : '';
                            card.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                        <p class="text-sm text-gray-600">${formatDate(record.timestamp)}</p>
                                        ${abnormalHtml}
                                    </div>
                                </div>
                                <div class="mt-2 flex space-x-2 overflow-x-auto">
                                    <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> 照片 (${(record.photoUrls?.length || 0)})
                                    </button>
                                    <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                        <i data-lucide="map-pin"></i> 地圖
                                    </button>
                                    <button class="apply-mod-btn bg-orange-500 text-white px-2 py-1 rounded text-sm"
                                        data-id="${record.id}"
                                        data-type="${record.type || ''}"
                                        data-ts="${(record.timestamp?.toMillis ? record.timestamp.toMillis() : (record.timestamp?.seconds ? record.timestamp.seconds * 1000 : (record.timestamp ? (new Date(record.timestamp)).getTime() : Date.now())))}"
                                        data-locationname="${record.locationName || ''}">
                                        <i data-lucide="edit"></i> 申請修改
                                    </button>
                                </div>
                            `;
                            recordsListEl.appendChild(card);
                        });
                         
                        lucide.createIcons();
                        
                        document.querySelectorAll('.map-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const lat = parseFloat(e.currentTarget.dataset.lat);
                                const lng = parseFloat(e.currentTarget.dataset.lng);
                                if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                                else showToast("無位置資訊可顯示", true);
                            });
                        });

                        // 申請修改按鈕事件（提交至 retroClockRequests，使用中文欄位）
                        document.querySelectorAll('.apply-mod-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const d = e.currentTarget.dataset;
                                const tsMillis = parseInt(d.ts || '0', 10);
                                const ts = Number.isFinite(tsMillis) && tsMillis > 0 ? new Date(tsMillis) : new Date();
                                const recTypeRaw = d.type || '';
                                const recLocationName = d.locationname || '';
                                const typeMap = { clock_in: '上班', clock_out: '下班', out: '外出', arrive: '抵達', leave: '離開', return: '返回' };
                                const recType = typeMap[recTypeRaw] || recTypeRaw;
                                const backdrop = document.createElement('div');
                                backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                                const modal = document.createElement('div');
                                modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[92%] max-w-[560px]';
                                modal.innerHTML = `
                                    <h3 class="text-lg font-bold mb-3">申請修改打卡資料</h3>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium">日期</label>
                                                <input type="date" id="mod-date" class="w-full border border-gray-300 rounded-md p-2" value="${ts.toISOString().split('T')[0]}" />
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium">時間</label>
                                                <input type="time" id="mod-time" class="w-full border border-gray-300 rounded-md p-2" value="${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}" />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium">項目</label>
                                            <select id="mod-type" class="w-full border border-gray-300 rounded-md p-2">
                                                <option value="上班" ${recType==='上班' ? 'selected' : ''}>上班</option>
                                                <option value="下班" ${recType==='下班' ? 'selected' : ''}>下班</option>
                                                <option value="外出" ${recType==='外出' ? 'selected' : ''}>外出</option>
                                                <option value="抵達" ${recType==='抵達' ? 'selected' : ''}>抵達</option>
                                                <option value="離開" ${recType==='離開' ? 'selected' : ''}>離開</option>
                                                <option value="返回" ${recType==='返回' ? 'selected' : ''}>返回</option>
                                            </select>
                                        </div>
                                        <div id="mod-extra" class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium">事由</label>
                                                <input type="text" id="mod-reason" class="w-full border border-gray-300 rounded-md p-2" placeholder="請輸入事由" />
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium">地點</label>
                                                <input type="text" id="mod-location" class="w-full border border-gray-300 rounded-md p-2" placeholder="請輸入地點" value="${recLocationName}" />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium">備註</label>
                                            <input type="text" id="mod-note" class="w-full border border-gray-300 rounded-md p-2" placeholder="請填寫申請原因/說明" />
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-4">
                                        <button id="mod-cancel" class="px-3 py-2 border rounded-md">取消</button>
                                        <button id="mod-submit" class="px-3 py-2 bg-orange-600 text-white rounded-md">送出審核</button>
                                    </div>
                                `;
                                document.body.appendChild(backdrop);
                                document.body.appendChild(modal);
                                const typeSelect = modal.querySelector('#mod-type');
                                const reasonInput = modal.querySelector('#mod-reason');
                                const locInput = modal.querySelector('#mod-location');
                                const toggle = () => {
                                    const need = ['外出','抵達','離開'].includes(typeSelect.value);
                                    modal.querySelector('#mod-extra').style.display = need ? 'grid' : 'none';
                                };
                                typeSelect.addEventListener('change', toggle); toggle();
                                modal.querySelector('#mod-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                modal.querySelector('#mod-submit').addEventListener('click', async () => {
                                    try {
                                        const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                                        if (!user) { showToast('尚未登入', true); return; }
                                        const dateStr = modal.querySelector('#mod-date').value;
                                        const timeStr = modal.querySelector('#mod-time').value;
                                        const type = typeSelect.value;
                                        const reason = (reasonInput.value || '').trim();
                                        const locationName = (locInput.value || '').trim();
                                        if (!dateStr || !timeStr) { showToast('請填寫日期與時間', true); return; }
                                        if (['外出','抵達','離開'].includes(type) && (!reason || !locationName)) { showToast('外出/抵達/離開需填寫事由與地點', true); return; }
                                        const dt = new Date(`${dateStr}T${timeStr}:00`);
                                        const payload = {
                                            userId: user.uid,
                                            type,
                                            reason: reason || '',
                                            locationName: locationName || '',
                                            requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                                            targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                                            status: 'pending'
                                        };
                                        await addDoc(collection(db, 'retroClockRequests'), payload);
                                        showToast('已送出修改申請');
                                        backdrop.remove(); modal.remove();
                                    } catch (err) {
                                        console.error('送出申請失敗', err);
                                        showToast('送出申請失敗，請稍後再試', true);
                                    }
                                });
                            });
                        });
                        
                        document.querySelectorAll('.photo-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                openPhotoModal(photos, descriptions);
                            });
                        });
                    }, (error) => {
                        const recordsListEl = document.getElementById('records-list');
                        const expectedCodes = ['permission-denied','failed-precondition','invalid-argument'];
                        if (expectedCodes.includes(error?.code)) {
                            console.warn("讀取 clockInRecords 失敗:", error?.code, error?.message || error);
                        } else {
                            console.error("Error fetching records: ", error);
                        }
                        if (recordsListEl) {
                            (async () => {
                                try {
                                    const { doc, getDoc, collection, query, where, getDocs } = window.__fs; const db2 = window.__db;
                                    const uid = state.currentUser?.uid || window.__auth?.currentUser?.uid;
                                    if (!uid) { recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄</p>`; return; }

                                    // Fallback：僅以 userId 讀取紀錄，再在前端依月份過濾
                                    const q2 = query(collection(db2, 'clockInRecords'), where('userId', '==', uid));
                                    const snap2 = await getDocs(q2);
                                    const records = [];
                                    snap2.forEach(d => { records.push({ id: d.id, ...d.data() }); });
                                    const filtered = records.filter(r => {
                                        const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                                        return ts && ts >= startOfMonth && ts <= endOfMonth;
                                    }).sort((a, b) => {
                                        const timeA = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                                        const timeB = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                                        return timeB - timeA;
                                    });

                                    if (filtered.length > 0) {
                                        recordsListEl.innerHTML = '';
                                        filtered.forEach(record => {
                                            const card = document.createElement('div');
                                            card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
                                            const statusText = getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null);
                                            const statusColor = getStatusColor(statusText);
                                            const abnormalInfo = computeRecordAbnormal(record, state.currentUserData?.serviceCommunities || []);
                                            const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                                                ? `<div class="mt-1 flex items-center"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">打卡位置異常</span>${abnormalInfo.detail ? `<span class="ml-2 text-xs text-gray-500">${abnormalInfo.detail}</span>` : ''}</div>`
                                                : '';
                                            card.innerHTML = `
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                                        <p class="text-sm text-gray-600">${formatDate(record.timestamp)}</p>
                                                        ${abnormalHtml}
                                                    </div>
                                                </div>
                                                <div class="mt-2 flex space-x-2 overflow-x-auto">
                                                    <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                                        <i data-lucide="image"></i> 照片 (${(record.photoUrls?.length || 0)})
                                                    </button>
                                                    <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                                        <i data-lucide="map-pin"></i> 地圖
                                                    </button>
                                                    <button class="apply-mod-btn bg-orange-500 text-white px-2 py-1 rounded text-sm"
                                                        data-id="${record.id}"
                                                        data-type="${record.type || ''}"
                                                        data-ts="${(record.timestamp?.toMillis ? record.timestamp.toMillis() : (record.timestamp?.seconds ? record.timestamp.seconds * 1000 : (record.timestamp ? (new Date(record.timestamp)).getTime() : Date.now())))}"
                                                        data-locationname="${record.locationName || ''}">
                                                        <i data-lucide="edit"></i> 申請修改
                                                    </button>
                                                </div>
                                            `;
                                            recordsListEl.appendChild(card);
                                        });
                                         
                                        try { lucide.createIcons(); } catch(e) {}
                                        document.querySelectorAll('.map-btn').forEach(btn => {
                                            btn.addEventListener('click', (e) => {
                                                const lat = parseFloat(e.currentTarget.dataset.lat);
                                                const lng = parseFloat(e.currentTarget.dataset.lng);
                                                if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                                                else showToast("無位置資訊可顯示", true);
                                            });
                                        });
                                        
                                        document.querySelectorAll('.apply-mod-btn').forEach(btn => {
                                            btn.addEventListener('click', async (e) => {
                                                const d = e.currentTarget.dataset;
                                                const tsMillis = parseInt(d.ts || '0', 10);
                                                const ts = Number.isFinite(tsMillis) && tsMillis > 0 ? new Date(tsMillis) : new Date();
                                                const recTypeRaw = d.type || '';
                                                const recLocationName = d.locationname || '';
                                                const typeMap = { clock_in: '上班', clock_out: '下班', out: '外出', arrive: '抵達', leave: '離開', return: '返回' };
                                                const recType = typeMap[recTypeRaw] || recTypeRaw;
                                                const backdrop = document.createElement('div');
                                                backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                                                const modal = document.createElement('div');
                                                modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[92%] max-w-[560px]';
                                                modal.innerHTML = `
                                                    <h3 class="text-lg font-bold mb-3">申請修改打卡資料</h3>
                                                    <div class="space-y-3">
                                                        <div class="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label class="text-sm font-medium">日期</label>
                                                                <input type="date" id="mod-date" class="w-full border border-gray-300 rounded-md p-2" value="${ts.toISOString().split('T')[0]}" />
                                                            </div>
                                                            <div>
                                                                <label class="text-sm font-medium">時間</label>
                                                                <input type="time" id="mod-time" class="w-full border border-gray-300 rounded-md p-2" value="${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}" />
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="text-sm font-medium">項目</label>
                                                            <select id="mod-type" class="w-full border border-gray-300 rounded-md p-2">
                                                                <option value="上班" ${recType==='上班' ? 'selected' : ''}>上班</option>
                                                                <option value="下班" ${recType==='下班' ? 'selected' : ''}>下班</option>
                                                                <option value="外出" ${recType==='外出' ? 'selected' : ''}>外出</option>
                                                                <option value="抵達" ${recType==='抵達' ? 'selected' : ''}>抵達</option>
                                                                <option value="離開" ${recType==='離開' ? 'selected' : ''}>離開</option>
                                                                <option value="返回" ${recType==='返回' ? 'selected' : ''}>返回</option>
                                                            </select>
                                                        </div>
                                                        <div id="mod-extra" class="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label class="text-sm font-medium">事由</label>
                                                                <input type="text" id="mod-reason" class="w-full border border-gray-300 rounded-md p-2" placeholder="請輸入事由" />
                                                            </div>
                                                            <div>
                                                                <label class="text-sm font-medium">地點</label>
                                                                <input type="text" id="mod-location" class="w-full border border-gray-300 rounded-md p-2" placeholder="請輸入地點" value="${recLocationName}" />
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="text-sm font-medium">備註</label>
                                                            <input type="text" id="mod-note" class="w-full border border-gray-300 rounded-md p-2" placeholder="請填寫申請原因/說明" />
                                                        </div>
                                                    </div>
                                                    <div class="flex justify-end gap-2 mt-4">
                                                        <button id="mod-cancel" class="px-3 py-2 border rounded-md">取消</button>
                                                        <button id="mod-submit" class="px-3 py-2 bg-orange-600 text-white rounded-md">送出審核</button>
                                                    </div>
                                                `;
                                                document.body.appendChild(backdrop);
                                                document.body.appendChild(modal);
                                                const typeSelect = modal.querySelector('#mod-type');
                                                const reasonInput = modal.querySelector('#mod-reason');
                                                const locInput = modal.querySelector('#mod-location');
                                                const toggle = () => {
                                                    const need = ['外出','抵達','離開'].includes(typeSelect.value);
                                                    modal.querySelector('#mod-extra').style.display = need ? 'grid' : 'none';
                                                };
                                                typeSelect.addEventListener('change', toggle); toggle();
                                                modal.querySelector('#mod-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                                backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                                modal.querySelector('#mod-submit').addEventListener('click', async () => {
                                                    try {
                                                        const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                                                        if (!user) { showToast('尚未登入', true); return; }
                                                        const dateStr = modal.querySelector('#mod-date').value;
                                                        const timeStr = modal.querySelector('#mod-time').value;
                                                        const type = typeSelect.value;
                                                        const reason = (reasonInput.value || '').trim();
                                                        const locationName = (locInput.value || '').trim();
                                                        if (!dateStr || !timeStr) { showToast('請填寫日期與時間', true); return; }
                                                        if (['外出','抵達','離開'].includes(type) && (!reason || !locationName)) { showToast('外出/抵達/離開需填寫事由與地點', true); return; }
                                                        const dt = new Date(`${dateStr}T${timeStr}:00`);
                                                        const payload = {
                                                            userId: user.uid,
                                                            type,
                                                            reason: reason || '',
                                                            locationName: locationName || '',
                                                            requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                                                            targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                                                            status: 'pending'
                                                        };
                                                        await addDoc(collection(db, 'retroClockRequests'), payload);
                                                        showToast('已送出修改申請');
                                                        backdrop.remove(); modal.remove();
                                                    } catch (err) {
                                                        console.error('送出申請失敗', err);
                                                        showToast('送出申請失敗，請稍後再試', true);
                                                    }
                                                });
                                            });
                                        });
                                        
                                        document.querySelectorAll('.photo-btn').forEach(btn => {
                                            btn.addEventListener('click', (e) => {
                                                const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                                const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                                openPhotoModal(photos, descriptions);
                                            });
                                        });
                                    } else {
                                        const userRef = doc(db2, 'users', uid);
                                        const userSnap = await getDoc(userRef);
                                        if (userSnap.exists() && userSnap.data().clockInStatus) {
                                            const u = userSnap.data();
                                            const ts = u.lastUpdated?.toDate?.() || (u.lastUpdated ? new Date(u.lastUpdated) : null);
                                            if (ts && ts >= startOfMonth && ts <= endOfMonth) {
                                                const statusText = getStatusDisplayText(u.clockInStatus, u.outboundLocation || null, u.dutyType || null);
                                                const statusColor = getStatusColor(statusText);
                                                recordsListEl.innerHTML = `
                                                    <div class="bg-white p-3 rounded-lg shadow-sm border mb-3">
                                                        <div class="flex justify-between items-start">
                                                            <div>
                                                                <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                                                <p class="text-sm text-gray-600">${ts ? formatDate(ts) : ''}</p>
                                                            </div>
                                                        </div>
                                                        <div class="mt-2 text-xs text-gray-400">來源：使用者狀態快照（clockInRecords 建立失敗）</div>
                                                    </div>`;
                                                try { lucide.createIcons(); } catch(e){}
                                            } else {
                                                const hint = (error?.code === 'failed-precondition') ? '可能需要建立複合索引（userId + timestamp）。' : '請確認 Firestore 規則與網路狀況。';
                                                recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄 ${hint}</p>`;
                                            }
                                        } else {
                                            const hint = (error?.code === 'failed-precondition') ? '可能需要建立複合索引（userId + timestamp）。' : '請確認 Firestore 規則與網路狀況。';
                                            recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄 ${hint}</p>`;
                                        }
                                    }
                                } catch (e2) {
                                    const hint = (error?.code === 'failed-precondition') ? '可能需要建立複合索引（userId + timestamp）。' : '請確認 Firestore 規則與網路狀況。';
                                    recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">本月無打卡紀錄 ${hint}</p>`;
                                }
                            })();
                        }
                    });

                    state.activeListeners.push(unsubscribe);
                };

                monthInput.addEventListener('change', loadRecords);
                loadRecords();

                // 月報表：選擇月份彈窗
                const monthBtn = document.getElementById('open-month-report');
                monthBtn?.addEventListener('click', () => openMonthReportModal());

                function openMonthReportModal() {
                    const now = new Date();
                    const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md overflow-hidden">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between">
                                <h3 class="font-semibold">選擇月份</h3>
                                <button class="close-month-modal">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="p-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">月份</label>
                                    <input type="month" id="month-input" value="${ym}" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button class="close-month-modal px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">取消</button>
                                    <button id="gen-month-report" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">生成月報表</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    try { lucide.createIcons(); } catch(e) {}
                    modal.querySelectorAll('.close-month-modal').forEach(btn => btn.addEventListener('click', () => document.body.removeChild(modal)));
                    document.getElementById('gen-month-report').addEventListener('click', async () => {
                        const mi = document.getElementById('month-input').value;
                        if (!mi) { showToast('請選擇月份', true); return; }
                        document.body.removeChild(modal);
                        await generateMonthlyReport(mi);
                    });
                }

                async function generateMonthlyReport(ymStr) {
                    // ymStr: YYYY-MM
                    const [yearStr, monthStr] = ymStr.split('-');
                    const year = parseInt(yearStr, 10); const monthIndex = parseInt(monthStr, 10) - 1; // 0-based
                    const start = new Date(year, monthIndex, 1, 0, 0, 0, 0);
                    const end = new Date(year, monthIndex + 1, 0, 23, 59, 59, 999);

                    // 讀取該月打卡紀錄（本人）
                    const { collection, where, query, getDocs, Timestamp } = window.__fs; const db = window.__db;
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex, 1)) : start;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex + 1, 0, 23, 59, 59, 999)) : end;
                    const q = query(
                        collection(db, 'clockInRecords'),
                        where('userId', '==', state.currentUser.uid),
                        where('timestamp', '>=', startTS),
                        where('timestamp', '<=', endTS)
                    );
                    const snap = await getDocs(q);
                    const allRecords = [];
                    snap.forEach(d => allRecords.push({ id: d.id, ...d.data() }));

                    // 請假資料（覆蓋該月任何一天）
                    let leaves = [];
                    try {
                        const lq = query(collection(db, 'leaves'), where('userId','==', state.currentUser.uid));
                        const ls = await getDocs(lq);
                        ls.forEach(doc => leaves.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('讀取請假失敗', e); }

                    // 特殊勤務（值班）資料
                    let duties = [];
                    try {
                        const dq = query(collection(db, 'specialDuties'), where('userId','==', state.currentUser.uid));
                        const ds = await getDocs(dq);
                        ds.forEach(doc => duties.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('讀取特殊勤務失敗', e); }

                    // 讀取週五值班名單（設定），用於判斷本人的值班日
                    let fridayDutyRoster = {};
                    try {
                        const { doc, getDoc } = window.__fs || {};
                        if (doc && getDoc && db) {
                            const settingsRef = doc(db, 'settings', 'general');
                            const settingsSnap = await getDoc(settingsRef);
                            fridayDutyRoster = settingsSnap.exists() ? (settingsSnap.data().fridayDutyRoster || {}) : {};
                        }
                    } catch (e) { console.warn('讀取值班名單失敗', e); }

                    // 準備列印容器
                    const old = document.getElementById('monthly-report-container');
                    if (old) old.remove();
                    const container = document.createElement('div');
                    container.id = 'monthly-report-container';
                    container.className = 'fixed inset-0 z-50 bg-white';
                    const name = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                    const ymTag = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                    const titleText = `${ymTag}出勤紀錄-${name}`;
                    container.innerHTML = `
                        <div class="bg-white w-full h-full flex flex-col">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between shrink-0">
                                <h3 class="font-semibold">${titleText}</h3>
                                <div class="space-x-2">
                                    <button id="print-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">列印</button>
                                    <button id="close-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">關閉</button>
                                </div>
                            </div>
                            <div class="p-4 flex-1 overflow-auto">
                                <div id="month-report-content" class="mx-auto" style="width:190mm">
                                    <div id="month-report-inner" style="transform-origin: top left;">
                                        <h2 class="text-xl font-bold mb-2 text-center">${titleText}</h2>
                                        <table class="w-full border border-gray-300 text-sm">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border px-2 py-1">日期</th>
                                                    <th class="border px-2 py-1">星期幾</th>
                                                    <th class="border px-2 py-1">當日上班狀態+打卡時間</th>
                                                    <th class="border px-2 py-1">當日下班狀態+打卡時間</th>
                                                    <th class="border px-2 py-1">總時數</th>
                                                    <th class="border px-2 py-1">外出次數</th>
                                                    <th class="border px-2 py-1">假日/請假日/值班</th>
                                                </tr>
                                            </thead>
                                            <tbody id="month-report-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(container);

                    // 填充表格
                    const weekdayZh = ['日','一','二','三','四','五','六'];
                    const bodyEl = container.querySelector('#month-report-body');
                    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dayStart = new Date(year, monthIndex, d, 0, 0, 0, 0);
                        const dayEnd = new Date(year, monthIndex, d, 23, 59, 59, 999);
                        const w = dayStart.getDay();
                        const dateLabel = `${year}-${String(monthIndex+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                        const records = allRecords.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= dayStart && ts <= dayEnd;
                        }).sort((a,b) => {
                            const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return ta - tb;
                        });

                        // 上班狀態/時間：優先「上班」，若無則取第一個「外出」
                        let startRecord = records.find(r => (r.type === '上班')) || records.find(r => (r.type === '外出')) || null;
                        let endRecord = records.slice().reverse().find(r => (r.type === '下班')) || null;
                        const fmt = (dt) => dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
                        const startTime = startRecord ? (startRecord.timestamp?.toDate?.() || new Date(startRecord.timestamp)) : null;
                        const endTime = endRecord ? (endRecord.timestamp?.toDate?.() || new Date(endRecord.timestamp)) : null;
                        const startText = startRecord ? `${startRecord.type}${startTime ? ' '+fmt(startTime) : ''}` : '';
                        const endText = endRecord ? `${endRecord.type}${endTime ? ' '+fmt(endTime) : ''}` : '';

                        // 總時數
                        let totalHours = '';
                        if (startTime && endTime && endTime > startTime) {
                            const diffMs = endTime - startTime;
                            totalHours = (diffMs / 3600000).toFixed(2);
                        }

                        // 外出次數
                        const outboundCount = records.filter(r => r.type === '外出').length;

                        // 讀取使用者本月上班設定以判斷假日（若為值班日則不標示假日）
                        let indicators = [];
                        try {
                            const ymId = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                            const { doc, getDoc } = window.__fs || {};
                            const db = window.__db;
                            if (doc && getDoc && db) {
                                const ref = doc(db, 'users', state.currentUser.uid, 'workdays', ymId);
                                const snap = await getDoc(ref);
                                const days = snap.exists() ? (snap.data().days || []) : [];
                                const set = new Set(days.map(n => Number(n)));
                                // 值班判定（特殊勤務或在週五值班名單內）
                                const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                const isDutyBySpecial = duties.some(di => {
                                    const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                    const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                    if (!s || !e) return false;
                                    return s < nextDay && e > dayStart;
                                });
                                const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                                const names = fridayDutyRoster[dateLabel] || [];
                                const normalize = (s) => (s || '').trim();
                                const isRosterDuty = Array.isArray(names) && names.some(n => normalize(n) === normalize(myName));
                                const isDuty = isDutyBySpecial || isRosterDuty;
                                // 非值班且不在使用者自訂工作日，才標示假日
                                if (!isDuty && !set.has(d)) indicators.push('假日');
                            } else {
                                // 後備判斷：週末為假日
                                // 若為值班則不標示假日
                                const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                const isDutyBySpecial = duties.some(di => {
                                    const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                    const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                    if (!s || !e) return false;
                                    return s < nextDay && e > dayStart;
                                });
                                const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                                const names = fridayDutyRoster[dateLabel] || [];
                                const normalize = (s) => (s || '').trim();
                                const isRosterDuty = Array.isArray(names) && names.some(n => normalize(n) === normalize(myName));
                                const isDuty = isDutyBySpecial || isRosterDuty;
                                if (!isDuty && (w === 6 || w === 0)) indicators.push('假日');
                            }
                        } catch(e) {
                            // 讀取失敗，維持週末為假日
                            const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                            const isDutyBySpecial = duties.some(di => {
                                const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay && e > dayStart;
                            });
                            const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                            const names = fridayDutyRoster[dateLabel] || [];
                            const normalize = (s) => (s || '').trim();
                            const isRosterDuty = Array.isArray(names) && names.some(n => normalize(n) === normalize(myName));
                            const isDuty = isDutyBySpecial || isRosterDuty;
                            if (!isDuty && (w === 6 || w === 0)) indicators.push('假日');
                        }
                        // 請假日（時間範圍相交）
                        const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                        const isLeave = leaves.some(l => {
                            const s = l.startTime?.toDate?.() || (l.startTime ? new Date(l.startTime) : null);
                            const e = l.endTime?.toDate?.() || (l.endTime ? new Date(l.endTime) : null);
                            if (!s || !e) return false;
                            return s < nextDay && e > dayStart; // overlap
                        });
                        if (isLeave) indicators.push('請假日');
                        // 值班（有當日特殊勤務）
                        const isDutyBySpecial = duties.some(di => {
                            const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                            const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                            if (!s || !e) return false;
                            return s < nextDay && e > dayStart; // overlap
                        });
                        const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                        const rosterNames = fridayDutyRoster[dateLabel] || [];
                        const normalizeName = (s) => (s || '').trim();
                        const isRosterDuty = Array.isArray(rosterNames) && rosterNames.some(n => normalizeName(n) === normalizeName(myName));
                        const isDutyFinal = isDutyBySpecial || isRosterDuty;
                        if (isDutyFinal) indicators.push('值班');

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="border px-2 py-1">${dateLabel}</td>
                            <td class="border px-2 py-1">${weekdayZh[w]}</td>
                            <td class="border px-2 py-1">${startText}</td>
                            <td class="border px-2 py-1">${endText}</td>
                            <td class="border px-2 py-1">${totalHours}</td>
                            <td class="border px-2 py-1 text-center">${outboundCount}</td>
                            <td class="border px-2 py-1">${indicators.join('、')}</td>`;
                        bodyEl.appendChild(tr);
                    }

                    // 注入列印樣式（A4、靠上對齊、水平置中，僅顯示報表內容）
                    if (!document.getElementById('monthly-report-print-style')) {
                        const style = document.createElement('style');
                        style.id = 'monthly-report-print-style';
                        style.textContent = `
                        @page { size: A4; margin: 10mm; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            body > * { display: none !important; }
                            #monthly-report-container { display: block !important; position: static !important; }
                            #monthly-report-container .px-4.py-3.bg-indigo-600 { display: none !important; }
                            #monthly-report-container .p-4.flex-1 { padding: 0 !important; }
                            #month-report-content { width: 190mm !important; margin: 0 auto !important; }
                            table { border-collapse: collapse; }
                            th, td { font-size: 11px; line-height: 1.2; padding: 2px 4px; }
                        }
                        `;
                        document.head.appendChild(style);
                    }

                    container.querySelector('#close-month-report').addEventListener('click', () => container.remove());
                    container.querySelector('#print-month-report').addEventListener('click', () => {
                        window.print();
                    });
                    // 已取消 PDF 匯出功能
                }
            }

            async function initClockInMap() {
                const mapLoader = document.getElementById('map-loader');
                const mapDiv = document.getElementById('map');
                if(!mapDiv || !mapLoader) return;
                
                mapLoader.classList.remove('hide');
                state.currentLocation = null;
                
                // Geolocation requires secure context in modern browsers
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('非安全來源，可能導致 geolocation 或地圖無法使用');
                    const tip = document.createElement('div');
                    tip.className = 'p-2 text-yellow-700 text-xs';
                    tip.textContent = '提示：請以 https 或 localhost 開啟以使用定位功能';
                    mapDiv.parentElement?.insertBefore(tip, mapDiv);
                }

                if (!window.google || !window.google.maps) {
                    setTimeout(initClockInMap, 100);
                    return;
                }
                
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 0 
                        });
                    });
                    
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    state.currentLocation = coords;
                    
                    if (mapDiv.offsetWidth === 0 || mapDiv.offsetHeight === 0) {
                        mapDiv.style.width = '100%';
                        mapDiv.style.height = '300px';
                    }
                    
                    const map = new google.maps.Map(mapDiv, { 
                        center: coords, 
                        zoom: 17, 
                        disableDefaultUI: true 
                    });
                    
                    new google.maps.Marker({ 
                        position: coords, 
                        map: map 
                    });
                    
                    mapLoader.classList.add('hide');
                } catch (error) {
                    console.error("初始化地圖時發生錯誤:", error);
                    mapDiv.innerHTML = `<div class="p-4 text-center text-red-500">無法取得您的位置。請確認已開啟定位服務。</div>`;
                    mapLoader.classList.add('hide');
                    showToast("無法取得位置資訊，請確認已開啟定位服務", true);
                }
            }
            
            function renderTracking(subPage, params = {}) {
                const role = state.currentUserData?.role || '';
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="map" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'map' || !subPage ? 'active' : ''}">人員地圖</button>
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">出勤紀錄</button>
                        <button data-subtab="leave" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'leave' ? 'active' : ''}">假單審核</button>
                        <button data-subtab="retro" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'retro' ? 'active' : ''}">修改申請</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'attendance') {
                    renderTrackingAttendance(subPageContent, params);
                } else if (subPage === 'leave') {
                    renderTrackingLeave(subPageContent);
                } else if (subPage === 'retro') {
                    renderRetroApprovals(subPageContent);
                } else {
                    renderTrackingMap(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('tracking', btn.dataset.subtab)));
            }

            // 補打卡申請表單
            function renderRetroClockRequestForm(container) {
                const todayStr = new Date().toISOString().split('T')[0];
                container.innerHTML = `
                    <div class="p-4 h-full">
                        <div class="bg-white rounded-lg shadow-sm border p-4 space-y-4">
                            <h2 class="text-lg font-bold">補打卡申請</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">日期</label>
                                    <input type="date" id="retro-date" value="${todayStr}" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">時間</label>
                                    <input type="time" id="retro-time" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">項目</label>
                                    <select id="retro-type" class="w-full border border-gray-300 rounded-md p-2">
                                        <option value="上班">上班</option>
                                        <option value="下班">下班</option>
                                        <option value="外出">外出</option>
                                        <option value="抵達">抵達</option>
                                        <option value="離開">離開</option>
                                        <option value="返回">返回</option>
                                    </select>
                                </div>
                            </div>
                            <div id="retro-extra" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">事由</label>
                                    <input type="text" id="retro-reason" placeholder="請輸入事由" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">地點</label>
                                    <input type="text" id="retro-location" placeholder="請輸入地點" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button id="retro-submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">送出申請</button>
                            </div>
                        </div>
                        <div id="retro-submit-status" class="mt-3 text-sm text-gray-500"></div>
                        <div class="mt-4 bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold">我的申請列表</h3>
                                <span class="text-sm text-gray-500">顯示本人已提交補打卡</span>
                            </div>
                            <div id="my-retro-list" class="space-y-3"></div>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch (e) {}
                const typeEl = document.getElementById('retro-type');
                const reasonEl = document.getElementById('retro-reason');
                const locEl = document.getElementById('retro-location');
                const toggleExtra = () => {
                    const t = typeEl.value;
                    const needExtra = ['外出','抵達','離開'].includes(t);
                    reasonEl.parentElement.style.display = needExtra ? 'block' : 'none';
                    locEl.parentElement.style.display = needExtra ? 'block' : 'none';
                };
                typeEl.addEventListener('change', toggleExtra);
                toggleExtra();

                document.getElementById('retro-submit').addEventListener('click', async () => {
                    const dateStr = document.getElementById('retro-date').value;
                    const timeStr = document.getElementById('retro-time').value;
                    const type = typeEl.value;
                    const reason = reasonEl.value.trim();
                    const locationName = locEl.value.trim();
                    if (!dateStr || !timeStr) { showToast('請填寫日期與時間', true); return; }
                    if (['外出','抵達','離開'].includes(type)) {
                        if (!reason || !locationName) { showToast('外出/抵達/離開需填寫事由與地點', true); return; }
                    }
                    const dt = new Date(`${dateStr}T${timeStr}:00`);
                    const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                    if (!user) { showToast('尚未登入', true); return; }
                    const payload = {
                        userId: user.uid,
                        type,
                        reason: reason || '',
                        locationName: locationName || '',
                        requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                        targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                        status: 'pending'
                    };
                    try {
                        await addDoc(collection(db, 'retroClockRequests'), payload);
                        showToast('已送出補打卡申請');
                        document.getElementById('retro-submit-status').textContent = '申請已送出，待管理員審核';
                        try { await renderMyRetroRequests(); } catch (e) {}
                    } catch (e) {
                        console.error('送出補打卡申請失敗', e);
                        showToast('送出申請失敗', true);
                    }
                });

                // 我的申請列表（本人）
                async function renderMyRetroRequests() {
                    const listEl = document.getElementById('my-retro-list');
                    if (!listEl) return;
                    listEl.innerHTML = `<div class="p-2 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>載入中...</div></div>`;
                    try {
                        const { collection, query, where, orderBy, getDocs } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                        if (!user) { listEl.innerHTML = '<p class="text-sm text-red-600">請先登入</p>'; return; }
                        const qs = await getDocs(query(collection(db, 'retroClockRequests'), where('userId','==', user.uid), orderBy('requestedAt', 'desc')));
                        if (qs.empty) { listEl.innerHTML = '<p class="text-sm text-gray-500">尚無申請</p>'; return; }
                        listEl.innerHTML = '';
                        qs.forEach(docSnap => {
                            const r = { id: docSnap.id, ...docSnap.data() };
                            const when = r.targetTime?.toDate?.() ? r.targetTime.toDate() : (r.targetTime ? new Date(r.targetTime) : null);
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded-md bg-white flex items-center justify-between';
                            item.innerHTML = `
                                <div>
                                    <p class=\"font-medium text-gray-800\">${r.type}</p>
                                    <p class=\"text-sm text-gray-600\">${when ? when.toLocaleString('zh-TW', { hour12: false }) : ''}</p>
                                    ${r.locationName ? `<p class=\"text-xs text-gray-500\">地點：${r.locationName}</p>` : ''}
                                    ${r.reason ? `<p class=\"text-xs text-gray-500\">事由：${r.reason}</p>` : ''}
                                </div>
                                <span class=\"text-sm ${r.status==='approved' ? 'text-green-600' : (r.status==='rejected' ? 'text-red-600' : 'text-gray-500')}\">${r.status || 'pending'}</span>`;
                            listEl.appendChild(item);
                        });
                    } catch (e) {
                        console.error('載入申請列表失敗', e);
                        listEl.innerHTML = '<p class="text-sm text-red-600">載入失敗</p>';
                    } finally { try { lucide.createIcons(); } catch(e) {} }
                }
                try { renderMyRetroRequests(); } catch(e) {}
            }

            // 補打申請審核頁面
            async function renderRetroApprovals(container) {
                container.innerHTML = `
                    <div class="p-4 h-full">
                        <div class="bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-bold">補打申請審核</h2>
                                <button id="manual-add-record" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">新增人員打卡紀錄</button>
                            </div>
                            <div class="mb-3 flex items-center gap-2">
                                <input type="date" id="retro-filter-date" class="border border-gray-300 rounded-md p-2">
                                <select id="retro-filter-user" class="border border-gray-300 rounded-md p-2 min-w-[180px]">
                                    <option value="">全部人員</option>
                                </select>
                            </div>
                            <div id="retro-requests-list" class="space-y-3"></div>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch(e) {}
                const { collection, query, where, orderBy, getDocs, addDoc, updateDoc, doc, Timestamp, GeoPoint } = window.__fs; const db = window.__db;
                const listEl = document.getElementById('retro-requests-list');
                const filterDateEl = document.getElementById('retro-filter-date');
                const filterUserEl = document.getElementById('retro-filter-user');

                // 載入人員下拉
                try {
                    const us = await getDocs(collection(db, 'users'));
                    us.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id; opt.textContent = d.data().name || d.id;
                        filterUserEl.appendChild(opt);
                    });
                } catch(e) {}

                async function renderList() {
                    listEl.innerHTML = `<div class="p-4 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>載入申請...</div></div>`;
                    try {
                        const qs = await getDocs(query(collection(db, 'retroClockRequests'), where('status','==','pending'), orderBy('requestedAt','desc')));
                        const selectedUser = filterUserEl.value || '';
                        const selectedDate = filterDateEl.value || '';
                        const items = [];
                        qs.forEach(docSnap => {
                            const req = { id: docSnap.id, ...docSnap.data() };
                            const when = req.targetTime?.toDate?.() ? req.targetTime.toDate() : (req.targetTime ? new Date(req.targetTime) : null);
                            const dateStr = when ? when.toISOString().split('T')[0] : '';
                            if (selectedUser && req.userId !== selectedUser) return;
                            if (selectedDate && dateStr !== selectedDate) return;
                            items.push({ ...req, when });
                        });
                        if (items.length === 0) { listEl.innerHTML = `<p class="text-center text-gray-500 p-4">無符合條件的申請</p>`; return; }
                        // 載入使用者名稱映射
                        const userMap = {};
                        try {
                            const us = await getDocs(collection(db, 'users'));
                            us.forEach(d => userMap[d.id] = d.data().name || d.id);
                        } catch(e) {}
                        listEl.innerHTML = '';
                        items.forEach(req => {
                            const userName = userMap[req.userId] || req.userId;
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded-md bg-white flex items-center justify-between';
                            item.innerHTML = `
                                <div>
                                    <p class=\"font-medium text-gray-800\">${userName}</p>
                                    <p class=\"text-sm text-gray-600\">${req.type} · ${req.when ? req.when.toLocaleString('zh-TW', { hour12: false }) : ''}</p>
                                    ${req.locationName ? `<p class=\"text-xs text-gray-500\">地點：${req.locationName}</p>` : ''}
                                    ${req.reason ? `<p class=\"text-xs text-gray-500\">事由：${req.reason}</p>` : ''}
                                </div>
                                <div class=\"flex items-center space-x-2\">
                                    <button class=\"approve-btn px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700\" data-id=\"${req.id}\">同意</button>
                                    <button class=\"reject-btn px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700\" data-id=\"${req.id}\">不同意</button>
                                </div>`;
                            listEl.appendChild(item);
                        });
                        try { lucide.createIcons(); } catch(e) {}
                        // 綁定事件
                        const canReview = await (window.checkReviewerStatus ? window.checkReviewerStatus() : (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)));
                        const handleApprove = async (id) => {
                            if (!canReview) { showToast('僅管理員/人事/高階主管可審核', true); return; }
                            try {
                                const reqDoc = await window.__fs.getDoc(window.__fs.doc(db, 'retroClockRequests', id));
                                if (!reqDoc.exists()) { showToast('申請不存在', true); return; }
                                const r = reqDoc.data();
                                const ts = r.targetTime?.toDate?.() ? r.targetTime.toDate() : (r.targetTime ? new Date(r.targetTime) : new Date());
                                await addDoc(collection(db, 'clockInRecords'), {
                                    userId: r.userId,
                                    type: r.type,
                                    timestamp: Timestamp?.fromDate ? Timestamp.fromDate(ts) : ts,
                                    location: GeoPoint ? new GeoPoint(0,0) : { latitude: 0, longitude: 0 },
                                    photoUrls: [],
                                    descriptions: [],
                                    deviceId: 'retro',
                                    locationName: r.locationName || null,
                                    dutyType: null,
                                    isAutomatic: false
                                });
                                // 同步更新 users 狀態，讓儀錶板與定位打卡按鈕正確顯示
                                try {
                                    const newStatus = r.type; // 可能為：上班/下班/外出/抵達/離開/返回
                                    const updatePayload = {
                                        status: newStatus,
                                        clockInStatus: newStatus,
                                        lastUpdated: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                    };
                                    // 核准「上班」補打卡時，更新 lastClockInTime 供排序與顯示
                                    if (newStatus === '上班') {
                                        updatePayload.lastClockInTime = Timestamp?.fromDate ? Timestamp.fromDate(ts) : ts;
                                    }
                                    // 外出/抵達/離開可更新外出地點文字（若有）
                                    if (newStatus === '外出' || newStatus === '抵達' || newStatus === '離開') {
                                        updatePayload.outboundLocation = r.locationName || '';
                                    }
                                    await updateDoc(doc(db, 'users', r.userId), updatePayload);
                                } catch (e) {
                                    console.warn('更新使用者狀態失敗（已新增打卡紀錄，但 users 狀態未同步）', e);
                                }
                                await updateDoc(doc(db, 'retroClockRequests', id), {
                                    status: 'approved',
                                    reviewerId: window.__auth?.currentUser?.uid || null,
                                    reviewedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                });
                                showToast('已核准並新增打卡紀錄');
                                renderList();
                            } catch (e) {
                                console.error('核准失敗', e);
                                showToast('核准失敗', true);
                            }
                        };
                        const handleReject = async (id) => {
                            if (!canReview) { showToast('僅管理員/人事/高階主管可審核', true); return; }
                            try {
                                await updateDoc(doc(db, 'retroClockRequests', id), {
                                    status: 'rejected',
                                    reviewerId: window.__auth?.currentUser?.uid || null,
                                    reviewedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                });
                                showToast('已退回申請');
                                renderList();
                            } catch (e) {
                                console.error('退回失敗', e);
                                showToast('退回失敗', true);
                            }
                        };
                        container.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', (e) => handleApprove(e.currentTarget.dataset.id)));
                        container.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', (e) => handleReject(e.currentTarget.dataset.id)));
                    } catch (e) {
                        console.error('讀取補打申請失敗', e);
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">讀取失敗</p>`;
                    }
                }

                filterDateEl.addEventListener('change', renderList);
                filterUserEl.addEventListener('change', renderList);

                // 手動新增人員打卡紀錄（彈窗）
                document.getElementById('manual-add-record').addEventListener('click', () => {
                    const backdrop = document.createElement('div');
                    backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                    const modal = document.createElement('div');
                    modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[90%] max-w-[520px]';
                    modal.innerHTML = `
                        <h3 class=\"text-lg font-bold mb-3\">新增人員打卡紀錄</h3>
                        <div class=\"space-y-3\">
                            <div>
                                <label class=\"text-sm font-medium\">人員姓名</label>
                                <select id=\"manual-user\" class=\"w-full border border-gray-300 rounded-md p-2\"></select>
                            </div>
                            <div class=\"grid grid-cols-2 gap-3\">
                                <div>
                                    <label class=\"text-sm font-medium\">日期</label>
                                    <input type=\"date\" id=\"manual-date\" class=\"w-full border border-gray-300 rounded-md p-2\" />
                                </div>
                                <div>
                                    <label class=\"text-sm font-medium\">時間</label>
                                    <input type=\"time\" id=\"manual-time\" class=\"w-full border border-gray-300 rounded-md p-2\" />
                                </div>
                            </div>
                            <div>
                                <label class=\"text-sm font-medium\">項目</label>
                                <select id=\"manual-type\" class=\"w-full border border-gray-300 rounded-md p-2\">
                                    <option value=\"上班\">上班</option>
                                    <option value=\"下班\">下班</option>
                                    <option value=\"外出\">外出</option>
                                    <option value=\"抵達\">抵達</option>
                                    <option value=\"離開\">離開</option>
                                    <option value=\"返回\">返回</option>
                                </select>
                            </div>
                            <div id=\"manual-extra\" class=\"grid grid-cols-2 gap-3\">
                                <div>
                                    <label class=\"text-sm font-medium\">事由</label>
                                    <input type=\"text\" id=\"manual-reason\" class=\"w-full border border-gray-300 rounded-md p-2\" placeholder=\"請輸入事由\" />
                                </div>
                                <div>
                                    <label class=\"text-sm font-medium\">地點</label>
                                    <input type=\"text\" id=\"manual-location\" class=\"w-full border border-gray-300 rounded-md p-2\" placeholder=\"請輸入地點\" />
                                </div>
                            </div>
                        </div>
                        <div class=\"flex justify-end gap-2 mt-4\">
                            <button id=\"manual-cancel\" class=\"px-3 py-2 border rounded-md\">取消</button>
                            <button id=\"manual-submit\" class=\"px-3 py-2 bg-indigo-600 text-white rounded-md\">新增</button>
                        </div>
                    `;
                    document.body.appendChild(backdrop);
                    document.body.appendChild(modal);
                    // 填入人員
                    filterUserEl.querySelectorAll('option').forEach(opt => {
                        if (!opt.value) return;
                        const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.textContent;
                        modal.querySelector('#manual-user').appendChild(o);
                    });
                    const typeSelect = modal.querySelector('#manual-type');
                    const reasonInput = modal.querySelector('#manual-reason');
                    const locInput = modal.querySelector('#manual-location');
                    const toggle = () => {
                        const need = ['外出','抵達','離開'].includes(typeSelect.value);
                        modal.querySelector('#manual-extra').style.display = need ? 'grid' : 'none';
                    };
                    typeSelect.addEventListener('change', toggle); toggle();
                    modal.querySelector('#manual-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                    backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                    modal.querySelector('#manual-submit').addEventListener('click', async () => {
                        try {
                            const userId = modal.querySelector('#manual-user').value;
                            const dateStr = modal.querySelector('#manual-date').value;
                            const timeStr = modal.querySelector('#manual-time').value;
                            const type = typeSelect.value;
                            const reason = (reasonInput.value || '').trim();
                            const locationName = (locInput.value || '').trim();
                            if (!userId || !dateStr || !timeStr) { showToast('請完整填寫人員與日期時間', true); return; }
                            if (['外出','抵達','離開'].includes(type) && (!reason || !locationName)) { showToast('外出/抵達/離開需填寫事由與地點', true); return; }
                            const tsDate = new Date(`${dateStr}T${timeStr}:00`);
                            await addDoc(collection(db, 'clockInRecords'), {
                                userId,
                                type,
                                timestamp: Timestamp?.fromDate ? Timestamp.fromDate(tsDate) : tsDate,
                                location: GeoPoint ? new GeoPoint(0,0) : { latitude: 0, longitude: 0 },
                                photoUrls: [],
                                descriptions: [],
                                deviceId: 'manual-admin',
                                locationName: ['外出','抵達','離開'].includes(type) ? `${locationName}${reason ? '｜'+reason : ''}` : (locationName || null),
                                dutyType: null,
                                isAutomatic: false
                            });
                            // 同步使用者文件的狀態，讓儀表板即時顯示
                            try {
                                const userUpdate = {
                                    status: type,
                                    clockInStatus: type,
                                    lastUpdated: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                                    outboundLocation: ['外出','抵達','離開'].includes(type) ? `${locationName}${reason ? '｜'+reason : ''}` : null,
                                    dutyType: null
                                };
                                if (type === '上班') {
                                    userUpdate.lastClockInTime = Timestamp?.fromDate ? Timestamp.fromDate(tsDate) : tsDate;
                                }
                                await updateDoc(doc(db, 'users', userId), userUpdate);
                            } catch (uerr) {
                                console.warn('更新使用者狀態失敗（非致命）', uerr);
                            }
                            if (typeof updateDashboardStatus === 'function') {
                                try { updateDashboardStatus(); } catch {}
                            }
                            showToast('已新增打卡紀錄');
                            backdrop.remove(); modal.remove();
                        } catch (err) {
                            console.error('新增打卡失敗', err);
                            showToast('新增失敗', true);
                        }
                    });
                });

                await renderList();
            }

            // 人員分頁：帳號申請、帳號列表（各社區獨立內容）
            function renderHR(subPage) {
                const role = state.currentUserData?.role || '';
                // 依需求：人員頁只提供帳號申請、帳號列表
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="applications" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'applications' ? 'active' : ''}">帳號申請</button>
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">帳號列表</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else {
                    renderSettingsApplications(subPageContent);
                }
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('hr', btn.dataset.subtab)));
            }

            // 群組分頁：人員地圖、出勤紀錄（僅顯示指定成員）
            function renderGroup(subPage) {
                const role = state.currentUserData?.role || '';
                const isManagement = new Set(['admin','hr','manager','junior_manager']).has(role);
                const firstLabel = isManagement ? '巡邏任務' : '開始巡邏';
                const secondLabel = '巡邏紀錄';
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="map" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'map' || !subPage ? 'active' : ''}">${firstLabel}</button>
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">${secondLabel}</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'attendance') {
                    renderGroupAttendance(subPageContent);
                } else {
                    renderGroupMap(subPageContent);
                }
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('group', btn.dataset.subtab)));
            }

            function renderShifts(subPage) {
                const comm = state.currentCommunity;
                if (!comm || !comm.id) {
                    mainContent.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="home" class="w-8 h-8 mx-auto mb-3"></i>
                                <div>請先選擇社區後再進入排班頁</div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }
                const communityId = comm.id;

                const pageState = {
                    posts: [],
                    selectedPostId: null,
                    monthDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
                    monthDocsMap: {},
                    selectedDayIso: null,
                    roleFilter: null
                };

                const fmtYMD = (d) => {
                    const y = d.getFullYear();
                    const m = (d.getMonth()+1).toString().padStart(2,'0');
                    const day = d.getDate().toString().padStart(2,'0');
                    return `${y}-${m}-${day}`;
                };
                const parseHM = (s) => {
                    const [h,m] = (s||'00:00').split(':').map(x=>parseInt(x,10)||0);
                    return h*60+m;
                };
                const mergeIntervalsMinutes = (list) => {
                    if (!Array.isArray(list) || !list.length) return [];
                    const intervals = list.map(it => ({start: parseHM(it.start||'00:00'), end: parseHM(it.end||'00:00')}))
                        .filter(it => it.end>it.start)
                        .sort((a,b)=>a.start-b.start);
                    const merged = [];
                    for (const iv of intervals) {
                        if (!merged.length || iv.start > merged[merged.length-1].end) {
                            merged.push({start: iv.start, end: iv.end});
                        } else {
                            merged[merged.length-1].end = Math.max(merged[merged.length-1].end, iv.end);
                        }
                    }
                    return merged;
                };
                const hasOverlap = (list) => {
                    const intervals = list.map(it => ({start: parseHM(it.start||'00:00'), end: parseHM(it.end||'00:00')}))
                        .filter(it => it.end>it.start)
                        .sort((a,b)=>a.start-b.start);
                    for (let i=1;i<intervals.length;i++) {
                        if (intervals[i].start < intervals[i-1].end) return true;
                    }
                    return false;
                };
                const coverageMinutes = (list) => {
                    const merged = mergeIntervalsMinutes(list);
                    return merged.reduce((acc,iv)=>acc+(iv.end-iv.start),0);
                };

                // 排班異常邏輯已移除

                const renderShell = () => {
                    mainContent.innerHTML = `
                        <div class="h-[50px] flex items-center justify-between border-b border-gray-200 bg-white px-3">
                            <div id="shift-summary" class="flex items-center gap-2 flex-wrap">
                                <button class="px-2 py-1 text-xs rounded-md bg-amber-500 text-white" data-role="總幹事"><span id="count-gm">總幹事：0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-purple-500 text-white" data-role="秘書"><span id="count-sec">秘書：0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-green-700 text-white" data-role="保全"><span id="count-guard">保全：0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-pink-500 text-white" data-role="清潔"><span id="count-clean">清潔：0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-blue-500 text-white" data-role="機電"><span id="count-mech">機電：0</span></button>
                            </div>
                        </div>
                        <div class="overflow-y-auto" style="height: calc(100% - 50px);">
                            <div id="calendar-sticky" class="sticky top-0 z-10 bg-white" style="height: 50%;">
                                <div class="p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <button id="prev-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">上個月</button>
                                        <div id="shift-current-month-year" class="text-lg font-semibold"></div>
                                        <button id="next-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">下個月</button>
                                    </div>
                                    <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-1">
                                        <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                                    </div>
                                    <div id="shift-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                                </div>
                            </div>
                            <div class="p-3">
                                <div class="flex items-center justify-between mt-1 flex-nowrap">
                                    <div id="shift-list-title" class="text-xs font-medium whitespace-nowrap">每月班表列表</div>
                                    <div class="flex items-center gap-1 whitespace-nowrap">
                                        <button id="export-csv" class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50">匯出CSV</button>
                                        <button id="import-csv" class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50">匯入CSV</button>
                                        <button id="open-add-schedule" class="px-2 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700">新增排班</button>
                                        <input id="import-csv-input" type="file" accept=".csv,text/csv" class="hidden">
                                    </div>
                                </div>
                                <div id="shift-monthly-list" class="mt-2"></div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    // 綁定角色過濾按鈕
                    const summaryEl = document.getElementById('shift-summary');
                    const updateRoleButtonsActive = () => {
                        if (!summaryEl) return;
                        summaryEl.querySelectorAll('button[data-role]').forEach(b => {
                            const r = b.getAttribute('data-role');
                            const active = (pageState.roleFilter === r);
                            b.classList.toggle('ring-2', active);
                            b.classList.toggle('ring-offset-1', active);
                            b.classList.toggle('opacity-80', !active && pageState.roleFilter !== null);
                        });
                    };
                    if (summaryEl) {
                        summaryEl.querySelectorAll('button[data-role]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const role = btn.getAttribute('data-role');
                                pageState.roleFilter = (pageState.roleFilter === role) ? null : role;
                                updateRoleButtonsActive();
                                renderCalendar();
                                renderMonthlyList();
                            });
                        });
                        updateRoleButtonsActive();
                    }
                };

                const loadPosts = async () => {
                    try {
                        const qref = collection(db, 'communities', communityId, 'posts');
                        const snap = await getDocs(qref);
                        pageState.posts = [];
                        snap.forEach(d=> pageState.posts.push({ id: d.id, ...d.data() }));
                        if (!pageState.posts.length) {
                            // 初次無哨點：建立一個預設哨點
                            const defaultName = '哨點 A';
                            const newDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                communityId,
                                name: defaultName,
                                createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            });
                            pageState.posts.push({ id: newDoc.id, communityId, name: defaultName });
                        }
                        pageState.posts.sort((a,b)=> (a.createdAt?.toMillis?.()||0) - (b.createdAt?.toMillis?.()||0));
                        pageState.selectedPostId = pageState.selectedPostId || pageState.posts[0]?.id || null;
                        updateCounts();
                    } catch (e) {
                        console.warn('載入哨點失敗', e);
                        pageState.posts = [];
                        updateCounts();
                    }
                };

                const renderTabs = () => {
                    const tabsEl = document.getElementById('posts-tabs');
                    if (!tabsEl) return;
                    tabsEl.innerHTML = [
                        ...pageState.posts.map((p,i)=>`
                            <button class="px-3 py-1 rounded-md text-sm font-medium ${pageState.selectedPostId===p.id? 'bg-red-600 text-white':'bg-white text-gray-700 border'}" data-post="${p.id}" title="${p.name||'未命名哨點'}">
                                <span class="text-gray-500 mr-1">${i+1}</span>
                                <span class="post-name">${p.name||'未命名哨點'}</span>
                                <span class="ml-2 text-gray-400 hover:text-red-600 delete-post" title="刪除">×</span>
                            </button>
                        `),
                        `<button class="px-3 py-1 rounded-md text-sm font-medium bg-white text-gray-700 border" data-action="add" title="新增哨點">＋</button>`
                    ].join('');
                    // 切換哨點
                    tabsEl.querySelectorAll('button[data-post]').forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            pageState.selectedPostId = btn.getAttribute('data-post');
                            renderTabs();
                            renderPostTitle();
                            loadMonth().then(()=> { renderCalendar(); });
                        });
                        // 直覺式重命名（雙擊）
                        btn.addEventListener('dblclick', ()=>{
                            const postId = btn.getAttribute('data-post');
                            startRenameTab(btn, postId);
                        });
                        // 刪除哨點
                        const del = btn.querySelector('.delete-post');
                        if (del) del.addEventListener('click', async (e)=>{
                            e.stopPropagation();
                            const postId = btn.getAttribute('data-post');
                            await handleDeletePost(postId);
                        });
                    });

                    async function handleDeletePost(postId) {
                        if (!postId) return;
                        if (!confirm('確定刪除該哨點及其班表？')) return;
                        try {
                            // 刪除哨點模板（若仍存在）
                            const tplSnap = await getDocs(collection(db,'communities', communityId, 'posts', postId, 'templates'));
                            await Promise.all(tplSnap.docs.map(d=> deleteDoc(doc(db,'communities', communityId, 'posts', postId, 'templates', d.id))));
                            // 刪除該哨點所有班表
                            const schedSnap = await getDocs(query(collection(db,'communities', communityId, 'postSchedules'), where('postId','==', postId)));
                            await Promise.all(schedSnap.docs.map(d=> deleteDoc(doc(db,'communities', communityId, 'postSchedules', d.id))));
                            // 刪除哨點文件
                            await deleteDoc(doc(db,'communities', communityId, 'posts', postId));
                            // 更新本地狀態
                            pageState.posts = pageState.posts.filter(p=> p.id !== postId);
                            if (pageState.selectedPostId === postId) pageState.selectedPostId = pageState.posts[0]?.id || null;
                            updateCounts();
                            renderTabs();
                            await loadMonth();
                            renderCalendar();
                            renderDayPanel();
                            showToast('哨點已刪除');
                        } catch (e) { showToast('刪除哨點失敗', true); }
                    }
                    // 使用「＋」子分頁新增哨點
                    const plusBtn = tabsEl.querySelector('button[data-action="add"]');
                    if (plusBtn) plusBtn.addEventListener('click', async ()=>{
                        try {
                            const defaultName = '未命名哨點';
                            const newDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                communityId,
                                name: defaultName,
                                createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            });
                            pageState.posts.push({ id: newDoc.id, communityId, name: defaultName });
                            pageState.selectedPostId = newDoc.id;
                            updateCounts();
                            renderTabs();
                            // 自動進入重命名模式
                            const newTab = tabsEl.querySelector(`button[data-post="${newDoc.id}"]`);
                            if (newTab) startRenameTab(newTab, newDoc.id);
                            await loadMonth();
                            renderCalendar();
                        } catch (e) { showToast('新增哨點失敗', true); }
                    });

                    function startRenameTab(btn, postId) {
                        const nameEl = btn.querySelector('.post-name');
                        const current = nameEl ? nameEl.textContent : '';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = current;
                        input.className = 'px-2 py-1 text-sm border rounded';
                        btn.innerHTML = '';
                        btn.appendChild(input);
                        input.focus();
                        // 防止點擊輸入框觸發切換事件
                        input.addEventListener('click', (e)=> e.stopPropagation());

                        const commit = async (val) => {
                            const newName = (val || '').trim();
                            if (newName && newName !== current) {
                                try {
                                    await updateDoc(doc(db,'communities', communityId, 'posts', postId), {
                                        name: newName,
                                        updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                    });
                                    const p = pageState.posts.find(p=>p.id===postId);
                                    if (p) p.name = newName;
                                } catch (e) { showToast('重命名失敗', true); }
                            }
                            renderTabs();
                        };

                        input.addEventListener('keydown', (e)=>{
                            if (e.key === 'Enter') commit(input.value);
                            else if (e.key === 'Escape') renderTabs();
                        });
                        input.addEventListener('blur', ()=> commit(input.value));
                    }
                };

                const renderPostTitle = () => {
                    const el = document.getElementById('post-title');
                    if (!el) return;
                    const current = pageState.posts.find(p=>p.id===pageState.selectedPostId) || pageState.posts[0] || null;
                    const name = current?.name || '未命名哨點';
                    el.innerHTML = `<span id="post-title-text" class="cursor-pointer">${name}</span>`;
                    const span = document.getElementById('post-title-text');
                    if (span) {
                        span.addEventListener('dblclick', ()=> startRenameTitle(el, current?.id));
                    }
                };

                function startRenameTitle(container, postId) {
                    if (!container || !postId) return;
                    const current = (container.textContent || '').trim();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = current;
                    input.className = 'px-2 py-1 text-sm border rounded';
                    container.innerHTML = '';
                    container.appendChild(input);
                    input.focus();
                    const commit = async (val) => {
                        const newName = (val || '').trim();
                        if (newName && newName !== current) {
                            try {
                                await updateDoc(doc(db,'communities', communityId, 'posts', postId), {
                                    name: newName,
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                });
                                const p = pageState.posts.find(p=>p.id===postId);
                                if (p) p.name = newName;
                            } catch (e) { showToast('重命名失敗', true); }
                        }
                        renderTabs();
                        renderPostTitle();
                    };
                    input.addEventListener('keydown', (e)=>{
                        if (e.key === 'Enter') commit(input.value);
                        else if (e.key === 'Escape') renderPostTitle();
                    });
                    input.addEventListener('blur', ()=> commit(input.value));
                }

                const renderMonthHeader = () => {
                    const title = document.getElementById('shift-current-month-year');
                    if (!title) return;
                    const d = pageState.monthDate;
                    title.textContent = `${d.getFullYear()} 年 ${d.getMonth()+1} 月`;
                    const prev = document.getElementById('prev-month');
                    const next = document.getElementById('next-month');
                    // 使用 onclick 取代 addEventListener，避免重複綁定導致月份錯亂
                    if (prev) prev.onclick = ()=>{ pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()-1, 1); loadMonth().then(()=>{ renderMonthHeader(); renderCalendar(); renderMonthlyList(); }); };
                    if (next) next.onclick = ()=>{ pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()+1, 1); loadMonth().then(()=>{ renderMonthHeader(); renderCalendar(); renderMonthlyList(); }); };
                };

                const updateCounts = () => {
                    const list = (pageState.communityUsers || []);
                    const counts = { '總幹事': 0, '秘書': 0, '保全': 0, '清潔': 0, '機電': 0 };
                    for (const u of list) {
                        const r = (u.role || '').trim();
                        if (counts.hasOwnProperty(r)) counts[r] += 1;
                    }
                    const gmEl = document.getElementById('count-gm');
                    const secEl = document.getElementById('count-sec');
                    const guardEl = document.getElementById('count-guard');
                    const cleanEl = document.getElementById('count-clean');
                    const mechEl = document.getElementById('count-mech');
                    if (gmEl) gmEl.textContent = `總幹事：${counts['總幹事']}`;
                    if (secEl) secEl.textContent = `秘書：${counts['秘書']}`;
                    if (guardEl) guardEl.textContent = `保全：${counts['保全']}`;
                    if (cleanEl) cleanEl.textContent = `清潔：${counts['清潔']}`;
                    if (mechEl) mechEl.textContent = `機電：${counts['機電']}`;
                };

                const loadMonth = async () => {
                    pageState.monthDocsMap = {};
                    if (!pageState.selectedPostId) return;
                    try {
                        const q = query(collection(db,'communities', communityId, 'postSchedules'), where('postId','==', pageState.selectedPostId));
                        const snap = await getDocs(q);
                        const y = pageState.monthDate.getFullYear();
                        const m = pageState.monthDate.getMonth()+1; const ymStr = `${y}-${m.toString().padStart(2,'0')}-`;
                        snap.forEach(d=>{
                            const data = d.data();
                            const iso = (data.dateIso || '').toString();
                            if (iso.startsWith(ymStr)) pageState.monthDocsMap[iso] = { id: d.id, ...data };
                        });
                    } catch (e) { console.warn('載入班表失敗', e); }
                };

                const loadCommunityUsers = async () => {
                    try {
                        const users = [];
                        const communityCode = (comm && (comm.code || comm.communityCode)) ? (comm.code || comm.communityCode) : communityId;
                        const queries = [
                            query(collection(db,'users'), where('serviceCommunityCode','==', communityId)),
                            query(collection(db,'users'), where('serviceCommunityCode','==', communityCode)),
                            query(collection(db,'users'), where('serviceCommunityCodes','array-contains', communityId)),
                            query(collection(db,'users'), where('serviceCommunityCodes','array-contains', communityCode)),
                            // 兼容舊欄位：serviceCommunities（以社區代碼為元素）
                            query(collection(db,'users'), where('serviceCommunities','array-contains', communityId)),
                            query(collection(db,'users'), where('serviceCommunities','array-contains', communityCode)),
                        ];
                        for (const q of queries) {
                            try {
                                const s = await getDocs(q);
                                s.forEach(d=> { if (!users.find(u=>u.id===d.id)) users.push({ id: d.id, ...d.data() }); });
                            } catch (_) {}
                        }
                        // 僅依各社區帳號列表角色計數（總幹事、秘書、保全、清潔、機電）
                        const allowedRoles = new Set(['總幹事','秘書','保全','清潔','機電']);
                        const filtered = users.filter(u=> allowedRoles.has((u.role||'').trim()))
                                              .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                        pageState.communityUsers = filtered;
                        pageState.userOptionsHTML = filtered.map(u=>`<option value="${u.id}">${u.name||u.displayName||u.id}</option>`).join('');
                    } catch (e) { console.warn('載入社區成員失敗', e); pageState.communityUsers = []; pageState.userOptionsHTML = ''; }
                    updateCounts();
                };

                const renderCalendar = () => {
                    const grid = document.getElementById('shift-calendar-grid');
                    if (!grid) return;
                    const year = pageState.monthDate.getFullYear();
                    const month = pageState.monthDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const startWeekday = firstDay.getDay();
                    const daysInMonth = new Date(year, month+1, 0).getDate();
                    const prevMonthDays = new Date(year, month, 0).getDate();
                    const cells = [];
                    const selectedIso = pageState.selectedDayIso || fmtYMD(new Date());
                    // Previous month fillers
                    for (let i=startWeekday-1; i>=0; i--) {
                        const date = new Date(year, month-1, prevMonthDays - i);
                        cells.push({ date, inMonth:false });
                    }
                    // Current month
                    for (let d=1; d<=daysInMonth; d++) {
                        const date = new Date(year, month, d);
                        cells.push({ date, inMonth:true });
                    }
                    // Fill to 6 weeks
                    const totalCells = Math.ceil(cells.length/7)*7;
                    const nextFill = totalCells - cells.length;
                    for (let i=1; i<=nextFill; i++) {
                        const date = new Date(year, month+1, i);
                        cells.push({ date, inMonth:false });
                    }
                    grid.innerHTML = cells.map(cell => {
                        const iso = fmtYMD(cell.date);
                        const docData = pageState.monthDocsMap[iso];
                        const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                        const cov = coverageMinutes(shifts);
                        let segCount = 0;
                        try {
                            const mins = shifts.map(s=>({ start: parseHM(s.start), end: parseHM(s.end) }));
                            segCount = mergeIntervalsMinutes(mins).length;
                        } catch (_) { segCount = (shifts.length>0?1:0); }
                        const discontinuity = segCount > 1;
                        const badgeText = discontinuity ? '斷續' : '';
                        const badge = badgeText ? `<span class="text-[10px] text-blue-600">${badgeText}</span>` : '';
                        const bgStyle = (()=>{
                            if (!cell.inMonth) return '';
                            if (!cov) return '';
                            if (cov >= 18*60) return 'background-color:#A7F3D0;';
                            if (cov >= 12*60) return 'background-color:#D1FAE5;';
                            if (cov >= 6*60) return 'background-color:#FEF3C7;';
                            return 'background-color:#FFF7ED;';
                        })();
                        const isSelected = iso === selectedIso;
                        const hasRole = !!pageState.roleFilter && Array.isArray(shifts) && shifts.some(s => ((s.role || '保全') === pageState.roleFilter));
                        const roleBorderMap = { '總幹事':'border-amber-500','秘書':'border-purple-500','保全':'border-green-700','清潔':'border-pink-500','機電':'border-blue-500' };
                        const roleCls = hasRole ? `border-2 ${roleBorderMap[pageState.roleFilter] || 'border-gray-400'}` : '';
                        const cls = `${cell.inMonth? '':'bg-gray-50 text-gray-400'} ${isSelected? 'border-2 border-red-500': roleCls} hover:bg-red-50 rounded p-2 text-xs h-[30px] flex flex-col ${cell.inMonth?'bg-white':''}`;
                        return `<div class="${cls}" style="${bgStyle}" data-iso="${iso}"><div class="font-semibold">${cell.date.getDate()}</div><div class="mt-auto">${badge}</div></div>`;
                    }).join('');
                    grid.querySelectorAll('[data-iso]').forEach(el=>{
                        el.addEventListener('click', ()=>{
                            const iso = el.getAttribute('data-iso');
                            pageState.selectedDayIso = (pageState.selectedDayIso === iso) ? null : iso;
                            renderDayPanel();
                            renderMonthlyList();
                        });
                    });
                };

                const renderDayPanel = async () => {
                    const panel = document.getElementById('shift-day-panel');
                    if (!panel) return;
                    const iso = pageState.selectedDayIso || fmtYMD(new Date());
                    const { Timestamp } = window.__fs || {};
                    pageState.selectedDayIso = iso;
                    const id = `${communityId}__${pageState.selectedPostId}__${iso}`;
                    let docData = null;
                    try {
                        const dref = doc(db,'communities', communityId, 'postSchedules', id);
                        const dsnap = await getDoc(dref);
                        if (dsnap.exists()) docData = dsnap.data();
                    } catch (e) { console.warn('讀取當日班表失敗', e); }
                    const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                    const isScheduledDay = !!docData?.isScheduledDay;

                    // 角色過濾：保留原始索引，事件仍指向原陣列索引
                    const roleFilter = pageState.roleFilter || null;
                    const filteredList = roleFilter
                        ? shifts.map((s,idx)=>({ s, idx })).filter(x => ((x.s.role || '保全') === roleFilter))
                        : shifts.map((s,idx)=>({ s, idx }));

                    await loadCommunityUsers();
                    const userOptions = pageState.userOptionsHTML && pageState.userOptionsHTML.length ? pageState.userOptionsHTML : '<option value="" disabled>請先建立或指派人員</option>';
                    panel.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold">${iso} 的哨點班表</div>
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" id="chk-scheduled" ${isScheduledDay?'checked':''}/> 排班日</label>
                            <button id="save-day-rules" class="ml-auto px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">儲存設定</button>
                        </div>
                        <div>
                            ${(filteredList.length===0) ? `<div class=\"text-gray-500 text-sm\">尚未排班${roleFilter? '（或被角色過濾）' : ''}</div>` : ''}
                            <div id="shift-list" class="space-y-3">
                                ${filteredList.map(({s,idx})=>`
                                    <div class="flex items-start gap-2">
                                        <div class="text-sm w-48">
                                            <span data-time-label="${idx}">${s.start || '—'} ~ ${s.end || '—'}</span>
                                            <span class="ml-1 text-[10px] px-1 rounded bg-gray-100">${s.role || '保全'}</span>
                                            <div class="mt-1 space-x-1">
                                                <button class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-edit="${idx}">編輯</button>
                                                <span class="inline-flex items-center gap-1 hidden" data-edit-area="${idx}">
                                                    <input type="time" class="px-1 py-0.5 border rounded text-xs" id="edit-start-${idx}" value="${s.start || ''}">
                                                    <span>~</span>
                                                    <input type="time" class="px-1 py-0.5 border rounded text-xs" id="edit-end-${idx}" value="${s.end || ''}">
                                                    <button class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-edit-save="${idx}">儲存時間</button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="text-xs text-gray-500 mb-1">指定人員</div>
                                            <select class="px-2 py-1 border rounded text-xs min-w-[220px]" data-assign="${idx}">
                                                ${pageState.communityUsers.length ? pageState.communityUsers.map(u=>`<option value=\"${u.id}\" ${(Array.isArray(s.assignees)&&s.assignees[0]===u.id)?'selected':''}>${(u.name||u.displayName||u.id)}｜${u.role||''}</option>`).join('') : '<option value=\"\" disabled>請先建立或指派人員</option>'}
                                            </select>
                                            <button class="ml-2 px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-assign-save="${idx}">儲存指派</button>
                                        </div>
                                        <button class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-del="${idx}">刪除</button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-3 flex items-center gap-2">
                                <input id="new-start" type="time" class="px-2 py-1 border rounded text-sm" />
                                <span>~</span>
                                <input id="new-end" type="time" class="px-2 py-1 border rounded text-sm" />
                                <select id="new-assignees" class="px-2 py-1 border rounded text-sm min-w-[220px]">${userOptions}</select>
                                <button id="add-shift" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">新增班表</button>
                            </div>
                        </div>`;

                    // 已移除模板與批次複製功能（按鍵與事件）

                    const saveBtn = document.getElementById('save-day-rules');
                    if (saveBtn) saveBtn.addEventListener('click', async ()=>{
                        try {
                            const data = {
                                communityId,
                                postId: pageState.selectedPostId,
                                dateIso: iso,
                                dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                isScheduledDay: !!document.getElementById('chk-scheduled')?.checked,
                                shifts: shifts,
                                updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            };
                            await setDoc(doc(db,'communities', communityId, 'postSchedules', id), data);
                            showToast('已儲存設定');
                            await loadMonth();
                            renderCalendar();
                            renderDayPanel();
                        } catch (e) { showToast('儲存失敗', true); }
                    });

                    panel.querySelectorAll('[data-del]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const idx = parseInt(btn.getAttribute('data-del'),10);
                            const newShifts = shifts.filter((_,i)=>i!==idx);
                            try {
                                const base = (!docData || !docData.communityId || !docData.postId || !docData.dateIso || !docData.dateTS) ? {
                                    communityId,
                                    postId: pageState.selectedPostId,
                                    dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                } : {};
                                const payloadDel = { communityId, postId: pageState.selectedPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay, shifts: newShifts, createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payloadDel);
                                showToast('已刪除班表');
                                await loadMonth();
                                renderCalendar();
                                renderDayPanel();
                            } catch (e) { showToast('刪除失敗', true); }
                        });
                    });

                    panel.querySelectorAll('[data-assign-save]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const idx = parseInt(btn.getAttribute('data-assign-save'),10);
                            const sel = panel.querySelector(`[data-assign="${idx}"]`);
                            const assVal = sel?.value || '';
                            const newShifts = shifts.map((sh,i)=> i===idx ? { ...sh, assignees: assVal ? [assVal] : [] } : sh);
                            try {
                                const base = (!docData || !docData.communityId || !docData.postId || !docData.dateIso || !docData.dateTS) ? {
                                    communityId,
                                    postId: pageState.selectedPostId,
                                    dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                } : {};
                                const payloadAssign = { communityId, postId: pageState.selectedPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay, shifts: newShifts, createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payloadAssign);
                                showToast('已更新指派');
                                await loadMonth();
                                renderCalendar();
                                renderDayPanel();
                            } catch (e) { showToast('更新指派失敗', true); }
                        });
                    });

                    // 編輯既有班表時間
                    panel.querySelectorAll('[data-edit]').forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            const idx = parseInt(btn.getAttribute('data-edit'),10);
                            const area = panel.querySelector(`[data-edit-area="${idx}"]`);
                            if (area) {
                                area.classList.toggle('hidden');
                                const input = area.querySelector(`#edit-start-${idx}`);
                                input && input.focus();
                            }
                        });
                    });
                    panel.querySelectorAll('[data-edit-save]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const idx = parseInt(btn.getAttribute('data-edit-save'),10);
                            const s = document.getElementById(`edit-start-${idx}`)?.value || '';
                            const e = document.getElementById(`edit-end-${idx}`)?.value || '';
                            if (!s || !e) return showToast('請輸入完整時間', true);
                            if (parseHM(e) <= parseHM(s)) return showToast('結束時間需晚於開始時間', true);
                            const newShifts = shifts.map((sh,i)=> i===idx ? { ...sh, start: s, end: e } : sh);
                            try {
                                const base = (!docData || !docData.communityId || !docData.postId || !docData.dateIso || !docData.dateTS) ? {
                                    communityId,
                                    postId: pageState.selectedPostId,
                                    dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                } : {};
                                const payloadEdit = { communityId, postId: pageState.selectedPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay, shifts: newShifts, createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payloadEdit);
                                showToast('已更新班表時間');
                                await loadMonth();
                                renderCalendar();
                                renderDayPanel();
                            } catch (e) { showToast('更新失敗', true); }
                        });
                    });

                    const addBtn = document.getElementById('add-shift');
                    if (addBtn) addBtn.addEventListener('click', async ()=>{
                        const s = document.getElementById('new-start')?.value || '';
                        const e = document.getElementById('new-end')?.value || '';
                        if (!s || !e) return showToast('請輸入完整時間', true);
                        if (parseHM(e) <= parseHM(s)) return showToast('結束時間需晚於開始時間', true);
                        const assVal = document.getElementById('new-assignees')?.value || '';
                        const newShifts = [...shifts, { start: s, end: e, assignees: assVal ? [assVal] : [] }];
                        try {
                            const base = (!docData || !docData.communityId || !docData.postId || !docData.dateIso || !docData.dateTS) ? {
                                communityId,
                                postId: pageState.selectedPostId,
                                dateIso: iso,
                                dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            } : {};
                            const payloadAdd = { communityId, postId: pageState.selectedPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay, shifts: newShifts, createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payloadAdd);
                            showToast('已新增班表');
                            await loadMonth();
                            renderCalendar();
                            renderDayPanel();
                        } catch (err) {
                            console.error('新增班表失敗', err);
                            const msg = (err && err.code === 'permission-denied') ? '沒有社區寫入權限，請使用管理端或社區管理員身分' : '新增失敗';
                            showToast(msg, true);
                        }
                    });
                };

                const dayOfWeekLabel = (iso) => {
                    try {
                        const arr = ['日','一','二','三','四','五','六'];
                        const dt = new Date(`${iso}T00:00:00`);
                        return `星期${arr[dt.getDay()]}`;
                    } catch (_) { return '星期'; }
                };

                // 短版星期（只顯示日、一、二、三、四、五、六）
                const dayOfWeekShort = (iso) => {
                    try {
                        const arr = ['日','一','二','三','四','五','六'];
                        const dt = new Date(`${iso}T00:00:00`);
                        return arr[dt.getDay()];
                    } catch (_) { return ''; }
                };

                const getUserNameById = (uid) => {
                    const u = (pageState.communityUsers || []).find(x => x.id === uid);
                    return u ? (u.name || u.displayName || u.id) : '未指派';
                };

                const getUserTitleById = (uid) => {
                    const u = (pageState.communityUsers || []).find(x => x.id === uid);
                    return u ? (u.jobTitle || '') : '';
                };

                const computeShiftStatus = (iso, shift) => {
                    try {
                        const startStr = shift?.start || '07:00';
                        const endStr = shift?.end || '19:00';
                        const endIso = shift?.endDateIso || iso;
                        const start = new Date(`${iso}T${startStr}:00`);
                        const end = new Date(`${endIso}T${endStr}:00`);
                        const now = new Date();
                        const assId = Array.isArray(shift?.assignees) ? shift.assignees[0] : null;
                        const assUser = assId ? (pageState.communityUsers || []).find(u=>u.id===assId) : null;
                        if (shift?.cashShift === true || (assUser && (assUser.employmentStatus === '現金班'))) return '轉現金班';
                        if (now < start) return '未到上班時間';
                        if (now > end) return '已完成';
                        return '未上哨';
                    } catch(_) { return '未上哨'; }
                };

                const renderMonthlyList = async () => {
                    const el = document.getElementById('shift-monthly-list');
                    if (!el) return;
                    await loadCommunityUsers();
                    const filterIso = pageState.selectedDayIso || null;
                    const roleFilter = pageState.roleFilter || null;
                    const titleEl = document.getElementById('shift-list-title');
                    if (titleEl) titleEl.textContent = `${filterIso ? '當日' : '每月'}班表列表${roleFilter ? `（角色：${roleFilter}）` : ''}`;
                    const entries = Object.entries(pageState.monthDocsMap).sort(([a],[b]) => a.localeCompare(b));
                    const rows = [];
                    const currentPost = pageState.posts.find(p=>p.id===pageState.selectedPostId);
                    const postName = currentPost?.name || '未命名哨點';
                    for (const [iso, doc] of entries) {
                        if (filterIso && iso !== filterIso) continue;
                        const shifts = Array.isArray(doc.shifts) ? doc.shifts : [];
                        shifts.forEach((s, idx) => {
                            if (roleFilter && ((s.role || '保全') !== roleFilter)) return;
                            const start = s.start || '07:00';
                            const end = s.end || '19:00';
                            const assId = Array.isArray(s.assignees) ? (s.assignees[0] || '') : '';
                            const assName = assId ? getUserNameById(assId) : '未指派';
                            const assTitle = assId ? getUserTitleById(assId) : '';
                            const status = computeShiftStatus(iso, s);
                            const dow = dayOfWeekShort(iso);
                            const role = s.role || '保全';
                            const endIso = s.endDateIso || iso;
                            const endDow = dayOfWeekShort(endIso);
                            const displayPost = role === '保全' ? postName : '無';
                            rows.push(`
                                <tr>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${role}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${assName}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${assTitle}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${displayPost}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${iso}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${dow}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${start}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${endIso}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${endDow}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${end}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${status}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">
                                    <button class="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700" data-edit-month="${iso}__${idx}">編輯</button>
                                    <button class="ml-1 px-2 py-1 text-xs rounded bg-indigo-600 text-white hover:bg-indigo-700" data-copy-month="${iso}__${idx}">複製</button>
                                    <button class="ml-1 px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-700" data-del-month="${iso}__${idx}">刪除</button>
                                    <button class="ml-1 px-2 py-1 text-xs rounded bg-amber-500 text-white hover:bg-amber-600" data-share-month="${iso}__${idx}">分享(轉現金班)</button>
                                  </td>
                                </tr>`);
                        });
                    }
                    el.innerHTML = `
                        <div class="overflow-x-auto">
                          <table class="text-sm" style="min-width: max-content; border-collapse: collapse;">
                            <thead>
                              <tr class="bg-gray-50 text-gray-600">
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">角色</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">指派人員</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">職稱</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">哨點</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">上班日期</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">星期</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">上班時間</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">下班日期</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">星期</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">下班時間</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">狀態</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">操作</th>
                              </tr>
                            </thead>
                            <tbody>${rows.join('') || `<tr><td colspan="12" class="px-2 py-3 text-center text-gray-500 border border-gray-300">本月尚無班表</td></tr>`}</tbody>
                          </table>
                        </div>`;
                    const addBtn = document.getElementById('open-add-schedule');
                    if (addBtn) { addBtn.onclick = () => openAddScheduleModal(); }

                    const exportBtn = document.getElementById('export-csv');
                    if (exportBtn) exportBtn.onclick = async () => {
                        const header = ['角色','指派人員','哨點','上班日期','上班時間','下班日期','下班時間'];
                        const lines = [header.join(',')];
                        const entries2 = Object.entries(pageState.monthDocsMap).sort(([a],[b]) => a.localeCompare(b));
                        const currentPost2 = pageState.posts.find(p=>p.id===pageState.selectedPostId);
                        const postName2 = currentPost2?.name || '未命名哨點';
                        for (const [iso2, doc2] of entries2) {
                            if (filterIso && iso2 !== filterIso) continue;
                            const shifts2 = Array.isArray(doc2.shifts) ? doc2.shifts : [];
                            shifts2.forEach((s2) => {
                                if (roleFilter && ((s2.role || '保全') !== roleFilter)) return;
                                const start = s2.start || '07:00';
                                const end = s2.end || '19:00';
                                const assId = Array.isArray(s2.assignees) ? (s2.assignees[0] || '') : '';
                                const assName = assId ? getUserNameById(assId) : '未指派';
                                const assTitle = assId ? getUserTitleById(assId) : '';
                                const status = computeShiftStatus(iso2, s2);
                                const dow = dayOfWeekShort(iso2);
                                const role = s2.role || '保全';
                                const endIso = s2.endDateIso || iso2;
                                const endDow = dayOfWeekShort(endIso);
                                const displayPost = role === '保全' ? postName2 : '無';
                                const row = [role, assName, displayPost, iso2, start, endIso, end].map(v => `"${String(v).replace(/"/g,'""')}"`).join(',');
                                lines.push(row);
                            });
                        }
                        const csv = lines.join('\r\n');
                        const blob = new Blob(["\uFEFF", csv], { type: 'text/csv;charset=utf-8;' });
                        const d0 = pageState.monthDate || new Date();
                        const fname = `shifts_${d0.getFullYear()}_${String(d0.getMonth()+1).padStart(2,'0')}.csv`;
                        const url = URL.createObjectURL(blob);
                        const a0 = document.createElement('a');
                        a0.href = url; a0.download = fname; a0.click();
                        setTimeout(()=> URL.revokeObjectURL(url), 1000);
                    };

                    const importBtn = document.getElementById('import-csv');
                    const importInput = document.getElementById('import-csv-input');
                    if (importBtn && importInput) {
                        importBtn.onclick = () => importInput.click();
                        importInput.onchange = async (evt) => {
                            const file = evt.target.files?.[0];
                            if (!file) return;
                            try {
                                let text = await file.text();
                                text = text.replace(/^\uFEFF/, '');
                                const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
                                if (lines.length <= 1) { showToast('CSV 無資料', true); return; }
                                const header = lines[0].split(',').map(h=>h.replace(/^\s*\"|\"\s*$/g,''));
                                const idxMap = {
                                    role: header.indexOf('角色'),
                                    assignee: header.indexOf('指派人員'),
                                    post: header.indexOf('哨點'),
                                    date: header.indexOf('上班日期'),
                                    start: header.indexOf('上班時間'),
                                    endDate: header.indexOf('下班日期'),
                                    end: header.indexOf('下班時間')
                                };
                                const missing = ['role','assignee','post','date','start','endDate','end'].filter(k=> idxMap[k] === -1);
                                if (missing.length) { showToast('CSV 欄位缺少：' + missing.join('、'), true); return; }
                                const { Timestamp } = window.__fs || {};
                                for (let i=1; i<lines.length; i++) {
                                    const cols = lines[i].match(/("([^"]|"")*"|[^,]+)/g);
                                    if (!cols || !cols.length) continue;
                                    const get = (ix) => {
                                        const v = cols[ix] || '';
                                        return v.trim().replace(/^\"|\"$/g,'').replace(/""/g,'"');
                                    };
                                    const roleVal = get(idxMap.role) || '保全';
                                    const assigneeName = get(idxMap.assignee) || '';
                                    const rawDateIso = get(idxMap.date) || '';
                                    const startStr = get(idxMap.start) || '07:00';
                                    const rawEndDateIso = get(idxMap.endDate) || rawDateIso;
                                    const endStr = get(idxMap.end) || '19:00';
                                    // 允許多種日期格式，轉為 YYYY-MM-DD；並去除附帶時間
                                    const toIso = (raw) => {
                                        const s = String(raw || '').trim();
                                        if (!s) return '';
                                        const datePart = s.split(/[T\s]/)[0];
                                        let m = datePart.match(/^([0-9]{4})[\/\.-]([0-9]{1,2})[\/\.-]([0-9]{1,2})$/);
                                        if (m) {
                                            const y = parseInt(m[1],10), mo = parseInt(m[2],10), d = parseInt(m[3],10);
                                            if (mo>=1 && mo<=12 && d>=1 && d<=31) return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                        }
                                        m = datePart.match(/^([0-9]{1,2})[\/\.-]([0-9]{1,2})[\/\.-]([0-9]{4})$/);
                                        if (m) {
                                            const mo = parseInt(m[1],10), d = parseInt(m[2],10), y = parseInt(m[3],10);
                                            if (mo>=1 && mo<=12 && d>=1 && d<=31) return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                        }
                                        const dt = new Date(datePart);
                                        if (!isNaN(dt.getTime())) {
                                            return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
                                        }
                                        return '';
                                    };
                                    const dateIso = toIso(rawDateIso);
                                    const endDateIso = toIso(rawEndDateIso) || dateIso;
                                    let postId = pageState.selectedPostId || null;
                                    if (roleVal === '保全' && idxMap.post !== -1) {
                                        const postName = get(idxMap.post) || '';
                                        if (postName) {
                                            const existing = pageState.posts.find(p => (p.name || '') === postName);
                                            if (existing) {
                                                postId = existing.id;
                                            } else {
                                                const newPostDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                                    communityId,
                                                    name: postName,
                                                    createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                                });
                                                postId = newPostDoc.id;
                                                pageState.posts.push({ id: postId, communityId, name: postName });
                                            }
                                        }
                                    }
                                    const assUser = (pageState.communityUsers || []).find(u => (u.name || u.displayName || '') === assigneeName);
                                    const assId = assUser ? assUser.id : '';
                                    if (!dateIso || !startStr || !endStr) continue;
                                    const effPostId = postId || pageState.selectedPostId;
                                    const dref = doc(db,'communities', communityId, 'postSchedules', `${communityId}__${effPostId}__${dateIso}`);
                                    const dsnap = await getDoc(dref);
                                    const docData = dsnap.exists() ? dsnap.data() : null;
                                    const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                    const newShift = { start: startStr, end: endStr, assignees: assId ? [assId] : [], role: roleVal, endDateIso };
                                    const payload = {
                                        communityId, postId: effPostId, dateIso,
                                        // 避免字串解析造成 Invalid time value，改用原生年月日建構
                                        dateTS: (() => {
                                            const parts = dateIso.split('-');
                                            const y = parseInt(parts[0],10), mo = parseInt(parts[1],10), d = parseInt(parts[2],10);
                                            const jsDate = new Date(y, mo - 1, d, 0, 0, 0, 0);
                                            return (Timestamp?.fromDate ? Timestamp.fromDate(jsDate) : jsDate);
                                        })(),
                                        isScheduledDay: !!docData?.isScheduledDay,
                                        shifts: [...shifts, newShift],
                                        createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                        updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                    };
                                    await setDoc(dref, payload);
                                }
                                showToast('CSV 匯入完成');
                                await loadMonth();
                                renderCalendar();
                                renderMonthlyList();
                                renderDayPanel();
                            } catch (e) {
                                console.error('CSV 匯入錯誤', e);
                                showToast('CSV 匯入失敗', true);
                            } finally {
                                importInput.value = '';
                            }
                        };
                    }

                    el.querySelectorAll('[data-edit-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-edit-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const d = pageState.monthDocsMap[iso];
                            const s = Array.isArray(d?.shifts) ? d.shifts[idx] : null;
                            if (!s) return;
                            openAddScheduleModal({ iso, index: idx, shift: s });
                        });
                    });
                    el.querySelectorAll('[data-del-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-del-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const id = `${communityId}__${pageState.selectedPostId}__${iso}`;
                            try {
                                const { Timestamp } = window.__fs || {};
                                const dsnap = await getDoc(doc(db,'communities', communityId, 'postSchedules', id));
                                const docData = dsnap.exists() ? dsnap.data() : null;
                                const isScheduledDay = !!docData?.isScheduledDay;
                                const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                const newShifts = shifts.filter((_,i)=>i!==idx);
                                const payload = {
                                    communityId, postId: pageState.selectedPostId, dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    isScheduledDay, shifts: newShifts,
                                    createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payload);
                                showToast('已刪除班表');
                                await loadMonth();
                                renderCalendar();
                                renderMonthlyList();
                                renderDayPanel();
                            } catch(e) { showToast('刪除失敗', true); }
                        });
                    });
                    el.querySelectorAll('[data-share-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-share-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const d = pageState.monthDocsMap[iso];
                            const s = Array.isArray(d?.shifts) ? d.shifts[idx] : null;
                            if (!s) return;
                            const start = s.start || '07:00';
                            const end = s.end || '19:00';
                            const assId = Array.isArray(s.assignees) ? (s.assignees[0] || '') : '';
                            const assName = assId ? getUserNameById(assId) : '未指派';
                            const dow = dayOfWeekLabel(iso);
                            const role = s.role || '保全';
                            const endIso = s.endDateIso || iso;
                            const endDow = dayOfWeekLabel(endIso);
                            const displayPost = role === '保全' ? postName : '無';
                            const content = `職稱：${role}\n哨點：${displayPost}\n上班日期：${iso} ${dow}\n上班時間：${start}\n下班日期：${endIso} ${endDow}\n下班時間：${end}\n指派人員：${assName}`;
                            try {
                                if (navigator.share) {
                                    await navigator.share({ title: '班表', text: content });
                                } else {
                                    await navigator.clipboard.writeText(content);
                                    showToast('已複製班表資訊');
                                }
                                // 分享後標記為現金班
                                const { Timestamp } = window.__fs || {};
                                const id = `${communityId}__${pageState.selectedPostId}__${iso}`;
                                const dsnap = await getDoc(doc(db,'communities', communityId, 'postSchedules', id));
                                const docData = dsnap.exists() ? dsnap.data() : null;
                                const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                const newShifts = shifts.map((sh,i)=> i===idx ? { ...sh, cashShift: true } : sh);
                                const payload = {
                                    communityId, postId: pageState.selectedPostId, dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    isScheduledDay: !!docData?.isScheduledDay, shifts: newShifts,
                                    createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payload);
                            } catch(_) {}
                        });
                    });
                    el.querySelectorAll('[data-copy-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-copy-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const d = pageState.monthDocsMap[iso];
                            const s = Array.isArray(d?.shifts) ? d.shifts[idx] : null;
                            if (!s) return;
                            const start = s.start || '07:00';
                            const end = s.end || '19:00';
                            const assId = Array.isArray(s.assignees) ? (s.assignees[0] || '') : '';
                            const assName = assId ? getUserNameById(assId) : '未指派';
                            const dow = dayOfWeekLabel(iso);
                            const role = s.role || '保全';
                            const endIso = s.endDateIso || iso;
                            const endDow = dayOfWeekLabel(endIso);
                            const displayPost = role === '保全' ? postName : '無';
                            const content = `職稱：${role}\n哨點：${displayPost}\n上班日期：${iso} ${dow}\n上班時間：${start}\n下班日期：${endIso} ${endDow}\n下班時間：${end}\n指派人員：${assName}`;
                            try {
                                await navigator.clipboard.writeText(content);
                                showToast('已複製班表資訊');
                            } catch(_) {}
                        });
                    });
                };

                const openAddScheduleModal = (edit = null) => {
                    const defaultDateIso = pageState.selectedDayIso || fmtYMD(new Date());
                    const defaultStart = edit?.shift?.start || '07:00';
                    const defaultEnd = edit?.shift?.end || '19:00';
                    const defaultEndDateIso = edit?.shift?.endDateIso || defaultDateIso;
                    const defaultRole = edit?.shift?.role || '保全';
                    const defaultAss = Array.isArray(edit?.shift?.assignees) ? edit.shift.assignees[0] || '' : '';
                    const currentPostId = pageState.selectedPostId;
                    const currentPostName = (pageState.posts.find(p => p.id===currentPostId)?.name) || '';
                    const postsOptionsDatalist = pageState.posts.map(p => `<option value="${p.name||'未命名哨點'}"></option>`).join('');
                    const usersOptions = (pageState.userOptionsHTML && pageState.userOptionsHTML.length) ? pageState.userOptionsHTML : '<option value="" disabled>請先建立或指派人員</option>';
                    const startDow = dayOfWeekLabel(defaultDateIso);
                    const endDow = dayOfWeekLabel(defaultEndDateIso);
                    const modal = document.getElementById('modal-container');
                    if (!modal) return;
                    modal.innerHTML = `
                        <div class="modal-backdrop"></div>
                        <div class="modal-content max-w-[880px]">
                          <div class="text-lg font-semibold mb-3">${edit ? '編輯排班' : '新增排班'}</div>
                          <div class="grid grid-cols-8 gap-2 items-center">
                            <div class="col-span-2 text-sm text-gray-600">角色</div>
                            <div class="col-span-6">
                              <select id="new-role" class="px-2 py-1 border rounded w-full">
                                ${['總幹事','秘書','保全','清潔','機電'].map(r=>`<option value="${r}" ${r===defaultRole?'selected':''}>${r}</option>`).join('')}
                              </select>
                            </div>

                            <div class="col-span-2 text-sm text-gray-600">指派人員</div>
                            <div class="col-span-6"><select id="new-assignee" class="px-2 py-1 border rounded w-full">${usersOptions}</select></div>

                            <div id="role-post-row" class="contents">
                              <div class="col-span-2 text-sm text-gray-600">哨點</div>
                              <div class="col-span-6">
                                <input id="new-post-input" list="post-name-list" class="px-2 py-1 border rounded w-full" value="${currentPostName}" placeholder="輸入或選擇哨點"/>
                                <datalist id="post-name-list">${postsOptionsDatalist}</datalist>
                              </div>
                            </div>

                            <div class="col-span-2 text-sm text-gray-600">上班日期</div>
                            <div class="col-span-6"><input type="date" id="new-date" value="${defaultDateIso}" class="px-2 py-1 border rounded w-full"/></div>

                            <div class="col-span-2 text-sm text-gray-600">星期</div>
                            <div class="col-span-6"><input id="new-dow" class="px-2 py-1 border rounded w-full" value="${startDow}" readonly/></div>

                            <div class="col-span-2 text-sm text-gray-600">上班時間</div>
                            <div class="col-span-6"><input type="time" id="new-start-time" value="${defaultStart}" class="px-2 py-1 border rounded w-full"/></div>

                            <div class="col-span-2 text-sm text-gray-600">加入小時按鈕</div>
                            <div class="col-span-6">
                              <div class="flex items-center gap-2">
                                <button id="btn-add-9h" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">+9</button>
                                <button id="btn-add-12h" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">+12</button>
                              </div>
                            </div>

                            <div class="col-span-2 text-sm text-gray-600">下班日期</div>
                            <div class="col-span-6"><input type="date" id="new-end-date" value="${defaultEndDateIso}" class="px-2 py-1 border rounded w-full"/></div>

                            <div class="col-span-2 text-sm text-gray-600">星期</div>
                            <div class="col-span-6"><input id="new-end-dow" class="px-2 py-1 border rounded w-full" value="${endDow}" readonly/></div>

                            <div class="col-span-2 text-sm text-gray-600">下班時間</div>
                            <div class="col-span-6"><input type="time" id="new-end-time" value="${defaultEnd}" class="px-2 py-1 border rounded w-full"/></div>


                          </div>
                          <div class="mt-4 flex items-center justify-end gap-2">
                            <button id="new-schedule-cancel" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">取消</button>
                            <button id="new-schedule-save" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">${edit ? '儲存' : '新增'}</button>
                          </div>
                        </div>`;
                    modal.classList.remove('hide');
                    try { lucide.createIcons(); } catch(_) {}

                    const roleSel = document.getElementById('new-role');
                    const postRow = document.getElementById('role-post-row');
                    const dateInput = document.getElementById('new-date');
                    const dowInput = document.getElementById('new-dow');
                    const endDateInput = document.getElementById('new-end-date');
                    const endDowInput = document.getElementById('new-end-dow');
                    const startTimeInput = document.getElementById('new-start-time');
                    const endTimeInput = document.getElementById('new-end-time');

                    const togglePostRow = () => {
                        if (!roleSel || !postRow) return;
                        if (roleSel.value === '保全') {
                            postRow.classList.remove('hidden');
                            postRow.classList.add('contents');
                        } else {
                            postRow.classList.add('hidden');
                            postRow.classList.remove('contents');
                        }
                    };
                    togglePostRow();
                    if (roleSel) roleSel.addEventListener('change', togglePostRow);

                    if (dateInput && dowInput) {
                        dateInput.addEventListener('change', ()=>{
                            const iso = dateInput.value;
                            dowInput.value = dayOfWeekLabel(iso);
                        });
                    }
                    if (endDateInput && endDowInput) {
                        endDateInput.addEventListener('change', ()=>{
                            const iso = endDateInput.value;
                            endDowInput.value = dayOfWeekLabel(iso);
                        });
                    }

                    const addHours = (h) => {
                        const iso = dateInput?.value || defaultDateIso;
                        const start = startTimeInput?.value || '07:00';
                        const addMin = h * 60;
                        const sm = parseHM(start);
                        let total = sm + addMin;
                        let endIsoCalc = iso;
                        if (total >= 24*60) {
                            total -= 24*60;
                            const d0 = new Date(`${iso}T00:00:00`);
                            d0.setDate(d0.getDate()+1);
                            endIsoCalc = fmtYMD(d0);
                        }
                        const hh = String(Math.floor(total/60)).padStart(2,'0');
                        const mm = String(total % 60).padStart(2,'0');
                        if (endTimeInput) endTimeInput.value = `${hh}:${mm}`;
                        if (endDateInput) endDateInput.value = endIsoCalc;
                        if (endDowInput) endDowInput.value = dayOfWeekLabel(endIsoCalc);
                    };

                    const btn9 = document.getElementById('btn-add-9h');
                    const btn12 = document.getElementById('btn-add-12h');
                    if (btn9) btn9.addEventListener('click', ()=> addHours(9));
                    if (btn12) btn12.addEventListener('click', ()=> addHours(12));

                    const cancelBtn = document.getElementById('new-schedule-cancel');
                    if (cancelBtn) cancelBtn.addEventListener('click', ()=> { modal.classList.add('hide'); });

                    const saveBtn = document.getElementById('new-schedule-save');
                    if (saveBtn) saveBtn.addEventListener('click', async ()=>{
                        const roleVal = roleSel?.value || '保全';
                        let postId = pageState.selectedPostId || null;
                        let nameVal = '';
                        if (roleVal === '保全') {
                            nameVal = document.getElementById('new-post-input')?.value.trim() || '';
                            if (!nameVal) return showToast('請輸入哨點名稱', true);
                            const existing = pageState.posts.find(p => (p.name || '') === nameVal);
                            if (existing) {
                                postId = existing.id;
                            } else {
                                const { Timestamp } = window.__fs || {};
                                const newPostDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                    communityId,
                                    name: nameVal,
                                    createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                });
                                postId = newPostDoc.id;
                            }
                        }
                        const iso = document.getElementById('new-date')?.value || defaultDateIso;
                        const endIso = document.getElementById('new-end-date')?.value || defaultEndDateIso;
                        const start = startTimeInput?.value || '07:00';
                        const end = endTimeInput?.value || '19:00';
                        const assId = document.getElementById('new-assignee')?.value || '';
                        if (!iso || !start || !end) return showToast('請完整填寫排班資訊', true);
                        if (roleVal === '保全' && !postId) return showToast('請輸入哨點名稱', true);
                        if (endIso === iso && parseHM(end) <= parseHM(start)) return showToast('結束時間需晚於開始時間', true);
                        try {
                            const { Timestamp } = window.__fs || {};
                            const effPostId = postId || pageState.selectedPostId;
                            const dref = doc(db,'communities', communityId, 'postSchedules', `${communityId}__${effPostId}__${iso}`);
                            const dsnap = await getDoc(dref);
                            const docData = dsnap.exists() ? dsnap.data() : null;
                            const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                            let newShifts = [];
                            if (edit && typeof edit.index === 'number') {
                                newShifts = shifts.map((sh,i)=> i===edit.index ? { ...sh, start, end, assignees: assId ? [assId] : [], role: roleVal, endDateIso: endIso } : sh);
                            } else {
                                newShifts = [...shifts, { start, end, assignees: assId ? [assId] : [], role: roleVal, endDateIso: endIso }];
                            }
                            const payload = {
                                communityId, postId: effPostId, dateIso: iso,
                                dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                isScheduledDay: !!docData?.isScheduledDay,
                                shifts: newShifts,
                                createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            };
                            await setDoc(dref, payload);
                            showToast(edit ? '已更新排班' : '已新增排班');
                            modal.classList.add('hide');
                            pageState.selectedPostId = effPostId;
                            await loadMonth();
                            renderTabs();
                            renderPostTitle();
                            renderMonthHeader();
                            renderCalendar();
                            renderMonthlyList();
                            renderDayPanel();
                        } catch(e) {
                            const msg = (e && e.code === 'permission-denied') ? '沒有社區寫入權限，請使用管理端或社區管理員身分' : '儲存失敗';
                            showToast(msg, true);
                        }
                    });
                };

                const init = async () => {
                    renderShell();
                    await loadPosts();
                    await loadCommunityUsers();
                    renderMonthHeader();
                    await loadMonth();
                    renderCalendar();
                    await renderMonthlyList();
                    await renderDayPanel();
                    updateCounts();
                };
                init();
            }

            function renderGroupMap(container) {
                container.innerHTML = `
                    <div class="h-full w-full relative">
                        <div id="group-map" class="h-full w-full"></div>
                        <div id="group-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
<button id="group-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>回到社區
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-2">
                            <div id="group-user-list" class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg max-h-[150px] overflow-y-auto p-2 space-y-2"></div>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                if (state.googleMapsLoaded) {
                    initGroupMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) { clearInterval(interval); initGroupMap(); }
                    }, 100);
                }
            }

            async function initGroupMap() {
                const mapDiv = document.getElementById('group-map');
                const mapLoader = document.getElementById('group-map-loader');
                if (!mapDiv || !mapLoader) return;
                let mapCenter = { lat: 25.0330, lng: 121.5654 };
                try {
                    // 優先使用目前社區的 GPS 座標
                    const comm = state.currentCommunity;
                    if (comm && typeof comm.lat === 'number' && typeof comm.lng === 'number') {
                        mapCenter = { lat: comm.lat, lng: comm.lng };
                    } else {
                        const docSnap = await getDoc(doc(db, "settings", "location"));
                        if (docSnap.exists()) {
                            const s = docSnap.data();
                            if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                                mapCenter = { lat: s.companyLat, lng: s.companyLng };
                            }
                        }
                    }
                } catch (e) { console.warn("載入中心點失敗，使用預設中心點", e); }
                state.groupMap = new google.maps.Map(mapDiv, { center: mapCenter, zoom: 12, disableDefaultUI: true, zoomControl: true, mapId: 'DEMO_MAP_ID' });
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('group-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.groupMap.panTo(state.companyCenter);
                            state.groupMap.setZoom(14);
                        } else {
                            showToast('尚未設定社區座標', true);
                        }
                    });
                }
                mapLoader.classList.add('hide');
                listenForGroupUserLocations();
            }

            async function listenForGroupUserLocations() {
                const allowedUserIds = await loadJuniorManagerAllowedUsers(state.currentUserData.id);
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));
                const unsubscribe = onSnapshot(q, async (querySnapshot) => {
                    const listEl = document.getElementById('group-user-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    if (!Array.isArray(allowedUserIds) || allowedUserIds.length === 0) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-2">尚未由管理員設定可查看人員</p>`;
                        return;
                    }
                    // 清除舊標記
                    (state.groupMarkers || []).forEach(m => m.map = null);
                    state.groupMarkers = [];

                    const users = [];
                    querySnapshot.forEach(doc => { const data = { id: doc.id, ...doc.data() }; if (allowedUserIds.includes(data.id)) users.push(data); });
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
                    const usersByCommunity = (currentCommId || currentCommCode) ? users.filter(u => {
                        const byId = Array.isArray(u.serviceCommunities) && currentCommId ? u.serviceCommunities.includes(currentCommId) : false;
                        const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                        const byCode = currentCommCode ? (codesArr.includes(currentCommCode) || (u.serviceCommunityCode === currentCommCode)) : false;
                        const byLegacy = currentCommId ? ((u.serviceCommunityCode === currentCommId) || (codesArr.includes(currentCommId))) : false;
                        return byId || byCode || byLegacy;
                    }) : users;
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {}
                    // 僅顯示社區內指定角色（總幹事、秘書、保全、清潔、機電）
                    const allowedRoles = new Set(['總幹事','秘書','保全','清潔','機電']);
                    const communityRoleUsers = usersByCommunity.filter(u => allowedRoles.has((u.role || '').trim()));
                    const visibleUsersList = communityRoleUsers.filter(user => visibleUsers[user.id] !== false);
                    const latestMap = {};
                    try {
                        await Promise.all(visibleUsersList.map(async (u) => {
                            const recQ = query(
                                collection(db, 'clockInRecords'),
                                where('userId', '==', u.id),
                                orderBy('timestamp', 'desc'),
                                limit(1)
                            );
                            const snap = await getDocs(recQ);
                            if (!snap.empty) {
                                latestMap[u.id] = snap.docs[0].data();
                            }
                        }));
                    } catch (e) {}
                    visibleUsersList.sort((a, b) => {
                        const recA = latestMap[a.id];
                        const recB = latestMap[b.id];
                        const statusA = recA ? getStatusDisplayText(recA.type || '未知', recA.locationName || null, recA.dutyType || null) : getStatusDisplayText(a.clockInStatus || '未打卡', a.lastLocation?.address, a.dutyType);
                        const statusB = recB ? getStatusDisplayText(recB.type || '未知', recB.locationName || null, recB.dutyType || null) : getStatusDisplayText(b.clockInStatus || '未打卡', b.lastLocation?.address, b.dutyType);
                        if (statusA.includes('上班中') && !statusB.includes('上班中')) return -1;
                        if (!statusA.includes('上班中') && statusB.includes('上班中')) return 1;
                        if (statusA.includes('上班中') && statusB.includes('上班中')) {
                            const timeA = (recA?.timestamp?.toDate?.() || (a.lastClockInTime?.toDate?.() || new Date(0)));
                            const timeB = (recB?.timestamp?.toDate?.() || (b.lastClockInTime?.toDate?.() || new Date(0)));
                            return timeA - timeB;
                        }
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    });
                    visibleUsersList.forEach(user => {
                        const hasLocation = user.lastLocation && user.lastLocation.latitude;
                        const userElement = document.createElement('div');
                        userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                        const latest = latestMap[user.id] || null;
                        const locText = latest?.locationName || (user.clockInStatus === '外出' && user.outboundLocation ? user.outboundLocation : user.lastLocation?.address);
                        const statusText = latest ? getStatusDisplayText(latest.type || '未知', latest.locationName || null, latest.dutyType || null)
                                                  : (getStatusDisplayText(user.clockInStatus || '未打卡', locText, user.dutyType) || '未打卡');
                        const latestTime = latest ? (latest.timestamp?.toDate?.() || (latest.timestamp ? new Date(latest.timestamp) : null))
                                                  : (user.lastClockInTime?.toDate?.() || null);
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-sm text-gray-800">${user.name}</p>
                                    <p class="text-xs text-gray-500">${statusText}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${latestTime ? '最近狀態時間：' + timeAgo(latestTime) : '無紀錄'}</span>
                        `;
                        listEl.appendChild(userElement);
                        if (hasLocation) {
                            const position = { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                            const markerIcon = document.createElement('img');
                            markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`;
                            const roleColorMap = { '總幹事': 'border-amber-500', '秘書': 'border-purple-500', '保全': 'border-green-800', '清潔': 'border-pink-400', '機電': 'border-blue-500' };
const titleKey = ((user.applicationTitle || user.jobTitle || user.role || '').trim());
const roleBorderClass = roleColorMap[titleKey] || 'border-white';
                            markerIcon.className = `w-9 h-9 rounded-full border-2 ${roleBorderClass} shadow-md object-cover`;
                            const marker = new AdvancedMarkerElement({ position, map: state.groupMap, title: user.name, content: markerIcon });
                            const infoWindow = new google.maps.InfoWindow({ content: `
                                <div class="p-1">
                                    <p class="font-bold">${user.name}</p>
                                    <p>狀態: ${statusText}</p>
                                    <p>最近狀態時間: ${latestTime ? formatDateTime(latestTime) : 'N/A'}</p>
                                </div>` });
                            marker.addListener('click', () => infoWindow.open({ anchor: marker, map: state.groupMap }));
                            userElement.addEventListener('click', () => { state.groupMap.panTo(position); state.groupMap.setZoom(17); infoWindow.open({ anchor: marker, map: state.groupMap }); });
                            state.groupMarkers.push(marker);
                        }
                    });
                });
                state.activeListeners.push(unsubscribe);
            }

            function renderGroupAttendance(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="group-user-select" class="text-sm font-medium">選擇人員:</label>
                                <select id="group-user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">由管理員指定名單</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="group-record-date" class="text-sm font-medium">選擇日期:</label>
                                <input type="date" id="group-record-date" value="${new Date().toISOString().split('T')[0]}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                        </div>
                        <div id="group-attendance-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">正在讀取紀錄...</div>
                        </div>
                    </div>`;

                const userSelect = document.getElementById('group-user-select');
                const dateInput = document.getElementById('group-record-date');

                loadJuniorManagerAllowedUsers(state.currentUserData.id).then(ids => {
                    if (!ids || ids.length === 0) return;
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((qs) => {
                        const users = [];
                        qs.forEach(doc => { const d = { id: doc.id, ...doc.data() }; if (ids.includes(d.id)) users.push(d); });
                        users.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(u => {
                            const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.name; userSelect.appendChild(opt);
                        });
                        const loadRecords = () => renderAttendanceRecordsList('group-attendance-records-list', userSelect.value, dateInput.value, ids);
                        userSelect.addEventListener('change', loadRecords);
                        dateInput.addEventListener('change', loadRecords);
                        loadRecords();
                    });
                });
            }

            // 共用：出勤紀錄列表渲染（支援指定用戶白名單）
            async function renderAttendanceRecordsList(containerId, selectedUserId, selectedDateStr, allowedUserIds = null) {
                const container = document.getElementById(containerId);
                const selectedDate = new Date(selectedDateStr);
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);
                const recordsRef = collection(db, 'clockInRecords');
                let q;
                const { Timestamp } = window.__fs || {};
                const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                if (selectedUserId === 'all') {
                    q = query(recordsRef, where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                } else {
                    q = query(recordsRef, where('userId', '==', selectedUserId), where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                }

                container.innerHTML = `<div class="text-center p-4 text-gray-500">正在讀取紀錄...</div>`;
                await ensureAbnormalMarkingConfig();
                await ensureCommunitiesCache();
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = `<p class="text-center text-gray-500 p-4">無打卡紀錄</p>`;
                    return;
                }
                const records = [];
                querySnapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const usersMap = {};
                const userCommunitiesMap = {};
                usersSnapshot.forEach(doc => { 
                    const d = doc.data();
                    usersMap[doc.id] = d.name;
                    userCommunitiesMap[doc.id] = Array.isArray(d.serviceCommunities) ? d.serviceCommunities : [];
                });

                container.innerHTML = '';
                records
                    .filter(r => !allowedUserIds || allowedUserIds.includes(r.userId))
                    .sort((a,b) => {
                        const timeA = a.timestamp?.toDate?.() || new Date(0);
                        const timeB = b.timestamp?.toDate?.() || new Date(0);
                        return timeB - timeA;
                    })
                    .forEach(record => {
                        const time = record.timestamp?.toDate?.() || new Date();
                        const userName = usersMap[record.userId] || '未知用戶';
                        const abnormalInfo = computeRecordAbnormal(record, userCommunitiesMap[record.userId] || []);
                        const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                            ? `<div class="mt-1"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">打卡位置異常</span>${abnormalInfo.detail ? `<span class=\"ml-2 text-xs text-gray-500\">${abnormalInfo.detail}</span>` : ''}</div>`
                            : '';
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold">${userName}</div>
                                    <div class="text-sm text-gray-500">${time.toLocaleString('zh-TW', { hour12: false })}</div>
                                    <div class="mt-1 flex items-center">
<span class="px-2 py-0.5 rounded text-sm ${getStatusBgColor(getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null))}">${getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null)}</span>
                        ${record.location && typeof record.location.latitude === 'number' && typeof record.location.longitude === 'number' ? `<span class="ml-2 text-sm text-gray-500">${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</span>` : ''}
                                    </div>
                                    <div class="mt-1 text-xs text-gray-500">裝置ID: ${record.deviceId || '未知'}</div>
                                    ${abnormalHtml}
                                </div>
                                <div class="flex space-x-2 items-start"></div>
                            </div>
                            <div class="mt-2 flex space-x-2 overflow-x-auto items-center">
                                ${record.photoUrls && record.photoUrls.length > 0 ? `
                                    <button class="photo-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> 照片 (${record.photoUrls.length})
                                    </button>
                                ` : ''}
                                ${record.location ? `
                                    <button class="map-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-lat="${record.location.latitude}" 
                                        data-lng="${record.location.longitude}">
                                        <i data-lucide="map-pin"></i> 地圖
                                    </button>
                                ` : ''}
                                <!-- Admin controls: edit/delete -->
                                <span class="admin-controls hidden" data-record-id="${record.id}" data-record='${encodeURIComponent(JSON.stringify({
                                    id: record.id,
                                    type: record.type,
                                    timeISO: (record.timestamp?.toDate?.() || new Date()).toISOString(),
                                    lat: record.location?.latitude ?? null,
                                    lng: record.location?.longitude ?? null,
                                    locationName: record.locationName || '',
                                    dutyType: record.dutyType || ''
                                }))}'>
                                    <button class="edit-record-btn bg-yellow-500 text-white px-2 py-1 rounded text-sm">
                                        <i data-lucide="pencil"></i> 編輯
                                    </button>
                                    <button class="delete-record-btn bg-red-600 text-white px-2 py-1 rounded text-sm">
                                        <i data-lucide="trash-2"></i> 刪除
                                    </button>
                                </span>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                lucide.createIcons();
                container.querySelectorAll('.map-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lat = parseFloat(e.currentTarget.dataset.lat);
                        const lng = parseFloat(e.currentTarget.dataset.lng);
                        if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                        else showToast('無位置資訊可顯示', true);
                    });
                });
                container.querySelectorAll('.photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                        const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                        openPhotoModal(photos, descriptions);
                    });
                });

                // 顯示並綁定管理員控制按鈕
                (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)).then(isAdmin => {
                    if (!isAdmin) return;
                    container.querySelectorAll('.admin-controls').forEach(ctrl => ctrl.classList.remove('hidden'));
                    container.querySelectorAll('.edit-record-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            try {
                                const parent = e.currentTarget.closest('.admin-controls');
                                const recordData = JSON.parse(decodeURIComponent(parent.dataset.record || '%7B%7D'));
                                openEditRecordModal(recordData);
                            } catch (err) {
                                console.error('openEditRecordModal parse error', err);
                                showToast('載入紀錄失敗', true);
                            }
                        });
                    });
                    container.querySelectorAll('.delete-record-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            try {
                                const parent = e.currentTarget.closest('.admin-controls');
                                const recordId = parent.dataset.recordId;
                                if (!recordId) return;
                                const ok = confirm('確定要刪除此出勤紀錄？此操作無法復原。');
                                if (!ok) return;
                                const { doc, deleteDoc } = window.__fs;
                                const db = window.__db;
                                await deleteDoc(doc(db, 'clockInRecords', recordId));
                                showToast('刪除成功');
                                // 重新載入列表
                                const selectedUserId = document.getElementById('user-select')?.value || 'all';
                                const selectedDateStr = document.getElementById('record-date')?.value || new Date().toISOString().split('T')[0];
                                await renderAttendanceRecordsList('attendance-records-list', selectedUserId, selectedDateStr);
                            } catch (err) {
                                console.error('delete clockInRecord error', err);
                                showToast('刪除失敗：請檢查權限', true);
                            }
                        });
                    });
                });
            }

            // 讀取初階主管可見用戶設定
            async function loadJuniorManagerAllowedUsers(managerUserId) {
                try {
                    const docRef = doc(db, 'settings', 'group');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data?.managerGroups?.[managerUserId] || [];
                    }
                } catch (e) { console.error('loadJuniorManagerAllowedUsers error', e); }
                return [];
            }
            
            function renderTrackingMap(container) {
                container.innerHTML = `
                    <div class="relative w-full min-h-[420px] md:min-h-[520px]">
                        <div id="tracking-map" class="w-full h-full min-h-[420px] md:min-h-[520px]"></div>
                        <div id="tracking-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
<button id="tracking-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>回到社區
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-2">
                            <div id="user-tracking-list" class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg max-h-[180px] overflow-y-auto p-2 space-y-2">
                                <!-- User list will be populated here -->
                            </div>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                if (state.googleMapsLoaded) {
                    initTrackingMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) {
                            clearInterval(interval);
                            initTrackingMap();
                        }
                    }, 100);
                }
            }

            async function initTrackingMap() {
                const mapDiv = document.getElementById('tracking-map');
                const mapLoader = document.getElementById('tracking-map-loader');
                if (!mapDiv || !mapLoader) return;

                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

                // 以目前選擇的社區 GPS 為中心；若無則退回設定或預設
                let mapCenter = null;
                let circleRadius = null;
                const c = state.currentCommunity || {};
                const cLat = typeof c.lat === 'number' ? c.lat : null;
                const cLng = typeof c.lng === 'number' ? c.lng : null;
                if (cLat != null && cLng != null) {
                    mapCenter = { lat: cLat, lng: cLng };
                    if (typeof c.radius === 'number' && c.radius > 0) circleRadius = c.radius;
                } else {
                    try {
                        const docSnap = await getDoc(doc(db, "settings", "location"));
                        if (docSnap.exists()) {
                            const s = docSnap.data();
                            // 優先社區中心，其次舊公司中心
                            if (typeof s.communityLat === 'number' && typeof s.communityLng === 'number') {
                                mapCenter = { lat: s.communityLat, lng: s.communityLng };
                            } else if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                                mapCenter = { lat: s.companyLat, lng: s.companyLng };
                            }
                            if (typeof s.companyRadius === 'number' && s.companyRadius > 0) circleRadius = s.companyRadius;
                        }
                    } catch (e) { console.warn("載入中心點失敗，使用預設中心點", e); }
                }
                if (!mapCenter) mapCenter = { lat: 25.0330, lng: 121.5654 };
                
                state.trackingMap = new google.maps.Map(mapDiv, {
                    center: mapCenter,
                    zoom: 16,
                    disableDefaultUI: true,
                    zoomControl: true,
                    mapId: 'DEMO_MAP_ID' // Required for Advanced Markers
                });
                // 將中心點存入狀態，供「回到社區」使用
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('tracking-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.trackingMap.panTo(state.companyCenter);
                            state.trackingMap.setZoom(16);
                        } else {
                            showToast('尚未設定社區座標', true);
                        }
                    });
                }

                // 清理舊的中心標記與半徑圈
                try { if (state.trackingCenterMarker) state.trackingCenterMarker.map = null; } catch (_) {}
                try { if (state.trackingRadiusCircle) state.trackingRadiusCircle.setMap(null); } catch (_) {}

                // 在社區中心點放置圖示
                const centerIcon = document.createElement('div');
                centerIcon.className = 'w-10 h-10 rounded-full bg-white border border-gray-300 shadow flex items-center justify-center';
                const innerDot = document.createElement('div');
                innerDot.className = 'w-3 h-3 rounded-full bg-red-600 border-2 border-white';
                centerIcon.appendChild(innerDot);

                state.trackingCenterMarker = new AdvancedMarkerElement({
                    position: mapCenter,
                    map: state.trackingMap,
                    title: '社區中心',
                    content: centerIcon,
                    zIndex: 1000
                });

                // 標示社區打卡半徑
                if (typeof circleRadius === 'number' && circleRadius > 0) {
                    state.trackingRadiusCircle = new google.maps.Circle({
                        map: state.trackingMap,
                        center: mapCenter,
                        radius: circleRadius,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.1
                    });
                }

                mapLoader.classList.add('hide');
                listenForUserLocations();
            }
            
            function renderTrackingAttendance(container, params = {}) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="user-select" class="text-sm font-medium">選擇人員:</label>
                                <select id="user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">全部人員</option>
                                    <!-- 人員選項將動態添加 -->
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="record-date" class="text-sm font-medium">選擇日期:</label>
                                <input type="date" id="record-date" value="${new Date().toISOString().split('T')[0]}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                        </div>
                        <div id="attendance-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">正在讀取紀錄...</div>
                        </div>
                    </div>
                `;
                
                // 載入所有用戶
                const { collection, getDocs } = window.__fs || {};
                const db = window.__db;
                const usersRef = db && collection ? collection(db, "users") : null;
                const userSelect = document.getElementById('user-select');
                if (!usersRef || !getDocs) {
                    document.getElementById('attendance-records-list').innerHTML = '<div class="p-4 text-red-600">資料庫尚未就緒</div>';
                    return;
                }
                
                getDocs(usersRef).then((querySnapshot) => {
                    const users = [];
                    querySnapshot.forEach(doc => {
                        users.push({ id: doc.id, ...doc.data() });
                    });
                    
                    users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        userSelect.appendChild(option);
                    });
                    // 若帶入 selectedUserId 參數，預選該使用者
                    if (params && params.selectedUserId) {
                        userSelect.value = params.selectedUserId;
                    }
                    
                    // 初始載入記錄
                    loadAttendanceRecords();
                });
                
                const dateInput = document.getElementById('record-date');
                userSelect.addEventListener('change', loadAttendanceRecords);
                dateInput.addEventListener('change', loadAttendanceRecords);
                
                async function loadAttendanceRecords() {
                    const selectedDate = new Date(dateInput.value);
                    const startOfDay = new Date(selectedDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(selectedDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    const selectedUserId = userSelect.value;
                    
                    const recordsRef = collection(db, "clockInRecords");
                    let q;
                    const { Timestamp } = window.__fs || {};
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                    
                    if (selectedUserId === 'all') {
                        q = query(recordsRef, 
                            where("timestamp", ">=", startTS),
                            where("timestamp", "<=", endTS)
                        );
                    } else {
                        q = query(recordsRef, 
                            where("userId", "==", selectedUserId),
                            where("timestamp", ">=", startTS),
                            where("timestamp", "<=", endTS)
                        );
                    }
                    
                    const recordsList = document.getElementById('attendance-records-list');
                    recordsList.innerHTML = `<div class="text-center p-4 text-gray-500">正在讀取紀錄...</div>`;
                    await ensureAbnormalMarkingConfig();
                    await ensureCommunitiesCache();
                    getDocs(q).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = `<p class="text-center text-gray-500 p-4">無打卡紀錄</p>`;
                            return;
                        }
                        
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // 獲取所有用戶資料，用於顯示名稱
                        getDocs(usersRef).then((usersSnapshot) => {
                            const usersMap = {};
                            usersSnapshot.forEach(doc => {
                                usersMap[doc.id] = doc.data().name;
                            });
                            
                            recordsList.innerHTML = '';
                            records.sort((a, b) => {
                                const timeA = a.timestamp?.toDate?.() || new Date(0);
                                const timeB = b.timestamp?.toDate?.() || new Date(0);
                                return timeB - timeA;
                            }).forEach(record => {
                                const time = record.timestamp?.toDate?.() || new Date();
                                const userName = usersMap[record.userId] || '未知用戶';
                                const abnormalInfo = computeRecordAbnormal(record, (users.find(u => u.id === record.userId)?.serviceCommunities) || []);
                                const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                                    ? `<div class="mt-1"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">打卡位置異常</span>${abnormalInfo.detail ? `<span class=\"ml-2 text-xs text-gray-500\">${abnormalInfo.detail}</span>` : ''}</div>`
                                    : '';
                                
                                const card = document.createElement('div');
                                card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                                card.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-semibold">${userName}</div>
                                            <div class="text-sm text-gray-500">${time.toLocaleString('zh-TW', { hour12: false })}</div>
                                            <div class="mt-1 flex items-center">
                                                <span class="px-2 py-0.5 rounded text-sm ${getStatusBgColor(getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null))}">${getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null)}</span>
                        ${record.location && typeof record.location.latitude === 'number' && typeof record.location.longitude === 'number' ? `<span class="ml-2 text-sm text-gray-500">${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</span>` : ''}
                                            </div>
                                            <div class="mt-1 text-xs text-gray-500">裝置ID: ${record.deviceId || '未知'}</div>
                                            ${abnormalHtml}
                                        </div>
                                        <div class="flex space-x-2 items-start"></div>
                                    </div>
                                    <div class="mt-2 flex space-x-2 overflow-x-auto items-center">
                                        ${record.photoUrls && record.photoUrls.length > 0 ? `
                                            <button class="photo-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" 
                                                data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                                data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                                <i data-lucide="image"></i> 照片 (${record.photoUrls.length})
                                            </button>
                                        ` : ''}
                                        ${record.location ? `
                                            <button class="map-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                                data-lat="${record.location.latitude}" 
                                                data-lng="${record.location.longitude}">
                                                <i data-lucide="map-pin"></i> 地圖
                                            </button>
                                        ` : ''}
                                        <!-- Admin controls: edit/delete -->
                                        <span class="admin-controls hidden" data-record-id="${record.id}" data-record='${encodeURIComponent(JSON.stringify({
                                            id: record.id,
                                            type: record.type,
                                            timeISO: (record.timestamp?.toDate?.() || new Date()).toISOString(),
                                            lat: record.location?.latitude ?? null,
                                            lng: record.location?.longitude ?? null,
                                            locationName: record.locationName || '',
                                            dutyType: record.dutyType || ''
                                        }))}'>
                                            <button class="edit-record-btn bg-yellow-500 text-white px-2 py-1 rounded text-sm">
                                                <i data-lucide="pencil"></i> 編輯
                                            </button>
                                            <button class="delete-record-btn bg-red-600 text-white px-2 py-1 rounded text-sm">
                                                <i data-lucide="trash-2"></i> 刪除
                                            </button>
                                        </span>
                                    </div>
                                `;
                                recordsList.appendChild(card);
                            });
                            
                            lucide.createIcons();
                            
                            // 添加地圖和照片按鈕的事件監聽器
                            document.querySelectorAll('.map-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const lat = parseFloat(e.currentTarget.dataset.lat);
                                    const lng = parseFloat(e.currentTarget.dataset.lng);
                                    if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                                    else showToast("無位置資訊可顯示", true);
                                });
                            });
                            
                            document.querySelectorAll('.photo-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                    const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                    openPhotoModal(photos, descriptions);
                                });
                            });

                            // 顯示並綁定管理員控制按鈕
                            (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)).then(isAdmin => {
                                if (!isAdmin) return;
                                recordsList.querySelectorAll('.admin-controls').forEach(ctrl => ctrl.classList.remove('hidden'));
                                recordsList.querySelectorAll('.edit-record-btn').forEach(btn => {
                                    btn.addEventListener('click', (e) => {
                                        try {
                                            const parent = e.currentTarget.closest('.admin-controls');
                                            const recordData = JSON.parse(decodeURIComponent(parent.dataset.record || '%7B%7D'));
                                            openEditRecordModal(recordData);
                                        } catch (err) {
                                            console.error('openEditRecordModal parse error', err);
                                            showToast('載入紀錄失敗', true);
                                        }
                                    });
                                });
                                recordsList.querySelectorAll('.delete-record-btn').forEach(btn => {
                                    btn.addEventListener('click', async (e) => {
                                        try {
                                            const parent = e.currentTarget.closest('.admin-controls');
                                            const recordId = parent.dataset.recordId;
                                            if (!recordId) return;
                                            const ok = confirm('確定要刪除此出勤紀錄？此操作無法復原。');
                                            if (!ok) return;
                                            const { doc, deleteDoc } = window.__fs;
                                            const db = window.__db;
                                            await deleteDoc(doc(db, 'clockInRecords', recordId));
                                            showToast('刪除成功');
                                            loadAttendanceRecords();
                                        } catch (err) {
                                            console.error('delete clockInRecord error', err);
                                            showToast('刪除失敗：請檢查權限', true);
                                        }
                                    });
                                });
                            });
                        });
                    }).catch(error => {
                        console.error("Error fetching records:", error);
                        recordsList.innerHTML = `<div class="text-center text-red-500 p-4">讀取紀錄失敗。</div>`;
                    });
                }
                
                function getStatusBgColor(typeOrText) {
                    const s = String(typeOrText || '').toLowerCase();
                    if (s.includes('上班') || s.includes('返回') || s.includes('在辦')) return 'bg-green-100 text-green-800';
                    if (s.includes('下班')) return 'bg-red-100 text-red-800';
                    if (s.includes('外出') || s.includes('抵達') || s.includes('離開')) return 'bg-blue-100 text-blue-800';
                    if (s.includes('請假')) return 'bg-orange-100 text-orange-800';
                    if (s.includes('特殊勤務')) return 'bg-indigo-100 text-indigo-800';
                    return 'bg-gray-100 text-gray-800';
                }
            }
            
            function renderTrackingLeave(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="leave-status-filter" class="text-sm font-medium">審核狀態:</label>
                                <select id="leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>全部</option>
                                    <option value="pending">待審核</option>
                                    <option value="approved">已核准</option>
                                    <option value="rejected">已拒絕</option>
                                    <option value="canceled">已取消</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="leave-date-filter" class="text-sm font-medium">日期:</label>
                                <input type="date" id="leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="leave-show-deleted" class="rounded" />
                                <span class="text-sm font-medium">顯示已刪除</span>
                            </label>
                            <button id="leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>搜尋
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">請假人</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">事由</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">開始時間</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">結束時間</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    載入中...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="no-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>沒有符合條件的請假記錄</p>
                        </div>
                    </div>
                `;
                
                lucide.createIcons();
                
                // 獲取元素
                const statusFilter = document.getElementById('leave-status-filter');
                const dateFilter = document.getElementById('leave-date-filter');
                const searchBtn = document.getElementById('leave-search-btn');
                const showDeletedChk = document.getElementById('leave-show-deleted');

                // 取得 Firestore 快捷參考（後續多處使用）
                const db = window.__db; 
                const { collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, serverTimestamp } = window.__fs;

                // 讀取當前使用者是否為管理員
                let isAdmin = false;
                (async () => {
                    try {
                        const uid = window.__auth?.currentUser?.uid;
                        if (uid) {
                            const userSnap = await getDoc(doc(db, 'users', uid));
                            if (userSnap.exists()) {
                                const role = userSnap.data().role;
                                isAdmin = role === 'admin';
                            }
                        }
                    } catch (err) {
                        console.warn('讀取使用者角色失敗', err);
                    } finally {
                        // 初始加載數據
                        loadLeaveRecords();
                    }
                })();
                
                // 添加搜尋按鈕事件
                searchBtn.addEventListener('click', () => {
                    loadLeaveRecords();
                });
                // 顯示已刪除勾選事件
                showDeletedChk.addEventListener('change', () => {
                    loadLeaveRecords();
                });
                
                // 加載請假記錄
                function loadLeaveRecords() {
                    const recordsList = document.getElementById('leave-records-list');
                    const noRecordsMsg = document.getElementById('no-leave-records');
                    
                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    載入中...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                    
                    // 獲取過濾條件
                    const status = statusFilter.value;
                    const date = dateFilter.value;
                    
                    // 構建查詢
                    let leavesQuery = collection(db, 'leaves');
                    
                    // 如果選擇了特定狀態
                    if (status !== 'all') {
                        leavesQuery = query(leavesQuery, where('status', '==', status));
                    }

                    // 按創建時間排序
                    leavesQuery = query(leavesQuery, orderBy('createdAt', 'desc'));

                    // 執行查詢
                    getDocs(leavesQuery).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }
                        
                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';
                        
                        // 日期過濾
                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }
                        
                        let hasRecords = false;
                        
                        querySnapshot.forEach((docSnap) => {
                            const leave = docSnap.data();
                            const leaveId = docSnap.id;
                            const isDeleted = !!leave.deleted;
                            
                            // 若未勾選顯示已刪除，則過濾掉 deleted 記錄
                            if (!showDeletedChk.checked && isDeleted) {
                                return;
                            }
                            
                            // 如果選擇了日期，檢查請假時間是否在所選日期範圍內
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                
                                // 檢查請假時間是否與所選日期有重疊
                                if (!(startTime < nextDay && endTime > selectedDate)) {
                                    return; // 跳過不符合日期條件的記錄
                                }
                            }
                            
                            hasRecords = true;
                            
                            const startTime = leave.startTime.toDate().toLocaleString('zh-TW', { hour12: false });
                            const endTime = leave.endTime.toDate().toLocaleString('zh-TW', { hour12: false });
                            
                            let statusBadge = '';
                            switch (leave.status) {
                                case 'pending':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">待審核</span>';
                                    break;
                                case 'approved':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">已核准</span>';
                                    break;
                                case 'rejected':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">已拒絕</span>';
                                    break;
                                case 'canceled':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">已取消</span>';
                                    break;
                                default:
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">未知</span>';
                            }
                            
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            
                            let actionButtons = '';
                            if (leave.status === 'pending') {
                                actionButtons += `
                                    <button data-leave-id="${leaveId}" data-action="approve" class="text-green-600 hover:text-green-900 mr-3">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    </button>
                                    <button data-leave-id="${leaveId}" data-action="reject" class="text-red-600 hover:text-red-900">
                                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                                    </button>
                                `;
                            }
                            if (isAdmin) {
                                actionButtons += `
                                    <button data-leave-id="${leaveId}" data-action="${isDeleted ? 'restore' : 'delete'}" class="text-gray-600 hover:text-gray-900 ml-3">
                                        <i data-lucide="${isDeleted ? 'rotate-ccw' : 'trash-2'}" class="w-5 h-5"></i>
                                    </button>
                                `;
                            }
                            
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">${leave.userName || '未知用戶'}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || '無事由'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${statusBadge}
                                    ${isDeleted ? '<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-500">已刪除</span>' : ''}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    ${actionButtons}
                                </td>
                            `;
                            
                            recordsList.appendChild(row);
                        });
                        
                        lucide.createIcons();
                        
                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                        
                        // 添加操作按鈕事件（審核／刪除／還原）
                        document.querySelectorAll('[data-leave-id]').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const leaveId = e.currentTarget.dataset.leaveId;
                                const action = e.currentTarget.dataset.action;
                                
                                try {
                                    showLoading(true);
                                    
                                    // 獲取請假記錄
                                    const leaveDocSnap = await getDoc(doc(db, 'leaves', leaveId));
                                    if (!leaveDocSnap.exists()) {
                                        showToast('找不到請假記錄', true);
                                        return;
                                    }
                                    const leaveData = leaveDocSnap.data();
                                    const userId = leaveData.userId;
                                    
                                    if (action === 'approve' || action === 'reject') {
                                        // 更新請假記錄狀態（審核）
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            status: action === 'approve' ? 'approved' : 'rejected',
                                            reviewedAt: serverTimestamp(),
                                            reviewedBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        // 如果核准，更新用戶狀態
                                        if (action === 'approve') {
                                            await updateDoc(doc(db, 'users', userId), { leaveStatus: 'approved' });
                                        }
                                        showToast(`已${action === 'approve' ? '核准' : '拒絕'}請假申請`);
                                    } else if (action === 'delete') {
                                        // 軟刪除
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            deleted: true,
                                            deletedAt: serverTimestamp(),
                                            deletedBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        showToast('已標記為刪除');
                                    } else if (action === 'restore') {
                                        // 還原
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            deleted: false,
                                            restoredAt: serverTimestamp(),
                                            restoredBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        showToast('已還原刪除標記');
                                    }
                                    
                                    // 重新加載記錄
                                    loadLeaveRecords();
                                } catch (error) {
                                    console.error('處理請假申請失敗:', error);
                                    showToast('處理請假申請失敗，請稍後再試', true);
                                } finally {
                                    showLoading(false);
                                }
                            });
                        });
                    }).catch(error => {
                        console.error('獲取請假記錄失敗:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-red-500">
                                    讀取記錄失敗，請稍後再試
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            function renderTrackingReports(container) {
                container.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-report="personal" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 active">個人日報表</button>
                        <button data-report="all" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600">全體月報表</button>
                    </div>
                    <div id="report-content" class="p-4">
                        <div class="text-center">
                            <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">報表功能開發中</h2>
                            <p class="text-gray-500">此功能正在開發中，敬請期待！</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                
                container.querySelectorAll('.report-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        container.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const reportType = btn.dataset.report;
                        const reportContent = document.getElementById('report-content');
                        
                        reportContent.innerHTML = `
                            <div class="text-center">
                                <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h2 class="text-xl font-semibold text-gray-700 mb-2">${reportType === 'personal' ? '個人日報表' : '全體月報表'}功能開發中</h2>
                                <p class="text-gray-500">此功能正在開發中，敬請期待！</p>
                            </div>
                        `;
                        lucide.createIcons();
                    });
                });
            }

            async function listenForUserLocations() {
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    state.trackingMarkers.forEach(marker => marker.map = null);
                    state.trackingMarkers = [];

                    const userListEl = document.getElementById('user-tracking-list');
                    if (!userListEl) return;
                    userListEl.innerHTML = '';

                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

                    // 依一般設定過濾可見人員
                    let visibilityMap = {};
                    try {
                        const saved = localStorage.getItem('app_general_settings');
                        if (saved) {
                            const settings = JSON.parse(saved);
                            visibilityMap = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn('載入可見人員設定失敗', e);
                    }
                    const filteredUsers = users.filter(u => visibilityMap[u.id] !== false);

                    // 僅顯示指定社區角色（總幹事、秘書、保全、清潔、機電）；若已選擇社區，僅顯示該社區成員
                    let baseList = filteredUsers.filter(u => isFieldLikeRole(u.role));
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || null;
                    if (currentCommId || currentCommCode) {
                        baseList = baseList.filter(u => {
                            const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                            const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                            const codeSingle = u.serviceCommunityCode || null;
                            const matchById = currentCommId ? ids.includes(currentCommId) : false;
                            const matchByCode = currentCommCode ? (codesArr.includes(currentCommCode) || codeSingle === currentCommCode) : false;
                            return matchById || matchByCode;
                        });
                    }

                    if (baseList.length === 0) {
                        userListEl.innerHTML = `<p class="text-center text-gray-500 p-2">該社區目前沒有可追蹤的人員</p>`;
                        return;
                    }

                    // 讀取每位使用者最新打卡紀錄，並以此顯示與排序
                    const { collection: fsCollection, query: fsQuery, where, orderBy: fsOrderBy, limit, getDocs } = window.__fs || {};
                    const dbRef = window.__db || null;

                    const augmentedPromises = baseList.map(async (user) => {
                        let latestRecord = null;
                        try {
                            if (fsCollection && fsQuery && where && fsOrderBy && limit && getDocs && dbRef) {
                                const recQ = fsQuery(
                                    fsCollection(dbRef, 'clockInRecords'),
                                    where('userId', '==', user.id),
                                    fsOrderBy('timestamp', 'desc'),
                                    limit(1)
                                );
                                const snap = await getDocs(recQ);
                                if (!snap.empty) {
                                    latestRecord = snap.docs[0].data();
                                }
                            }
                        } catch (e) {
                            console.warn('取得最新打卡紀錄失敗', e);
                        }

                        // 狀態文字與時間：優先使用最新紀錄，否則回退 user 欄位
                        const recordType = latestRecord?.type || user.clockInStatus || user.status || '未打卡';
                        const recordLocationName = latestRecord?.locationName || user.lastLocation?.address || null;
                        const dutyType = latestRecord?.dutyType || null;
                        let statusText = getStatusDisplayText(recordType, recordLocationName, dutyType);

                        // 核准的請假：顯示「請假」（橘色），僅在當天有效期內；未核准但臨時請假顯示「請假申請」
                        const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                        const now = new Date();
                        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                        if (user.leaveStatus === 'approved' && user.leaveStartTime && user.leaveEndTime) {
                            const leaveStart = toDate(user.leaveStartTime);
                            const leaveEnd = toDate(user.leaveEndTime);
                            if (leaveStart && leaveEnd && leaveStart <= todayEnd && leaveEnd >= todayStart) {
                                statusText = '請假';
                            }
                        } else if (user.clockInStatus === '臨時請假') {
                            statusText = '請假申請';
                        }

                        const ts = latestRecord?.timestamp && latestRecord.timestamp.toDate ? latestRecord.timestamp.toDate() : (latestRecord?.timestamp ? new Date(latestRecord.timestamp) : (user.lastClockInTime?.toDate ? user.lastClockInTime.toDate() : null));

                        return {
                            ...user,
                            __statusText: statusText,
                            __lastStatusTime: ts,
                            __latestRecord: latestRecord || null
                        };
                    });

                    Promise.all(augmentedPromises).then((augmentedUsers) => {
                        // 排序對齊「所有同仁狀態」：狀態優先級 -> 最近更新時間(新→舊) -> 姓名
                        const statusPriority = (u) => {
                        const display = u.__statusText || getStatusDisplayText(u.clockInStatus || '未打卡', (u.clockInStatus === '外出' && u.outboundLocation ? u.outboundLocation : (u.lastLocation?.address || null)), u.dutyType);
                            let isLeave = (u.clockInStatus === '臨時請假') || (display.includes('請假'));
                            if (!isLeave) {
                                const leave = u.leaveStatus || '';
                                if (leave === 'approved' || leave === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (u.leaveStartTime && u.leaveEndTime) {
                                        const leaveStart = u.leaveStartTime.toDate ? u.leaveStartTime.toDate() : new Date(u.leaveStartTime);
                                        const leaveEnd = u.leaveEndTime.toDate ? u.leaveEndTime.toDate() : new Date(u.leaveEndTime);
                                        isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                    }
                                }
                            }
                            if (display.includes('上班') && (display.includes('辦公室') || display.includes('在辦公室'))) return 1;
                            if (display.includes('返回') && (display.includes('辦公室') || display.includes('在辦公室'))) return 2;
                            if (display.startsWith('外出-')) return 3;
                            if (display.startsWith('抵達-')) return 4;
                            if (display.startsWith('離開-')) return 5;
                            if (isLeave) return 6;
                            if (display.includes('下班')) return 7;
                            return 8;
                        };

                        augmentedUsers.sort((a, b) => {
                            const prA = statusPriority(a);
                            const prB = statusPriority(b);
                            if (prA !== prB) return prA - prB;
                            const tA = a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0);
                            const tB = b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0);
                            if (tA.getTime() !== tB.getTime()) return tB - tA;
                            return (a.name || '').localeCompare(b.name || '', 'zh-Hant');
                        });

                        // 生成列表與地圖標記
                        augmentedUsers.forEach(user => {
                            const recLoc = user.__latestRecord?.location || null;
                            const recLat = recLoc && typeof recLoc.latitude === 'number' ? recLoc.latitude : (user.__latestRecord?.locationLat ?? null);
                            const recLng = recLoc && typeof recLoc.longitude === 'number' ? recLng : (user.__latestRecord?.locationLng ?? null);
                            const hasRecordLocation = typeof recLat === 'number' && typeof recLng === 'number';
                            const hasLastLocation = user.lastLocation && typeof user.lastLocation.latitude === 'number' && typeof user.lastLocation.longitude === 'number';
                            const hasLocation = hasRecordLocation || hasLastLocation;

                            const userElement = document.createElement('div');
                            userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                            const statusColorClass = getStatusColor(user.__statusText || '未打卡');

                            // 距離與圈內外顯示
                            let distanceText = '';
                            let rangeText = '';
                            let insideRange = null;
                            let position = null;
                            if (hasLocation) {
                                position = hasRecordLocation
                                    ? { lat: recLat, lng: recLng }
                                    : { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                                const center = state.companyCenter || (state.trackingMap ? state.trackingMap.getCenter().toJSON() : null);
                                const radius = state.trackingRadiusCircle ? state.trackingRadiusCircle.getRadius() : null;
                                if (center && typeof center.lat === 'number' && typeof center.lng === 'number') {
                                    const toRad = d => d * Math.PI / 180;
                                    const R = 6371000;
                                    const dLat = toRad(position.lat - center.lat);
                                    const dLng = toRad(position.lng - center.lng);
                                    const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(center.lat)) * Math.cos(toRad(position.lat)) * Math.sin(dLng/2) ** 2;
                                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                                    const dist = R * c;
                                    distanceText = `距社區約 ${Math.round(dist)}m`;
                                    if (typeof radius === 'number') {
                                        insideRange = dist <= radius;
                                        rangeText = insideRange ? '（範圍內）' : '（範圍外）';
                                    }
                                }
                            }

                            userElement.innerHTML = `
                                <div class="flex items-center">
                                    <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.name || 'U').charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                    <div>
                                        <p class="font-medium text-sm text-gray-800">${user.name || '未知用戶'}</p>
                                        <p class="text-xs font-semibold ${statusColorClass}">${user.__statusText || '未打卡'}</p>
                                        ${distanceText ? `<p class=\"text-xs text-gray-500\">${distanceText}${rangeText}</p>` : ''}
                                    </div>
                                </div>
                                <span class="text-xs text-gray-400">${user.__lastStatusTime ? '最近狀態時間：' + timeAgo(user.__lastStatusTime) : '無紀錄'}</span>
                            `;
                            userListEl.appendChild(userElement);

                            if (hasLocation) {
                                const markerIcon = document.createElement('img');
                                markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${(user.name || 'U').charAt(0)}`;
                                const roleColorMap = { '總幹事': 'border-amber-500', '秘書': 'border-purple-500', '保全': 'border-green-800', '清潔': 'border-pink-400', '機電': 'border-blue-500' };
const titleKey = ((user.applicationTitle || user.jobTitle || user.role || '').trim());
const roleBorderClass = roleColorMap[titleKey] || null;
                                const borderClass = roleBorderClass || (insideRange === true ? 'border-green-500' : (insideRange === false ? 'border-red-500' : 'border-white'));
                                markerIcon.className = `w-9 h-9 rounded-full border-2 ${borderClass} shadow-md object-cover`;

                                const marker = new AdvancedMarkerElement({
                                    position,
                                    map: state.trackingMap,
                                    title: user.name || '',
                                    content: markerIcon,
                                });

                                const locationName = user.__latestRecord?.locationName
                                    || (user.clockInStatus === '外出' ? (user.outboundLocation || '') : '')
                                    || (user.lastLocation?.address || '');
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `
                                        <div class="p-1">
                                            <p class="font-bold">${user.name || '未知用戶'}</p>
                                            <p>狀態: ${user.__statusText || '未打卡'}</p>
                                            <p>最近狀態時間: ${user.__lastStatusTime ? formatDateTime(user.__lastStatusTime) : 'N/A'}</p>
                                            ${locationName ? `<p>打卡地點: ${locationName}</p>` : ''}
                                            ${distanceText ? `<p>距社區：${distanceText.replace('距社區約 ', '').replace('m',' 公尺')} ${insideRange === null ? '' : (insideRange ? '(圈內)' : '(圈外)')}</p>` : ''}
                                        </div>
                                    `
                                });

                                marker.addListener('click', () => {
                                    infoWindow.open({ anchor: marker, map: state.trackingMap });
                                });

                                userElement.addEventListener('click', () => {
                                    state.trackingMap.panTo(position);
                                    state.trackingMap.setZoom(17);
                                    infoWindow.open({ anchor: marker, map: state.trackingMap });
                                });

                                state.trackingMarkers.push(marker);
                            }
                        });
                    });
                });
                state.activeListeners.push(unsubscribe);
            }


            function renderSettings(subPage) {
                // 新增「帳號申請」子分頁，提供管理員審核
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="applications" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'applications' ? 'active' : ''}">帳號申請</button>
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">帳號列表</button>
                        <button data-subtab="community" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'community' ? 'active' : ''}">社區列表</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'applications') {
                    renderSettingsApplications(subPageContent);
                } else if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else {
                    renderSettingsCommunity(subPageContent);
                }

                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('settings', btn.dataset.subtab)));
            }

            function renderSettingsGroup(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <h2 class="text-lg font-semibold">群組設定</h2>
                        <p class="text-sm text-gray-600">將初階主管關聯至可查看的員工名單。</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="manager-select-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">選擇管理者</h3>
                                <select id="manager-user-select" class="w-full border border-gray-300 rounded-md px-2 py-1"></select>
                            </div>
                            <div id="allowed-users-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">可查看員工</h3>
                                <div id="allowed-users-list" class="space-y-2"></div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="save-group-settings" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700">儲存設定</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initSettingsGroupUI();
            }

            async function initSettingsGroupUI() {
                const managerSelect = document.getElementById('manager-user-select');
                const allowedList = document.getElementById('allowed-users-list');
                const usersRef = collection(db, 'users');
                const qs = await getDocs(usersRef);
                const users = [];
                qs.forEach(docSnap => users.push({ id: docSnap.id, ...docSnap.data() }));
                const managers = users.filter(u => u.role === 'junior_manager');
                managers.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(m => {
                    const opt = document.createElement('option'); opt.value = m.id; opt.textContent = `${m.name}`; managerSelect.appendChild(opt);
                });

                const renderAllowedUsers = async () => {
                    allowedList.innerHTML = '';
                    const selectedManagerId = managerSelect.value;
                    const allowedIds = await loadJuniorManagerAllowedUsers(selectedManagerId);
                    users.filter(u => u.role === 'user').sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(u => {
                        const row = document.createElement('label');
                        row.className = 'flex items-center justify-between bg-white p-2 rounded border';
                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.checked = allowedIds.includes(u.id);
                        chk.dataset.userid = u.id;
                        row.appendChild(document.createTextNode(u.name));
                        row.appendChild(chk);
                        allowedList.appendChild(row);
                    });
                };
                managerSelect.addEventListener('change', renderAllowedUsers);
                await renderAllowedUsers();

                document.getElementById('save-group-settings').addEventListener('click', async () => {
                    const selectedManagerId = managerSelect.value;
                    const checkboxes = allowedList.querySelectorAll('input[type="checkbox"]');
                    const allowedIds = Array.from(checkboxes).filter(c => c.checked).map(c => c.dataset.userid);
                    const docRef = doc(db, 'settings', 'group');
                    const existingSnap = await getDoc(docRef);
                    const baseData = existingSnap.exists() ? existingSnap.data() : {};
                    const newData = { ...baseData, managerGroups: { ...(baseData.managerGroups || {}), [selectedManagerId]: allowedIds } };
                    await setDoc(docRef, newData, { merge: true });
                    showToast('群組設定已儲存');
                });
            }
            
            async function renderSettingsAccounts(container) {
                const isHRPage = state.currentPage === 'hr';
                const isGlobalSettings = state.currentPage === 'settings' || state.currentPage === 'navigation';
                const rolesHR = ['總幹事','秘書','保全','清潔','機電'];
                const rolesGlobal = ['admin','hr','manager','junior_manager','總幹事','秘書','保全','清潔','機電'];
                const roleOpts = (isHRPage ? rolesHR : rolesGlobal)
                    .map(r => `<option value="${r}">${roleLabel(r)}</option>`)
                    .join('');
                const communityFilterHtml = isGlobalSettings ? `
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">社區</label>
                                    <select id="filter-community" class="w-full px-3 py-2 border rounded-md">
                                        <option value="">全部社區</option>
                                    </select>
                                </div>` : '';
                const tipHtml = isHRPage
                    ? '<div class="text-sm text-gray-500">此列表僅顯示目前社區之人員；不提供新增功能。</div>'
                    : '<div class="text-sm text-gray-500">顯示全部社區之人員；可依角色與社區過濾。</div>';

                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="bg-white p-3 rounded-md shadow-sm border space-y-2">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-lg">帳號列表</h3>
                                ${ (state.currentPage === 'navigation' && (state.currentUserData?.role === 'admin')) ? `<button id="add-user-btn" class="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700">新增帳號</button>` : '' }
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">角色</label>
                                    <select id="filter-role" class="w-full px-3 py-2 border rounded-md">
                                        <option value="">全部角色</option>
                                        ${roleOpts}
                                    </select>
                                </div>
                                ${communityFilterHtml}
                            </div>
                        </div>

                        ${tipHtml}
                        <div id="user-list" class="space-y-2"></div>
                    </div>`;
                lucide.createIcons();

                const userList = document.getElementById('user-list');
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));

                // 篩選狀態
                let allUsers = [];
                let lastRendered = [];
                const roleSelect = document.getElementById('filter-role');
                const communitySelect = document.getElementById('filter-community');
                let communitiesCache = [];

                roleSelect.addEventListener('change', renderUserList);
                if (isGlobalSettings && communitySelect) {
                    try { await ensureCommunitiesCache(); } catch (_) {}
                    try { computeAvailableCommunities(); } catch (_) {}
                    const byId = state.communitiesById || {};
                    const list = Object.values(byId).slice().sort(compareCommunitiesByCode);
                    communitiesCache = list;
                    communitySelect.innerHTML = `<option value="">全部社區</option>` + list.map(c => `<option value="${c.id}" data-code="${c.code || ''}">${c.code ? '['+c.code+'] ' : ''}${c.name || '(未命名社區)'}</option>`).join('');
                    communitySelect.addEventListener('change', renderUserList);
                }

                const addBtn = document.getElementById('add-user-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', () => openUserModal());
                }

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    allUsers = [];
                    querySnapshot.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
                    state.users = allUsers; // Update global state
                    renderUserList();
                });

                function renderUserList() {
                    userList.innerHTML = '';
                    if (allUsers.length === 0) {
                        userList.innerHTML = `<p class="text-center text-gray-500 p-4">尚未建立任何帳號</p>`;
                        return;
                    }
                    const selectedRole = roleSelect.value || '';
                    const allowedRoles = isHRPage ? rolesHR : rolesGlobal;
                    let filtered = allUsers.filter(u => selectedRole ? (u.role === selectedRole) : allowedRoles.includes(u.role));

                    if (isHRPage) {
                        // 依目前社區過濾服務成員（僅顯示服務該社區的人員）
                        const currentCommId = state.currentCommunity?.id || null;
                        const currentCommCode = state.currentCommunity?.code || null;
                        if (currentCommId || currentCommCode) {
                            filtered = filtered.filter(u => {
                                const byId = currentCommId ? (Array.isArray(u.serviceCommunities) && u.serviceCommunities.includes(currentCommId)) : false;
                                const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                                const byCode = currentCommCode ? (codesArr.includes(currentCommCode) || (u.serviceCommunityCode === currentCommCode)) : false;
                                return byId || byCode;
                            });
                        } else {
                            // 無指定社區，提示選擇社區並顯示空列表
                            filtered = [];
                            userList.innerHTML = `<p class="text-center text-gray-500 p-4">請先選擇社區</p>`;
                            return;
                        }
                    } else if (isGlobalSettings && communitySelect) {
                        // 設定/導覽設定頁：可選社區過濾；預設顯示全部社區
                        const selectedCommId = communitySelect.value || '';
                        if (selectedCommId) {
                            const selectedComm = communitiesCache.find(c => c.id === selectedCommId);
                            const selectedCode = selectedComm?.code || '';
                            filtered = filtered.filter(u => {
                                const byId = Array.isArray(u.serviceCommunities) && u.serviceCommunities.includes(selectedCommId);
                                const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                                const byCode = selectedCode ? (codesArr.includes(selectedCode) || (u.serviceCommunityCode === selectedCode)) : false;
                                return byId || byCode;
                            });
                        }
                    }

                    // 人員依姓氏筆畫少→多
                    filtered = filtered.slice().sort(compareUsersBySurnameStroke);

                    filtered.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${(user.name||'?').charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-gray-800">${user.name || '(未命名)'}</p>
                                    <p class="text-sm text-gray-500">${user.email || ''}</p>
                                    <div class="flex items-center flex-wrap gap-2 mt-1">
                                        <p class="text-xs text-gray-400 mr-2">${user.phone || ''}</p>
                                        <span class="text-xs px-2 py-1 rounded-full ${roleBadgeClass(user.role)}">${roleLabel(user.role)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-userid="${user.id}" class="edit-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-userid="${user.id}" class="delete-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>`;
                        userList.appendChild(userElement);
                    });
                    lastRendered = filtered;
                    lucide.createIcons();

                    document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToEdit = state.users.find(u => u.id === userId);
                        if (userToEdit) openUserModal(userToEdit);
                    }));

                    document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToDelete = state.users.find(u => u.id === userId);
                        if (userToDelete && confirm(`確定要刪除 ${userToDelete.name} 的帳號資料嗎？\n注意：此操作只會刪除資料庫紀錄，不會刪除使用者的登入權限。`)) {
                            try {
                                showLoading(true);
                                await deleteDoc(doc(db, "users", userId));
                                showToast("帳號資料刪除成功");
                            } catch (error) {
                                console.error("Error deleting user document:", error);
                                showToast("刪除失敗", true);
                            } finally {
                                showLoading(false);
                            }
                        }
                    }));
                }

                state.activeListeners.push(unsubscribe);
            }

            // 設定分頁：帳號申請（審核）
            function renderSettingsApplications(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="bg-white p-3 rounded-md shadow-sm border space-y-2">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-lg">帳號申請審核</h3>
                                <div class="flex items-center space-x-2">
                                    <button data-status="" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600 active">全部</button>
                                    <button data-status="pending" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600">待審</button>
                                    <button data-status="approved" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600">已核准</button>
                                    <button data-status="rejected" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600">已拒絕</button>
                                </div>
                            </div>
                        </div>

                        <div id="applications-list" class="space-y-2"></div>
                    </div>`;
                if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }

                const listEl = document.getElementById('applications-list');
                const statusButtons = container.querySelectorAll('.status-filter-btn');
                let allApps = [];
                let currentStatus = '';

                statusButtons.forEach(btn => btn.addEventListener('click', () => {
                    container.querySelectorAll('.status-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStatus = btn.dataset.status || '';
                    renderList();
                }));

                const { collection: fsCollection, query: fsQuery, orderBy: fsOrderBy, onSnapshot: fsOnSnapshot, doc: fsDoc, getDoc: fsGetDoc, setDoc: fsSetDoc, updateDoc: fsUpdateDoc, where: fsWhere, getDocs: fsGetDocs, serverTimestamp: fsServerTimestamp } = window.__fs || {};
                const appsCol = fsCollection(db, 'accountApplications');
                const q = fsQuery(appsCol, fsOrderBy('createdAt', 'desc'));
                const unsubscribe = fsOnSnapshot(q, (snap) => {
                    allApps = [];
                    snap.forEach(ds => allApps.push({ id: ds.id, ...ds.data() }));
                    renderList();
                });
                state.activeListeners.push(unsubscribe);

                function renderList() {
                    listEl.innerHTML = '';
                    let filtered = currentStatus ? allApps.filter(a => (a.status || 'pending') === currentStatus) : allApps;

                    // 依目前社區代號過濾申請
                    const currentCommCode = state.currentCommunity?.code || null;
                    if (currentCommCode) {
                        filtered = filtered.filter(a => (a.serviceCommunityCode || '') === currentCommCode);
                    } else {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">請先選擇社區</p>`;
                        return;
                    }

                    if (filtered.length === 0) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">目前該社區沒有申請</p>`;
                        return;
                    }
                    filtered.forEach(app => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        const licenseStr = app.license || '無';
                        let createdAtText = '';
                        try {
                            const dt = app.createdAt?.toDate ? app.createdAt.toDate() : (app.createdAt ? new Date(app.createdAt) : null);
                            if (dt) createdAtText = formatDateTime(dt);
                        } catch (_) {}

                        el.innerHTML = `
                            <div class="flex items-center">
                                <img src="${app.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${(app.name||'?').charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-gray-800">${app.name || '(未填姓名)'}</p>
                                    <p class="text-sm text-gray-500">${app.email || ''}</p>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span class="mr-2">${app.phone || ''}</span>
                                        <span class="mr-2">地址：${app.homeAddress || ''}</span>
                                        <span class="mr-2">生日：${app.birthDate || ''}</span>
                                        <span class="mr-2">身分證：${app.idNumber || ''}</span>
                                        <span class="mr-2">證照：${licenseStr}</span>
                                        <span class="mr-2">社區代號：${app.serviceCommunityCode || ''}</span>
                                    </div>
                                    ${createdAtText ? `<p class="text-xs text-gray-400 mt-1">申請時間：${createdAtText}</p>` : ''}
                                    ${app.status && app.status !== 'pending' ? `<p class="text-xs mt-1 ${app.status==='approved' ? 'text-green-600' : 'text-red-600'}">狀態：${app.status === 'approved' ? '已核准' : '已拒絕'}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                ${app.status === 'pending' ? `
                                <button data-id="${app.id}" class="approve-btn p-2 text-gray-500 hover:text-green-600"><i data-lucide="check" class="w-4 h-4"></i></button>
                                <button data-id="${app.id}" class="reject-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                                ` : ''}
                            </div>`;
                        listEl.appendChild(el);
                    });
                    if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                        lucide.createIcons();
                    }
                    container.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', () => handleApprove(btn.dataset.id)));
                    container.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', () => handleReject(btn.dataset.id)));
                }

                async function handleApprove(appId) {
                    try {
                        showLoading(true);
                        const appRef = fsDoc(db, 'accountApplications', appId);
                        const appSnap = await fsGetDoc(appRef);
                        if (!appSnap.exists()) {
                            showToast('申請不存在', true);
                            return;
                        }
                        const app = appSnap.data();
                        const email = (app.email || '').trim();
                        if (!email) { showToast('申請缺少電子郵件', true); return; }

                        // 建立 Auth 帳號（隨機暫時密碼），若 email 已存在則嘗試掛接既有使用者
                        let targetUserId = null;
                        let createdAuthUser = false;
                        try {
                            const { initializeApp: initializeAppSecondary, deleteApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
                            const secondaryApp = initializeAppSecondary(firebaseConfig, `secondary-app-${Date.now()}`);
                            const secondaryAuth = getAuth(secondaryApp);
                            const tempPassword = `Temp${Math.random().toString(36).slice(2, 10)}!1`;
                            const cred = await createUserWithEmailAndPassword(secondaryAuth, email, tempPassword);
                            targetUserId = cred.user.uid;
                            createdAuthUser = true;
                            await signOut(secondaryAuth);
                            await deleteApp(secondaryApp);
                        } catch (creationError) {
                            if (creationError?.code === 'auth/email-already-in-use') {
                                try {
                                    const usersRef = fsCollection(db, 'users');
                                    const q = fsQuery(usersRef, fsWhere('email', '==', email));
                                    const qs = await fsGetDocs(q);
                                    if (!qs.empty) {
                                        targetUserId = qs.docs[0].id;
                                    } else {
                                        throw creationError;
                                    }
                                } catch (_) {
                                    throw creationError;
                                }
                            } else {
                                throw creationError;
                            }
                        }

                        // 依代號映射服務社區
                        let serviceCommunities = [];
                        try {
                            const communitiesRef = fsCollection(db, 'communities');
                            const qs = await fsGetDocs(fsQuery(communitiesRef, fsWhere('code', '==', app.serviceCommunityCode || '')));
                            qs.forEach(docSnap => serviceCommunities.push(docSnap.id));
                        } catch (_) {}

                        const userDoc = {
                            name: app.name || '',
                            phone: app.phone || '',
                            email,
                            role: 'user',
                            jobTitle: app.applicationTitle || '',
                            serviceCommunities,
                            homeAddress: app.homeAddress || '',
                            birthDate: app.birthDate || '',
                            idNumber: app.idNumber || '',
                            license: app.license || '無',
                            serviceCommunityCode: app.serviceCommunityCode || '',
                            avatarUrl: app.avatarUrl || null,
                            points: 0,
                            status: '未打卡',
                            createdAt: fsServerTimestamp(),
                        };
                        if (targetUserId) {
                            await fsSetDoc(fsDoc(db, 'users', targetUserId), userDoc, { merge: true });
                        }

                        const updates = {
                            status: 'approved',
                            reviewerId: auth.currentUser?.uid || '',
                            reviewedAt: fsServerTimestamp(),
                            reviewNotes: ''
                        };
                        if (targetUserId) updates.convertedUserId = targetUserId;
                        await fsUpdateDoc(appRef, updates);

                        if (createdAuthUser) { try { await sendPasswordResetEmail(auth, email); } catch (_) {} }
                        showToast('已核准並建立帳號');
                    } catch (err) {
                        console.error('approve application error', err);
                        const msg = err?.code === 'auth/email-already-in-use' ? 'Email 已存在於系統，請確認' : (err.message || '核准失敗');
                        showToast(msg, true);
                    } finally {
                        showLoading(false);
                    }
                }

                async function handleReject(appId) {
                    try {
                        const reason = prompt('請輸入拒絕原因（可留空）') || '';
                        showLoading(true);
                        const appRef = fsDoc(db, 'accountApplications', appId);
                        await fsUpdateDoc(appRef, {
                            status: 'rejected',
                            reviewerId: auth.currentUser?.uid || '',
                            reviewedAt: fsServerTimestamp(),
                            reviewNotes: reason || ''
                        });
                        showToast('已拒絕此申請');
                    } catch (err) {
                        console.error('reject application error', err);
                        showToast('拒絕失敗', true);
                    } finally {
                        showLoading(false);
                    }
                }
            }

            function renderSettingsGeneral(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">儀表板設定</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label for="show-employee-status" class="text-gray-700">顯示員工狀態</label>
                                    <label class="switch">
                                        <input type="checkbox" id="show-employee-status" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4" id="admin-overtime-section" style="display: none;">
                            <h3 class="font-bold text-lg mb-4">管理員功能</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="text-gray-700 font-medium">檢查超時狀態</label>
                                        <p class="text-sm text-gray-500">檢查所有員工是否有超過工作時數的情況</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="check-overtime-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                            <i data-lucide="clock" class="w-4 h-4 mr-2"></i>檢查超時
                                        </button>
                                        <button id="test-overtime-btn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 flex items-center">
                                            <i data-lucide="test-tube" class="w-4 h-4 mr-2"></i>測試超時
                                        </button>
                                    </div>
                                </div>

                                <!-- 補建使用者文件（單筆/批次） -->
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="text-gray-700 font-medium">補建使用者文件</label>
                                        <p class="text-sm text-gray-500">從申請資料補齊 users 文件（單筆或批次）</p>
                                    </div>
                                    <div class="flex space-x-2 items-center">
                                        <input type="email" id="backfill-email-input" class="border rounded-md px-2 py-1 w-56" placeholder="輸入 Email">
                                        <button id="backfill-by-email-btn" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 flex items-center">
                                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>補齊單筆
                                        </button>
                                        <button id="batch-backfill-users-btn" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 flex items-center">
                                            <i data-lucide="refresh-ccw" class="w-4 h-4 mr-2"></i>批次補齊
                                        </button>
                                    </div>
                                </div>

                                <div id="overtime-results" class="hidden">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                        <h4 class="font-medium text-yellow-800 mb-2">超時員工列表</h4>
                                        <div id="overtime-list" class="space-y-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">顯示所有帳號</h3>
                            <p class="text-sm text-gray-600 mb-4">勾選要在儀表板「所有同仁狀態」中顯示的帳號</p>
                            <div id="user-display-settings" class="space-y-2">
                                <div class="flex items-center justify-between p-2 border-b">
                                    <label class="text-gray-700 font-medium">帳號名稱</label>
                                    <label class="text-gray-700 font-medium">顯示</label>
                                </div>
                                <div class="flex justify-center items-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                                    <span class="ml-2 text-gray-600">載入中...</span>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-general-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>儲存設定
                        </button>
                    </div>`;
                
                lucide.createIcons();

                // 顯示管理員區塊（管理員或審核角色可見）
                if (typeof window.checkReviewerStatus === 'function') {
                    window.checkReviewerStatus().then(isReviewer => {
                        const adminSection = document.getElementById('admin-overtime-section');
                        if (adminSection) adminSection.style.display = isReviewer ? 'block' : 'none';
                    }).catch(() => {});
                }

                // 別名與工具
                const dbRef = window.__db;
                const { doc: fsDoc, getDoc: fsGetDoc, setDoc: fsSetDoc, updateDoc: fsUpdateDoc, collection: fsCollection, query: fsQuery, where: fsWhere, getDocs: fsGetDocs, serverTimestamp: fsServerTimestamp } = window.__fs || {};
                const authRef = window.__auth;

                // 權限安全的欄位值
                function normalizeLicense(lic) {
                    const allowed = ['無','職業安全衛生業務主管證照','職業安全衛生管理員證照','防火避難設施管理人員證照','設備安全管理人員證照','救生員證照'];
                    return allowed.includes(lic || '') ? lic : '無';
                }

                async function resolveCommunitiesByCode(code) {
                    if (!dbRef || !fsCollection || !fsQuery || !fsWhere || !fsGetDocs) return [];
                    if (!code) return [];
                    try {
                        const qs = await fsGetDocs(fsQuery(fsCollection(dbRef, 'communities'), fsWhere('code', '==', code)));
                        const ids = [];
                        qs.forEach(d => ids.push(d.id));
                        return ids;
                    } catch (_) { return []; }
                }

                async function backfillByEmail() {
                    try {
                        const emailInput = document.getElementById('backfill-email-input');
                        const email = (emailInput?.value || '').trim();
                        if (!email) { showToast('請輸入 Email', true); return; }
                        showLoading(true);

                        // 取得申請資料（若存在）
                        let app = null;
                        if (dbRef && fsCollection && fsQuery && fsWhere && fsGetDocs) {
                            const appsCol = fsCollection(dbRef, 'accountApplications');
                            const qs = await fsGetDocs(fsQuery(appsCol, fsWhere('email', '==', email)));
                            let latest = null;
                            qs.forEach(snap => {
                                const data = snap.data();
                                const item = { id: snap.id, ...data };
                                if (!latest) latest = item; else latest = item; // 不排序，保留最後一筆
                            });
                            app = latest;
                        }

                        // 找使用者 UID
                        let targetUserId = null;
                        if (dbRef && fsCollection && fsQuery && fsWhere && fsGetDocs) {
                            const usersCol = fsCollection(dbRef, 'users');
                            const uq = await fsGetDocs(fsQuery(usersCol, fsWhere('email', '==', email)));
                            if (!uq.empty) {
                                targetUserId = uq.docs[0].id;
                            }
                        }
                        if (!targetUserId && app && app.convertedUserId) targetUserId = app.convertedUserId;
                        if (!targetUserId) {
                            showToast('找不到使用者 UID，請先用核准流程建立 Auth 帳號', true);
                            return;
                        }

                        // 準備 users 文件資料
                        const serviceCommunities = await resolveCommunitiesByCode(app?.serviceCommunityCode || '');
                        const userDoc = {
                            name: app?.name || email,
                            phone: app?.phone || '',
                            email,
                            role: 'user',
                            jobTitle: app?.applicationTitle || '',
                            serviceCommunities,
                            homeAddress: app?.homeAddress || '',
                            birthDate: app?.birthDate || '',
                            idNumber: app?.idNumber || '',
                            license: normalizeLicense(app?.license),
                            serviceCommunityCode: app?.serviceCommunityCode || '',
                            avatarUrl: app?.avatarUrl || null,
                            points: 0,
                            status: '未打卡',
                            createdAt: fsServerTimestamp ? fsServerTimestamp() : new Date(),
                        };

                        if (!dbRef || !fsDoc || !fsSetDoc) { showToast('環境未就緒，請稍後再試', true); return; }
                        await fsSetDoc(fsDoc(dbRef, 'users', targetUserId), userDoc, { merge: true });

                        // 同步申請狀態與對應 UID（若有申請）
                        if (app && fsUpdateDoc && fsDoc) {
                            const updates = {
                                status: 'approved',
                                convertedUserId: targetUserId,
                                reviewerId: authRef?.currentUser?.uid || '',
                                reviewedAt: fsServerTimestamp ? fsServerTimestamp() : new Date(),
                                reviewNotes: '補齊建立'
                            };
                            await fsUpdateDoc(fsDoc(dbRef, 'accountApplications', app.id), updates);
                        }

                        showToast('已補齊使用者文件');
                    } catch (err) {
                        console.error('backfillByEmail error', err);
                        showToast('補齊失敗：' + (err?.message || '未知錯誤'), true);
                    } finally { showLoading(false); }
                }

                async function batchBackfillUsers() {
                    try {
                        showLoading(true);
                        if (!dbRef || !fsCollection || !fsQuery || !fsWhere || !fsGetDocs || !fsGetDoc || !fsSetDoc || !fsDoc) {
                            showToast('環境未就緒，請稍後再試', true); return;
                        }
                        const appsCol = fsCollection(dbRef, 'accountApplications');
                        const qs = await fsGetDocs(fsQuery(appsCol, fsWhere('status', '==', 'approved')));
                        let done = 0, skipped = 0;
                        for (const docSnap of qs.docs) {
                            const app = { id: docSnap.id, ...docSnap.data() };
                            const uid = app.convertedUserId;
                            if (!uid) { skipped++; continue; }
                            const userRef = fsDoc(dbRef, 'users', uid);
                            const userSnap = await fsGetDoc(userRef);
                            if (userSnap.exists()) { skipped++; continue; }
                            const serviceCommunities = await resolveCommunitiesByCode(app?.serviceCommunityCode || '');
                            const userDoc = {
                                name: app?.name || app?.email || '未命名',
                                phone: app?.phone || '',
                                email: app?.email || '',
                                role: 'user',
                                jobTitle: app?.applicationTitle || '',
                                serviceCommunities,
                                homeAddress: app?.homeAddress || '',
                                birthDate: app?.birthDate || '',
                                idNumber: app?.idNumber || '',
                                license: normalizeLicense(app?.license),
                                serviceCommunityCode: app?.serviceCommunityCode || '',
                                avatarUrl: app?.avatarUrl || null,
                                points: 0,
                                status: '未打卡',
                                createdAt: fsServerTimestamp ? fsServerTimestamp() : new Date(),
                            };
                            await fsSetDoc(userRef, userDoc, { merge: true });
                            done++;
                        }
                        if (done > 0) {
                            showToast(`批次補齊完成：${done} 筆，略過 ${skipped} 筆`);
                        } else {
                            showToast('沒有需要補齊的帳號');
                        }
                    } catch (err) {
                        console.error('batchBackfillUsers error', err);
                        showToast('批次補齊失敗：' + (err?.message || '未知錯誤'), true);
                    } finally { showLoading(false); }
                }

                // 綁定按鈕事件
                const backfillEmailBtn = document.getElementById('backfill-by-email-btn');
                if (backfillEmailBtn) backfillEmailBtn.addEventListener('click', backfillByEmail);
                const batchBtn = document.getElementById('batch-backfill-users-btn');
                if (batchBtn) batchBtn.addEventListener('click', batchBackfillUsers);
                
                // 從 Firebase 讀取設定
                const settingsRef = doc(db, "settings", "general");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('show-employee-status').checked = settings.showEmployeeStatus !== false;
                        
                        
                        
                        // 載入使用者顯示設定
                        loadUserDisplaySettings(settings.visibleUsers || {});
                    } else {
                        // 如果設定不存在，載入預設值（全部顯示）
                        loadUserDisplaySettings({});
                    }
                }).catch(error => {
                    console.error("Error getting general settings:", error);
                    showToast("無法讀取設定", true);
                    // 發生錯誤時，仍然載入使用者列表
                    loadUserDisplaySettings({});
                });
                
                // 載入使用者列表並設定顯示狀態
                function loadUserDisplaySettings(visibleUsers) {
                    const userDisplayContainer = document.getElementById('user-display-settings');
                    
                    // 獲取所有使用者
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((querySnapshot) => {
                        // 清除載入中的提示
                        userDisplayContainer.innerHTML = `
                            <div class="flex items-center justify-between p-2 border-b">
                                <label class="text-gray-700 font-medium">帳號名稱</label>
                                <label class="text-gray-700 font-medium">顯示</label>
                            </div>
                        `;
                        
                        // 添加全選/取消全選選項
                        const selectAllDiv = document.createElement('div');
                        selectAllDiv.className = 'flex items-center justify-between p-2 border-b bg-gray-50';
                        selectAllDiv.innerHTML = `
                            <label for="select-all-users" class="text-gray-700 font-medium">全選/取消全選</label>
                            <label class="switch">
                                <input type="checkbox" id="select-all-users">
                                <span class="slider round"></span>
                            </label>
                        `;
                        userDisplayContainer.appendChild(selectAllDiv);
                        
                        // 獲取全選/取消全選的checkbox
                        const selectAllCheckbox = document.getElementById('select-all-users');
                        
                        // 添加使用者列表
                        const userCheckboxes = [];
                        querySnapshot.forEach((doc) => {
                            const userData = doc.data();
                            const userId = doc.id;
                            
                            // 預設值：如果visibleUsers為空或該使用者未設定，則顯示
                            const isVisible = visibleUsers[userId] !== false;
                            
                            const userDiv = document.createElement('div');
                            userDiv.className = 'flex items-center justify-between p-2 border-b';
                            userDiv.innerHTML = `
                                <label for="user-${userId}" class="text-gray-700">${userData.name || userData.email || '未命名使用者'}</label>
                                <label class="switch">
                                    <input type="checkbox" id="user-${userId}" data-user-id="${userId}" class="user-visibility-checkbox" ${isVisible ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            `;
                            userDisplayContainer.appendChild(userDiv);
                            
                            // 將checkbox加入陣列，以便後續全選/取消全選操作
                            const checkbox = userDiv.querySelector(`#user-${userId}`);
                            userCheckboxes.push(checkbox);
                        });
                        
                        // 設定全選/取消全選的功能
                        selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                        selectAllCheckbox.addEventListener('change', () => {
                            const isChecked = selectAllCheckbox.checked;
                            userCheckboxes.forEach(cb => {
                                cb.checked = isChecked;
                            });
                        });
                        
                        // 當個別checkbox變更時，更新全選checkbox的狀態
                        userCheckboxes.forEach(cb => {
                            cb.addEventListener('change', () => {
                                selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                            });
                        });
                        
                    }).catch(error => {
                        console.error("Error getting users:", error);
                        userDisplayContainer.innerHTML = `
                            <div class="p-4 text-center text-red-600">
                                <p>無法載入使用者列表</p>
                                <p class="text-sm">${error.message}</p>
                            </div>
                        `;
                    });
                }
                
                // 儲存設定
                document.getElementById('save-general-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const showEmployeeStatus = document.getElementById('show-employee-status').checked;
                        
                        
                        // 收集使用者顯示設定
                        const visibleUsers = {};
                        document.querySelectorAll('.user-visibility-checkbox').forEach(checkbox => {
                            const userId = checkbox.dataset.userId;
                            // 只儲存未勾選的使用者（預設為顯示）
                            if (!checkbox.checked) {
                                visibleUsers[userId] = false;
                            }
                        });
                        
                        // 儲存到 Firebase
                        await setDoc(doc(db, "settings", "general"), {
                            showEmployeeStatus,
                            
                            visibleUsers,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("設定已儲存");
                    } catch (error) {
                        console.error("Error saving general settings:", error);
                        showToast("儲存設定失敗：" + error.message, true);
                    } finally {
                        showLoading(false);
                    }
                });
                
                
                
                // 全域函數已定義於檔案頂端，這裡不再重複宣告
            }
            
            function renderSettingsLocation(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">公司位置設定</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="company-lat" class="block text-sm font-medium text-gray-700">緯度</label>
                                        <input type="number" id="company-lat" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                    <div>
                                        <label for="company-lng" class="block text-sm font-medium text-gray-700">經度</label>
                                        <input type="number" id="company-lng" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                </div>
                                <div>
                                    <label for="company-radius" class="block text-sm font-medium text-gray-700">有效打卡半徑 (公尺)</label>
                                    <input type="number" id="company-radius" min="10" max="1000" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="mark-abnormal-location" class="text-gray-700">標記異常位置</label>
                                    <label class="switch">
                                        <input type="checkbox" id="mark-abnormal-location" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">其他打卡位置</h3>
                            <div id="other-locations" class="space-y-4">
                                <!-- 其他位置會動態添加在這裡 -->
                            </div>
                            <button id="add-location-btn" class="w-full mt-4 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>新增位置
                            </button>
                        </div>
                        
                        <button id="save-location-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>儲存設定
                        </button>
                    </div>`;
                
                lucide.createIcons();
                
                // 從 Firebase 讀取設定
                const settingsRef = doc(db, "settings", "location");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('company-lat').value = settings.companyLat || '';
                        document.getElementById('company-lng').value = settings.companyLng || '';
                        document.getElementById('company-radius').value = settings.companyRadius || 100;
                        document.getElementById('mark-abnormal-location').checked = settings.markAbnormalLocation !== false;
                        
                        // 渲染其他位置
                        renderOtherLocations(settings.otherLocations || []);
                    }
                }).catch(error => {
                    console.error("Error getting location settings:", error);
                    showToast("無法讀取位置設定", true);
                });
                
                // 渲染其他位置
                function renderOtherLocations(locations) {
                    const container = document.getElementById('other-locations');
                    container.innerHTML = '';
                    
                    if (locations.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">尚未設定其他位置</p>';
                        return;
                    }
                    
                    locations.forEach((location, index) => {
                        const locationEl = document.createElement('div');
                        locationEl.className = 'bg-gray-50 p-3 rounded-md border';
                        locationEl.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">${location.name || `位置 ${index + 1}`}</h4>
                                <button class="delete-location-btn text-red-500" data-index="${index}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-xs text-gray-500">名稱</label>
                                    <input type="text" class="location-name w-full px-2 py-1 border rounded-md text-sm" value="${location.name || ''}" placeholder="位置名稱">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">半徑 (公尺)</label>
                                    <input type="number" class="location-radius w-full px-2 py-1 border rounded-md text-sm" value="${location.radius || 100}" min="10" max="1000">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-500">緯度</label>
                                    <input type="number" class="location-lat w-full px-2 py-1 border rounded-md text-sm" value="${location.lat || ''}" step="0.000001">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">經度</label>
                                    <input type="number" class="location-lng w-full px-2 py-1 border rounded-md text-sm" value="${location.lng || ''}" step="0.000001">
                                </div>
                            </div>
                        `;
                        container.appendChild(locationEl);
                    });
                    
                    lucide.createIcons();
                    
                    // 刪除位置按鈕事件
                    document.querySelectorAll('.delete-location-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.dataset.index);
                            const settingsRef = doc(db, "settings", "location");
                            getDoc(settingsRef).then((docSnap) => {
                                if (docSnap.exists()) {
                                    const settings = docSnap.data();
                                    const otherLocations = settings.otherLocations || [];
                                    otherLocations.splice(index, 1);
                                    renderOtherLocations(otherLocations);
                                }
                            });
                        });
                    });
                }
                
                // 新增位置按鈕事件
                document.getElementById('add-location-btn').addEventListener('click', () => {
                    const settingsRef = doc(db, "settings", "location");
                    getDoc(settingsRef).then((docSnap) => {
                        const settings = docSnap.exists() ? docSnap.data() : {};
                        const otherLocations = settings.otherLocations || [];
                        otherLocations.push({
                            name: `位置 ${otherLocations.length + 1}`,
                            lat: '',
                            lng: '',
                            radius: 100
                        });
                        renderOtherLocations(otherLocations);
                    });
                });
                
                // 儲存設定
                document.getElementById('save-location-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const companyLat = parseFloat(document.getElementById('company-lat').value);
                        const companyLng = parseFloat(document.getElementById('company-lng').value);
                        const companyRadius = parseInt(document.getElementById('company-radius').value);
                        const markAbnormalLocation = document.getElementById('mark-abnormal-location').checked;
                        
                        // 收集其他位置資料
                        const otherLocations = [];
                        document.querySelectorAll('#other-locations > div').forEach(el => {
                            const name = el.querySelector('.location-name').value;
                            const lat = parseFloat(el.querySelector('.location-lat').value);
                            const lng = parseFloat(el.querySelector('.location-lng').value);
                            const radius = parseInt(el.querySelector('.location-radius').value);
                            
                            if (name && !isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
                                otherLocations.push({ name, lat, lng, radius });
                            }
                        });
                        
                        await setDoc(doc(db, "settings", "location"), {
                            companyLat,
                            companyLng,
                            companyRadius,
                            markAbnormalLocation,
                            otherLocations,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("位置設定已儲存");
                    } catch (error) {
                        console.error("Error saving location settings:", error);
                        showToast("儲存位置設定失敗", true);
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            function renderSettingsWorkdays(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg">上班設定（每人每月）</h3>
                                <div class="flex items-center space-x-2">
                                    <button id="prev-month" class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                        <i data-lucide="chevrons-left" class="w-4 h-4"></i>
                                    </button>
                                    <span id="workdays-month-label" class="font-semibold"></span>
                                    <button id="next-month" class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                        <i data-lucide="chevrons-right" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">為目前登入者設定指定月份的上班日。</p>
                            <div id="workdays-grid" class="grid grid-cols-7 gap-2"></div>
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <button id="select-weekdays" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200">選取週一至週五</button>
                                <button id="clear-selection" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200">清除選取</button>
                            </div>
                            <button id="save-workdays" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>儲存本月上班日
                            </button>
                        </div>
                    </div>`;

                lucide.createIcons();

                const { doc, getDoc, setDoc, serverTimestamp } = window.__fs || {};
                const db = window.__db;
                const user = window.__auth?.currentUser;
                if (!user) {
                    showToast('請先登入', true);
                    return;
                }

                let targetYear, targetMonth; // 0-based month
                const gridEl = document.getElementById('workdays-grid');
                const labelEl = document.getElementById('workdays-month-label');

                function setMonth(date) {
                    targetYear = date.getFullYear();
                    targetMonth = date.getMonth();
                    labelEl.textContent = `${targetYear}年${String(targetMonth + 1).padStart(2,'0')}月`;
                    renderMonthGrid();
                    loadWorkdays();
                    // 載入本月週五值班人員
                    loadFridayDuty?.();
                }

                function daysInMonth(y, m0) {
                    return new Date(y, m0 + 1, 0).getDate();
                }

                function renderMonthGrid(selectedDays = new Set()) {
                    gridEl.innerHTML = '';
                    // Weekday headers
                    const weekdays = ['日','一','二','三','四','五','六'];
                    weekdays.forEach(w => {
                        const h = document.createElement('div');
                        h.className = 'text-center text-gray-500 text-sm';
                        h.textContent = w;
                        gridEl.appendChild(h);
                    });
                    // First day offset
                    const firstDay = new Date(targetYear, targetMonth, 1).getDay();
                    for (let i = 0; i < firstDay; i++) {
                        const empty = document.createElement('div');
                        gridEl.appendChild(empty);
                    }
                    const dim = daysInMonth(targetYear, targetMonth);
                    for (let d = 1; d <= dim; d++) {
                        const cell = document.createElement('button');
                        cell.className = 'border rounded p-2 text-center hover:bg-gray-50';
                        cell.dataset.day = String(d);
                        const dow = new Date(targetYear, targetMonth, d).getDay();
                        const isSelected = selectedDays.has(d);
                        cell.innerHTML = `
                            <div class="text-xs text-gray-500">${['日','一','二','三','四','五','六'][dow]}</div>
                            <div class="text-lg">${d}</div>
                        `;
                        if (isSelected) {
                            cell.classList.add('bg-blue-100','border-blue-400');
                        }
                        cell.addEventListener('click', () => {
                            cell.classList.toggle('bg-blue-100');
                            cell.classList.toggle('border-blue-400');
                        });
                        gridEl.appendChild(cell);
                    }
                }

                async function loadWorkdays() {
                    try {
                        const ymId = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}`;
                        const ref = doc(db, 'users', user.uid, 'workdays', ymId);
                        const snap = await getDoc(ref);
                        const selected = new Set();
                        if (snap.exists()) {
                            const data = snap.data();
                            (data.days || []).forEach(n => selected.add(Number(n)));
                        }
                        renderMonthGrid(selected);
                    } catch (err) {
                        console.error('載入上班日設定失敗:', err);
                        renderMonthGrid(new Set());
                        showToast('載入上班日設定失敗', true);
                    }
                }

                function getSelectedDays() {
                    const selected = [];
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        if (btn.classList.contains('bg-blue-100')) {
                            selected.push(Number(btn.dataset.day));
                        }
                    });
                    return selected;
                }

                document.getElementById('prev-month').addEventListener('click', () => {
                    const d = new Date(targetYear, targetMonth - 1, 1);
                    setMonth(d);
                });
                document.getElementById('next-month').addEventListener('click', () => {
                    const d = new Date(targetYear, targetMonth + 1, 1);
                    setMonth(d);
                });
                document.getElementById('select-weekdays').addEventListener('click', () => {
                    // Select Mon-Fri
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        const day = Number(btn.dataset.day);
                        const dow = new Date(targetYear, targetMonth, day).getDay();
                        if (dow >= 1 && dow <= 5) {
                            btn.classList.add('bg-blue-100','border-blue-400');
                        } else {
                            btn.classList.remove('bg-blue-100','border-blue-400');
                        }
                    });
                });
                document.getElementById('clear-selection').addEventListener('click', () => {
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        btn.classList.remove('bg-blue-100','border-blue-400');
                    });
                });

                document.getElementById('save-workdays').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const days = getSelectedDays();
                        const ymId = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}`;
                        const ref = doc(db, 'users', user.uid, 'workdays', ymId);
                        await setDoc(ref, { days, updatedAt: serverTimestamp() }, { merge: true });
                        showToast('本月上班日已儲存');
                    } catch (err) {
                        console.error('儲存上班日失敗:', err);
                        showToast('儲存上班日失敗', true);
                    } finally {
                        showLoading(false);
                    }
                });

                // 動態插入週五值班名單（分週設定）
                try {
                    const root = container.querySelector('.p-4');
                    const dutyHTML = `
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg">指定月份每週五值班名單（分週設定）</h3>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">每週單獨設定，請從下拉清單選擇值班人員（可多選），不要手寫輸入。</p>
                            <div id="friday-roster-list" class="space-y-2"></div>
                            <div class="flex items-center justify-end mt-2">
                                <button id="save-friday-roster" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>儲存指定月份值班名單
                                </button>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">已儲存：<span id="friday-duty-display"></span></div>
                        </div>`;
                    root?.insertAdjacentHTML('beforeend', dutyHTML);
                    lucide.createIcons();
                } catch(e) { console.warn('插入週五值班人員區塊失敗', e); }

                // 供值班名單選擇使用：所有使用者姓名
                let allUserNames = [];

                async function loadAllUserNames() {
                    try {
                        if (typeof getDocs !== 'function' || typeof collection !== 'function') {
                            allUserNames = [];
                            return;
                        }
                        const snap = await getDocs(collection(db, 'users'));
                        const namesSet = new Set();
                        snap.forEach(docu => {
                            const data = docu.data();
                            const name = (data.displayName || data.name || data.email || docu.id || '').toString().trim();
                            if (name) namesSet.add(name);
                        });
                        allUserNames = Array.from(namesSet).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                    } catch (e) {
                        console.warn('讀取所有帳號姓名失敗', e);
                        allUserNames = [];
                    }
                }

                // 工具：取得某月所有週五日期（YYYY-MM-DD）
                function getFridaysInMonth(year, month0) {
                    const fridays = [];
                    const last = new Date(year, month0 + 1, 0).getDate();
                    for (let d = 1; d <= last; d++) {
                        const dt = new Date(year, month0, d);
                        if (dt.getDay() === 5) {
                            const y = dt.getFullYear();
                            const m = String(dt.getMonth() + 1).padStart(2, '0');
                            const dd = String(dt.getDate()).padStart(2, '0');
                            fridays.push(`${y}-${m}-${dd}`);
                        }
                    }
                    return fridays;
                }

                // 將名單渲染成每週多選下拉列
                function renderFridayRosterList(rosterMap) {
                    const listEl = document.getElementById('friday-roster-list');
                    if (!listEl) return;
                    const fridays = getFridaysInMonth(targetYear, targetMonth);
                    listEl.innerHTML = '';
                    fridays.forEach((iso) => {
                        const presetArr = (rosterMap[iso] || []);
                        const row = document.createElement('div');
                        row.className = 'space-y-1';
                        const label = document.createElement('label');
                        label.className = 'block text-sm text-gray-700';
                        label.textContent = `${iso}（週五）`;
                        const select = document.createElement('select');
                        select.className = 'w-full border border-gray-300 rounded-md px-3 py-2';
                        select.multiple = true;
                        select.setAttribute('data-iso', iso);
                        // 建立選項
                        (allUserNames || []).forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            if (presetArr.includes(name)) opt.selected = true;
                            select.appendChild(opt);
                        });
                        row.appendChild(label);
                        row.appendChild(select);
                        listEl.appendChild(row);
                    });
                }

                // 顯示摘要文字
                function summarizeRosterDisplay(rosterMap) {
                    const fridays = getFridaysInMonth(targetYear, targetMonth);
                    const items = fridays
                        .filter(iso => (rosterMap[iso] || []).length > 0)
                        .map(iso => `${iso}：${(rosterMap[iso] || []).join('、')}`);
                    return items.length ? items.join('；') : '';
                }

                // 週五值班名單載入（全域設定 settings/general.fridayDutyRoster）
                async function loadFridayDuty() {
                    try {
                        const settingsRef = doc(db, 'settings', 'general');
                        const snap = await getDoc(settingsRef);
                        const roster = snap.exists() ? (snap.data().fridayDutyRoster || {}) : {};

                        // 自動帶入名單：若本月未填，嘗試沿用上個月同週次的名單
                        const thisFridays = getFridaysInMonth(targetYear, targetMonth);
                        const prevDate = new Date(targetYear, targetMonth - 1, 1);
                        const prevFridays = getFridaysInMonth(prevDate.getFullYear(), prevDate.getMonth());
                        const renderMap = { ...roster };
                        for (let i = 0; i < thisFridays.length; i++) {
                            const iso = thisFridays[i];
                            const prevIso = prevFridays[i];
                            const hasThis = Array.isArray(renderMap[iso]) && renderMap[iso].length > 0;
                            const hasPrev = prevIso && Array.isArray(roster[prevIso]) && roster[prevIso].length > 0;
                            if (!hasThis && hasPrev) {
                                renderMap[iso] = roster[prevIso];
                            }
                        }

                        // 先載入所有使用者姓名，再渲染多選清單
                        if (!allUserNames || allUserNames.length === 0) {
                            await loadAllUserNames();
                        }
                        renderFridayRosterList(renderMap);
                        const display = document.getElementById('friday-duty-display');
                        if (display) display.textContent = summarizeRosterDisplay(renderMap);
                    } catch (e) {
                        console.warn('載入週五值班名單失敗', e);
                    }
                }

                function parseDutyNames(str) {
                    return (str || '')
                        .split(/[,，、\s]+/)
                        .map(s => s.trim())
                        .filter(s => s.length > 0);
                }

                const saveFridayBtn = document.getElementById('save-friday-roster');
                if (saveFridayBtn) {
                    saveFridayBtn.addEventListener('click', async () => {
                        try {
                            showLoading(true);
                            const settingsRef = doc(db, 'settings', 'general');
                            const snap = await getDoc(settingsRef);
                            const current = snap.exists() ? (snap.data().fridayDutyRoster || {}) : {};
                            const fridays = getFridaysInMonth(targetYear, targetMonth);
                            const updated = { ...current };
                            fridays.forEach(iso => {
                                const select = document.querySelector(`#friday-roster-list select[data-iso="${iso}"]`);
                                const names = Array.from(select?.selectedOptions || []).map(o => o.value);
                                updated[iso] = names;
                            });
                            await setDoc(settingsRef, { fridayDutyRoster: updated, updatedAt: serverTimestamp() }, { merge: true });
                            const display = document.getElementById('friday-duty-display');
                            if (display) display.textContent = summarizeRosterDisplay(updated);
                            showToast('指定月份週五值班名單已儲存');
                        } catch (err) {
                            console.error('儲存週五值班名單失敗:', err);
                            showToast('儲存週五值班名單失敗', true);
                        } finally {
                            showLoading(false);
                        }
                    });
                }

                setMonth(new Date());
            }
            
            function renderSettingsRules(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-rule-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>新增規則
                        </button>
                        <div id="rule-list" class="space-y-2">讀取中...</div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-rule-btn').addEventListener('click', () => openRuleModal());

                const ruleList = document.getElementById('rule-list');
                const rulesRef = collection(db, "pointRules");
                const q = query(rulesRef, orderBy("reason"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    ruleList.innerHTML = '';
                    if (querySnapshot.empty) {
                        ruleList.innerHTML = `<p class="text-center text-gray-500 p-4">尚未建立任何規則</p>`;
                        return;
                    }
                    querySnapshot.forEach(doc => {
                        const rule = { id: doc.id, ...doc.data() };
                        const pointsClass = rule.points > 0 ? 'text-green-600' : 'text-red-600';
                        const ruleElement = document.createElement('div');
                        ruleElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        ruleElement.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${rule.reason}</p>
                                <p class="text-sm text-gray-500">對象: ${rule.target}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg ${pointsClass}">${rule.points > 0 ? '+' : ''}${rule.points}</span>
                                <button data-ruleid="${rule.id}" class="edit-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-ruleid="${rule.id}" class="delete-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        ruleList.appendChild(ruleElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                         const ruleId = e.currentTarget.dataset.ruleid;
                         const ruleDoc = await getDoc(doc(db, "pointRules", ruleId));
                         if (ruleDoc.exists()) {
                            openRuleModal({ id: ruleId, ...ruleDoc.data() });
                         }
                    }));

                    document.querySelectorAll('.delete-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const ruleId = e.currentTarget.dataset.ruleid;
                        if (confirm('確定要刪除此規則嗎？')) {
                            await deleteDoc(doc(db, "pointRules", ruleId));
                            showToast("規則刪除成功");
                        }
                    }));

                });
                state.activeListeners.push(unsubscribe);
            }

            // --- Settings: 社區列表 ---
            function renderSettingsCommunity(container) {
                const canEditCommunity = (state.currentUserData?.role === 'admin');
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="bg-white p-3 rounded-md shadow-sm border">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">區域</label>
                                    <select id="filter-community-region" class="w-full px-3 py-2 border rounded-md">
                                        <option value="">全部</option>
                                        <option value="台北">台北</option>
                                        <option value="新北">新北</option>
                                        <option value="桃園">桃園</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">編號(前綴)</label>
                                    <input id="filter-community-code" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="例如：A" />
                                </div>
                                <div class="flex items-end">
                                    <button id="reset-community-filters" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 flex items-center justify-center">重置篩選</button>
                                </div>
                                <div class="flex items-end">
                                    <button id="add-community-btn" ${canEditCommunity ? '' : 'disabled'} class="w-full ${canEditCommunity ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'} font-semibold py-2 px-4 rounded-md flex items-center justify-center">
                                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>新增社區
                                    </button>
                                </div>
                            </div>
                            ${canEditCommunity ? '' : '<div class="mt-3 bg-yellow-50 border border-yellow-200 text-yellow-900 rounded-md px-3 py-2 text-sm">您目前沒有權限新增或編輯社區，請聯絡管理員。</div>'}
                        </div>
                        <div id="community-list" class="space-y-2">讀取中...</div>
                    </div>`;
                lucide.createIcons();
                const listEl = document.getElementById('community-list');
                const addBtn = document.getElementById('add-community-btn');
                if (canEditCommunity) {
                    addBtn.addEventListener('click', () => openCommunityModal());
                } else {
                    addBtn.addEventListener('click', () => showToast('您目前沒有權限新增或編輯社區，請聯絡管理員。', true));
                }
                const regionSelect = document.getElementById('filter-community-region');
                const codeInput = document.getElementById('filter-community-code');
                const resetFilterBtn = document.getElementById('reset-community-filters');

                const communitiesRef = collection(db, 'communities');
                const q = query(communitiesRef, orderBy('name'));
                let allCommunities = [];

                const unsubscribe = onSnapshot(q, (snap) => {
                    allCommunities = [];
                    snap.forEach(docSnap => { allCommunities.push({ id: docSnap.id, ...docSnap.data() }); });
                    renderCommunityList();
                });

                function renderCommunityList() {
                    listEl.innerHTML = '';
                    if (!allCommunities.length) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">尚未建立任何社區</p>`;
                        return;
                    }
                    const region = regionSelect.value || '';
                    const codePrefix = (codeInput.value || '').trim();
                    let filtered = allCommunities.filter(c => {
                        const rOk = region ? (c.region === region) : true;
                        const codeVal = (c.code || '').toString();
                        const cOk = codePrefix ? codeVal.toUpperCase().startsWith(codePrefix.toUpperCase()) : true;
                        return rOk && cOk;
                    });
                    // 預設依社區編號排序（A101, A102, ... B209）
                    filtered = filtered.slice().sort((a,b) => compareCommunitiesByCode(a, b));

                    filtered.forEach(c => {
                        const lat = c.location?.latitude ?? '';
                        const lng = c.location?.longitude ?? '';
                        const region = c.region || '';
                        const code = c.code || '';
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        row.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">
                                    ${region ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-700 mr-2\">${region}</span>` : ''}
                                    ${code ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700 mr-2\">${code}</span>` : ''}
                                    ${c.name || '(未命名)'}
                                </p>
                                <p class="text-sm text-gray-500">${c.address || ''}</p>
                                <p class="text-xs text-gray-400">${lat && lng ? `(${lat.toFixed ? lat.toFixed(6) : lat}, ${lng.toFixed ? lng.toFixed(6) : lng})` : '未設定座標'}</p>
                                <p class="text-xs text-gray-500">有效打卡範圍：${(typeof c.radius === 'number' && c.radius >= 0) ? `${c.radius} 公尺` : '未設定'}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="view-map-btn px-2 py-1 text-gray-600 hover:text-red-600" data-lat="${lat}" data-lng="${lng}"><i data-lucide="map-pin" class="w-4 h-4"></i></button>
                                ${canEditCommunity ? `<button class=\"edit-community-btn px-2 py-1 text-gray-600 hover:text-red-600\" data-id=\"${c.id}\"><i data-lucide=\"edit\" class=\"w-4 h-4\"></i></button>` : ''}
                                ${canEditCommunity ? `<button class=\"delete-community-btn px-2 py-1 text-gray-600 hover:text-red-600\" data-id=\"${c.id}\"><i data-lucide=\"trash-2\" class=\"w-4 h-4\"></i></button>` : ''}
                            </div>`;
                        listEl.appendChild(row);
                    });

                    lucide.createIcons();

                    listEl.querySelectorAll('.view-map-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const latStr = e.currentTarget.dataset.lat;
                        const lngStr = e.currentTarget.dataset.lng;
                        const lat = parseFloat(latStr);
                        const lng = parseFloat(lngStr);
                        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                            showToast('此社區尚未設定座標', true);
                            return;
                        }
                        openMapModal(lat, lng);
                    }));

                    if (canEditCommunity) {
                        listEl.querySelectorAll('.edit-community-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            try {
                                const d = await getDoc(doc(db, 'communities', id));
                                if (d.exists()) openCommunityModal({ id, ...d.data() });
                            } catch (err) {
                                console.error('讀取社區資料失敗', err);
                                showToast('讀取社區資料失敗', true);
                            }
                        }));

                        listEl.querySelectorAll('.delete-community-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (!confirm('確定要刪除此社區嗎？')) return;
                            try {
                                await deleteDoc(doc(db, 'communities', id));
                                showToast('社區已刪除');
                            } catch (err) {
                                console.error('刪除社區失敗', err);
                                showToast('刪除社區失敗', true);
                            }
                        }));
                    }
                }

                regionSelect.addEventListener('change', renderCommunityList);
                codeInput.addEventListener('input', renderCommunityList);
                resetFilterBtn.addEventListener('click', () => {
                    regionSelect.value = '';
                    codeInput.value = '';
                    renderCommunityList();
                });
                state.activeListeners.push(unsubscribe);
            }

            function openCommunityModal(community = null) {
                const role = state.currentUserData?.role || '';
                if (role !== 'admin') {
                    showToast('您目前沒有權限新增或編輯社區，請聯絡管理員。', true);
                    return;
                }
                const modalId = `community-modal-${Date.now()}`;
                const isEditing = !!community;
                const title = isEditing ? '編輯社區' : '新增社區';
                const initLat = community?.location?.latitude ?? null;
                const initLng = community?.location?.longitude ?? null;
                const nameVal = community?.name || '';
                const addrVal = community?.address || '';
                const regionVal = community?.region || '';
                const codeVal = community?.code || '';
                const shortNameVal = community?.shortName || '';
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="community-form" class="p-4 space-y-4 overflow-y-auto">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">社區名稱 (必填)</label>
                                    <input id="community-name" type="text" value="${nameVal}" class="w-full mt-1 px-3 py-2 border rounded-md" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">地址</label>
                                    <input id="community-address" type="text" value="${addrVal}" class="w-full mt-1 px-3 py-2 border rounded-md" />
                                    <p class="text-xs text-gray-500 mt-1">輸入地址後自動帶出GPS座標與區域</p>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">區域 (必選)</label>
                                        <select id="community-region" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                            <option value="" ${!regionVal ? 'selected' : ''}>請選擇</option>
                                            <option value="台北" ${regionVal === '台北' ? 'selected' : ''}>台北</option>
                                            <option value="新北" ${regionVal === '新北' ? 'selected' : ''}>新北</option>
                                            <option value="桃園" ${regionVal === '桃園' ? 'selected' : ''}>桃園</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">社區編號 (不可重複)</label>
                                        <input id="community-code" type="text" value="${codeVal}" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="例如：A001" required />
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">社區簡稱（可多行）</label>
                                    <textarea id="community-short" rows="3" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="可輸入多行，顯示於『依社區』按鈕中置中顯示">${shortNameVal}</textarea>
                                    <p class="text-xs text-gray-500 mt-1">每一行會對應按鈕中的一列（最多顯示前兩行）。</p>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">緯度</label>
                                        <input id="community-lat" type="number" step="0.000001" value="${initLat ?? ''}" class="w-full mt-1 px-3 py-2 border rounded-md" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">經度</label>
                                        <input id="community-lng" type="number" step="0.000001" value="${initLng ?? ''}" class="w-full mt-1 px-3 py-2 border rounded-md" />
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">有效打卡範圍半徑 (公尺)</label>
                                    <input id="community-radius" type="number" min="0" step="1" value="${typeof community?.radius === 'number' ? community.radius : ''}" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="例如：100" />
                                    <p class="text-xs text-gray-500 mt-1">打卡點距社區座標的最大距離，超過則標示為打卡位置異常。</p>
                                </div>
                                <div>
                                    <button type="button" id="pick-location-btn" class="px-3 py-1 bg-gray-200 rounded-md text-sm">選擇座標</button>
                                </div>
                                <p id="community-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">取消</button>
                                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">儲存</button>
                                </div>
                            </form>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modal = document.getElementById(modalId);
                const close = () => modal?.remove();
                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                const nameInput = document.getElementById('community-name');
                const addrInput = document.getElementById('community-address');
                const regionInput = document.getElementById('community-region');
                const codeInput = document.getElementById('community-code');
                const shortNameInput = document.getElementById('community-short');
                const latInput = document.getElementById('community-lat');
                const lngInput = document.getElementById('community-lng');
                const errorEl = document.getElementById('community-form-error');
                document.getElementById('pick-location-btn').addEventListener('click', () => {
                    const lat = parseFloat(latInput.value);
                    const lng = parseFloat(lngInput.value);
                    const hasInit = Number.isFinite(lat) && Number.isFinite(lng);
                    openSelectLocationModal(hasInit ? lat : null, hasInit ? lng : null, (selLat, selLng) => {
                        // 正規化為 6 位小數，避免 step 驗證失敗
                        latInput.value = Number(selLat).toFixed(6);
                        lngInput.value = Number(selLng).toFixed(6);
                    });
                });

                // 地址自動地理編碼與區域判斷
                const debounceMs = 600;
                let geoTimer = null;
                const guessRegionFromText = (text) => {
                    if (!text) return '';
                    const t = ('' + text).toLowerCase();
                    if (/台北|臺北|taipei/.test(t)) return '台北';
                    if (/新北|new taipei/.test(t)) return '新北';
                    if (/桃園|taoyuan/.test(t)) return '桃園';
                    return '';
                };
                const guessRegionFromComponents = (components = []) => {
                    for (const c of components) {
                        const name = `${c.long_name || ''} ${c.short_name || ''}`;
                        const r = guessRegionFromText(name);
                        if (r) return r;
                    }
                    return '';
                };
                const geocodeAddressAndFill = async (addr) => {
                    const address = (addr || '').trim();
                    if (!address) return;
                    try {
                        const apiKey = typeof GOOGLE_MAPS_API_KEY !== 'undefined' ? GOOGLE_MAPS_API_KEY : null;
                        if (!apiKey) {
                            console.warn('GOOGLE_MAPS_API_KEY 未設定，跳過地理編碼');
                            return;
                        }
                        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&region=tw&language=zh-TW&key=${apiKey}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.status === 'OK' && Array.isArray(data.results) && data.results.length > 0) {
                            const r = data.results[0];
                            const loc = r.geometry && r.geometry.location ? r.geometry.location : null;
                            if (loc && Number.isFinite(loc.lat) && Number.isFinite(loc.lng)) {
                                // 正規化為 6 位小數以符合 input 的 step=0.000001
                                latInput.value = Number(loc.lat).toFixed(6);
                                lngInput.value = Number(loc.lng).toFixed(6);
                            }
                            // 嘗試從 components 或字串推斷區域
                            let regionCandidate = guessRegionFromComponents(r.address_components || []);
                            if (!regionCandidate) regionCandidate = guessRegionFromText(r.formatted_address || '');
                            if (!regionCandidate) regionCandidate = guessRegionFromText(address);
                            if (regionCandidate) {
                                regionInput.value = regionCandidate;
                            }
                        } else {
                            console.warn('Geocode 失敗:', data.status, data.error_message || '');
                            // 若失敗，不阻塞流程；提示訊息留在表單提交階段
                        }
                    } catch (e) {
                        console.error('Geocode 發生錯誤:', e);
                    }
                };
                const triggerGeocodeDebounced = () => {
                    if (geoTimer) clearTimeout(geoTimer);
                    geoTimer = setTimeout(() => geocodeAddressAndFill(addrInput.value), debounceMs);
                };
                addrInput.addEventListener('input', () => {
                    errorEl.textContent = '';
                    triggerGeocodeDebounced();
                });
                addrInput.addEventListener('blur', () => {
                    errorEl.textContent = '';
                    const v = addrInput.value.trim();
                    if (v) geocodeAddressAndFill(v);
                });
                // 失焦時正規化座標為 6 位小數，避免瀏覽器顯示無效值
                latInput.addEventListener('blur', () => {
                    const v = parseFloat(latInput.value);
                    if (Number.isFinite(v)) latInput.value = v.toFixed(6);
                });
                lngInput.addEventListener('blur', () => {
                    const v = parseFloat(lngInput.value);
                    if (Number.isFinite(v)) lngInput.value = v.toFixed(6);
                });
                // 若已有地址但座標或區域缺失，初始化時嘗試解析
                if ((addrVal && (!Number.isFinite(initLat) || !Number.isFinite(initLng) || !regionVal))) {
                    setTimeout(() => geocodeAddressAndFill(addrVal), 0);
                }

                document.getElementById('community-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';
                    try {
                        const name = nameInput.value.trim();
                        const address = addrInput.value.trim();
                        const region = regionInput.value.trim();
                        const code = codeInput.value.trim();
                        const shortName = shortNameInput.value.trim();
                        const lat = parseFloat(latInput.value);
                        const lng = parseFloat(lngInput.value);
                        const radiusInput = document.getElementById('community-radius');
                        const radiusVal = radiusInput ? parseFloat(radiusInput.value) : null;
                        if (!name) throw new Error('請輸入社區名稱');
                        if (!region) throw new Error('請選擇區域');
                        if (!code) throw new Error('請輸入社區編號');
                        if (!Number.isFinite(lat) || !Number.isFinite(lng)) throw new Error('請設定有效座標');
                        // 檢查社區編號唯一性
                        try {
                            const fs = window.__fs || {};
                            const db = window.__db;
                            const { collection, query, where, getDocs } = fs;
                            if (!collection || !query || !where || !getDocs || !db) {
                                console.warn('Firestore 函式不可用，跳過編號唯一性檢查');
                            } else {
                                const q = query(collection(db, 'communities'), where('code', '==', code));
                                const snap = await getDocs(q);
                                let duplicated = false;
                                snap.forEach(d => {
                                    const sameId = community?.id && d.id === community.id;
                                    if (!sameId) duplicated = true;
                                });
                                if (duplicated) throw new Error('社區編號已存在，請使用其他編號');
                            }
                        } catch (checkErr) {
                            if (checkErr && checkErr.message) throw checkErr;
                        }
                        const payload = {
                            name,
                            address,
                            region,
                            code,
                            shortName: shortName || null,
                            location: new GeoPoint(lat, lng),
                            radius: (Number.isFinite(radiusVal) && radiusVal >= 0) ? Math.floor(radiusVal) : 0,
                            updatedAt: serverTimestamp()
                        };
                        if (isEditing) {
                            await updateDoc(doc(db, 'communities', community.id), payload);
                            showToast('社區已更新');
                        } else {
                            payload.createdAt = serverTimestamp();
                            await addDoc(collection(db, 'communities'), payload);
                            showToast('社區已新增');
                        }
                        close();
                    } catch (err) {
                        console.error('儲存社區失敗', err);
                        if (err && (err.code === 'permission-denied' || /insufficient permissions/i.test(err.message || ''))) {
                            errorEl.textContent = '您目前沒有權限新增或編輯社區，請聯絡管理員。';
                        } else {
                            errorEl.textContent = err.message || '儲存失敗';
                        }
                    } finally {
                        showLoading(false);
                    }
                });
            }

            // 通用：互動式選點地圖
            function openSelectLocationModal(initialLat = null, initialLng = null, onSelect = () => {}) {
                const modalId = `select-location-modal-${Date.now()}`;
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[520px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">選擇座標</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div id="select-map" class="h-[320px] w-full"></div>
                            <div class="flex items-center justify-between p-4 border-t">
                                <div class="text-sm text-gray-600"><span id="sel-lat">--</span>, <span id="sel-lng">--</span></div>
                                <div class="flex gap-2">
                                    <button class="cancel-btn px-3 py-1 rounded bg-gray-200">取消</button>
                                    <button class="ok-btn px-3 py-1 rounded bg-blue-600 text-white">確定</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modalEl = document.getElementById(modalId);
                const close = () => modalEl?.remove();
                modalEl.querySelector('.close-btn')?.addEventListener('click', close);
                modalEl.querySelector('.cancel-btn')?.addEventListener('click', close);
                const latEl = modalEl.querySelector('#sel-lat');
                const lngEl = modalEl.querySelector('#sel-lng');

                let selectedLat = initialLat;
                let selectedLng = initialLng;
                const updateDisplay = () => {
                    latEl.textContent = Number.isFinite(selectedLat) ? selectedLat.toFixed(6) : '--';
                    lngEl.textContent = Number.isFinite(selectedLng) ? selectedLng.toFixed(6) : '--';
                };
                updateDisplay();

                if (!(window.google && window.google.maps)) {
                    document.getElementById('select-map').innerHTML = '<div class="p-4 text-center text-red-500">Google Maps 尚未載入</div>';
                } else {
                    const center = Number.isFinite(initialLat) && Number.isFinite(initialLng)
                        ? { lat: initialLat, lng: initialLng }
                        : { lat: 25.0330, lng: 121.5654 };
                    const map = new google.maps.Map(document.getElementById('select-map'), { center, zoom: 16 });
                    let marker = null;
                    if (Number.isFinite(initialLat) && Number.isFinite(initialLng)) {
                        marker = new google.maps.Marker({ position: center, map });
                    }
                    map.addListener('click', (e) => {
                        const pos = e.latLng;
                        selectedLat = pos.lat();
                        selectedLng = pos.lng();
                        if (!marker) {
                            marker = new google.maps.Marker({ position: pos, map });
                        } else {
                            marker.setPosition(pos);
                        }
                        updateDisplay();
                    });
                }

                modalEl.querySelector('.ok-btn')?.addEventListener('click', () => {
                    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) {
                        showToast('請在地圖上點選位置', true);
                        return;
                    }
                    try { onSelect(selectedLat, selectedLng); } catch (_) {}
                    close();
                });
            }

            // --- Modals ---
            function openMapModal(lat, lng) {
                const modalId = `map-modal-${Date.now()}`;
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">位置資訊</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div id="modal-map" class="h-[300px] w-full"></div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                // Chrome requires secure context (https:// or localhost) for geolocation; inform user if not secure
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('非安全來源，可能導致定位或地圖無法使用');
                    showToast('提示：請以 https 或 localhost 開啟以使用地圖定位', true);
                }
                if (window.google && window.google.maps) {
                    const mapDiv = document.getElementById('modal-map');
                    const map = new google.maps.Map(mapDiv, {
                        center: { lat, lng },
                        zoom: 17
                    });
                    
                    new google.maps.Marker({
                        position: { lat, lng },
                        map: map
                    });
                } else {
                    document.getElementById('modal-map').innerHTML = 
                        '<div class="p-4 text-center text-red-500">Google Maps 尚未載入，請稍後再試</div>';
                }
            }
            
            function openPhotoModal(photos, descriptions) {
                const modalId = `photo-modal-${Date.now()}`;
                
                let contentHTML;
                if (photos && photos.length > 0) {
                    contentHTML = photos.map((url, index) => `
                        <div class="photo-slide">
                            <img src="${url}" class="max-h-[400px] max-w-full object-contain mx-auto" onerror="this.src='https://via.placeholder.com/400x300?text=照片載入失敗'">
                            <p class="text-center mt-2 text-gray-600">${descriptions[index] || ''}</p>
                        </div>
                    `).join('');
                } else {
                    contentHTML = '<div class="p-4 text-center text-gray-500">無照片</div>';
                }
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">照片瀏覽</h3>
                                <div class="flex items-center gap-2">
                                    <button class="close-btn text-gray-500 hover:text-gray-700">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 photo-container">
                                ${contentHTML}
                            </div>
                            ${(photos?.length || 0) > 1 ? `
                            <div class="flex justify-center p-2 gap-2">
                                <button class="prev-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">上一張</button>
                                <button class="next-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">下一張</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                // 下載功能已移除
                
                if ((photos?.length || 0) > 1) {
                    const slides = modal.querySelectorAll('.photo-slide');
                    let currentSlide = 0;
                    
                    slides.forEach((slide, index) => {
                        slide.style.display = index === 0 ? 'block' : 'none';
                    });
                    
                    modal.querySelector('.prev-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                    
                    modal.querySelector('.next-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide + 1) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                }
            }

            // 新增：編輯出勤紀錄彈窗
            function openEditRecordModal(record) {
                const modalId = `edit-record-modal-${Date.now()}`;
                const toDatetimeLocal = (iso) => {
                    try {
                        const d = iso ? new Date(iso) : new Date();
                        const pad = (n) => String(n).padStart(2, '0');
                        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    } catch {
                        return '';
                    }
                };
                const typeOptions = ['上班','下班','外出','返回','抵達','離開','自動下班'];
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[520px] bg-white rounded-lg shadow-xl">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">編輯出勤紀錄</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-4 space-y-3">
                                <div>
                                    <label class="text-sm">狀態</label>
                                    <select id="edit-type" class="border rounded px-2 py-1 w-full">
                                        ${typeOptions.map(t => `<option value="${t}" ${t===record.type? 'selected':''}>${t}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm">時間</label>
                                    <input id="edit-time" type="datetime-local" value="${toDatetimeLocal(record.timeISO)}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-sm">緯度</label>
                                        <input id="edit-lat" type="number" step="0.000001" value="${record.lat ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                    <div>
                                        <label class="text-sm">經度</label>
                                        <input id="edit-lng" type="number" step="0.000001" value="${record.lng ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm">地點名稱</label>
                                    <input id="edit-location-name" type="text" value="${record.locationName || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div>
                                    <label class="text-sm">勤務類型</label>
                                    <input id="edit-duty-type" type="text" value="${record.dutyType || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 p-4 border-t">
                                <button class="cancel-btn px-3 py-1 rounded bg-gray-200">取消</button>
                                <button class="save-btn px-3 py-1 rounded bg-blue-600 text-white">儲存</button>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modalEl = document.getElementById(modalId);
                const close = () => { modalEl?.remove(); };
                modalEl.querySelector('.close-btn')?.addEventListener('click', close);
                modalEl.querySelector('.cancel-btn')?.addEventListener('click', close);
                modalEl.querySelector('.save-btn')?.addEventListener('click', async () => {
                    try {
                        const db = window.__db; const { updateDoc, doc, GeoPoint, Timestamp } = window.__fs;
                        const type = document.getElementById('edit-type').value;
                        const timeStr = document.getElementById('edit-time').value;
                        const latStr = document.getElementById('edit-lat').value;
                        const lngStr = document.getElementById('edit-lng').value;
                        const locationName = document.getElementById('edit-location-name').value?.trim?.() || '';
                        const dutyType = document.getElementById('edit-duty-type').value?.trim?.() || '';
                        const allowed = ['上班','下班','外出','返回','抵達','離開','自動下班'];
                        if (!allowed.includes(type)) { showToast('狀態不合法', true); return; }
                        const d = timeStr ? new Date(timeStr) : new Date();
                        const updateData = { type, timestamp: Timestamp.fromDate(d) };
                        const lat = latStr ? parseFloat(latStr) : null;
                        const lng = lngStr ? parseFloat(lngStr) : null;
                        if (typeof lat === 'number' && typeof lng === 'number' && !Number.isNaN(lat) && !Number.isNaN(lng)) {
                            updateData.location = new GeoPoint(lat, lng);
                        }
                        if (locationName) updateData.locationName = locationName.slice(0, 100);
                        if (dutyType) updateData.dutyType = dutyType.slice(0, 100);
                        await updateDoc(doc(db, 'clockInRecords', record.id), updateData);
                        showToast('更新成功');
                        // 依當前頁面觸發刷新：追蹤或人事列表
                        try {
                            if (typeof loadAttendanceRecords === 'function') {
                                // 追蹤頁面
                                loadAttendanceRecords();
                            } else if (typeof renderAttendanceRecordsList === 'function') {
                                // 人事列表頁面
                                const selectedUserId = document.getElementById('user-select')?.value || 'all';
                                const selectedDateStr = document.getElementById('record-date')?.value || new Date().toISOString().split('T')[0];
                                await renderAttendanceRecordsList('attendance-records-list', selectedUserId, selectedDateStr);
                            }
                        } catch (err) {
                            console.warn('刷新列表時發生問題：', err);
                        }
                        close();
                    } catch (e) {
                        console.error('update clockInRecord error', e);
                        showToast('更新失敗：請檢查權限或資料格式', true);
                    }
                });
            }

            function openUserModal(user = null) {
                const modalId = `user-modal-${Date.now()}`;
                const isEditing = user !== null;
                const title = isEditing ? '編輯帳號' : '新增帳號';
                const isSelfEditing = isEditing && user.id === (state.currentUser?.uid || null);
                let newUserAvatarFile = null;
                let newUserAvatarBase64 = null;
                const close = () => document.getElementById(modalId)?.remove();

                const defaultAvatar = 'https://placehold.co/80x80/EFEFEF/333333?text=頭像';

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="user-form" class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar Section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="user-avatar-preview" src="${isEditing && user.avatarUrl ? user.avatarUrl : defaultAvatar}" class="w-20 h-20 rounded-full object-cover">
                                    <input type="file" id="user-avatar-upload" class="hidden" accept="image/*">
                                    <div class="flex space-x-2">
                                        <button type="button" id="user-upload-avatar-btn" class="text-sm px-3 py-1 bg-gray-200 rounded-md">上傳照片</button>
                                
                                    </div>
                                </div>
                                
                                <!-- Form Fields -->
                                <div>
                                    <label for="user-name" class="block text-sm font-medium text-gray-700">姓名 (必填)</label>
                                    <input type="text" id="user-name" value="${isEditing ? user.name : ''}" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="user-phone" class="block text-sm font-medium text-gray-700">手機號碼</label>
                                    <input type="tel" id="user-phone" value="${isEditing ? user.phone || '' : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-title" class="block text-sm font-medium text-gray-700">職稱</label>
                                    <input type="text" id="user-title" value="${isEditing ? (user.jobTitle || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-employment-status" class="block text-sm font-medium text-gray-700">狀態</label>
                                    <select id="user-employment-status" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="在職" ${isEditing ? (user.employmentStatus === '在職' ? 'selected' : '') : 'selected'}>在職</option>
                                        <option value="離職" ${isEditing && user.employmentStatus === '離職' ? 'selected' : ''}>離職</option>
                                        <option value="現金班" ${isEditing && user.employmentStatus === '現金班' ? 'selected' : ''}>現金班</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-email" class="block text-sm font-medium text-gray-700">電子郵件 / 帳號 (必填)</label>
                                    <input type="email" id="user-email" value="${isEditing ? user.email : ''}" ${isEditing ? 'disabled' : ''} class="w-full mt-1 px-3 py-2 border rounded-md ${isEditing ? 'bg-gray-100' : ''}" required>
                                </div>
                                ${!isEditing ? `
                                <div>
                                    <label for="user-password" class="block text-sm font-medium text-gray-700">設定密碼 (必填, 至少6位數)</label>
                                    <input type="password" id="user-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="user-confirm-password" class="block text-sm font-medium text-gray-700">再次確認密碼 (必填)</label>
                                    <input type="password" id="user-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                ` : ''}
                                <!-- 新增欄位：住家地址 / 生日 / 身分證號 / 證照 / 前科 / 服務社區代號 -->
                                <div>
                                    <label for="user-address" class="block text-sm font-medium text-gray-700">住家地址</label>
                                    <input type="text" id="user-address" value="${isEditing ? (user.homeAddress || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-birthdate" class="block text-sm font-medium text-gray-700">出生年月日</label>
                                    <input type="date" id="user-birthdate" value="${isEditing ? (user.birthDate || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-idnumber" class="block text-sm font-medium text-gray-700">身分證號</label>
                                    <input type="text" id="user-idnumber" value="${isEditing ? (user.idNumber || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-blood-type" class="block text-sm font-medium text-gray-700">血型</label>
                                    <select id="user-blood-type" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="" ${isEditing && !user.bloodType ? 'selected' : ''}>未選擇</option>
                                        <option value="A" ${isEditing && user.bloodType === 'A' ? 'selected' : ''}>A</option>
                                        <option value="B" ${isEditing && user.bloodType === 'B' ? 'selected' : ''}>B</option>
                                        <option value="O" ${isEditing && user.bloodType === 'O' ? 'selected' : ''}>O</option>
                                        <option value="AB" ${isEditing && user.bloodType === 'AB' ? 'selected' : ''}>AB</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-emergency-name" class="block text-sm font-medium text-gray-700">緊急聯絡人姓名</label>
                                    <input type="text" id="user-emergency-name" value="${isEditing ? (user.emergencyName || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-emergency-relation" class="block text-sm font-medium text-gray-700">與聯絡人關係</label>
                                    <input type="text" id="user-emergency-relation" value="${isEditing ? (user.emergencyRelation || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-emergency-phone" class="block text-sm font-medium text-gray-700">緊急連絡人手機號碼</label>
                                    <input type="tel" id="user-emergency-phone" value="${isEditing ? (user.emergencyPhone || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-license" class="block text-sm font-medium text-gray-700">專業證照</label>
                                    <select id="user-license" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="無" ${isEditing && user.license === '無' ? 'selected' : ''}>無</option>
                                        <option value="職業安全衛生業務主管證照" ${isEditing && user.license === '職業安全衛生業務主管證照' ? 'selected' : ''}>職業安全衛生業務主管證照</option>
                                        <option value="職業安全衛生管理員證照" ${isEditing && user.license === '職業安全衛生管理員證照' ? 'selected' : ''}>職業安全衛生管理員證照</option>
                                        <option value="防火避難設施管理人員證照" ${isEditing && user.license === '防火避難設施管理人員證照' ? 'selected' : ''}>防火避難設施管理人員證照</option>
                                        <option value="設備安全管理人員證照" ${isEditing && user.license === '設備安全管理人員證照' ? 'selected' : ''}>設備安全管理人員證照</option>
                                        <option value="救生員證照" ${isEditing && user.license === '救生員證照' ? 'selected' : ''}>救生員證照</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-criminal" class="block text-sm font-medium text-gray-700">有無前科</label>
                                    <select id="user-criminal" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="無" ${isEditing && (user.hasCriminalRecord === false) ? 'selected' : ''}>無</option>
                                        <option value="有" ${isEditing && (user.hasCriminalRecord === true) ? 'selected' : ''}>有</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-service-code" class="block text-sm font-medium text-gray-700">服務社區代號 (手動輸入)</label>
                                    <input type="text" id="user-service-code" value="${isEditing ? (user.serviceCommunityCode || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-role" class="block text-sm font-medium text-gray-700">角色 (必填)</label>
                                    <select id="user-role" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="field" ${isEditing && user.role === 'field' ? 'selected' : ''}>外勤（一般）</option>
                                        <option value="總幹事" ${isEditing && user.role === '總幹事' ? 'selected' : ''}>總幹事</option>
                                        <option value="保全" ${isEditing && user.role === '保全' ? 'selected' : ''}>保全</option>
                                        <option value="秘書" ${isEditing && user.role === '秘書' ? 'selected' : ''}>秘書</option>
                                        <option value="清潔" ${isEditing && user.role === '清潔' ? 'selected' : ''}>清潔</option>
                                        <option value="機電" ${isEditing && user.role === '機電' ? 'selected' : ''}>機電</option>
                                        <option value="user" ${isEditing && user.role === 'user' ? 'selected' : ''}>內勤</option>
                                        <option value="junior_manager" ${isEditing && user.role === 'junior_manager' ? 'selected' : ''}>初階主管</option>
                                        <option value="manager" ${isEditing && user.role === 'manager' ? 'selected' : ''}>高階主管</option>
                                        <option value="hr" ${isEditing && user.role === 'hr' ? 'selected' : ''}>人事</option>
                                        <option value="admin" ${isEditing && user.role === 'admin' ? 'selected' : ''}>管理員</option>
                                    </select>
                                </div>

                                <!-- 服務社區 (可複選) -->
                                <div id="service-communities-section">
                                    <label class="block text-sm font-medium text-gray-700">服務社區 (可複選)</label>
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" id="service-community-select-all" class="mr-2">
                                        <span class="text-sm text-gray-600">全選</span>
                                    </div>
                                    <div id="service-community-list" class="grid grid-cols-1 gap-2"></div>
                                </div>

                                <!-- 密碼管理（編輯） -->
                                ${isEditing ? `
                                <div class="bg-gray-50 p-3 rounded-md border">
                                    <p class="text-sm font-medium text-gray-700 mb-2">密碼管理</p>
                                    ${isSelfEditing ? `
                                        <div>
                                            <label for="edit-new-password" class="block text-sm font-medium text-gray-700">新密碼 (選填，至少6位數)</label>
                                            <input type="password" id="edit-new-password" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        </div>
                                        <div>
                                            <label for="edit-confirm-password" class="block text-sm font-medium text-gray-700">再次確認新密碼</label>
                                            <input type="password" id="edit-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        </div>
                                    ` : `
                                        <button type="button" id="send-reset-email-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">
                                            寄送重設密碼信到 ${user.email}
                                        </button>
                                        <p class="mt-2 text-xs text-gray-500">無法直接變更其他用戶密碼，請透過 Email 重設。</p>
                                    `}
                                </div>
                                ` : ''}
                                
                                <p id="user-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2 flex-shrink-0">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">取消</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">儲存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                const userForm = document.getElementById('user-form');
                const errorEl = document.getElementById('user-form-error');
                const avatarPreview = document.getElementById('user-avatar-preview');
                const avatarUploadInput = document.getElementById('user-avatar-upload');
                const serviceCommunityListEl = document.getElementById('service-community-list');
                const serviceCommunitySelectAllEl = document.getElementById('service-community-select-all');

                // 限制角色選項（設定分頁與人員分頁）
                try {
                    const roleSelectEl = document.getElementById('user-role');
                    if (roleSelectEl) {
                        const allowedHR = new Set(['總幹事','秘書','保全','清潔','機電']);
                        const allowedGlobal = new Set(['admin','hr','manager','junior_manager','總幹事','秘書','保全','清潔','機電']);
                        const isHRPage = state.currentPage === 'hr';
                        const isGlobalSettings = state.currentPage === 'settings' || state.currentPage === 'navigation';
                        const allowedSet = isHRPage ? allowedHR : (isGlobalSettings ? allowedGlobal : null);
                        if (allowedSet) {
                            const currentVal = roleSelectEl.value;
                            Array.from(roleSelectEl.options).forEach(opt => {
                                if (!allowedSet.has(opt.value)) {
                                    opt.remove();
                                }
                            });
                            if (!allowedSet.has(currentVal) && roleSelectEl.options.length > 0) {
                                roleSelectEl.selectedIndex = 0;
                            }
                        }
                    }
                } catch (e) { /* noop */ }

                // 壓縮圖片為 Base64，限制大小與尺寸
                const compressToBase64 = async (file, maxW = 320, maxH = 320, quality = 0.8) => {
                    return await new Promise((resolve, reject) => {
                        const img = new Image();
                        const url = URL.createObjectURL(file);
                        img.onload = () => {
                            try {
                                const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
                                const w = Math.max(1, Math.floor(img.width * ratio));
                                const h = Math.max(1, Math.floor(img.height * ratio));
                                const canvas = document.createElement('canvas');
                                canvas.width = w;
                                canvas.height = h;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, w, h);
                                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                                URL.revokeObjectURL(url);
                                resolve(dataUrl);
                            } catch (err) {
                                URL.revokeObjectURL(url);
                                reject(err);
                            }
                        };
                        img.onerror = (e) => {
                            URL.revokeObjectURL(url);
                            reject(e);
                        };
                        img.src = url;
                    });
                };

                // --- Avatar Logic ---
                // 允許所有用戶（包括編輯現有用戶）上傳頭像
                const uploadBtn = document.getElementById('user-upload-avatar-btn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => avatarUploadInput.click());
                }
                
                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        newUserAvatarFile = file;
                        try {
                            const base64 = await compressToBase64(file, 320, 320, 0.8);
                            // 檢查大小（約略換算 Base64 至位元組）
                            const approxBytes = Math.floor(base64.length * 3 / 4);
                            if (approxBytes > 900 * 1024) {
                                showToast('照片過大，請選擇較小檔案或降低品質', true);
                                newUserAvatarBase64 = null;
                                return;
                            }
                            newUserAvatarBase64 = base64;
                            avatarPreview.src = base64;
                        } catch (err) {
                            console.warn('壓縮頭像失敗，使用原檔預覽：', err);
                            avatarPreview.src = URL.createObjectURL(file);
                            newUserAvatarBase64 = null;
                        }
                    }
                });
                
                // 載入服務社區清單（多選 + 全選）
                (async () => {
                    try {
                        const communitiesSnap = await getDocs(collection(db, 'communities'));
                        const communities = [];
                        communitiesSnap.forEach(docSnap => communities.push({ id: docSnap.id, ...docSnap.data() }));
                        // 依社區編號排序（如 A101、A102、...、B207、B208）
                        communities.sort(compareCommunitiesByCode);
                        const selectedIds = isEditing && Array.isArray(user.serviceCommunities) ? new Set(user.serviceCommunities) : new Set();
                        serviceCommunityListEl.innerHTML = communities.map(c => {
                            const label = `${c.region ? `[${c.region}] ` : ''}${c.code ? `[${c.code}] ` : ''}${c.name || ''}`;
                            const checked = selectedIds.has(c.id) ? 'checked' : '';
                            return `
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="service-community" value="${c.id}" class="rounded" ${checked}>
                                    <span class="text-sm text-gray-700">${label}</span>
                                </label>
                            `;
                        }).join('');

                        if (serviceCommunitySelectAllEl) {
                            serviceCommunitySelectAllEl.addEventListener('change', (e) => {
                                const checked = e.target.checked;
                                serviceCommunityListEl.querySelectorAll('input[name="service-community"]').forEach(chk => { chk.checked = checked; });
                            });
                        }
                    } catch (err) {
                        console.error('載入服務社區失敗', err);
                        serviceCommunityListEl.innerHTML = '<p class="text-sm text-red-500">服務社區載入失敗</p>';
                    }
                })();


                // --- Form Logic ---
                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    // --- Form Data Collection ---
                    const name = document.getElementById('user-name').value;
                    const phone = document.getElementById('user-phone').value;
                    const jobTitle = document.getElementById('user-title')?.value || '';
                    const employmentStatus = document.getElementById('user-employment-status')?.value || '';
                    const email = document.getElementById('user-email').value;
                    const rawRole = document.getElementById('user-role').value;
                    const homeAddress = document.getElementById('user-address')?.value || '';
                    const birthDate = document.getElementById('user-birthdate')?.value || '';
                    const idNumber = document.getElementById('user-idnumber')?.value || '';
                    const bloodType = document.getElementById('user-blood-type')?.value || '';
                    const emergencyName = document.getElementById('user-emergency-name')?.value || '';
                    const emergencyRelation = document.getElementById('user-emergency-relation')?.value || '';
                    const emergencyPhone = document.getElementById('user-emergency-phone')?.value || '';
                    const license = document.getElementById('user-license')?.value || '';
                    const hasCriminalRecord = (document.getElementById('user-criminal')?.value || '無') === '有';
                    const serviceCommunityCode = document.getElementById('user-service-code')?.value || '';
                    
                    // 收集服務社區
                    const scChecks = modal.querySelectorAll('input[name="service-community"]');
                    const serviceCommunities = Array.from(scChecks).filter(c => c.checked).map(c => c.value);
                    // 權限角色與職務映射：一般員工的權限一律為 user，職務記錄在 applicationTitle
                    const titleRoles = new Set(['總幹事','秘書','保全','清潔','機電','field']);
                    const permissionRole = (['admin','hr','manager','junior_manager','community_admin','user'].includes(rawRole)) ? rawRole : 'user';
                    const applicationTitle = titleRoles.has(rawRole) ? (rawRole === 'field' ? '' : rawRole) : '';
                    const updateData = { name, phone, role: permissionRole, email, serviceCommunities, homeAddress, birthDate, idNumber, license, hasCriminalRecord, serviceCommunityCode, bloodType, emergencyName, emergencyRelation, emergencyPhone, jobTitle, employmentStatus };
                    if (applicationTitle) updateData.applicationTitle = applicationTitle;

                    try {
                        let targetUserId = isEditing ? user.id : null;
                        let newAvatarUrl = isEditing ? user.avatarUrl : null;

                        // --- Password Validation (for new users) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const confirmPassword = document.getElementById('user-confirm-password').value;
                            if (password.length < 6) {
                                throw new Error("密碼長度至少需要6個字元。");
                            }
                            if (password !== confirmPassword) {
                                throw new Error("兩次輸入的密碼不相符。");
                            }
                        }

                        // --- User Creation (if applicable) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const { initializeApp: initializeAppSecondary, deleteApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                            const secondaryApp = initializeAppSecondary(firebaseConfig, `secondary-app-${Date.now()}`);
                            const secondaryAuth = getAuth(secondaryApp);
                             try {
                                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                                targetUserId = userCredential.user.uid;
                                // 確保新用戶的獎懲點數預設為0
                                updateData.points = 0;
                            } catch (creationError) {
                                if (creationError.code === 'auth/email-already-in-use') throw new Error('此電子郵件已被註冊。');
                                else throw new Error('建立驗證帳號失敗，請稍後再試。');
                            } finally {
                                await signOut(secondaryAuth);
                                await deleteApp(secondaryApp);
                            }
                        }
                        
                        // --- Avatar Upload (if new avatar is set) ---
                        if (newUserAvatarFile) {
                            try {
                                if (newUserAvatarBase64) {
                                    newAvatarUrl = newUserAvatarBase64;
                                } else {
                                    // 後備：直接轉 Base64（可能較大）
                                    const reader = new FileReader();
                                    const base64Promise = new Promise((resolve, reject) => {
                                        reader.onload = () => resolve(reader.result);
                                        reader.onerror = () => reject(new Error('讀取檔案失敗'));
                                        reader.readAsDataURL(newUserAvatarFile);
                                    });
                                    const rawBase64 = await base64Promise;
                                    const approxBytes = Math.floor(rawBase64.length * 3 / 4);
                                    if (approxBytes > 900 * 1024) {
                                        throw new Error('照片過大，請選擇較小檔案或降低品質');
                                    }
                                    newAvatarUrl = rawBase64;
                                }
                                console.log('頭像已處理為 Base64 格式');
                            } catch (avatarError) {
                                console.error('頭像處理錯誤:', avatarError);
                                showToast(avatarError.message || '頭像處理失敗，但會繼續儲存其他資料', true);
                            }
                        }
                        updateData.avatarUrl = newAvatarUrl;

                        // --- 密碼修改（僅本人可直接修改） ---
                        if (isSelfEditing) {
                            const newPwd = document.getElementById('edit-new-password')?.value || '';
                            const confirmNewPwd = document.getElementById('edit-confirm-password')?.value || '';
                            if (newPwd || confirmNewPwd) {
                                if (newPwd.length < 6) throw new Error('新密碼長度至少需要6個字元。');
                                if (newPwd !== confirmNewPwd) throw new Error('兩次輸入的新密碼不相符。');
                                try {
                                    await updatePassword(auth.currentUser, newPwd);
                                    showToast('密碼已更新');
                                } catch (pwdErr) {
                                    console.error('更新密碼失敗', pwdErr);
                                    if (pwdErr?.code === 'auth/requires-recent-login') {
                                        throw new Error('更新密碼需要重新登入，請先登出再登入後重試');
                                    } else {
                                        throw new Error('更新密碼失敗，請稍後再試');
                                    }
                                }
                            }
                        }

                        // --- Database Operation ---
                        if (isEditing) {
                            await updateDoc(doc(db, "users", targetUserId), updateData);
                            showToast("使用者資料更新成功");
                        } else {
                            updateData.status = "未打卡";
                            updateData.createdAt = serverTimestamp();
                            await setDoc(doc(db, "users", targetUserId), updateData);
                            showToast("新帳號建立成功");
                        }
                        
                        close();

                    } catch (error) {
                        console.error("User modal error:", error);
                        errorEl.textContent = error.message || '操作失敗，請稍後再試。';
                    } finally {
                        showLoading(false);
                    }
                });

                // 寄送重設密碼信（編輯他人時）
                const sendResetBtn = document.getElementById('send-reset-email-btn');
                if (sendResetBtn) {
                    sendResetBtn.addEventListener('click', async () => {
                        try {
                            showLoading(true);
                            await sendPasswordResetEmail(auth, user.email);
                            showToast('已寄出重設密碼通知信');
                        } catch (err) {
                            console.error('寄送重設密碼信失敗', err);
                            showToast('寄送失敗：請稍後再試', true);
                        } finally {
                            showLoading(false);
                        }
                    });
                }
            }
            
            function openRuleModal(rule = null) {
                const modalId = `rule-modal-${Date.now()}`;
                const isEditing = rule !== null;
                const title = isEditing ? '編輯規則' : '新增規則';
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="rule-form" class="p-4 space-y-4">
                                <div>
                                    <label for="rule-reason" class="block text-sm font-medium text-gray-700">事由</label>
                                    <input type="text" id="rule-reason" value="${isEditing ? rule.reason : ''}" placeholder="例如：遲到" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-points" class="block text-sm font-medium text-gray-700">點數 (可為負數)</label>
                                    <input type="number" id="rule-points" value="${isEditing ? rule.points : ''}" placeholder="-1" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-target" class="block text-sm font-medium text-gray-700">適用對象</label>
                                    <select id="rule-target" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="個人" ${isEditing && rule.target === '個人' ? 'selected' : ''}>個人</option>
                                        <option value="全體" ${isEditing && rule.target === '全體' ? 'selected' : ''}>全體</option>
                                    </select>
                                </div>
                                <p id="rule-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">取消</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">儲存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const ruleForm = document.getElementById('rule-form');
                const errorEl = document.getElementById('rule-form-error');

                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                ruleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    const reason = document.getElementById('rule-reason').value;
                    const points = Number(document.getElementById('rule-points').value);
                    const target = document.getElementById('rule-target').value;

                    if (!reason || isNaN(points)) {
                        errorEl.textContent = '請填寫所有欄位。';
                        showLoading(false);
                        return;
                    }

                    try {
                        if (isEditing) {
                            const ruleRef = doc(db, "pointRules", rule.id);
                            await updateDoc(ruleRef, { reason, points, target });
                            showToast("規則更新成功");
                        } else {
                            await addDoc(collection(db, "pointRules"), { reason, points, target });
                            showToast("新規則新增成功");
                        }
                        close();
                    } catch (error) {
                        console.error("Rule modal error:", error);
                        errorEl.textContent = '操作失敗，請稍後再試。';
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderProfileModal() {
                const modalId = `profile-modal-${Date.now()}`;
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">個人資料</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>

                            <div class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="modal-avatar" src="${state.currentUserData.avatarUrl || `https://placehold.co/80x80/EFEFEF/333333?text=${state.currentUserData.name.charAt(0)}`}" alt="Avatar" class="w-20 h-20 rounded-full object-cover">
                                    <label for="avatar-upload" class="cursor-pointer text-blue-600 hover:text-blue-800">
                                        更換頭像
                                        <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                    </label>
                                </div>

                                <!-- Info -->
                                <div class="text-center">
                                    <p class="font-bold text-xl">${state.currentUserData.name}</p>
                                    <p class="text-gray-500">${state.currentUserData.email}</p>
                                </div>
                                
                                <!-- 獎懲點數 -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">獎懲點數</h4>
                                    <p class="text-center text-3xl font-bold">${state.currentUserData.points || 0} 點</p>
                                </div>

                                <!-- 未來請假 -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">請假申請</h4>
                                    <div id="future-leaves" class="space-y-2"></div>
                                </div>
                            </div>

                            <div class="p-4 border-t">
                                <button id="logout-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">登出</button>
                                <p class="mt-2 text-center">
                                    <a href="#" id="privacy-policy-link" class="text-blue-600 underline">隱私權政策</a>
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const changePasswordForm = document.getElementById('change-password-form');
                const logoutBtn = document.getElementById('logout-btn');
                const avatarUploadInput = document.getElementById('avatar-upload');
                const privacyLink = document.getElementById('privacy-policy-link');

                modal.querySelector('.close-btn').addEventListener('click', close);
                
                // 添加登出按鈕事件監聽器
                logoutBtn.addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        await signOut(auth);
                        showToast("已成功登出");
                        window.location.reload();
                    } catch (error) {
                        console.error("登出失敗:", error);
                        showToast("登出失敗，請稍後再試", true);
                        showLoading(false);
                    }
                });

                // 隱私權政策開窗
                if (privacyLink) {
                    privacyLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openPrivacyPolicyWindow();
                    });
                }

                async function processAndUploadAvatar(file) {
                    if (!file) return;
                    showLoading(true);
                    try {
                        // 壓縮為 Base64，控制尺寸以符合 Firestore 文件大小限制（1MB）
                        let dataUrl = await compressToBase64(file, 300); // 最長邊 300px，JPEG 0.7
                        const base64 = dataUrl.split(',')[1] || '';
                        // 若仍過大，嘗試再降低品質與尺寸
                        const approxBytes = Math.ceil(base64.length * 0.75); // Base64 估算
                        if (approxBytes > 900 * 1024) {
                            dataUrl = await compressToBase64(file, 240); // 再縮小
                        }
                        const base64After = dataUrl.split(',')[1] || '';
                        const bytesAfter = Math.ceil(base64After.length * 0.75);
                        if (bytesAfter > 900 * 1024) {
                            throw new Error('選擇的圖片過大（需小於約 900KB），請換較小的圖片');
                        }

                        // 寫入 Firestore 的 userAvatars/{uid}
                        const avatarDocRef = doc(db, 'userAvatars', state.currentUser.uid);
                        await setDoc(avatarDocRef, {
                            data: dataUrl,
                            mimeType: 'image/jpeg',
                            updatedAt: serverTimestamp(),
                        }, { merge: true });

                        // 兼容既有 UI：將 users.avatarUrl 更新為 Data URL
                        const userDocRef = doc(db, 'users', state.currentUser.uid);
                        await updateDoc(userDocRef, { avatarUrl: dataUrl });

                        // 更新本地 UI
                        state.currentUserData.avatarUrl = dataUrl;
                        document.getElementById('modal-avatar').src = dataUrl;
                        const header = document.getElementById('header-avatar');
                        if (header) header.src = dataUrl;

                        showToast('頭像更新成功（已存入 Firestore）');
                    } catch (error) {
                        console.error('Avatar upload error:', error);
                        showToast('頭像上傳失敗: ' + (error.message || error), true);
                    } finally {
                        showLoading(false);
                    }
                }

                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    await processAndUploadAvatar(file);
                });

                
                // 壓縮並轉 Base64（Data URL）
                async function compressToBase64(file, maxWidth) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('讀取圖片失敗'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('圖片載入失敗'));
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                if (width > maxWidth) {
                                    height = Math.round((height * maxWidth) / width);
                                    width = maxWidth;
                                }
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                try {
                                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                                    resolve(dataUrl);
                                } catch (e) {
                                    reject(e);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                // 新增：壓縮為 Blob（行動端更穩定，避免 Base64 大字串）
                async function compressToBlob(file, maxWidth, mime = 'image/jpeg', quality = 0.85) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('讀取圖片失敗'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('圖片載入失敗'));
                            img.src = event.target.result;
                            img.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    if (width > maxWidth) {
                                        height = Math.round((height * maxWidth) / width);
                                        width = maxWidth;
                                    }
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    if (canvas.toBlob) {
                                        canvas.toBlob((b) => {
                                            if (b) resolve(b); else reject(new Error('圖片壓縮失敗'));
                                        }, mime, quality);
                                    } else {
                                        // Fallback: 以 DataURL 轉 Blob
                                        const dataUrl = canvas.toDataURL(mime, quality);
                                        fetch(dataUrl).then(r => r.blob()).then(resolve).catch(reject);
                                    }
                                } catch (err) {
                                    reject(err);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                logoutBtn.addEventListener('click', async () => {
                    close();
                    await signOut(auth);
                    showToast("您已成功登出");
                });

                // 載入請假申請清單
                (async function loadFutureLeaves() {
                    const container = document.getElementById('future-leaves');
                    if (!container) return;
                    try {
                        const uid = state.currentUser?.uid;
                        if (!uid) {
                            container.innerHTML = '<div class="text-sm text-red-600">請先登入</div>';
                            return;
                        }
                        container.innerHTML = '<div class="text-sm text-gray-500">載入中...</div>';
                        const now = new Date();
                        const q = query(
                            collection(db, 'leaves'),
                            where('userId', '==', uid)
                        );
                        const snap = await getDocs(q);
                        const future = [];
                        snap.forEach(d => {
                            const l = d.data();
                            if (l.startTime && (l.startTime.toDate ? l.startTime.toDate() : new Date(l.startTime)) >= now) {
                                future.push({ id: d.id, ...l });
                            }
                        });
                        if (future.length === 0) {
                            container.innerHTML = '<div class="text-sm text-gray-500">沒有請假申請</div>';
                            return;
                        }
                        future.sort((a, b) => (a.startTime.toDate ? a.startTime.toDate() : new Date(a.startTime)) - (b.startTime.toDate ? b.startTime.toDate() : new Date(b.startTime)));
                        const statusText = s => (
                            s === 'pending' ? '待審核' : s === 'approved' ? '已核准' : s === 'rejected' ? '已拒絕' : '未知'
                        );
                        const statusClass = s => (
                            s === 'pending' ? 'bg-yellow-100 text-yellow-800' : s === 'approved' ? 'bg-green-100 text-green-800' : s === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
                        );
                        container.innerHTML = future.map(l => `
                            <div class="p-3 rounded-md border bg-white">
                                <div class="text-sm font-medium">
                                    ${l.reason || '無事由'}
                                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full ${statusClass(l.status)}">${statusText(l.status)}</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">從 ${formatDateTime(l.startTime)} 至 ${formatDateTime(l.endTime)}</div>
                                <div class="text-xs text-gray-500">${l.reasonType || ''}</div>
                            </div>
                        `).join('');
                    } catch (e) {
                        console.error('載入請假申請失敗:', e);
                        container.innerHTML = '<div class="text-sm text-red-600">載入請假申請失敗</div>';
                    }
                })();
            }

            // 開新視窗顯示隱私權政策
            function openPrivacyPolicyWindow() {
                const appName = '西北打卡';
                const policyHtml = `<!doctype html>
 <html lang="zh-Hant">
 <head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>隱私權政策 - ${appName}</title>
   <style>
     body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', 'Helvetica Neue', Arial, 'Microsoft JhengHei', sans-serif; margin: 0; padding: 24px; line-height: 1.7; color: #1f2937; }
     .container { max-width: 800px; margin: 0 auto; }
     h1 { font-size: 1.5rem; margin-bottom: 12px; }
     h2 { font-size: 1.1rem; margin-top: 20px; margin-bottom: 8px; }
     h3 { font-size: 1rem; margin-top: 14px; margin-bottom: 6px; }
     p { margin: 8px 0; }
     ul { margin: 8px 0 8px 20px; }
     .muted { color: #6b7280; font-size: 0.9rem; }
     .divider { height: 1px; background: #e5e7eb; margin: 16px 0; }
   </style>
   </head>
   <body>
     <div class="container">
       <h1>隱私權政策</h1>
       <p>西北打卡 (以下簡稱「本應用程式」) 尊重並保護所有使用服務用戶的個人隱私權。為了給您提供更準確、更有個性化的服務，本應用程式會按照本隱私權政策的規定使用和披露您的個人資訊。但本應用程式將以高度的勤勉、審慎義務對待這些資訊。除本隱私權政策另有規定外，在未徵得您事先許可的情況下，本應用程式不會將這些資訊對外披露或向第三方提供。本應用程式會不時更新本隱私權政策。 您在同意本應用程式服務使用協議之時，即視為您已經同意本隱私權政策全部內容。</p>
       <p class="muted">生效日期： 2025年10月07日</p>

       <h2>1. 資訊收集與使用</h2>
       <p>為了讓本應用程式正常運作並提供您所需的功能，我們需要請求以下權限，並收集相關資訊：</p>

       <h3>相機 (Camera) 權限：</h3>
       <p>本應用程式需要存取您裝置的相機。此權限僅用於 [請在此處明確說明使用相機的目的，例如：掃描 QR Code、拍照上傳等]。我們不會在您不知情的情況下開啟相機，所拍攝的照片或影片僅會在您的操作下進行處理，我們不會儲存或分享這些內容，除非得到您的明確同意。</p>

       <h3>精確位置 (Precise Location) 權限：</h3>
       <p>本應用程式需要獲取您裝置的精確位置資訊 (GPS 和網路基礎)。此權限僅用於 [請在此處明確說明使用定位的目的，例如：地圖導航、紀錄打卡地點等]。您的位置資訊將用於提升您的使用者體驗，我們不會將您的位置資訊用於本功能以外的其他目的，也不會與任何第三方分享您的個人軌跡。</p>

       <p>本應用程式不會收集與上述功能無關的任何其他個人可識別資訊。</p>

       <h2>2. 資訊披露</h2>
       <p>在如下情況下，本應用程式將依據您的個人意願或法律的規定全部或部分地披露您的個人資訊：</p>
       <ul>
         <li>a) 經您事先同意，向第三方披露；</li>
         <li>b) 為提供您所要求的產品和服務，而必須和第三方分享您的個人資訊；</li>
         <li>c) 根據法律的有關規定，或者行政或司法機構的要求，向第三方或者行政、司法機構披露；</li>
       </ul>

       <h2>3. 資訊安全</h2>
       <p>我們致力於保護您的資訊安全。我們採取了適當的管理、技術和實體安全措施來保護您的資訊，防止未經授權的存取、使用、披露、修改或銷毀。</p>

       <h2>4. 兒童隱私</h2>
       <p>我們的服務不針對任何未滿 13 歲的兒童。我們不會故意收集 13 歲以下兒童的個人可識別資訊。</p>

       <h2>5. 隱私權政策的變更</h2>
       <p>我們可能會不時更新我們的隱私權政策。因此，我們建議您定期查看此頁面以了解任何變更。我們將通過在此頁面上發布新的隱私權政策來通知您任何變更。</p>

       <h2>6. 聯絡我們</h2>
       <p>如果您對我們的隱私權政策有任何疑問或建議，請隨時與我們聯絡。 電子郵件:nwcom.eason@gmail.com</p>
      </div>
    </body>
  </html>`;

                // 優先開啟獨立頁面，使用絕對網址避免相對路徑解析問題
                const url = (window.location && window.location.origin ? window.location.origin : '') + '/privacy.html';
                const win = window.open(url, '_blank', 'width=800,height=900');
                if (win) {
                    try {
                        win.document.open();
                        win.document.write(policyHtml);
                        win.document.close();
                        return;
                    } catch (e) {
                        console.error('寫入隱私權政策視窗內容失敗:', e);
                    }
                }
                if (!win) {
                    // 後備方案：以站內彈窗呈現
                    const modalId = `privacy-modal-${Date.now()}`;
                    const contentOnly = policyHtml.replace(/^[\s\S]*<body[^>]*>/i, '').replace(/<\/body>[\s\S]*$/i, '');
                    const modalHTML = `
                        <div id="${modalId}" class="modal-backdrop" style="overflow:auto;">
                          <div class="modal-content w-[95%] max-w-[900px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                              <h3 class="font-bold text-lg">隱私權政策 - 西北打卡</h3>
                              <button class="close-btn text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                              </button>
                            </div>
                            <div class="p-4 overflow-y-auto" style="max-height: 80vh;">
                              ${contentOnly}
                            </div>
                          </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    const backdrop = document.getElementById(modalId);
                    const closeBtn = backdrop.querySelector('.close-btn');
                    const close = () => backdrop.remove();
                    closeBtn.addEventListener('click', close);
                    backdrop.addEventListener('click', (e) => { if (e.target.id === modalId) close(); });
                    lucide.createIcons();
                }
            }

            function renderLeaveInfo(userData) {
                if (!userData) return '目前沒有請假記錄';
                let isLeave = userData.clockInStatus === '臨時請假';
                if (!isLeave && (userData.leaveStatus === 'approved' || userData.leaveStatus === 'pending')) {
                    const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                    const startTime = toDate(userData.leaveStartTime);
                    const endTime = toDate(userData.leaveEndTime);
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    isLeave = !!(startTime && endTime && startTime <= todayEnd && endTime >= todayStart);
                }
                if (!isLeave) return '目前沒有請假記錄';
                const statusText = userData.leaveStatus === 'approved' ? '已請假' : '請假申請';
                const reasonText = userData.leaveReason ? `${userData.leaveReason}` : '';
                const typeText = userData.reasonType ? `(${userData.reasonType})` : '';
                const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                const startTime = toDate(userData.leaveStartTime);
                const endTime = toDate(userData.leaveEndTime);
                const timeInfo = (startTime && endTime) ? `<div class="text-sm mt-1">從 ${formatDateTime(startTime)} 至 ${formatDateTime(endTime)}</div>` : '';
                return `<div class="font-medium">${statusText}: ${reasonText} ${typeText}</div>${timeInfo}`;
            }

            function openAvatarCameraModal(callback) {
                const modalId = `avatar-camera-modal-${Date.now()}`;
                let videoStream;
                
                const stopCamera = () => {
                    if (videoStream) videoStream.getTracks().forEach(track => track.stop());
                };
                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop" style="z-index: 60;">
                        <div class="modal-content w-[90%] max-w-md bg-black rounded-lg shadow-xl flex flex-col p-4 text-white">
                            <video id="avatar-video" playsinline autoplay muted class="w-full h-auto rounded-lg"></video>
                            <canvas id="avatar-canvas" class="hidden"></canvas>
                            <div class="flex justify-center mt-4">
                                <button id="avatar-capture-btn" class="w-16 h-16 bg-white rounded-full border-4 border-gray-500"></button>
                            </div>
                             <button id="avatar-cancel-btn" class="text-gray-400 mt-2">取消</button>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const video = document.getElementById('avatar-video');
                const canvas = document.getElementById('avatar-canvas');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
                    .then(stream => {
                        videoStream = stream;
                        video.muted = true;
                        video.srcObject = stream;
                        Promise.resolve(video.play()).catch(err => {
                            console.warn("avatar video.play() failed:", err);
                        });
                    }).catch(async err => {
                        console.warn("avatar camera first attempt failed:", err);
                        try {
                            const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                            videoStream = fallbackStream;
                            video.muted = true;
                            video.srcObject = fallbackStream;
                            try { await Promise.resolve(video.play()); } catch (e) { console.warn("avatar fallback video.play() failed:", e); }
                        } catch (err2) {
                            showToast("無法開啟相機，請授權或檢查裝置", true);
                            close();
                        }
                    });

                document.getElementById('avatar-capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        callback(blob);
                        close();
                    }, 'image/jpeg');
                });
                document.getElementById('avatar-cancel-btn').addEventListener('click', close);
            }

            function openCameraModal(type, location) {
                 const modalId = `camera-modal-${Date.now()}`;
                let videoStream;
                const capturedPhotos = []; // { blob, description }

                const stopCamera = () => {
                    if (videoStream) {
                        videoStream.getTracks().forEach(track => track.stop());
                    }
                };

                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[390px] h-[730px] bg-black rounded-2xl shadow-xl flex flex-col p-4 text-white">
                            <div id="camera-view" class="flex-grow relative flex items-center justify-center">
                                <video id="camera-video" playsinline autoplay muted class="w-full h-full object-cover rounded-lg"></video>
                                <canvas id="camera-canvas" class="hidden"></canvas>
                                <div id="camera-loader" class="absolute inset-0 flex items-center justify-center bg-black/50 pointer-events-none"><div class="loader"></div></div>
                            </div>
                            <div id="preview-view" class="hide flex-grow flex flex-col">
                                <img id="photo-preview" class="w-full h-auto flex-grow object-contain rounded-lg">
                                <input type="text" id="photo-description" class="w-full mt-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2" placeholder="輸入說明 (30字內)" maxlength="30">
                            </div>

                            <div class="flex-shrink-0 pt-4">
                                <div id="capture-controls" class="flex items-center justify-between relative" style="z-index: 999;">
                                    <button id="switch-camera-btn" class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center">
                                        <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                                    </button>
                        <button id="capture-btn" class="w-32 h-20 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center" style="z-index: 1000;">
                                        <i data-lucide="camera" class="w-10 h-10 text-gray-800"></i>
                                    </button>
                                    <div class="w-12 h-12"></div><!-- 空白元素保持對稱 -->
                                </div>
                                <div id="confirm-controls" class="hide grid grid-cols-2 gap-2">
                                    <button id="add-another-btn" class="py-3 bg-gray-600 rounded-lg">拍下一張</button>
                                    <button id="finish-btn" class="py-3 bg-red-600 rounded-lg font-semibold">完成打卡</button>
                                </div>
                            </div>
                             <div class="flex-shrink-0 text-center pt-2">
                                <button id="cancel-camera-btn" class="text-gray-400">取消</button>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;

                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('camera-canvas');
                const cameraView = document.getElementById('camera-view');
                const previewView = document.getElementById('preview-view');
                const photoPreview = document.getElementById('photo-preview');
                const descriptionInput = document.getElementById('photo-description');
                const captureControls = document.getElementById('capture-controls');
                const confirmControls = document.getElementById('confirm-controls');

                // 以偏好後鏡頭開始，失敗時回退到前鏡頭，再回退為任何相機
                let currentFacingMode = "environment";
                const setupStream = async (stream) => {
                    videoStream = stream;
                    video.muted = true;
                    video.srcObject = stream;
                    try { await Promise.resolve(video.play()); } catch (e) { console.warn("camera video.play() failed:", e); }
                    document.getElementById('camera-loader').classList.add('hide');
                    lucide.createIcons();
                };

                navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: false })
                    .then(stream => setupStream(stream))
                    .catch(async err => {
                        console.warn("Camera first attempt failed:", err);
                        // 回退：前鏡頭
                        try {
                            currentFacingMode = "user";
                            const stream2 = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: false });
                            await setupStream(stream2);
                        } catch (err2) {
                            console.warn("Camera second attempt failed (user):", err2);
                            // 最終回退：任意可用相機
                            try {
                                const stream3 = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                                await setupStream(stream3);
                            } catch (err3) {
                                console.error("Camera failed after all fallbacks:", err, err2, err3);
                                showToast("無法開啟相機，請授權或檢查裝置", true);
                                close();
                                return;
                            }
                        }
                    });

                document.getElementById('switch-camera-btn').addEventListener('click', async () => {
                    stopCamera();
                    document.getElementById('camera-loader').classList.remove('hide');
                    currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
                    try {
                        const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: false });
                        await setupStream(newStream);
                    } catch (error) {
                        console.error("切換相機失敗:", error);
                        showToast("切換相機失敗，請重試", true);
                        document.getElementById('camera-loader').classList.add('hide');
                    }
                });

                document.getElementById('capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    // 設置固定寬度，但保持原始比例
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;
                    const targetWidth = 390;
                    const targetHeight = (videoHeight / videoWidth) * targetWidth;
                    
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    // 繪製並保持原始比例
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // 添加浮水印
                    context.font = '16px Arial';
                    context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    const now = new Date();
                    const dateTimeText = `${now.toLocaleDateString('zh-TW')} ${now.toLocaleTimeString('zh-TW',{ hour12: false })}`;
                const locationText = (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') ? `位置: ${state.currentLocation.lat.toFixed(6)}, ${state.currentLocation.lng.toFixed(6)}` : '無位置資訊';
                    const userText = `${state.currentUserData.name} - ${type}打卡`;
                    
                    // 在底部添加浮水印
                    context.fillText(dateTimeText, 10, canvas.height - 40);
                    context.fillText(locationText, 10, canvas.height - 20);
                    context.fillText(userText, 10, canvas.height - 60);
                    
                    photoPreview.src = canvas.toDataURL('image/jpeg');
                    cameraView.classList.add('hide');
                    previewView.classList.remove('hide');
                    captureControls.classList.add('hide');
                    confirmControls.classList.remove('hide');
                });
                
                const saveAndPrepareNext = () => {
                     canvas.toBlob(blob => {
                        if (!blob) {
                            showToast("照片處理失敗", true);
                            return;
                        }
                        const description = descriptionInput.value;
                        capturedPhotos.push({ blob, description });
                        
                        descriptionInput.value = '';
                        cameraView.classList.remove('hide');
                        previewView.classList.add('hide');
                        captureControls.classList.remove('hide');
                        confirmControls.classList.add('hide');
                        showToast(`已儲存 ${capturedPhotos.length} 張照片`);

                     }, 'image/jpeg', 0.8);
                };

                document.getElementById('add-another-btn').addEventListener('click', saveAndPrepareNext);

                document.getElementById('finish-btn').addEventListener('click', () => {
                    if (previewView.classList.contains('hide') === false) {
                         canvas.toBlob((blob) => {
                            if (blob) {
                                const description = descriptionInput.value;
                                capturedPhotos.push({ blob, description });
                            }
                            completeClockIn();
                         }, 'image/jpeg', 0.8);
                    } else {
                        completeClockIn();
                    }
                });

                const completeClockIn = async () => {
                    if (capturedPhotos.length === 0) {
                        showToast("請至少拍攝一張照片", true);
                        return;
                    }
                    stopCamera();
                    showLoading(true);

                    try {
                        // 僅允許安全規則中的打卡類型
                        const allowedTypes = ['上班','下班'];
                        if (!allowedTypes.includes(type)) {
                            console.warn('不允許的打卡類型，已取消寫入：', type);
                            showToast('此打卡類型不支援紀錄寫入，請改用對應功能', true);
                            return;
                        }

                        // 勤務時間檢查：開始前禁止打卡，結束後標記超時巡邏
                        const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                        const dutyStart = toDate(state.currentUserData?.dutyStartTime);
                        const dutyEnd = toDate(state.currentUserData?.dutyEndTime);
                        const restrictedTypes = ['外出','抵達','離開'];
                        let isOvertime = false;
                        if (restrictedTypes.includes(type) && (dutyStart || dutyEnd)) {
                            const now = new Date();
                            if (dutyStart && now < dutyStart) {
                                showToast(`勤務尚未開始（${dutyStart.toLocaleString('zh-TW', { hour12: false })}），不可打卡`, true);
                                return;
                            }
                            if (dutyEnd && now > dutyEnd) {
                                isOvertime = true;
                            }
                        }

                        // 上傳照片到 Cloud Storage；若在 GitHub Pages 或遇到 CORS/網路問題則回退為壓縮後的 Data URL 寫入 Firestore
                        const storageInst = window.__storage;
                        const uploadTargets = capturedPhotos.slice(0, 3);
                        let photoUrls = [];
                        let descriptions = [];
                        const isGithubPages = /\.github\.io$/i.test(window.location.hostname);
                        const compressBlobToDataURL = async (blob, maxWidth = 800, quality = 0.6) => {
                            try {
                                const imgBitmap = await createImageBitmap(blob);
                                const ratio = imgBitmap.height / imgBitmap.width;
                                const canvasEl = document.createElement('canvas');
                                canvasEl.width = maxWidth;
                                canvasEl.height = Math.round(maxWidth * ratio);
                                const ctx = canvasEl.getContext('2d');
                                ctx.drawImage(imgBitmap, 0, 0, canvasEl.width, canvasEl.height);
                                return canvasEl.toDataURL('image/jpeg', quality);
                            } catch (_) {
                                return await new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => resolve(reader.result);
                                    reader.readAsDataURL(blob);
                                });
                            }
                        };
                        const useStorage = !!storageInst && !isGithubPages;
                        if (useStorage) {
                            try {
                                const uploadedPhotos = await Promise.all(uploadTargets.map(async (photo, idx) => {
                                    const nowMs = Date.now();
                                    const ext = (photo.blob && typeof photo.blob.type === 'string' && photo.blob.type.includes('png')) ? 'png' : 'jpg';
                                    const uidForPath = window.__auth?.currentUser?.uid || state.currentUser?.uid || 'unknown-user';
                                    const path = `clock-in/${uidForPath}/${nowMs}_${idx}.${ext}`;
                                    const storageRef = ref(storageInst, path);
                                    const metadata = (photo.blob && photo.blob.type) ? { contentType: photo.blob.type } : undefined;
                                    await uploadBytes(storageRef, photo.blob, metadata);
                                    const url = await getDownloadURL(storageRef);
                                    return { url, description: photo.description };
                                }));
                                photoUrls = uploadedPhotos.map(p => p.url);
                                descriptions = uploadedPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));
                            } catch (uploadErr) {
                                console.warn('照片上傳至 Storage 失敗，改用壓縮後的 Data URL：', uploadErr);
                                const fallbackPhotos = await Promise.all(uploadTargets.map(async (photo) => {
                                    const url = await compressBlobToDataURL(photo.blob, 640, 0.5);
                                    return { url, description: photo.description };
                                }));
                                photoUrls = fallbackPhotos.map(p => p.url);
                                descriptions = fallbackPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));
                            }
                        } else {
                            console.info('偵測到 GitHub Pages 網域或缺少 Storage，直接使用壓縮後的 Data URL。');
                            const fallbackPhotos = await Promise.all(uploadTargets.map(async (photo) => {
                                const url = await compressBlobToDataURL(photo.blob, 640, 0.5);
                                return { url, description: photo.description };
                            }));
                            photoUrls = fallbackPhotos.map(p => p.url);
                            descriptions = fallbackPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));
                        }

                        // 安全座標處理：僅接受有限數值，否則回退 (0,0)
                        const toFinite = (n) => (typeof n === 'number' && Number.isFinite(n)) ? n : 0;
                        const safeLat = toFinite(location?.lat);
                        const safeLng = toFinite(location?.lng);

                        const uid = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                        if (!uid || !window.__auth?.currentUser) {
                            showToast('尚未登入或登入逾時，請重新登入', true);
                            showLoading(false);
                            return;
                        }
                        const recordData = {
                            userId: uid,
                            type: type,
                            timestamp: Timestamp.now(),
                            location: new GeoPoint(safeLat, safeLng),
                            photoUrls,
                            descriptions,
                            deviceId: state.deviceId || 'unknown-device',
                            isAutomatic: false
                        };
                        // 勤務項目與超時巡邏標記：避免 undefined 寫入
                        if (isOvertime) {
                            recordData.dutyType = '超時巡邏';
                        } else if (type === '外出' && state.dutyType) {
                            recordData.dutyType = state.dutyType;
                        }
                        
                        // 如果是外出打卡，添加地點名稱
                        if (type === '外出') {
                            const locName = typeof location.name === 'string' ? location.name : '';
                            if (locName) {
                                recordData.locationName = locName.slice(0, 100);
                            }
                        }
                        
                        try {
                            const { addDoc, collection } = window.__fs;
                            const db2 = window.__db;
                            await addDoc(collection(db2, "clockInRecords"), recordData);
                        } catch (e) {
                            const expectedCodes = ['permission-denied','failed-precondition','invalid-argument'];
                            const logFn = expectedCodes.includes(e?.code) ? console.warn : console.error;
                            logFn('新增 clockInRecords 失敗：', e?.code, e?.message || e, { keys: Object.keys(recordData), type: recordData.type, locationIsGeoPoint: recordData.location instanceof GeoPoint, photosLen: recordData.photoUrls.length, descLen: recordData.descriptions.length });
                            // 當前架構僅上班/下班：若無法建立紀錄，回退為僅更新使用者狀態
                            if (expectedCodes.includes(e?.code)) {
                                try {
                                    const { updateDoc, doc } = window.__fs;
                                    const db2 = window.__db;
                                    const uid2 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                                    await updateDoc(doc(db2, "users", uid2), {
                                        status: type,
                                        clockInStatus: type,
                                        lastUpdated: Timestamp.now()
                                    });
                                    console.warn('無法建立 clockInRecords，已改為僅更新使用者狀態');
                                } catch (e2) {
                                    console.error('回退更新使用者狀態失敗：', e2);
                                    throw e;
                                }
                            } else {
                                throw e;
                            }
                        }

                        // 首次打卡裝置ID寫入：僅當使用者尚未有 firstClockInDeviceId
                        try {
                            const { doc, getDoc, updateDoc } = window.__fs;
                            const db2 = window.__db;
                            const uid3 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            const userRef = doc(db2, "users", uid3);
                            const userSnap = await getDoc(userRef);
                            const hasFirst = userSnap.exists() && userSnap.data().firstClockInDeviceId;
                            if (!hasFirst && type === '上班') {
                                await updateDoc(userRef, { firstClockInDeviceId: state.deviceId || 'unknown-device' });
                            }
                        } catch (e) {
                            console.warn('寫入首次打卡裝置ID失敗', e);
                        }

                        const userUpdateData = {
                            status: type,
                            clockInStatus: type,
                            lastUpdated: Timestamp.now()
                        };
                        
                        // 如果是外出打卡，添加外出地點名稱
                        if (type === '外出') {
                            const locName2 = typeof location.name === 'string' ? location.name : '';
                            if (locName2) {
                                userUpdateData.outboundLocation = locName2.slice(0, 100);
                            }
                        }
                        // 超時巡邏標記或外出同步勤務項目（若有）
                        if (isOvertime) {
                            userUpdateData.dutyType = '超時巡邏';
                        } else if (type === '外出' && state.dutyType) {
                            userUpdateData.dutyType = state.dutyType;
                        }
                        
                        try {
                            const { updateDoc, doc } = window.__fs;
                            const db2 = window.__db;
                            const uid2 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            await updateDoc(doc(db2, "users", uid2), userUpdateData);
                        } catch (e) {
                            console.error('更新 users 狀態失敗：', e?.code, e?.message || e, { keys: Object.keys(userUpdateData) });
                            throw e;
                        }

                        // 更新本地狀態
                        state.clockInStatus = type;
                        
                        // 如果是上班打卡，啟動自動下班打卡計時器
                        if (type === '上班' && typeof startAutoClockOutTimer === 'function') {
                            // 重新載入設定並啟動計時器
                            loadAutoClockOutSettings().then(() => {
                                startAutoClockOutTimer();
                            });
                        }
                        
                        // 如果是下班打卡，停止自動下班打卡計時器
                        if (type === '下班' && typeof stopAutoClockOutTimer === 'function') {
                            stopAutoClockOutTimer();
                        }
                        
                        // 更新頁面顯示
                        updateStatusDisplay();
                        // 保險：直接刷新儀表板狀態（即使打卡頁區塊不存在也更新）
                        if (typeof updateDashboardStatus === 'function') {
                            try { updateDashboardStatus(); } catch (e) { console.warn('updateDashboardStatus 執行失敗', e); }
                        }
                        // 立即更新按鈕狀態，確保離開/返回等循環按鈕文字與樣式正確
                        if (typeof updateButtonStatus === 'function') {
                            try { updateButtonStatus(); } catch (e) { console.warn('updateButtonStatus 執行失敗', e); }
                        }
                        
                        showToast(`${type}打卡成功！`);
                        close();
                        showPage('clock-in', 'location');  // 改為顯示定位打卡頁面

                    } catch (error) {
                        console.error("Clock in error:", error);
                        showToast("打卡失敗，請稍後再試", true);
                    } finally {
                        showLoading(false);
                    }
                };

                document.getElementById('cancel-camera-btn').addEventListener('click', close);
            }

            // --- Google Maps ---
            function loadGoogleMapsScript() {
                if (window.google && state.googleMapsLoaded) return;
                
                window.initMap = () => { 
                    state.googleMapsLoaded = true; 
                    console.log("Google Maps API 已成功加載");
                };
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&v=weekly`;
                script.async = true;
                script.defer = true;
                
                script.onerror = () => {
                    console.error("Google Maps API 加載失敗");
                    showToast("地圖服務加載失敗，請檢查網絡連接或API金鑰", true);
                };
                
                document.head.appendChild(script);
            }
            
            // --- Helper functions ---
            function cleanupListeners() {
                state.activeListeners.forEach(unsubscribe => unsubscribe());
                state.activeListeners = [];
            }

            // 移除舊的 getStatusColor 函數，使用 dashboard-functions.js 中的版本
            
            // 渲染請假資訊（第二個版本，使用統一的判斷邏輯）
            function renderLeaveInfo(userData) {
                if (!userData) return '目前沒有請假記錄';
                let isLeave = userData.clockInStatus === '臨時請假';
                if (!isLeave && (userData.leaveStatus === 'approved' || userData.leaveStatus === 'pending')) {
                    const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                    const startTime = toDate(userData.leaveStartTime);
                    const endTime = toDate(userData.leaveEndTime);
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    isLeave = !!(startTime && endTime && startTime <= todayEnd && endTime >= todayStart);
                }
                if (!isLeave) {
                    // 檢查是否為特殊勤務
                    if (userData.clockInStatus === '特殊勤務') {
                        const dutyName = userData.dutyName || '未指定勤務';
                        const location = userData.dutyLocation || '未指定地點';
                        
                        let startTimeStr = '未指定時間';
                        let endTimeStr = '未指定時間';
                        
                        if (userData.dutyStartTime) {
                            const startTime = userData.dutyStartTime.toDate ? 
                                userData.dutyStartTime.toDate() : 
                                new Date(userData.dutyStartTime);
                            startTimeStr = startTime.toLocaleString('zh-TW', { hour12: false });
                        }
                        
                        if (userData.dutyEndTime) {
                            const endTime = userData.dutyEndTime.toDate ? 
                                userData.dutyEndTime.toDate() : 
                                new Date(userData.dutyEndTime);
                            endTimeStr = endTime.toLocaleString('zh-TW', { hour12: false });
                        }
                        
                        return `
                            <div class="font-semibold text-lg">執行特殊勤務</div>
                            <div class="mt-2">
                                <p><span class="font-medium">勤務名稱：</span>${dutyName}</p>
                                <p><span class="font-medium">勤務地點：</span>${location}</p>
                                <p><span class="font-medium">開始時間：</span>${startTimeStr}</p>
                                <p><span class="font-medium">結束時間：</span>${endTimeStr}</p>
                            </div>
                        `;
                    }
                    return '目前沒有請假記錄';
                }
                const leaveStatus = userData.leaveStatus === 'approved' ? '已請假' : '請假申請';
                const reason = userData.leaveReason || '未指定原因';
                
                const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                const startTime = toDate(userData.leaveStartTime);
                const endTime = toDate(userData.leaveEndTime);
                const startTimeStr = startTime ? startTime.toLocaleString('zh-TW', { hour12: false }) : '未指定時間';
                const endTimeStr = endTime ? endTime.toLocaleString('zh-TW', { hour12: false }) : '未指定時間';
                
                return `
                    <div class="font-semibold text-lg">${leaveStatus}</div>
                    <div class="mt-2">
                        <p><span class="font-medium">事由：</span>${reason}</p>
                        <p><span class="font-medium">開始時間：</span>${startTimeStr}</p>
                        <p><span class="font-medium">結束時間：</span>${endTimeStr}</p>
                    </div>
                `;
            }
            

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }
            // 使全域可用，以供其他腳本呼叫
            window.showToast = showToast;
            function openVoiceCallModal(targetUserId, stream) {
                const backdrop = document.createElement('div');
                backdrop.id = 'voice-call-backdrop';
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';

                const modal = document.createElement('div');
                modal.id = 'voice-call-modal';
                modal.className = 'fixed inset-0 flex items-center justify-center z-50';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg w-96 p-4';

                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold mb-2';
                const target = (window.state?.users || []).find(u => u.id === targetUserId);
                title.textContent = `語音通話：${target?.name || target?.email || targetUserId}`;

                const statusEl = document.createElement('div');
                statusEl.className = 'text-sm text-gray-600 mb-3';
                statusEl.textContent = '初始化麥克風…';

                const audio = document.createElement('audio');
                audio.autoplay = true;
                audio.className = 'w-full mb-3';

                const controls = document.createElement('div');
                controls.className = 'grid grid-cols-2 gap-2';

                const muteBtn = document.createElement('button');
                muteBtn.className = 'px-3 py-2 rounded-md bg-gray-200 text-gray-700';
                muteBtn.textContent = '靜音';

                const endBtn = document.createElement('button');
                endBtn.className = 'px-3 py-2 rounded-md bg-red-500 text-white';
                endBtn.textContent = '結束通話';

                controls.appendChild(muteBtn);
                controls.appendChild(endBtn);

                card.appendChild(title);
                card.appendChild(statusEl);
                card.appendChild(audio);
                card.appendChild(controls);
                modal.appendChild(card);
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);

                function close() {
                    try {
                        if (audio.srcObject) {
                            audio.srcObject.getTracks().forEach(t => t.stop());
                            audio.srcObject = null;
                        }
                    } catch (e) {}
                    backdrop.remove();
                    modal.remove();
                }
                backdrop.addEventListener('click', close);
                endBtn.addEventListener('click', close);

                let muted = false;
                muteBtn.addEventListener('click', () => {
                    muted = !muted;
                    muteBtn.textContent = muted ? '取消靜音' : '靜音';
                    const track = audio.srcObject && audio.srcObject.getAudioTracks()[0];
                    if (track) track.enabled = !muted;
                });

                if (stream) {
                    audio.srcObject = stream;
                    statusEl.textContent = '麥克風已啟動（僅本機播放，尚未連線）';
                } else {
                    statusEl.textContent = '無法取得麥克風串流';
                }
            }

            async function startVoiceCall(targetUserId) {
                // Secure context check for microphone APIs
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('非安全來源，麥克風可能無法啟用');
                    showToast('提示：請以 https 或 localhost 開啟以使用語音通話', true);
                }
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showToast('瀏覽器不支援語音通話 API', true);
                        return;
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    openVoiceCallModal(targetUserId, stream);
                    showToast('語音通話初始化完成（尚未建立連線）');
                } catch (e) {
                    console.error('啟動語音通話失敗:', e);
                    const msg = (e && e.name === 'NotAllowedError')
                        ? '已拒絕麥克風權限，請在瀏覽器設定中允許'
                        : (e && e.name === 'NotFoundError')
                            ? '找不到可用的音訊裝置'
                            : '無法啟用麥克風，請檢查權限與來源';
                    showToast(msg, true);
                }
            }
            window.startVoiceCall = startVoiceCall;

            function timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " 年前";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " 月前";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " 天前";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " 小時前";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " 分鐘前";
                return "剛剛";
            }
            
            function formatDate(timestamp) {
                if (!timestamp) return '';
                let d;
                try {
                    if (timestamp && typeof timestamp.toDate === 'function') {
                        d = timestamp.toDate();
                    } else if (timestamp instanceof Date) {
                        d = timestamp;
                    } else {
                        d = new Date(timestamp);
                    }
                } catch (_) {
                    d = new Date(timestamp);
                }
                if (!d || isNaN(d.getTime())) return '';
                return d.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
            }

            // 通用日期時間格式化：支援 Firestore Timestamp、Date、字串與數字
            function formatDateTime(value) {
                if (!value) return '';
                let d;
                try {
                    if (value && typeof value.toDate === 'function') {
                        d = value.toDate();
                    } else if (value instanceof Date) {
                        d = value;
                    } else {
                        d = new Date(value);
                    }
                    if (isNaN(d.getTime())) return '';
                    return d.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                } catch (e) {
                    console.error('formatDateTime error:', e);
                    return '';
                }
            }
        }

        // 用戶彈出視窗功能
        document.addEventListener('click', function(e) {
            // 關閉已打開的彈出視窗
            if (!e.target.closest('.user-popup') && !e.target.closest('.user-name-btn')) {
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
            }
            
            // 點擊用戶名稱時顯示彈出視窗
            if (e.target.classList.contains('user-name-btn') || e.target.closest('.user-name-btn')) {
                const nameBtn = e.target.classList.contains('user-name-btn') ? e.target : e.target.closest('.user-name-btn');
                const userId = nameBtn.dataset.userId;
                const userName = nameBtn.dataset.userName;
                const userPhone = nameBtn.dataset.userPhone;
                
                // 關閉已打開的彈出視窗
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                // 創建新的彈出視窗
                const popup = document.createElement('div');
                popup.className = 'user-popup fixed bg-white rounded-lg shadow-lg p-3 z-50';
                popup.style.width = '200px';
                
                // 計算位置 (在名稱下方) 並避免超出視窗邊界
                const rect = nameBtn.getBoundingClientRect();
                const popupWidth = 200; // 與 CSS 寬度一致
                const margin = 10; // 與邊界保持距離
                let left = rect.left;
                let top = rect.bottom + 5;

                // 右側邊界檢查
                if (left + popupWidth > window.innerWidth - margin) {
                    left = Math.max(margin, window.innerWidth - popupWidth - margin);
                }
                // 左側邊界檢查
                if (left < margin) {
                    left = margin;
                }

                // 預估高度並做下邊界檢查；若超出則顯示在名稱上方
                const estimatedHeight = 120; // 內容高度估算
                if (top + estimatedHeight > window.innerHeight - margin) {
                    top = rect.top - estimatedHeight - 5;
                }
                // 上側邊界檢查
                if (top < margin) {
                    top = margin;
                }

                popup.style.left = `${left}px`;
                popup.style.top = `${top}px`;
                // 動態限制高度並允許捲動
                const availableHeight = window.innerHeight - top - margin;
                popup.style.maxHeight = `${Math.max(80, availableHeight)}px`;
                popup.style.overflow = 'auto';
                
                // 添加按鈕（語音通話）
                popup.innerHTML = `
                    <div class="flex justify-center">
                        <button class="call-btn bg-purple-500 text-white py-1 px-2 rounded-md flex items-center justify-center" data-userid="${userId}">
                            <i data-lucide="mic" class="w-4 h-4 mr-1"></i>語音通話
                        </button>
                    </div>
                `;
                
                // 添加到頁面
                document.body.appendChild(popup);
                lucide.createIcons();
                
                // 添加按鈕事件（語音通話）
                popup.querySelector('.call-btn').addEventListener('click', function() {
                    const targetUserId = this.dataset.userid;
                    if (targetUserId) {
                        startVoiceCall(targetUserId);
                    } else {
                        showToast('無對象資訊', true);
                    }
                });
                
                // Line聊天按鈕已移除
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             lucide.createIcons();
             showLoading(true);
             if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY" || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                document.getElementById('api-key-warning').classList.remove('hide');
                showLoading(false);
                console.error("API Keys are not configured. Please edit index.html"); 
            } else {
                initializeAppLogic();
            }
        });
    </script>
</body>
</html>




